<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>http://blog.ludangxin.club</id>
    <title>æ–­å‰‘é‡é“¸ä¹‹æ—¥ï¼Œéª‘å£«å½’æ¥ä¹‹æ—¶ã€‚</title>
    <updated>2020-08-20T15:00:42.634Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="http://blog.ludangxin.club"/>
    <link rel="self" href="http://blog.ludangxin.club/atom.xml"/>
    <subtitle>å¿µå¿µä¸å¿˜ , å¿…æœ‰å›å“~</subtitle>
    <logo>http://blog.ludangxin.club/images/avatar.png</logo>
    <icon>http://blog.ludangxin.club/favicon.ico</icon>
    <rights>All rights reserved 2020, æ–­å‰‘é‡é“¸ä¹‹æ—¥ï¼Œéª‘å£«å½’æ¥ä¹‹æ—¶ã€‚</rights>
    <entry>
        <title type="html"><![CDATA[SpringBoot é›†æˆ Mybatis-Plus]]></title>
        <id>http://blog.ludangxin.club/post/mybatis-plus/</id>
        <link href="http://blog.ludangxin.club/post/mybatis-plus/">
        </link>
        <updated>2020-08-19T16:11:48.000Z</updated>
        <content type="html"><![CDATA[<h2 id="1-mybatis-plusç®€ä»‹">1 Mybatis-Plusç®€ä»‹</h2>
<h3 id="11-ç®€ä»‹">1.1 ç®€ä»‹</h3>
<p>MyBatis-Plusï¼ˆç®€ç§° MPï¼‰æ˜¯ä¸€ä¸ª MyBatis çš„å¢å¼ºå·¥å…·ï¼Œåœ¨ MyBatis çš„åŸºç¡€ä¸Šåªåšå¢å¼ºä¸åšæ”¹å˜ï¼Œä¸ºç®€åŒ–å¼€å‘ã€æé«˜æ•ˆç‡è€Œç”Ÿã€‚è¯¥æ¡†æ¶ç”±baomidouï¼ˆè‹ç±³è±†ï¼‰ç»„ç»‡å¼€å‘å¹¶ä¸”å¼€æºçš„ã€‚å®˜ç½‘ï¼š<a href="https://mp.baomidou.com/">https://mp.baomidou.com/</a>ï¼Œç äº‘åœ°å€ï¼š<a href="https://gitee.com/organizations/baomidou">https://gitee.com/organizations/baomidou</a><br>
<img src="http://blog.ludangxin.club/post-images/1597928865765.png" alt="" loading="lazy"><br>
<strong>æ„¿æ™¯</strong><br>
æˆ‘ä»¬çš„æ„¿æ™¯æ˜¯æˆä¸º MyBatis æœ€å¥½çš„æ­æ¡£ï¼Œå°±åƒé­‚æ–—ç½— ä¸­çš„ 1Pã€2Pï¼ŒåŸºå‹æ­é…ï¼Œæ•ˆç‡ç¿»å€ã€‚<br>
<img src="http://blog.ludangxin.club/post-images/1597928952406.png" alt="" loading="lazy"></p>
<h3 id="12-ç‰¹æ€§">1.2 ç‰¹æ€§</h3>
<ul>
<li><strong>æ— ä¾µå…¥</strong>ï¼šåªåšå¢å¼ºä¸åšæ”¹å˜ï¼Œå¼•å…¥å®ƒä¸ä¼šå¯¹ç°æœ‰å·¥ç¨‹äº§ç”Ÿå½±å“ï¼Œå¦‚ä¸èˆ¬é¡ºæ»‘</li>
<li><strong>æŸè€—å°</strong>ï¼šå¯åŠ¨å³ä¼šè‡ªåŠ¨æ³¨å…¥åŸºæœ¬ CURDï¼Œæ€§èƒ½åŸºæœ¬æ— æŸè€—ï¼Œç›´æ¥é¢å‘å¯¹è±¡æ“ä½œ</li>
<li><strong>å¼ºå¤§çš„ CRUD æ“ä½œ</strong>ï¼šå†…ç½®é€šç”¨ Mapperã€é€šç”¨ Serviceï¼Œä»…ä»…é€šè¿‡å°‘é‡é…ç½®å³å¯å®ç°å•è¡¨å¤§éƒ¨åˆ† CRUD æ“ä½œï¼Œæ›´æœ‰å¼ºå¤§çš„æ¡ä»¶æ„é€ å™¨ï¼Œæ»¡è¶³å„ç±»ä½¿ç”¨éœ€æ±‚</li>
<li><strong>æ”¯æŒ Lambda å½¢å¼è°ƒç”¨</strong>ï¼šé€šè¿‡ Lambda è¡¨è¾¾å¼ï¼Œæ–¹ä¾¿çš„ç¼–å†™å„ç±»æŸ¥è¯¢æ¡ä»¶ï¼Œæ— éœ€å†æ‹…å¿ƒå­—æ®µå†™é”™</li>
<li><strong>æ”¯æŒå¤šç§æ•°æ®åº“</strong>ï¼šæ”¯æŒ MySQLã€MariaDBã€Oracleã€DB2ã€H2ã€HSQLã€SQLiteã€Postgreã€SQLServer2005ã€SQLServer ç­‰å¤šç§æ•°æ®åº“</li>
<li><strong>æ”¯æŒä¸»é”®è‡ªåŠ¨ç”Ÿæˆ</strong>ï¼šæ”¯æŒå¤šè¾¾ 4 ç§ä¸»é”®ç­–ç•¥ï¼ˆå†…å«åˆ†å¸ƒå¼å”¯ä¸€ ID ç”Ÿæˆå™¨ - Sequenceï¼‰ï¼Œå¯è‡ªç”±é…ç½®ï¼Œå®Œç¾è§£å†³ä¸»é”®é—®é¢˜</li>
<li><strong>æ”¯æŒ XML çƒ­åŠ è½½</strong>ï¼šMapper å¯¹åº”çš„ XML æ”¯æŒçƒ­åŠ è½½ï¼Œå¯¹äºç®€å•çš„ CRUD æ“ä½œï¼Œç”šè‡³å¯ä»¥æ—  XML å¯åŠ¨</li>
<li><strong>æ”¯æŒ ActiveRecord æ¨¡å¼</strong>ï¼šæ”¯æŒ ActiveRecord å½¢å¼è°ƒç”¨ï¼Œå®ä½“ç±»åªéœ€ç»§æ‰¿ Model ç±»å³å¯è¿›è¡Œå¼ºå¤§çš„ CRUD æ“ä½œ</li>
<li><strong>æ”¯æŒè‡ªå®šä¹‰å…¨å±€é€šç”¨æ“ä½œ</strong>ï¼šæ”¯æŒå…¨å±€é€šç”¨æ–¹æ³•æ³¨å…¥ï¼ˆ Write once, use anywhere ï¼‰</li>
<li><strong>æ”¯æŒå…³é”®è¯è‡ªåŠ¨è½¬ä¹‰</strong>ï¼šæ”¯æŒæ•°æ®åº“å…³é”®è¯ï¼ˆorderã€key......ï¼‰è‡ªåŠ¨è½¬ä¹‰ï¼Œè¿˜å¯è‡ªå®šä¹‰å…³é”®è¯</li>
<li><strong>å†…ç½®ä»£ç ç”Ÿæˆå™¨</strong>ï¼šé‡‡ç”¨ä»£ç æˆ–è€… Maven æ’ä»¶å¯å¿«é€Ÿç”Ÿæˆ Mapper ã€ Model ã€ Service ã€ Controller å±‚ä»£ç ï¼Œæ”¯æŒæ¨¡æ¿å¼•æ“ï¼Œæ›´æœ‰è¶…å¤šè‡ªå®šä¹‰é…ç½®ç­‰æ‚¨æ¥ä½¿ç”¨</li>
<li><strong>å†…ç½®åˆ†é¡µæ’ä»¶</strong>ï¼šåŸºäº MyBatis ç‰©ç†åˆ†é¡µï¼Œå¼€å‘è€…æ— éœ€å…³å¿ƒå…·ä½“æ“ä½œï¼Œé…ç½®å¥½æ’ä»¶ä¹‹åï¼Œå†™åˆ†é¡µç­‰åŒäºæ™®é€š List æŸ¥è¯¢</li>
<li><strong>å†…ç½®æ€§èƒ½åˆ†ææ’ä»¶</strong>ï¼šå¯è¾“å‡º Sql è¯­å¥ä»¥åŠå…¶æ‰§è¡Œæ—¶é—´ï¼Œå»ºè®®å¼€å‘æµ‹è¯•æ—¶å¯ç”¨è¯¥åŠŸèƒ½ï¼Œèƒ½å¿«é€Ÿæªå‡ºæ…¢æŸ¥è¯¢</li>
<li><strong>å†…ç½®å…¨å±€æ‹¦æˆªæ’ä»¶</strong>ï¼šæä¾›å…¨è¡¨ delete ã€update æ“ä½œæ™ºèƒ½åˆ†æé˜»æ–­ï¼Œä¹Ÿå¯è‡ªå®šä¹‰æ‹¦æˆªè§„åˆ™ï¼Œé¢„é˜²è¯¯æ“ä½œ</li>
<li><strong>å†…ç½® Sql æ³¨å…¥å‰¥ç¦»å™¨</strong>ï¼šæ”¯æŒ Sql æ³¨å…¥å‰¥ç¦»ï¼Œæœ‰æ•ˆé¢„é˜² Sql æ³¨å…¥æ”»å‡»</li>
</ul>
<h2 id="2-å¿«é€Ÿå…¥é—¨">2 å¿«é€Ÿå…¥é—¨</h2>
<h3 id="21-åˆ›å»ºæ•°æ®åº“åŠè¡¨">2.1 åˆ›å»ºæ•°æ®åº“åŠè¡¨</h3>
<figure data-type="image" tabindex="1"><img src="http://blog.ludangxin.club/post-images/1597928994208.png" alt="" loading="lazy"></figure>
<pre><code class="language-sql">-- åˆ›å»ºæµ‹è¯•è¡¨
CREATE TABLE `sys_user` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `user_name` varchar(20) NOT NULL COMMENT 'ç”¨æˆ·å',
  `name` varchar(30) DEFAULT NULL COMMENT 'å§“å',
  `age` int(11) DEFAULT NULL COMMENT 'å¹´é¾„',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;

-- æ’å…¥æµ‹è¯•æ•°æ®
INSERT INTO `sys_user` (`id`, `user_name`, `name`, `age`) VALUES ('1', 'zhangsan', 'å¼ ä¸‰', '18');
INSERT INTO `sys_user` (`id`, `user_name`, `name`, `age`) VALUES ('2', 'lisi', 'æå››', '20');
INSERT INTO `sys_user` (`id`, `user_name`, `name`, `age`) VALUES ('3', 'wangwu', 'ç‹äº”', '28');
INSERT INTO `sys_user` (`id`, `user_name`, `name`, `age`) VALUES ('4', 'zhaoliu', 'èµµå…­', '21');
INSERT INTO `sys_user` (`id`, `user_name`, `name`, `age`) VALUES ('5', 'sunqi', 'å­™ä¸ƒ', '24');
~~~![](http://blog.ludangxin.club/post-images/1597929873595.jpg)
### 2.2 å·¥ç¨‹æ­å»º
#### å®Œæ•´çš„é¡¹ç›®ç»“æ„å›¾ç¤º
![](http://blog.ludangxin.club/post-images/1597929500996.jpg)
#### 2.2.1 æ·»åŠ æ‰€éœ€ä¾èµ–
~~~xml
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;!--ç®€åŒ–ä»£ç çš„å·¥å…·åŒ…--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
            &lt;artifactId&gt;lombok&lt;/artifactId&gt;
            &lt;optional&gt;true&lt;/optional&gt;
        &lt;/dependency&gt;
        &lt;!--mybatis-plusçš„springbootæ”¯æŒ--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.baomidou&lt;/groupId&gt;
            &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt;
            &lt;version&gt;3.3.2&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!--mysqlé©±åŠ¨--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;mysql&lt;/groupId&gt;
            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
            &lt;version&gt;5.1.47&lt;/version&gt;
        &lt;/dependency&gt;
</code></pre>
<h4 id="222-é…ç½®-applicationyml">2.2.2 é…ç½® application.yml</h4>
<pre><code class="language-yaml">spring:
  datasource:
    # Oracle: oracle.jdbc.OracleDriver
    #  5.7ä¹‹å‰ç‰ˆæœ¬ä½¿ç”¨ com.mysql.jdbc.Driver 
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/mp?useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=true&amp;serverTimezone=GMT%2B8
    username: root
    password: root
    type: com.zaxxer.hikari.HikariDataSource
    hikari:
      minimum-idle: 5
      maximum-pool-size: 5
      auto-commit: true
      idle-timeout: 30000
      pool-name: DatebookHikariCP
      max-lifetime: 1800000
      connection-timeout: 30000
      connection-test-query: SELECT 1  # Oracle: SELECT 1 FROM DUAL

mybatis-plus:
  # è®¾ç½®Mapperæ¥å£æ‰€å¯¹åº”çš„XMLæ–‡ä»¶ä½ç½®ï¼Œå¦‚æœä½ åœ¨Mapperæ¥å£ä¸­æœ‰è‡ªå®šä¹‰æ–¹æ³•ï¼Œéœ€è¦è¿›è¡Œè¯¥é…ç½®
  mapper-locations: classpath*:mybatis/*.xml
  # è®¾ç½®åˆ«ååŒ…æ‰«æè·¯å¾„ï¼Œé€šè¿‡è¯¥å±æ€§å¯ä»¥ç»™åŒ…ä¸­çš„ç±»æ³¨å†Œåˆ«å
  type-aliases-package: com.ludangxin.mp.pojo
  configuration:
    # æ§åˆ¶å°sqlæ‰“å°
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl

</code></pre>
<h4 id="223-ç¼–å†™pojo">2.2.3 ç¼–å†™pojo</h4>
<pre><code class="language-java">import com.baomidou.mybatisplus.annotation.TableName;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
@AllArgsConstructor
@TableName(&quot;sys_user&quot;)
public class User {
    @TableId(&quot;ID&quot;)
    private Long id;
    //é©¼å³°å‘½å,åˆ™æ— éœ€æ³¨è§£
    @TableField(&quot;USER_NAME&quot;) 
    private String userName; 
    @TableField(&quot;NAME&quot;)
    private String name;
    @TableField(&quot;AGE&quot;)
    private Integer age;
}
</code></pre>
<h4 id="225-ç¼–å†™mapperæ¥å£å’Œé…ç½®æ–‡ä»¶">2.2.5 ç¼–å†™mapperæ¥å£å’Œé…ç½®æ–‡ä»¶</h4>
<pre><code class="language-java">import com.ludangxin.mp.pojo.User;
import com.baomidou.mybatisplus.core.mapper.BaseMapper;

public interface UserMapper extends BaseMapper&lt;User&gt; {
}
</code></pre>
<p>åœ¨resourcesç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹mybatisï¼Œä¸“é—¨å­˜æ”¾mapperé…ç½®æ–‡ä»¶</p>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;
&lt;!DOCTYPE mapper
        PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;
        &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;
&lt;mapper namespace=&quot;com.ludangxin.mp.mapper.UserMapper&quot;&gt;
    
&lt;/mapper&gt;
</code></pre>
<h4 id="226-ä¿®æ”¹å¯åŠ¨ç±»">2.2.6 ä¿®æ”¹å¯åŠ¨ç±»</h4>
<pre><code class="language-java">import org.mybatis.spring.annotation.MapperScan;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.WebApplicationType;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.builder.SpringApplicationBuilder;

//è®¾ç½®mapperæ¥å£çš„æ‰«æåŒ…
@MapperScan(&quot;com.ludangxin.mp.mapper&quot;) 
@SpringBootApplication
public class MyApplication {
    public static void main(String[] args) {
        SpringApplication.run(MyApplication.class, args);
    }
}
</code></pre>
<h4 id="227-ç¼–å†™æµ‹è¯•ç”¨ä¾‹">2.2.7 ç¼–å†™æµ‹è¯•ç”¨ä¾‹</h4>
<pre><code class="language-java">import com.ludangxin.mp.mapper.UserMapper;
import com.ludangxin.mp.pojo.User;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.junit4.SpringRunner;

import java.util.List;

@RunWith(SpringRunner.class)
@SpringBootTest
public class TestMybatisSpringBoot {

    @Autowired
    private UserMapper userMapper;

    @Test
    public void testSelect() {
        //æ ¹æ®idæŸ¥è¯¢æ•°æ®
        User user = userMapper.selectById(2L);
        System.out.println(user);
    }

}
</code></pre>
<p>æµ‹è¯•ç»“æœï¼š</p>
<pre><code class="language-shell">JDBC Connection [HikariProxyConnection@358849801 wrapping com.mysql.cj.jdbc.ConnectionImpl@4fba8eec] will not be managed by Spring
==&gt;  Preparing: SELECT ID,USER_NAME,NAME,AGE FROM sys_user WHERE ID=? 
==&gt; Parameters: 2(Long)
&lt;==    Columns: ID, USER_NAME, NAME, AGE
&lt;==        Row: 2, lisi, æå››, 20
&lt;==      Total: 1
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@39da5e49]
User(id=2, userName=lisi, name=æå››, age=20)
</code></pre>
<h2 id="3-é€šç”¨crud">3 é€šç”¨CRUD</h2>
<pre><code>åœ¨å…¥é—¨æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬çš„Mapperæ¥å£ç»§æ‰¿äº†BaseMapperï¼Œç„¶åå°±å¯ä»¥è¿›è¡Œåˆ°å„ç§å„æ ·çš„å•è¡¨æ“ä½œï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†è¯¦ç»†è®²è§£è¿™äº›æ“ä½œã€‚
</code></pre>
<figure data-type="image" tabindex="2"><img src="http://blog.ludangxin.club/post-images/1597929052973.png" alt="" loading="lazy"></figure>
<h3 id="31-æ’å…¥æ“ä½œ">3.1 æ’å…¥æ“ä½œ</h3>
<h4 id="311-insertæ–¹æ³•">3.1.1 insertæ–¹æ³•</h4>
<pre><code class="language-java">/**
 * æ’å…¥ä¸€æ¡è®°å½•
 * @param entity å®ä½“å¯¹è±¡
*/
int insert(T entity);
</code></pre>
<h4 id="312-æµ‹è¯•ç”¨ä¾‹">3.1.2 æµ‹è¯•ç”¨ä¾‹</h4>
<pre><code class="language-java">import com.ludangxin.mp.mapper.UserMapper;
import com.ludangxin.mp.pojo.User;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.junit4.SpringRunner;

import java.util.List;

@RunWith(SpringRunner.class)
@SpringBootTest
public class TestUserMapper {

    @Autowired
    private UserMapper userMapper;

    @Test
    public void testInsert(){
        User user = new User();
        user.setAge(301);
        user.setUserName(&quot;caocao&quot;);
        user.setName(&quot;æ›¹æ“&quot;);

        //è¿”å›çš„resultæ˜¯å—å½±å“çš„è¡Œæ•°ï¼Œå¹¶ä¸æ˜¯è‡ªå¢åçš„id
        int result = userMapper.insert(user); 
        System.out.println(&quot;result = &quot; + result); 

        //è‡ªå¢åçš„idä¼šå›å¡«åˆ°å¯¹è±¡ä¸­
        System.out.println(user.getId()); 
    }
}
</code></pre>
<p>æµ‹è¯•ç»“æœï¼š</p>
<pre><code class="language-shell">JDBC Connection [HikariProxyConnection@1240320816 wrapping com.mysql.cj.jdbc.ConnectionImpl@59303963] will not be managed by Spring
==&gt;  Preparing: INSERT INTO sys_user ( ID, USER_NAME, NAME, AGE ) VALUES ( ?, ?, ?, ? ) 
==&gt; Parameters: 1295736901034086401(Long), caocao(String), æ›¹æ“(String), 301(Integer)
&lt;==    Updates: 1
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@108e9837]
result = 1
1295736901034086401
</code></pre>
<h4 id="313-ä¸»é”®ç”Ÿæˆç­–ç•¥">3.1.3 ä¸»é”®ç”Ÿæˆç­–ç•¥</h4>
<pre><code>åœ¨åˆšæ‰çš„ä¾‹å­ä¸­ï¼Œæ•°æ®å·²ç»ä¿å­˜åˆ°äº†æ•°æ®åº“ï¼Œä½†æ˜¯idçš„å€¼ä¸æ˜¯æˆ‘ä»¬æœŸæœ›çš„è‡ªå¢é•¿ï¼Œè€Œæ˜¯MPç”Ÿæˆäº†idçš„å€¼å¹¶å†™å…¥åˆ°äº†æ•°æ®åº“ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡IdTypeç±»è‡ªå·±è®¾ç½®idçš„ç”Ÿæˆç­–ç•¥ã€‚
</code></pre>
<pre><code class="language-java">package com.baomidou.mybatisplus.annotation;
import lombok.Getter;

/**
 * ç”ŸæˆIDç±»å‹æšä¸¾ç±»
 */
@Getter
public enum IdType {
    /**
     * æ•°æ®åº“IDè‡ªå¢
     */
    AUTO(0),
    /**
     * è¯¥ç±»å‹ä¸ºæœªè®¾ç½®ä¸»é”®ç±»å‹ï¼Œè¿™æ˜¯é»˜è®¤å€¼
     */
    NONE(1),
    /**
     * ç”¨æˆ·è¾“å…¥ID
     * &lt;p&gt;è¯¥ç±»å‹å¯ä»¥é€šè¿‡è‡ªå·±æ³¨å†Œè‡ªåŠ¨å¡«å……æ’ä»¶è¿›è¡Œå¡«å……&lt;/p&gt;
     */
    INPUT(2),

    /* ä»¥ä¸‹3ç§ç±»å‹ã€åªæœ‰å½“æ’å…¥å¯¹è±¡IDä¸ºç©ºï¼Œæ‰è‡ªåŠ¨å¡«å……ã€‚ */
    /**
     * å…¨å±€å”¯ä¸€ID (idWorker)
     */
    ID_WORKER(3),
    /**
     * å…¨å±€å”¯ä¸€ID (UUID)
     */
    UUID(4),
    /**
     * å­—ç¬¦ä¸²å…¨å±€å”¯ä¸€ID (idWorkerçš„å­—ç¬¦ä¸²è¡¨ç¤º)
     */
    ID_WORKER_STR(5);

    private final int key;

    IdType(int key) {
        this.key = key;
    }
}

</code></pre>
<p>ä¿®æ”¹Userå¯¹è±¡ï¼Œè®¾ç½®idä¸ºè‡ªå¢é•¿ï¼š</p>
<pre><code class="language-java">import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
@AllArgsConstructor
@TableName(&quot;sys_user&quot;)
public class User {

    @TableId(type = IdType.AUTO) //æŒ‡å®šidä¸ºè‡ªå¢é•¿
    private Long id;
    ... ...
}
</code></pre>
<h3 id="32-æ›´æ–°æ“ä½œ">3.2 æ›´æ–°æ“ä½œ</h3>
<h4 id="321-updatebyidæ–¹æ³•">3.2.1 updateByIdæ–¹æ³•</h4>
<pre><code class="language-java">/**
 * æ ¹æ®IDä¿®æ”¹
 * @param entity å®ä½“å¯¹è±¡
 */
int updateById(@Param(Constants.ENTITY) T entity);
</code></pre>
<p>####ã€€3.2.2 æµ‹è¯•ç”¨ä¾‹</p>
<pre><code class="language-java">    @Test
    public void testUpdateById() {
        User user = new User();
        user.setId(5L); //ä¸»é”®
        user.setAge(21); //æ›´æ–°çš„å­—æ®µ

        //æ ¹æ®idæ›´æ–°ï¼Œæ›´æ–°ä¸ä¸ºnullçš„å­—æ®µ
        this.userMapper.updateById(user);
    }

}
</code></pre>
<p>æµ‹è¯•ç»“æœï¼š</p>
<pre><code class="language-shell">JDBC Connection [HikariProxyConnection@864078397 wrapping com.mysql.cj.jdbc.ConnectionImpl@23310248] will not be managed by Spring
==&gt;  Preparing: UPDATE sys_user SET AGE=? WHERE id=? 
==&gt; Parameters: 21(Integer), 5(Long)
&lt;==    Updates: 1
</code></pre>
<h3 id="33-åˆ é™¤æ“ä½œ">3.3 åˆ é™¤æ“ä½œ</h3>
<h4 id="331-deletebyid">3.3.1 deleteById</h4>
<pre><code class="language-java">/**
 * æ ¹æ® ID åˆ é™¤
 * @param id ä¸»é”®ID
 */
int deleteById(Serializable id);
</code></pre>
<h4 id="332-æµ‹è¯•ç”¨ä¾‹">3.3.2 æµ‹è¯•ç”¨ä¾‹</h4>
<pre><code class="language-java">	@Test
    public void testDeleteById() {
        //æ‰§è¡Œåˆ é™¤æ“ä½œ
        int result = this.userMapper.deleteById(6L);
        System.out.println(&quot;result = &quot; + result);
    }
}
</code></pre>
<p>æµ‹è¯•ç»“æœï¼š</p>
<pre><code class="language-shell">JDBC Connection [HikariProxyConnection@103068963 wrapping com.mysql.cj.jdbc.ConnectionImpl@50b46e24] will not be managed by Spring
==&gt;  Preparing: DELETE FROM sys_user WHERE id=? 
==&gt; Parameters: 5(Long)
&lt;==    Updates: 1
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@5934ca1e]
result = 1
</code></pre>
<h4 id="333-æ‰¹é‡åˆ é™¤">3.3.3 æ‰¹é‡åˆ é™¤</h4>
<pre><code class="language-java">	@Test 
    public void testDeleteByIds() { 
        //æ ¹æ®idé›†åˆæ‰¹é‡åˆ é™¤ 
        int result = this.userMapper.deleteBatchIds(Arrays.asList(1L,10L,20L));
        System.out.println(&quot;result = &quot; + result); 
    }
</code></pre>
<h3 id="34-æŸ¥è¯¢æ“ä½œ">3.4 æŸ¥è¯¢æ“ä½œ</h3>
<p>MPæä¾›äº†å¤šç§æŸ¥è¯¢æ“ä½œï¼ŒåŒ…æ‹¬æ ¹æ®idæŸ¥è¯¢ã€æ‰¹é‡æŸ¥è¯¢ã€æŸ¥è¯¢å•æ¡æ•°æ®ã€æŸ¥è¯¢åˆ—è¡¨ã€åˆ†é¡µæŸ¥è¯¢ç­‰æ“ä½œã€‚</p>
<h4 id="341-selectbyid">3.4.1 selectById</h4>
<pre><code class="language-java">/**
 * æ ¹æ®IDæŸ¥è¯¢
 * @param id ä¸»é”®ID
 */
T selectById(Serializable id);
</code></pre>
<h4 id="342-æµ‹è¯•ç”¨ä¾‹">3.4.2 æµ‹è¯•ç”¨ä¾‹</h4>
<pre><code class="language-java">    @Test
    public void testSelectById() {
        //æ ¹æ®idæŸ¥è¯¢æ•°æ®
        User user = this.userMapper.selectById(2L);
        System.out.println(&quot;result = &quot; + user);
    }
}
</code></pre>
<p>æµ‹è¯•ç»“æœï¼š</p>
<pre><code class="language-shell">JDBC Connection [HikariProxyConnection@1317052417 wrapping com.mysql.cj.jdbc.ConnectionImpl@624b523] will not be managed by Spring
==&gt;  Preparing: SELECT id,USER_NAME,NAME,AGE FROM sys_user WHERE id=? 
==&gt; Parameters: 2(Long)
&lt;==    Columns: id, USER_NAME, NAME, AGE
&lt;==        Row: 2, lisi, æå››, 20
&lt;==      Total: 1
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@1cbc5693]
result = User(id=2, userName=lisi, name=æå››, age=20)
</code></pre>
<h2 id="4-æ¡ä»¶æ„é€ å™¨">4 æ¡ä»¶æ„é€ å™¨</h2>
<pre><code>åœ¨å¢åˆ æ”¹æŸ¥ä¸­ï¼Œæœ€å¤æ‚çš„å°±æ˜¯å¸¦æœ‰å„ç§æ¡ä»¶çš„æ“ä½œã€‚åœ¨MPä¸­ï¼Œä¸“é—¨é’ˆå¯¹sqlæ¡ä»¶è¿›è¡Œäº†å°è£…ï¼Œæä¾›äº†å„ç§Wrapperæ¥å£åŠå…¶å®ç°ç±»ã€‚XxxWrapperç±»æä¾›äº†å„ç§æ–¹æ³•æ¥å°è£…sqlæ¡ä»¶ã€‚
</code></pre>
<figure data-type="image" tabindex="3"><img src="http://blog.ludangxin.club/post-images/1597929075718.png" alt="" loading="lazy"></figure>
<p>MPæä¾›äº†å„ç§æ–¹æ³•ç”¨æ¥æ”¯æŒå¸¦æœ‰æ¡ä»¶çš„æŸ¥è¯¢æ–¹æ³•ã€ä¿®æ”¹æ–¹æ³•å’Œåˆ é™¤æ–¹æ³•ï¼š</p>
<pre><code class="language-java">/**
æ ¹æ® entity æ¡ä»¶ï¼ŒæŸ¥è¯¢ä¸€æ¡è®°å½•
@param queryWrapper å®ä½“å¯¹è±¡å°è£…æ“ä½œç±»ï¼ˆå¯ä»¥ä¸ºnullï¼‰
*/
T selectOne(@Param(Constants.WRAPPER) Wrapper&lt;T&gt; queryWrapper);

/**
æ ¹æ® Wrapper æ¡ä»¶ï¼ŒæŸ¥è¯¢æ€»è®°å½•æ•°
@param queryWrapper å®ä½“å¯¹è±¡å°è£…æ“ä½œç±»ï¼ˆå¯ä»¥ä¸ºnullï¼‰
*/
Integer selectCount(@Param(Constants.WRAPPER) Wrapper&lt;T&gt; queryWrapper);

/**
æ ¹æ® entity æ¡ä»¶ï¼ŒæŸ¥è¯¢å…¨éƒ¨è®°å½•
@param queryWrapper å®ä½“å¯¹è±¡å°è£…æ“ä½œç±»ï¼ˆå¯ä»¥ä¸ºnullï¼‰
*/
List&lt;T&gt; selectList(@Param(Constants.WRAPPER) Wrapper&lt;T&gt; queryWrapper);
</code></pre>
<p>ä¸‹é¢æˆ‘ä»¬ä»¥æŸ¥è¯¢æ–¹æ³•ä¸ºä¾‹å­¦ä¹ æ¡ä»¶æ„é€ å™¨çš„å…·ä½“ç”¨æ³•ã€‚</p>
<h3 id="41-æ¯”è¾ƒæ“ä½œ">4.1 æ¯”è¾ƒæ“ä½œ</h3>
<ul>
<li>eq
<ul>
<li>ç­‰äº =</li>
</ul>
</li>
<li>ne
<ul>
<li>ä¸ç­‰äº &lt;&gt;</li>
</ul>
</li>
<li>gt
<ul>
<li>å¤§äº &gt;</li>
</ul>
</li>
<li>ge
<ul>
<li>å¤§äºç­‰äº &gt;=</li>
</ul>
</li>
<li>lt
<ul>
<li>å°äº &lt;</li>
</ul>
</li>
<li>le
<ul>
<li>å°äºç­‰äº &lt;=</li>
</ul>
</li>
<li>between
<ul>
<li>BETWEEN å€¼1 AND å€¼2</li>
</ul>
</li>
<li>notBetween
<ul>
<li>NOT BETWEEN å€¼1 AND å€¼2</li>
</ul>
</li>
<li>in
<ul>
<li>å­—æ®µ IN (value.get(0), value.get(1), ...)</li>
</ul>
</li>
<li>notIn
<ul>
<li>å­—æ®µ NOT IN (v0, v1, ...)</li>
</ul>
</li>
</ul>
<p>æµ‹è¯•ç”¨ä¾‹ï¼š</p>
<pre><code class="language-java">    @Test
    public void testEq() {
        QueryWrapper&lt;User&gt; wrapper = new QueryWrapper&lt;&gt;();

        //SELECT id,user_name,name,age FROM sys_user WHERE 
        // AND age &gt;= ? AND name IN (?,?,?)
        wrapper.ge(&quot;age&quot;, 20)
               .in(&quot;name&quot;, &quot;æå››&quot;, &quot;ç‹äº”&quot;, &quot;èµµå…­&quot;);

        List&lt;User&gt; users = this.userMapper.selectList(wrapper);
        for (User user : users) {
            System.out.println(user);
        }
    }
}
</code></pre>
<p>æµ‹è¯•ç»“æœ:</p>
<pre><code class="language-shell">JDBC Connection [HikariProxyConnection@525275084 wrapping com.mysql.cj.jdbc.ConnectionImpl@46c10083] will not be managed by Spring
==&gt;  Preparing: SELECT id,USER_NAME,NAME,AGE FROM sys_user WHERE age &gt;= ? AND name IN (?,?,?) 
==&gt; Parameters: 20(Integer), æå››(String), ç‹äº”(String), èµµå…­(String)
&lt;==    Columns: id, USER_NAME, NAME, AGE
&lt;==        Row: 2, lisi, æå››, 20
&lt;==        Row: 3, wangwu, ç‹äº”, 28
&lt;==        Row: 4, zhaoliu, èµµå…­, 21
&lt;==      Total: 3
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@61149fa5]
User(id=2, userName=lisi, name=æå››, age=20)
User(id=3, userName=wangwu, name=ç‹äº”, age=28)
User(id=4, userName=zhaoliu, name=èµµå…­, age=21)
</code></pre>
<h3 id="42-æ¨¡ç³ŠæŸ¥è¯¢">4.2 æ¨¡ç³ŠæŸ¥è¯¢</h3>
<ul>
<li>like
<ul>
<li>LIKE '%å€¼%'</li>
<li>ä¾‹: <code>like(&quot;name&quot;, &quot;ç‹&quot;)</code>---&gt;<code>name like '%ç‹%'</code></li>
</ul>
</li>
<li>notLike
<ul>
<li>NOT LIKE '%å€¼%'</li>
<li>ä¾‹: <code>notLike(&quot;name&quot;, &quot;ç‹&quot;)</code>---&gt;<code>name not like '%ç‹%'</code></li>
</ul>
</li>
<li>likeLeft
<ul>
<li>LIKE '%å€¼'</li>
<li>ä¾‹: <code>likeLeft(&quot;name&quot;, &quot;ç‹&quot;)</code>---&gt;<code>name like '%ç‹'</code></li>
</ul>
</li>
<li>likeRight
<ul>
<li>LIKE 'å€¼%'</li>
<li>ä¾‹: <code>likeRight(&quot;name&quot;, &quot;ç‹&quot;)</code>---&gt;<code>name like 'ç‹%'</code></li>
</ul>
</li>
</ul>
<p>æµ‹è¯•ç”¨ä¾‹ï¼š</p>
<pre><code class="language-java">    @Test
    public void testLike() {
        QueryWrapper&lt;User&gt; wrapper = new QueryWrapper&lt;&gt;();

        //SELECT id,user_name,name,age FROM sys_user WHERE name LIKE ?
        //Parameters: %æ›¹%(String)
        wrapper.like(&quot;name&quot;, &quot;æ›¹&quot;);

        List&lt;User&gt; users = this.userMapper.selectList(wrapper);
        for (User user : users) {
            System.out.println(user);
        }
    }
}
</code></pre>
<h3 id="43-æ’åº">4.3 æ’åº</h3>
<ul>
<li>orderBy
<ul>
<li>æ’åºï¼šORDER BY å­—æ®µ, ...</li>
<li>ä¾‹: <code>orderBy(true, true, &quot;id&quot;, &quot;name&quot;)</code>---&gt;<code>order by id ASC,name ASC</code></li>
</ul>
</li>
<li>orderByAsc
<ul>
<li>æ’åºï¼šORDER BY å­—æ®µ, ... ASC</li>
<li>ä¾‹: <code>orderByAsc(&quot;id&quot;, &quot;name&quot;)</code>---&gt;<code>order by id ASC,name ASC</code></li>
</ul>
</li>
<li>orderByDesc
<ul>
<li>æ’åºï¼šORDER BY å­—æ®µ, ... DESC</li>
<li>ä¾‹: <code>orderByDesc(&quot;id&quot;, &quot;name&quot;)</code>---&gt;<code>order by id DESC,name DESC</code></li>
</ul>
</li>
</ul>
<p>æµ‹è¯•ç”¨ä¾‹ï¼š</p>
<pre><code class="language-java">    @Test
    public void testOrderByAgeDesc() {
        QueryWrapper&lt;User&gt; wrapper = new QueryWrapper&lt;&gt;();

        //SELECT id,user_name,name,age FROM sys_user ORDER BY age DESC
        wrapper.orderByDesc(&quot;age&quot;);

        List&lt;User&gt; users = this.userMapper.selectList(wrapper);
        for (User user : users) {
            System.out.println(user);
        }
    }
}
</code></pre>
<h3 id="44-é€»è¾‘æŸ¥è¯¢">4.4 é€»è¾‘æŸ¥è¯¢</h3>
<ul>
<li>or
<ul>
<li>æ‹¼æ¥ OR</li>
<li>ä¸»åŠ¨è°ƒç”¨<code>or</code>è¡¨ç¤ºç´§æ¥ç€ä¸‹ä¸€ä¸ª<strong>æ–¹æ³•</strong>ä¸æ˜¯ç”¨<code>and</code>è¿æ¥!(ä¸è°ƒç”¨<code>or</code>åˆ™é»˜è®¤ä¸ºä½¿ç”¨<code>and</code>è¿æ¥)</li>
</ul>
</li>
<li>and
<ul>
<li>AND åµŒå¥—</li>
<li>ä¾‹: <code>and(i -&gt; i.eq(&quot;name&quot;, &quot;æç™½&quot;).ne(&quot;status&quot;, &quot;æ´»ç€&quot;))</code>---&gt;<code>and (name = 'æç™½' and status &lt;&gt; 'æ´»ç€')</code></li>
</ul>
</li>
</ul>
<p>æµ‹è¯•ç”¨ä¾‹ï¼š</p>
<pre><code class="language-java">	@Test
    public void testOr() {
        QueryWrapper&lt;User&gt; wrapper = new QueryWrapper&lt;&gt;();

        //SELECT id,user_name,name,age FROM sys_user WHERE 
        //name = ? OR age = ?
        wrapper.eq(&quot;name&quot;,&quot;æå››&quot;).or().eq(&quot;age&quot;, 24);

        List&lt;User&gt; users = this.userMapper.selectList(wrapper);
        for (User user : users) {
            System.out.println(user);
        }
    }
}
</code></pre>
<pre><code class="language-java">	@Test
    public void testAnd() {
        QueryWrapper&lt;User&gt; wrapper = new QueryWrapper&lt;&gt;();

        //SELECT id,USER_NAME,NAME,AGE FROM sys_user WHERE age = ? AND ( name = ? OR user_Name = ? ) 
        wrapper.eq(&quot;age&quot;, 20)
        .and(obj -&gt; obj.eq(&quot;name&quot;,&quot;æå››&quot;).or().eq(&quot;user_name&quot;, &quot;ç‹äº”&quot;));

        List&lt;User&gt; users = this.userMapper.selectList(wrapper);
        for (User user : users) {
            System.out.println(user);
        }
    }
</code></pre>
<h3 id="45-åˆ†é¡µæŸ¥è¯¢">4.5 åˆ†é¡µæŸ¥è¯¢</h3>
<p>selectPageæ–¹æ³•ï¼š</p>
<pre><code class="language-java">/**
 * æ ¹æ® entity æ¡ä»¶ï¼ŒæŸ¥è¯¢å…¨éƒ¨è®°å½•ï¼ˆå¹¶ç¿»é¡µï¼‰
 * @param page         åˆ†é¡µæŸ¥è¯¢æ¡ä»¶ï¼ˆå¯ä»¥ä¸º RowBounds.DEFAULTï¼‰
 * @param queryWrapper å®ä½“å¯¹è±¡å°è£…æ“ä½œç±»ï¼ˆå¯ä»¥ä¸º nullï¼‰
 */
IPage&lt;T&gt; selectPage(IPage&lt;T&gt; page, @Param(Constants.WRAPPER) Wrapper&lt;T&gt; queryWrapper);
</code></pre>
<p>é…ç½®åˆ†é¡µæ’ä»¶ï¼š</p>
<pre><code class="language-java">import com.baomidou.mybatisplus.extension.plugins.PaginationInterceptor;
import org.mybatis.spring.annotation.MapperScan;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class MybatisPlusConfig {

    /**
     * åˆ†é¡µæ’ä»¶
     */
    @Bean
    public PaginationInterceptor paginationInterceptor() {
        PaginationInterceptor paginationInterceptor = new PaginationInterceptor();
        // è®¾ç½®è¯·æ±‚çš„é¡µé¢å¤§äºæœ€å¤§é¡µåæ“ä½œï¼Œ trueè°ƒå›åˆ°é¦–é¡µï¼Œfalse ç»§ç»­è¯·æ±‚  é»˜è®¤false
        // paginationInterceptor.setOverflow(false);
        // è®¾ç½®æœ€å¤§å•é¡µé™åˆ¶æ•°é‡ï¼Œé»˜è®¤ 500 æ¡ï¼Œ-1 ä¸å—é™åˆ¶
        // paginationInterceptor.setLimit(500);
        // å¼€å¯ count çš„ join ä¼˜åŒ–,åªé’ˆå¯¹éƒ¨åˆ† left join
        paginationInterceptor.setCountSqlParser(new JsqlParserCountOptimize(true));
        return paginationInterceptor;
    }
}
</code></pre>
<p>æµ‹è¯•ç”¨ä¾‹ï¼š</p>
<pre><code class="language-java">    @Test
    public void testSelectPage() {
        QueryWrapper&lt;User&gt; wrapper = new QueryWrapper&lt;User&gt;();
        wrapper.gt(&quot;age&quot;, 20); //å¹´é¾„å¤§äº20å²

        Page&lt;User&gt; page = new Page&lt;&gt;(1,1);

        //æ ¹æ®æ¡ä»¶æŸ¥è¯¢æ•°æ®
        IPage&lt;User&gt; iPage = this.userMapper.selectPage(page, wrapper);
        System.out.println(&quot;æ•°æ®æ€»æ¡æ•°ï¼š&quot; + iPage.getTotal());
        System.out.println(&quot;æ€»é¡µæ•°ï¼š&quot; + iPage.getPages());

        List&lt;User&gt; users = iPage.getRecords();
        for (User user : users) {
            System.out.println(&quot;user = &quot; + user);
        }
    }
}
</code></pre>
<p>æµ‹è¯•ç»“æœ:</p>
<pre><code class="language-sh">JDBC Connection [HikariProxyConnection@1663774813 wrapping com.mysql.cj.jdbc.ConnectionImpl@44598ef7] will not be managed by Spring
JsqlParserCountOptimize sql=SELECT  id,USER_NAME,NAME,AGE  FROM sys_user WHERE age &gt; ?
==&gt;  Preparing: SELECT COUNT(1) FROM sys_user WHERE age &gt; ? 
==&gt; Parameters: 20(Integer)
&lt;==    Columns: COUNT(1)
&lt;==        Row: 3
==&gt;  Preparing: SELECT id,USER_NAME,NAME,AGE FROM sys_user WHERE age &gt; ? LIMIT ?,? 
==&gt; Parameters: 20(Integer), 0(Long), 1(Long)
&lt;==    Columns: id, USER_NAME, NAME, AGE
&lt;==        Row: 3, wangwu, ç‹äº”, 28
&lt;==      Total: 1
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@11d4d979]
æ•°æ®æ€»æ¡æ•°ï¼š3
æ€»é¡µæ•°ï¼š3
user = User(id=3, userName=wangwu, name=ç‹äº”, age=28)
</code></pre>
<h3 id="46-ä¿®æ”¹å’Œåˆ é™¤">4.6 ä¿®æ”¹å’Œåˆ é™¤</h3>
<pre><code>å‰é¢éƒ½æ˜¯ä»¥æŸ¥è¯¢ä¸ºä¾‹è®²è§£æ¡ä»¶æ„é€ å™¨ï¼Œé‚£ä¹ˆåœ¨è¿›è¡Œä¿®æ”¹å’Œåˆ é™¤æ“ä½œæ—¶ä¹Ÿå¯ä»¥å¸¦æ¡ä»¶ï¼Œå’ŒæŸ¥è¯¢åŸºæœ¬ä¸€æ ·ï¼Œè¿™é‡Œä¸å†è®²è§£ï¼Œåé¢ç”¨åˆ°æ—¶å†è¯´ã€‚
</code></pre>
<pre><code class="language-java">/**
æ ¹æ®wrapperå°è£…çš„æ¡ä»¶è¿›è¡Œæ›´æ–°æ“ä½œ
*/
int delete(@Param(&quot;ew&quot;) Wrapper&lt;T&gt; wrapper);

/**
æ ¹æ®wrapperå°è£…çš„æ¡ä»¶è¿›è¡Œåˆ é™¤æ“ä½œ
*/
int update(@Param(&quot;et&quot;) T entity, @Param(&quot;ew&quot;) Wrapper&lt;T&gt; updateWrapper);
</code></pre>
<h3 id="47-lambda">4.7  lambda</h3>
<p>â€‹	è·å– <code>LambdaWrapper</code><br>
â€‹	åœ¨<code>QueryWrapper</code>ä¸­æ˜¯è·å–<code>LambdaQueryWrapper</code><br>
â€‹	åœ¨<code>UpdateWrapper</code>ä¸­æ˜¯è·å–<code>LambdaUpdateWrapper</code></p>
<p>â€‹	<strong>å¼ºçƒˆä½¿ç”¨lambdaè¡¨è¾¾å¼æ„å»ºwrapperï¼Œæ— éœ€å†æ‹…å¿ƒå­—æ®µå†™é”™</strong></p>
<h4 id="471-æµ‹è¯•ç”¨ä¾‹">4.7.1 æµ‹è¯•ç”¨ä¾‹</h4>
<pre><code class="language-java">	@Test
    public void testLambdaSelect(){
        LambdaQueryWrapper lambdaQueryWrapper = new LambdaQueryWrapper&lt;User&gt;().eq(User::getUserName,&quot;zhangsan&quot;);
        //QueryWrapper&lt;User&gt; queryWrapper = new QueryWrapper&lt;&gt;();
        //queryWrapper.lambda().eq(User::getName, &quot;zhangsan&quot;);
        int result = this.userMapper.selectCount(lambdaQueryWrapper);
        System.out.println(&quot;result = &quot; + result);
    }
</code></pre>
<h2 id="5-mybatis-plusçš„serviceå°è£…">5 Mybatis-Plusçš„Serviceå°è£…</h2>
<pre><code>Mybatis-Plusä¸ºäº†å¼€å‘æ›´åŠ å¿«æ·ï¼Œå¯¹ä¸šåŠ¡å±‚ä¹Ÿè¿›è¡Œäº†å°è£…ï¼Œç›´æ¥æä¾›äº†ç›¸å…³çš„æ¥å£å’Œå®ç°ç±»ã€‚æˆ‘ä»¬åœ¨è¿›è¡Œä¸šåŠ¡å±‚å¼€å‘æ—¶ï¼Œå¯ä»¥ç»§æ‰¿å®ƒæä¾›çš„æ¥å£å’Œå®ç°ç±»ï¼Œä½¿å¾—ç¼–ç æ›´åŠ é«˜æ•ˆã€‚
</code></pre>
<ol>
<li>
<p>com.baomidou.mybatisplus.extension.service.IServiceæ¥å£</p>
<p>è¯¥æ¥å£æ˜¯ä¸€ä¸ªæ³›å‹æ¥å£ï¼Œé‡Œé¢æä¾›äº†å¾ˆå¤šæ–¹æ³•ï¼ŒåŒ…æ‹¬åŸºæœ¬çš„å¢åˆ æ”¹æŸ¥ã€‚<br>
<img src="http://blog.ludangxin.club/post-images/1597929094373.png" alt="" loading="lazy"></p>
</li>
<li>
<p>com.baomidou.mybatisplus.extension.service.impl.ServiceImplç±»</p>
<p>è¯¥ç±»å®ç°äº†ä¸Šé¢æ¥å£ä¸­çš„æ‰€æœ‰æ–¹æ³•ã€‚</p>
</li>
<li>
<p>æµ‹è¯•ç”¨ä¾‹</p>
<p>1ï¼‰è‡ªå®šä¹‰ä¸šåŠ¡å±‚æ¥å£ï¼Œç»§æ‰¿IServiceï¼š</p>
<pre><code class="language-java">public interface UserService extends IService&lt;User&gt; {

}
</code></pre>
<p>2ï¼‰è‡ªå®šä¹‰ä¸šåŠ¡å±‚å®ç°ç±»ï¼Œç»§æ‰¿ServiceImplï¼š</p>
<pre><code class="language-java">@Service
public class UserServiceImpl extends ServiceImpl&lt;UserMapper,User&gt; implements UserService {

}
</code></pre>
<p>3ï¼‰æµ‹è¯•ç±»ï¼š</p>
<pre><code class="language-java">@RunWith(SpringRunner.class)
@SpringBootTest
public class TestUserService {
    @Autowired
    private UserService userService;

    @Test
    public void testInsert() {
        User user = new User();
        user.setAge(301);
        user.setUserName(&quot;caocao1&quot;);
        user.setName(&quot;æ›¹æ“1&quot;);

        userService.save(user);

        //è·å–è‡ªå¢é•¿åçš„idå€¼, è‡ªå¢é•¿åçš„idå€¼ä¼šå›å¡«åˆ°userå¯¹è±¡ä¸­
        System.out.println(&quot;id =&gt; &quot; + user.getId());
    }

    @Test
    public void testSelectById() {
        User user = userService.getById(2);
        System.out.println(user);
    }

    @Test
    public void testUpdateById() {
        User user = new User();
        user.setId(1L); //æ¡ä»¶ï¼Œæ ¹æ®idæ›´æ–°
        user.setAge(19); //æ›´æ–°çš„å­—æ®µ

        userService.updateById(user);
    }

    @Test
    public void testDeleteById(){
        // æ ¹æ®idåˆ é™¤æ•°æ®
        userService.removeById(2L);
    }

}
</code></pre>
</li>
</ol>
<h2 id="6-oracle-ä¸»é”®-sequence">6 oracle ä¸»é”® Sequence</h2>
<p>åœ¨mysqlä¸­ï¼Œä¸»é”®å¾€å¾€æ˜¯è‡ªå¢é•¿çš„ï¼Œè¿™æ ·ä½¿ç”¨èµ·æ¥æ˜¯æ¯”è¾ƒæ–¹ä¾¿çš„ï¼Œå¦‚æœä½¿ç”¨çš„æ˜¯Oracleæ•°æ®åº“ï¼Œé‚£ä¹ˆå°±ä¸èƒ½ä½¿ç”¨è‡ªå¢é•¿äº†ï¼Œå°±å¾—ä½¿ç”¨Sequence åºåˆ—ç”Ÿæˆidå€¼äº†ã€‚</p>
<h3 id="61ä¿®æ”¹applicationproperties">6.1ä¿®æ”¹application.properties</h3>
<pre><code class="language-yaml">mybatis-plus:
  # è®¾ç½®Mapperæ¥å£æ‰€å¯¹åº”çš„XMLæ–‡ä»¶ä½ç½®ï¼Œå¦‚æœä½ åœ¨Mapperæ¥å£ä¸­æœ‰è‡ªå®šä¹‰æ–¹æ³•ï¼Œéœ€è¦è¿›è¡Œè¯¥é…ç½®
  mapper-locations: classpath*:mybatis/*.xml
  # è®¾ç½®åˆ«ååŒ…æ‰«æè·¯å¾„ï¼Œé€šè¿‡è¯¥å±æ€§å¯ä»¥ç»™åŒ…ä¸­çš„ç±»æ³¨å†Œåˆ«å
  type-aliases-package: com.ludangxin.mp.pojo
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
  # id ç”Ÿæˆç­–ç•¥
  global-config:
    db-config:
      id-type: input
</code></pre>
<h3 id="62-mybatisplusconfig-å¢åŠ åºåˆ—ç”Ÿæˆå™¨é…ç½®">6.2 MybatisPlusConfig å¢åŠ åºåˆ—ç”Ÿæˆå™¨é…ç½®</h3>
<pre><code class="language-java">/*** åºåˆ—ç”Ÿæˆå™¨ */ 
@Bean 
public OracleKeyGenerator oracleKeyGenerator(){ 
    return new OracleKeyGenerator();
}
</code></pre>
<h2 id="7-é€»è¾‘åˆ é™¤">7 é€»è¾‘åˆ é™¤</h2>
<p>å¼€å‘ç³»ç»Ÿæ—¶ï¼Œæœ‰æ—¶å€™åœ¨å®ç°åŠŸèƒ½æ—¶ï¼Œåˆ é™¤æ“ä½œéœ€è¦å®ç°é€»è¾‘åˆ é™¤ï¼Œæ‰€è°“é€»è¾‘åˆ é™¤å°±æ˜¯å°†æ•°æ®æ ‡è®°ä¸ºåˆ é™¤ï¼Œè€Œå¹¶éçœŸæ­£çš„ç‰©ç†åˆ é™¤ï¼ˆéDELETEæ“ä½œï¼‰ï¼ŒæŸ¥è¯¢æ—¶éœ€è¦æºå¸¦çŠ¶æ€æ¡ä»¶ï¼Œç¡®ä¿è¢«æ ‡è®°çš„æ•°æ®ä¸è¢«æŸ¥è¯¢åˆ°ã€‚è¿™æ ·åšçš„ç›®çš„å°±æ˜¯é¿å…æ•°æ®è¢«çœŸæ­£çš„åˆ é™¤ã€‚</p>
<h3 id="71-å¢åŠ å­—æ®µ">7.1 å¢åŠ å­—æ®µ</h3>
<pre><code class="language-sql">ALTER TABLE sys_user ADD COLUMN deleted int(1) NULL DEFAULT 0 COMMENT '1ä»£è¡¨åˆ é™¤ï¼Œ0ä»£è¡¨æœªåˆ é™¤';
</code></pre>
<h3 id="72-ä¿®æ”¹pojo">7.2 ä¿®æ”¹pojo</h3>
<pre><code class="language-java">@TableLogic 
private Integer deleted;
</code></pre>
<h3 id="73-ä¿®æ”¹applicationyml">7.3 ä¿®æ”¹application.yml</h3>
<pre><code class="language-yaml">mybatis-plus:
  # è®¾ç½®Mapperæ¥å£æ‰€å¯¹åº”çš„XMLæ–‡ä»¶ä½ç½®ï¼Œå¦‚æœä½ åœ¨Mapperæ¥å£ä¸­æœ‰è‡ªå®šä¹‰æ–¹æ³•ï¼Œéœ€è¦è¿›è¡Œè¯¥é…ç½®
  mapper-locations: classpath*:mybatis/*.xml
  # è®¾ç½®åˆ«ååŒ…æ‰«æè·¯å¾„ï¼Œé€šè¿‡è¯¥å±æ€§å¯ä»¥ç»™åŒ…ä¸­çš„ç±»æ³¨å†Œåˆ«å
  type-aliases-package: com.ludangxin.mp.pojo
  configuration:
    # æ§åˆ¶å°sqlæ‰“å°
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
  global-config:
    db-config:
      # é€»è¾‘åˆ é™¤å€¼ä¸º1
      logic-delete-value: 1
      # é€»è¾‘æœªåˆ é™¤å€¼ä¸º 0
      logic-not-delete-value: 0
</code></pre>
<h3 id="74-æµ‹è¯•ç”¨ä¾‹">7.4 æµ‹è¯•ç”¨ä¾‹</h3>
<pre><code class="language-java">@Test
    public void testDeleteById2() {
        this.userMapper.deleteById(3L);
    }
</code></pre>
<h3 id="75-æµ‹è¯•ç»“æœ">7.5 æµ‹è¯•ç»“æœ</h3>
<pre><code class="language-shell">JDBC Connection [HikariProxyConnection@2098830440 wrapping com.mysql.cj.jdbc.ConnectionImpl@63411512] will not be managed by Spring
==&gt;  Preparing: UPDATE sys_user SET deleted=1 WHERE id=? AND deleted=0 
==&gt; Parameters: 3(Long)
&lt;==    Updates: 1
</code></pre>
<h2 id="8-ä¹è§‚é”">8   ä¹è§‚é”</h2>
<h3 id="ä¸»è¦é€‚ç”¨åœºæ™¯">ä¸»è¦é€‚ç”¨åœºæ™¯</h3>
<p>æ„å›¾ï¼š</p>
<p>å½“è¦æ›´æ–°ä¸€æ¡è®°å½•çš„æ—¶å€™ï¼Œå¸Œæœ›è¿™æ¡è®°å½•æ²¡æœ‰è¢«åˆ«äººæ›´æ–°</p>
<p>ä¹è§‚é”å®ç°æ–¹å¼ï¼š</p>
<ul>
<li>å–å‡ºè®°å½•æ—¶ï¼Œè·å–å½“å‰version</li>
<li>æ›´æ–°æ—¶ï¼Œå¸¦ä¸Šè¿™ä¸ªversion</li>
<li>æ‰§è¡Œæ›´æ–°æ—¶ï¼Œ set version = newVersion where version = oldVersion</li>
<li>å¦‚æœversionä¸å¯¹ï¼Œå°±æ›´æ–°å¤±è´¥</li>
</ul>
<p><strong>ä¹è§‚é”é…ç½®éœ€è¦2æ­¥ è®°å¾—ä¸¤æ­¥</strong></p>
<h3 id="81-å¢åŠ å­—æ®µ">8.1 å¢åŠ å­—æ®µ</h3>
<pre><code class="language-sql">ALTER TABLE `sys_user` ADD COLUMN `version` int(10) NULL COMMENT 'ä¹è§‚é”' ;
</code></pre>
<h3 id="82-ä¿®æ”¹pojo">8.2  ä¿®æ”¹pojo</h3>
<pre><code class="language-java">@Version 
private Integer version;
</code></pre>
<h3 id="83-å¢åŠ ä¹è§‚é”é…ç½®">8.3 å¢åŠ ä¹è§‚é”é…ç½®</h3>
<pre><code class="language-java">/**
 * ä¹è§‚é”é…ç½®
 * @return
*/
@Bean
public OptimisticLockerInterceptor optimisticLockerInterceptor() {
    return new OptimisticLockerInterceptor();
}
</code></pre>
<h3 id="84-æµ‹è¯•ç”¨ä¾‹">8.4 æµ‹è¯•ç”¨ä¾‹</h3>
<pre><code class="language-java">@Test
    public void testUpdate(){
        User user = new User();
        user.setAge(30);
        user.setId(2L);
        //è·å–åˆ°versionä¸º1
        user.setVersion(1);        
        int result = this.userMapper.updateById(user);
        System.out.println(&quot;result = &quot; + result); 
    }
</code></pre>
<h3 id="85-æµ‹è¯•ç»“æœ">8.5 æµ‹è¯•ç»“æœ</h3>
<pre><code class="language-shell">JDBC Connection [HikariProxyConnection@2032547119 wrapping com.mysql.cj.jdbc.ConnectionImpl@5bc63e20] will not be managed by Spring
==&gt;  Preparing: UPDATE sys_user SET AGE=?, version=? WHERE id=? AND version=? AND deleted=0 
==&gt; Parameters: 30(Integer), 2(Integer), 2(Long), 1(Integer)
&lt;==    Updates: 0
</code></pre>
<p><strong>æ³¨:</strong> æ“ä½œè®°å½•æ•°ä¸º0è¯´æ˜å·²ç»æœ‰äººupdateäº†</p>
<h2 id="9-è‡ªåŠ¨å¡«å……åŠŸèƒ½">9 è‡ªåŠ¨å¡«å……åŠŸèƒ½</h2>
<p>ç¤ºä¾‹å·¥ç¨‹ï¼š</p>
<p>ğŸ‘‰ <a href="https://gitee.com/baomidou/mybatis-plus-samples/tree/master/mybatis-plus-sample-auto-fill-metainfo">mybatis-plus-sample-auto-fill-metainfo</a></p>
<h3 id="91-æ·»åŠ å­—æ®µ">9.1 æ·»åŠ å­—æ®µ</h3>
<pre><code class="language-sql">ALTER TABLE `sys_user` ADD COLUMN `create_by` VARCHAR(50) NULL COMMENT 'åˆ›å»ºäºº' ;
ALTER TABLE `sys_user` ADD COLUMN `update_by` VARCHAR(50) NULL COMMENT 'ä¿®æ”¹äºº' ;
</code></pre>
<h3 id="92-ä¿®æ”¹pojo">9.2 ä¿®æ”¹pojo</h3>
<pre><code class="language-java">@TableField(fill = FieldFill.INSERT)
private String createBy;
@TableField(fill = FieldFill.UPDATE)
private String updateBy;
</code></pre>
<h4 id="921-fieldfillæä¾›äº†å¤šç§æ¨¡å¼é€‰æ‹©">9.2.1 FieldFillæä¾›äº†å¤šç§æ¨¡å¼é€‰æ‹©</h4>
<pre><code class="language-java">public enum FieldFill {
    /**
     * é»˜è®¤ä¸å¤„ç†
     */
    DEFAULT,
    /**
     * æ’å…¥å¡«å……å­—æ®µ
     */
    INSERT,
    /**
     * æ›´æ–°å¡«å……å­—æ®µ
     */
    UPDATE,
    /**
     * æ’å…¥å’Œæ›´æ–°å¡«å……å­—æ®µ
     */
    INSERT_UPDATE
}
</code></pre>
<ul>
<li>è‡ªå®šä¹‰å®ç°ç±» MyMetaObjectHandler</li>
</ul>
<pre><code class="language-java">import com.baomidou.mybatisplus.core.handlers.MetaObjectHandler;
import lombok.extern.slf4j.Slf4j;
import org.apache.ibatis.reflection.MetaObject;
import org.springframework.stereotype.Component;

@Slf4j
@Component
public class MyMetaObjectHandler implements MetaObjectHandler {

    @Override
    public void insertFill(MetaObject metaObject) {
//            Object createTime = getFieldValByName(&quot;createTime&quot;, metaObject);
//            //å­—æ®µä¸ºç©ºï¼Œå¯ä»¥è¿›è¡Œå¡«å……
//            if (null == createTime) {
//                setFieldValByName(&quot;createTime&quot;, LocalDateTime.now(), metaObject);
//            }
            log.info(&quot;start insert fill ....&quot;);
            this.strictInsertFill(metaObject, &quot;createBy&quot;, String.class, this.getUserId());
        }

        @Override
        public void updateFill (MetaObject metaObject){
            log.info(&quot;start update fill ....&quot;);
            this.strictUpdateFill(metaObject, &quot;updateBy&quot;, String.class, this.getUserId());
        }

        private String getUserId() {
            return &quot;001&quot;;
        }
}
</code></pre>
<p>æ³¨æ„äº‹é¡¹ï¼š</p>
<ul>
<li>å¡«å……åŸç†æ˜¯ç›´æ¥ç»™<code>entity</code>çš„å±æ€§è®¾ç½®å€¼!!!</li>
<li>æ³¨è§£åˆ™æ˜¯æŒ‡å®šè¯¥å±æ€§åœ¨å¯¹åº”æƒ…å†µä¸‹å¿…æœ‰å€¼,å¦‚æœæ— å€¼åˆ™å…¥åº“ä¼šæ˜¯<code>null</code></li>
<li><code>MetaObjectHandler</code>æä¾›çš„é»˜è®¤æ–¹æ³•çš„ç­–ç•¥å‡ä¸º:å¦‚æœå±æ€§æœ‰å€¼åˆ™ä¸è¦†ç›–,å¦‚æœå¡«å……å€¼ä¸º<code>null</code>åˆ™ä¸å¡«å……</li>
<li>å­—æ®µå¿…é¡»å£°æ˜<code>TableField</code>æ³¨è§£,å±æ€§<code>fill</code>é€‰æ‹©å¯¹åº”ç­–ç•¥,è¯¥å£°æ˜å‘ŠçŸ¥<code>Mybatis-Plus</code>éœ€è¦é¢„ç•™æ³¨å…¥<code>SQL</code>å­—æ®µ</li>
<li>å¡«å……å¤„ç†å™¨<code>MyMetaObjectHandler</code>åœ¨ Spring Boot ä¸­éœ€è¦å£°æ˜<code>@Component</code>æˆ–<code>@Bean</code>æ³¨å…¥</li>
<li>è¦æƒ³æ ¹æ®æ³¨è§£<code>FieldFill.xxx</code>å’Œ<code>å­—æ®µå</code>ä»¥åŠ<code>å­—æ®µç±»å‹</code>æ¥åŒºåˆ†å¿…é¡»ä½¿ç”¨çˆ¶ç±»çš„<code>strictInsertFill</code>æˆ–è€…<code>strictUpdateFill</code>æ–¹æ³•</li>
<li>ä¸éœ€è¦æ ¹æ®ä»»ä½•æ¥åŒºåˆ†å¯ä»¥ä½¿ç”¨çˆ¶ç±»çš„<code>fillStrategy</code>æ–¹æ³•</li>
</ul>
<h3 id="93-æ‰§è¡Œæ–°å¢æ“ä½œæ—¥å¿—">9.3 æ‰§è¡Œæ–°å¢æ“ä½œæ—¥å¿—</h3>
<pre><code class="language-shell">JDBC Connection [HikariProxyConnection@897358809 wrapping com.mysql.cj.jdbc.ConnectionImpl@7aea704c] will not be managed by Spring
==&gt;  Preparing: INSERT INTO sys_user ( USER_NAME, NAME, AGE, create_by ) VALUES ( ?, ?, ?, ? ) 
==&gt; Parameters: caocao(String), æ›¹æ“(String), 301(Integer), 001(String)
&lt;==    Updates: 1
</code></pre>
<h2 id="10-å¤šæ•°æ®æºé…ç½®">10 å¤šæ•°æ®æºé…ç½®</h2>
<h3 id="ç®€ä»‹">ç®€ä»‹</h3>
<p>dynamic-datasource-spring-boot-starter æ˜¯ä¸€ä¸ªåŸºäºspringbootçš„å¿«é€Ÿé›†æˆå¤šæ•°æ®æºçš„å¯åŠ¨å™¨ã€‚</p>
<p>å…¶æ”¯æŒ <strong>Jdk 1.7+, SpringBoot 1.4.x 1.5.x 2.x.x</strong>ã€‚</p>
<p><strong>ç¤ºä¾‹é¡¹ç›®</strong> å¯å‚è€ƒé¡¹ç›®ä¸‹çš„samplesç›®å½•ã€‚</p>
<h3 id="ç‰¹æ€§">ç‰¹æ€§</h3>
<ol>
<li>æ”¯æŒ <strong>æ•°æ®æºåˆ†ç»„</strong> ï¼Œé€‚ç”¨äºå¤šç§åœºæ™¯ çº¯ç²¹å¤šåº“ è¯»å†™åˆ†ç¦» ä¸€ä¸»å¤šä» æ··åˆæ¨¡å¼ã€‚</li>
<li>æ”¯æŒæ•°æ®åº“æ•æ„Ÿé…ç½®ä¿¡æ¯ <strong>åŠ å¯†</strong> ENC()ã€‚</li>
<li>æ”¯æŒæ¯ä¸ªæ•°æ®åº“ç‹¬ç«‹åˆå§‹åŒ–è¡¨ç»“æ„schemaå’Œæ•°æ®åº“databaseã€‚</li>
<li>æ”¯æŒ <strong>è‡ªå®šä¹‰æ³¨è§£</strong> ï¼Œéœ€ç»§æ‰¿DS(3.2.0+)ã€‚</li>
<li>æä¾›å¯¹Druidï¼ŒMybatis-Plusï¼ŒP6syï¼ŒJndiçš„å¿«é€Ÿé›†æˆã€‚</li>
<li>ç®€åŒ–Druidå’ŒHikariCpé…ç½®ï¼Œæä¾› <strong>å…¨å±€å‚æ•°é…ç½®</strong> ã€‚é…ç½®ä¸€æ¬¡ï¼Œå…¨å±€é€šç”¨ã€‚</li>
<li>æä¾› <strong>è‡ªå®šä¹‰æ•°æ®æºæ¥æº</strong> æ–¹æ¡ˆã€‚</li>
<li>æä¾›é¡¹ç›®å¯åŠ¨å <strong>åŠ¨æ€å¢åŠ ç§»é™¤æ•°æ®æº</strong> æ–¹æ¡ˆã€‚</li>
<li>æä¾›Mybatisç¯å¢ƒä¸‹çš„ <strong>çº¯è¯»å†™åˆ†ç¦»</strong> æ–¹æ¡ˆã€‚</li>
<li>æä¾›ä½¿ç”¨ <strong>spelåŠ¨æ€å‚æ•°</strong> è§£ææ•°æ®æºæ–¹æ¡ˆã€‚å†…ç½®spelï¼Œsessionï¼Œheaderï¼Œæ”¯æŒè‡ªå®šä¹‰ã€‚</li>
<li>æ”¯æŒ <strong>å¤šå±‚æ•°æ®æºåµŒå¥—åˆ‡æ¢</strong> ã€‚ï¼ˆServiceA &gt;&gt;&gt; ServiceB &gt;&gt;&gt; ServiceCï¼‰ã€‚</li>
<li>æä¾›å¯¹shiroï¼Œsharding-jdbc,quartzç­‰ç¬¬ä¸‰æ–¹åº“é›†æˆçš„æ–¹æ¡ˆ,æ³¨æ„äº‹é¡¹å’Œç¤ºä¾‹ã€‚</li>
<li>æä¾› <strong>åŸºäºseataçš„åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆã€‚</strong> é™„ï¼šä¸æ”¯æŒåŸç”Ÿspringäº‹åŠ¡ã€‚</li>
</ol>
<h3 id="çº¦å®š">çº¦å®š</h3>
<ol>
<li>æœ¬æ¡†æ¶åªåš <strong>åˆ‡æ¢æ•°æ®æº</strong> è¿™ä»¶æ ¸å¿ƒçš„äº‹æƒ…ï¼Œå¹¶<strong>ä¸é™åˆ¶ä½ çš„å…·ä½“æ“ä½œ</strong>ï¼Œåˆ‡æ¢äº†æ•°æ®æºå¯ä»¥åšä»»ä½•CRUDã€‚</li>
<li>é…ç½®æ–‡ä»¶æ‰€æœ‰ä»¥ä¸‹åˆ’çº¿ <code>_</code> åˆ†å‰²çš„æ•°æ®æº <strong>é¦–éƒ¨</strong> å³ä¸ºç»„çš„åç§°ï¼Œç›¸åŒç»„åç§°çš„æ•°æ®æºä¼šæ”¾åœ¨ä¸€ä¸ªç»„ä¸‹ã€‚</li>
<li>åˆ‡æ¢æ•°æ®æºå¯ä»¥æ˜¯ç»„åï¼Œä¹Ÿå¯ä»¥æ˜¯å…·ä½“æ•°æ®æºåç§°ã€‚ç»„ååˆ™åˆ‡æ¢æ—¶é‡‡ç”¨è´Ÿè½½å‡è¡¡ç®—æ³•åˆ‡æ¢ã€‚</li>
<li>é»˜è®¤çš„æ•°æ®æºåç§°ä¸º <strong>master</strong> ï¼Œä½ å¯ä»¥é€šè¿‡ <code>spring.datasource.dynamic.primary</code> ä¿®æ”¹ã€‚</li>
<li>æ–¹æ³•ä¸Šçš„æ³¨è§£ä¼˜å…ˆäºç±»ä¸Šæ³¨è§£ã€‚</li>
<li>å¼ºçƒˆå»ºè®®åªåœ¨serviceçš„ç±»å’Œæ–¹æ³•ä¸Šæ·»åŠ æ³¨è§£ï¼Œä¸å»ºè®®åœ¨mapperä¸Šæ·»åŠ æ³¨è§£ã€‚</li>
</ol>
<h3 id="ä½¿ç”¨æ–¹æ³•">ä½¿ç”¨æ–¹æ³•</h3>
<ol>
<li>å¼•å…¥dynamic-datasource-spring-boot-starterã€‚</li>
</ol>
<pre><code class="language-xml">&lt;dependency&gt;
  &lt;groupId&gt;com.baomidou&lt;/groupId&gt;
  &lt;artifactId&gt;dynamic-datasource-spring-boot-starter&lt;/artifactId&gt;
  &lt;version&gt;${version}&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<ol>
<li>é…ç½®æ•°æ®æºã€‚</li>
</ol>
<pre><code class="language-yaml">spring:
  datasource:
    dynamic:
      primary: master #è®¾ç½®é»˜è®¤çš„æ•°æ®æºæˆ–è€…æ•°æ®æºç»„,é»˜è®¤å€¼å³ä¸ºmaster
      strict: false #è®¾ç½®ä¸¥æ ¼æ¨¡å¼,é»˜è®¤falseä¸å¯åŠ¨. å¯åŠ¨ååœ¨æœªåŒ¹é…åˆ°æŒ‡å®šæ•°æ®æºæ—¶å€™ä¼šæŠ›å‡ºå¼‚å¸¸,ä¸å¯åŠ¨åˆ™ä½¿ç”¨é»˜è®¤æ•°æ®æº.
      datasource:
        master:
          url: jdbc:mysql://xx.xx.xx.xx:3306/dynamic
          username: root
          password: 123456
          driver-class-name: com.mysql.jdbc.Driver # 3.2.0å¼€å§‹æ”¯æŒSPIå¯çœç•¥æ­¤é…ç½®
        slave_1:
          url: jdbc:mysql://xx.xx.xx.xx:3307/dynamic
          username: root
          password: 123456
          driver-class-name: com.mysql.jdbc.Driver
        slave_2:
          url: ENC(xxxxx) # å†…ç½®åŠ å¯†,ä½¿ç”¨è¯·æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£
          username: ENC(xxxxx)
          password: ENC(xxxxx)
          driver-class-name: com.mysql.jdbc.Driver
          schema: db/schema.sql # é…ç½®åˆ™ç”Ÿæ•ˆ,è‡ªåŠ¨åˆå§‹åŒ–è¡¨ç»“æ„
          data: db/data.sql # é…ç½®åˆ™ç”Ÿæ•ˆ,è‡ªåŠ¨åˆå§‹åŒ–æ•°æ®
          continue-on-error: true # é»˜è®¤true,åˆå§‹åŒ–å¤±è´¥æ˜¯å¦ç»§ç»­
          separator: &quot;;&quot; # sqlé»˜è®¤åˆ†å·åˆ†éš”ç¬¦
          
       #......çœç•¥
       #ä»¥ä¸Šä¼šé…ç½®ä¸€ä¸ªé»˜è®¤åº“masterï¼Œä¸€ä¸ªç»„slaveä¸‹æœ‰ä¸¤ä¸ªå­åº“slave_1,slave_2
# å¤šä¸»å¤šä»                      çº¯ç²¹å¤šåº“ï¼ˆè®°å¾—è®¾ç½®primaryï¼‰                   æ··åˆé…ç½®
spring:                               spring:                               spring:
  datasource:                           datasource:                           datasource:
    dynamic:                              dynamic:                              dynamic:
      datasource:                           datasource:                           datasource:
        master_1:                             mysql:                                master:
        master_2:                             oracle:                               slave_1:
        slave_1:                              sqlserver:                            slave_2:
        slave_2:                              postgresql:                           oracle_1:
        slave_3:                              h2:                                   oracle_2:
</code></pre>
<ol>
<li>ä½¿ç”¨ <strong>@DS</strong> åˆ‡æ¢æ•°æ®æºã€‚</li>
</ol>
<p><strong>@DS</strong> å¯ä»¥æ³¨è§£åœ¨æ–¹æ³•ä¸Šå’Œç±»ä¸Šï¼Œ<strong>åŒæ—¶å­˜åœ¨æ–¹æ³•æ³¨è§£ä¼˜å…ˆäºç±»ä¸Šæ³¨è§£</strong>ã€‚</p>
<p>å¼ºçƒˆå»ºè®®åªæ³¨è§£åœ¨serviceå®ç°ä¸Šã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:center">æ³¨è§£</th>
<th style="text-align:center">ç»“æœ</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">æ²¡æœ‰@DS</td>
<td style="text-align:center">é»˜è®¤æ•°æ®æº</td>
</tr>
<tr>
<td style="text-align:center">@DS(&quot;dsName&quot;)</td>
<td style="text-align:center">dsNameå¯ä»¥ä¸ºç»„åä¹Ÿå¯ä»¥ä¸ºå…·ä½“æŸä¸ªåº“çš„åç§°</td>
</tr>
</tbody>
</table>
<pre><code class="language-java">@Service
@DS(&quot;slave&quot;)
public class UserServiceImpl implements UserService {

  @Autowired
  private JdbcTemplate jdbcTemplate;

  public List selectAll() {
    return  jdbcTemplate.queryForList(&quot;select * from user&quot;);
  }
  
  @Override
  @DS(&quot;slave_1&quot;)
  public List selectByCondition() {
    return  jdbcTemplate.queryForList(&quot;select * from user where age &gt;10&quot;);
  }
}
</code></pre>
<hr>
<p><a href="https://baomidou.com/guide/dynamic-datasource.html#%E8%B5%B6%E7%B4%A7%E9%9B%86%E6%88%90%E4%BD%93%E9%AA%8C%E4%B8%80%E4%B8%8B%E5%90%A7%EF%BC%81-%E5%A6%82%E6%9E%9C%E9%9C%80%E8%A6%81%E6%9B%B4%E5%A4%9A%E5%8A%9F%E8%83%BD%E8%AF%B7%E7%82%B9%E5%87%BB%E4%B8%8B%E9%9D%A2%E9%93%BE%E6%8E%A5%E6%9F%A5%E7%9C%8B%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3%EF%BC%81">#</a>èµ¶ç´§é›†æˆä½“éªŒä¸€ä¸‹å§ï¼ å¦‚æœéœ€è¦æ›´å¤šåŠŸèƒ½è¯·ç‚¹å‡»ä¸‹é¢é“¾æ¥æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£ï¼</p>
<hr>
<p><a href="https://github.com/baomidou/dynamic-datasource-spring-boot-starter/wiki/FAQ">å¸¸è§é—®é¢˜è¯·ç‚¹æˆ‘</a> <a href="https://github.com/baomidou/dynamic-datasource-spring-boot-starter/wiki">åˆ†å¸ƒå¼äº‹åŠ¡ï¼ŒåŠ å¯†,Druidé›†æˆï¼ŒMybatisPlusé›†æˆï¼ŒåŠ¨æ€å¢å‡æ•°æ®æºï¼Œè‡ªå®šä¹‰åˆ‡æ¢è§„åˆ™,çº¯è¯»å†™åˆ†ç¦»æ’ä»¶ç­‰ç­‰æ›´å¤šæ›´ç»†è‡´çš„æ–‡æ¡£åœ¨è¿™é‡Œ</a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[SpringBoot  é›†æˆ ä»»åŠ¡è°ƒåº¦]]></title>
        <id>http://blog.ludangxin.club/post/springboot-ji-cheng-ren-wu-diao-du/</id>
        <link href="http://blog.ludangxin.club/post/springboot-ji-cheng-ren-wu-diao-du/">
        </link>
        <updated>2020-06-07T11:29:38.000Z</updated>
        <content type="html"><![CDATA[<h1 id="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ä»»åŠ¡è°ƒåº¦">ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ä»»åŠ¡è°ƒåº¦</h1>
<p>å®šæ—¶ä»»åŠ¡çš„åœºæ™¯å¯ä»¥è¯´éå¸¸å¹¿æ³›ï¼Œæ¯”å¦‚æŸäº›è§†é¢‘ç½‘ç«™ï¼Œè´­ä¹°ä¼šå‘˜åï¼Œæ¯å¤©ä¼šç»™ä¼šå‘˜é€æˆé•¿å€¼ï¼Œæ¯æœˆä¼šç»™ä¼šå‘˜é€ä¸€äº›ç”µå½±åˆ¸ï¼›æ¯”å¦‚åœ¨ä¿è¯æœ€ç»ˆä¸€è‡´æ€§çš„åœºæ™¯ä¸­ï¼Œå¾€å¾€åˆ©ç”¨å®šæ—¶ä»»åŠ¡è°ƒåº¦è¿›è¡Œä¸€äº›æ¯”å¯¹å·¥ä½œï¼›æ¯”å¦‚ä¸€äº›å®šæ—¶éœ€è¦ç”Ÿæˆçš„æŠ¥è¡¨ã€é‚®ä»¶ï¼›æ¯”å¦‚ä¸€äº›éœ€è¦å®šæ—¶æ¸…ç†æ•°æ®çš„ä»»åŠ¡ç­‰ã€‚</p>
<h1 id="scheduled">@Scheduled</h1>
<p><a href="https://spring.io/guides/gs/scheduling-tasks/">springboot scheduling å®˜æ–¹æ•™ç¨‹</a></p>
<h2 id="å¿«é€Ÿä¸Šæ‰‹">å¿«é€Ÿä¸Šæ‰‹</h2>
<p><strong>éœ€æ±‚:</strong> æ¯ä¸ªäº”ç§’æ‰“å°ä¸€æ¬¡æ—¥å¿—</p>
<h2 id="å¼•å…¥æ‰€éœ€ä¾èµ–">å¼•å…¥æ‰€éœ€ä¾èµ–</h2>
<p><strong>å› spring-boot-starterä¸­é»˜è®¤å¼•å…¥äº†schedulerä¾èµ–,æ‰€ä»¥ä¸ç”¨é¢å¤–æ·»åŠ </strong></p>
<pre><code class="language-xml">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;!-- lombok å·¥å…·ç±» --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
    &lt;artifactId&gt;lombok&lt;/artifactId&gt;
    &lt;optional&gt;true&lt;/optional&gt;
&lt;/dependency&gt;
</code></pre>
<h2 id="ä¿®æ”¹å¯åŠ¨ç±»">ä¿®æ”¹å¯åŠ¨ç±»</h2>
<pre><code class="language-java">import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.scheduling.annotation.EnableScheduling;
// å¼€å¯Scheduler
@EnableScheduling
@SpringBootApplication
public class SpringbootApplication {

    public static void main(String[] args) {
        SpringApplication.run(SpringbootApplication.class, args);
    }

}
</code></pre>
<h2 id="åˆ›å»ºæ—¥å¿—æ‰“å°ä»»åŠ¡">åˆ›å»ºæ—¥å¿—æ‰“å°ä»»åŠ¡</h2>
<pre><code class="language-java">import lombok.extern.slf4j.Slf4j;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;
import java.text.SimpleDateFormat;
import java.util.Date;

@Slf4j
@Component
public class PrintTask {

    private static final SimpleDateFormat DATE_FORMAT = new SimpleDateFormat(&quot;HH:mm:ss&quot;);

    /**
     * æ¯éš”5ç§’æ‰“å°ä¸€æ¬¡æ—¥å¿—
     */
    @Scheduled(fixedRate = 5000)
    public void reportCurrentTime() {
        log.info(&quot;The time is now {}&quot;, DATE_FORMAT.format(new Date()));
    }

}
</code></pre>
<h2 id="è¾“å‡ºç»“æœ">è¾“å‡ºç»“æœ</h2>
<pre><code class="language-verilog">2020-06-04 21:33:06.130  INFO 1244 --- [   scheduling-1] com.ldx.springboot.scheduler.PrintTask   : The time is now 21:33:06
2020-06-04 21:33:11.131  INFO 1244 --- [   scheduling-1] com.ldx.springboot.scheduler.PrintTask   : The time is now 21:33:11
2020-06-04 21:33:16.133  INFO 1244 --- [   scheduling-1] com.ldx.springboot.scheduler.PrintTask   : The time is now 21:33:16
2020-06-04 21:33:21.135  INFO 1244 --- [   scheduling-1] com.ldx.springboot.scheduler.PrintTask   : The time is now 21:33:21
2020-06-04 21:33:26.137  INFO 1244 --- [   scheduling-1] com.ldx.springboot.scheduler.PrintTask   : The time is now 21:33:26
2020-06-04 21:33:31.139  INFO 1244 --- [   scheduling-1] com.ldx.springboot.scheduler.PrintTask   : The time is now 21:33:31
2020-06-04 21:33:36.140  INFO 1244 --- [   scheduling-1] com.ldx.springboot.scheduler.PrintTask   : The time is now 21:33:36
2020-06-04 21:33:41.142  INFO 1244 --- [   scheduling-1] com.ldx.springboot.scheduler.PrintTask   : The time is now 21:33:41
</code></pre>
<h2 id="é…ç½®taskschedulerçº¿ç¨‹æ± ">é…ç½®TaskSchedulerçº¿ç¨‹æ± </h2>
<p>åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬ä¸€ä¸ªç³»ç»Ÿå¯èƒ½ä¼šå®šä¹‰å¤šä¸ªå®šæ—¶ä»»åŠ¡ã€‚é‚£ä¹ˆå¤šä¸ªå®šæ—¶ä»»åŠ¡ä¹‹é—´æ˜¯å¯ä»¥ç›¸äº’ç‹¬ç«‹ä¸”å¯ä»¥å¹¶è¡Œæ‰§è¡Œçš„ã€‚</p>
<p>é€šè¿‡æŸ¥çœ‹org.springframework.scheduling.config.ScheduledTaskRegistraræºä»£ç ï¼Œå‘ç°springé»˜è®¤ä¼šåˆ›å»ºä¸€ä¸ªå•çº¿ç¨‹æ± ã€‚è¿™æ ·å¯¹äºæˆ‘ä»¬çš„å¤šä»»åŠ¡è°ƒåº¦å¯èƒ½ä¼šæ˜¯è‡´å‘½çš„ï¼Œå½“å¤šä¸ªä»»åŠ¡å¹¶å‘ï¼ˆæˆ–éœ€è¦åœ¨åŒä¸€æ—¶é—´ï¼‰æ‰§è¡Œæ—¶ï¼Œä»»åŠ¡è°ƒåº¦å™¨å°±ä¼šå‡ºç°æ—¶é—´æ¼‚ç§»ï¼Œä»»åŠ¡æ‰§è¡Œæ—¶é—´å°†ä¸ç¡®å®šã€‚</p>
<h3 id="æºç ">æºç </h3>
<pre><code class="language-java">protected void scheduleTasks() {
    if (this.taskScheduler == null) {
        this.localExecutor = Executors.newSingleThreadScheduledExecutor();
        this.taskScheduler = new ConcurrentTaskScheduler(this.localExecutor);
    }
    //çœç•¥...
}
</code></pre>
<h3 id="è‡ªå®šä¹‰çº¿ç¨‹æ± ">è‡ªå®šä¹‰çº¿ç¨‹æ± </h3>
<pre><code class="language-java">import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.scheduling.TaskScheduler;
import org.springframework.scheduling.concurrent.ThreadPoolTaskScheduler;

@Configuration
public class ScheduleConfig {

    @Bean
    public TaskScheduler taskScheduler() {
        //org.springframework.scheduling.concurrent.ThreadPoolTaskScheduler
        ThreadPoolTaskScheduler threadPoolTaskScheduler = new ThreadPoolTaskScheduler();
        threadPoolTaskScheduler.setPoolSize(20);
        return threadPoolTaskScheduler;
    }
}
</code></pre>
<h2 id="æ³¨è§£å‚æ•°ä»‹ç»">æ³¨è§£å‚æ•°ä»‹ç»</h2>
<table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>fixedRate</td>
<td>è¯¥å±æ€§çš„å«ä¹‰æ˜¯ä¸Šä¸€ä¸ªè°ƒç”¨å¼€å§‹åå†æ¬¡è°ƒç”¨çš„å»¶æ—¶ï¼ˆä¸ç”¨ç­‰å¾…ä¸Šä¸€æ¬¡è°ƒç”¨å®Œæˆï¼‰ï¼Œè¿™æ ·å°±ä¼šå­˜åœ¨é‡å¤æ‰§è¡Œçš„é—®é¢˜ï¼Œæ‰€ä»¥ä¸æ˜¯å»ºè®®ä½¿ç”¨ï¼Œä½†æ•°æ®é‡å¦‚æœä¸å¤§æ—¶åœ¨é…ç½®çš„é—´éš”æ—¶é—´å†…å¯ä»¥æ‰§è¡Œå®Œä¹Ÿæ˜¯å¯ä»¥ä½¿ç”¨çš„ã€‚</td>
</tr>
<tr>
<td>fixedDelay</td>
<td>è¯¥å±æ€§çš„åŠŸæ•ˆä¸ä¸Šé¢çš„fixedRateåˆ™æ˜¯ç›¸åçš„ï¼Œé…ç½®äº†è¯¥å±æ€§åä¼šç­‰åˆ°æ–¹æ³•æ‰§è¡Œå®Œæˆåå»¶è¿Ÿé…ç½®çš„æ—¶é—´å†æ¬¡æ‰§è¡Œè¯¥æ–¹æ³•.</td>
</tr>
<tr>
<td>initialDelay</td>
<td>è¯¥å±æ€§è·Ÿä¸Šé¢çš„fixedDelayã€fixedRateæœ‰ç€å¯†åˆ‡çš„å…³ç³»ï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿè¯¥å±æ€§çš„ä½œç”¨æ˜¯ç¬¬ä¸€æ¬¡æ‰§è¡Œå»¶è¿Ÿæ—¶é—´ï¼Œåªæ˜¯åšå»¶è¿Ÿçš„è®¾å®šï¼Œå¹¶ä¸ä¼šæ§åˆ¶å…¶ä»–é€»è¾‘ï¼Œæ‰€ä»¥è¦é…åˆfixedDelayæˆ–è€…fixedRateæ¥ä½¿ç”¨</td>
</tr>
<tr>
<td>cron</td>
<td>cronå°±ä¸åšèµ˜è¿°äº†ã€‚<a href="https://www.cnblogs.com/yanghj010/p/10875151.html">ä¼ é€é—¨</a></td>
</tr>
<tr>
<td>zone</td>
<td>æŒ‡å®šè§£æcronè¡¨è¾¾å¼çš„æ—¶åŒº</td>
</tr>
</tbody>
</table>
<h2 id="ç‰¹ç‚¹">ç‰¹ç‚¹</h2>
<p>ä¼˜ç‚¹: è¶³å¤Ÿç®€å• , æ˜“ä¸Šæ‰‹</p>
<p>ç¼ºç‚¹:</p>
<ol>
<li>
<p>æ— æ³•å®ç°å¤æ‚çš„ä¸šåŠ¡åœºæ™¯</p>
</li>
<li>
<p>å¦‚æœæœåŠ¡å™¨å®•æœº , é‚£ä¹ˆå†…å­˜ä¸­çš„å®šæ—¶ä»»åŠ¡å°±ä¼šé‡Šæ”¾,æ— æ³•æ”¯æŒ<code>misfire</code></p>
</li>
<li>
<p>åˆ†å¸ƒå¼éƒ¨ç½²ä¼šå‡ºç°é‡å¤è°ƒç”¨çš„é—®é¢˜ç­‰...</p>
</li>
</ol>
<h1 id="quartz">Quartz</h1>
<p>Quartzæ˜¯çº¯Javaå®ç°ï¼Œè€Œä¸”ä½œä¸ºSpringçš„é»˜è®¤è°ƒåº¦æ¡†æ¶ï¼Œç”±äºQuartzçš„å¼ºå¤§çš„è°ƒåº¦åŠŸèƒ½ã€çµæ´»çš„ä½¿ç”¨æ–¹å¼ã€è¿˜å…·æœ‰åˆ†å¸ƒå¼é›†ç¾¤èƒ½åŠ›ï¼Œå¯ä»¥è¯´Quartzå‡ºé©¬ï¼Œå¯ä»¥æå®šä¸€åˆ‡å®šæ—¶ä»»åŠ¡è°ƒåº¦ï¼</p>
<figure data-type="image" tabindex="1"><img src="http://blog.ludangxin.club/post-images/1591529517702.jpg" alt="" loading="lazy"></figure>
<h2 id="quartz-ä¸­ä¸»è¦å¯¹è±¡">Quartz  ä¸­ä¸»è¦å¯¹è±¡</h2>
<ul>
<li>Schedulerï¼šè°ƒåº¦ä»»åŠ¡çš„ä¸»è¦API</li>
<li>ScheduleBuilderï¼šç”¨äºæ„å»ºSchedulerï¼Œä¾‹å¦‚å…¶ç®€å•å®ç°ç±»SimpleScheduleBuilder</li>
<li>Jobï¼šè°ƒåº¦ä»»åŠ¡æ‰§è¡Œçš„æ¥å£ï¼Œä¹Ÿå³å®šæ—¶ä»»åŠ¡æ‰§è¡Œçš„æ–¹æ³•</li>
<li>JobDetailï¼šå®šæ—¶ä»»åŠ¡ä½œä¸šçš„å®ä¾‹</li>
<li>JobBuilderï¼šå…³è”å…·ä½“çš„Jobï¼Œç”¨äºæ„å»ºJobDetail</li>
<li>Triggerï¼šå®šä¹‰è°ƒåº¦æ‰§è¡Œè®¡åˆ’çš„ç»„ä»¶ï¼Œå³å®šæ—¶æ‰§è¡Œ</li>
<li>TriggerBuilderï¼šæ„å»ºTrigger</li>
</ul>
<h2 id="å¿«é€Ÿä¸Šæ‰‹-2">å¿«é€Ÿä¸Šæ‰‹</h2>
<h3 id="æ·»åŠ æ‰€éœ€ä¾èµ–">æ·»åŠ æ‰€éœ€ä¾èµ–</h3>
<pre><code class="language-xml">	    &lt;!-- spring boot --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;!-- quartz ä»»åŠ¡è°ƒåº¦ --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-quartz&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;!-- mysqlä¾èµ– --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;mysql&lt;/groupId&gt;
            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
            &lt;version&gt;5.1.47&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;!-- mybatis --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;
            &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;
            &lt;version&gt;2.1.1&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;!-- lombok å·¥å…·ç±» --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
            &lt;artifactId&gt;lombok&lt;/artifactId&gt;
            &lt;optional&gt;true&lt;/optional&gt;
        &lt;/dependency&gt;
</code></pre>
<h3 id="é…ç½®applicationyml">é…ç½®application.yml</h3>
<pre><code class="language-yaml">spring:
  datasource:
    type: com.zaxxer.hikari.HikariDataSource
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql://localhost:3306/test?useUnicode=true&amp;zeroDateTimeBehavior=convertToNull&amp;autoReconnect=true&amp;characterEncoding=utf-8
    username: root
    password: root
    hikari:
      minimum-idle: 5
      idle-timeout: 600000
      maximum-pool-size: 10
      auto-commit: true
      pool-name: MyHikariCP
      max-lifetime: 1800000
      connection-timeout: 30000
      connection-test-query: SELECT 1
  quartz:
    # ç›¸å…³å±æ€§é…ç½®
    properties:
      org:
        quartz:
          scheduler:
            # å®ä¾‹åç§°
            instanceName: TestScheduler
            # å®ä¾‹id
            instanceId: AUTO
          jobStore:
            class: org.quartz.impl.jdbcjobstore.JobStoreTX
            driverDelegateClass: org.quartz.impl.jdbcjobstore.StdJDBCDelegate
            tablePrefix: QRTZ_
            useProperties: false
            # å¼€å¯é›†ç¾¤
            isClustered: true
            clusterCheckinInterval: 15000
          threadPool:
            class: org.quartz.simpl.SimpleThreadPool
            threadCount: 20
            threadPriority: 8
            threadsInheritContextClassLoaderOfInitializingThread: true
    # åˆå§‹åŒ–åæ˜¯å¦è‡ªåŠ¨å¯åŠ¨è°ƒåº¦ç¨‹åº
    auto-startup: true
    # æ•°æ®åº“æ–¹å¼ memory å†…å­˜ ; jdbc æ•°æ®åº“
    job-store-type: jdbc
    # åˆå§‹åŒ–è¡¨ç»“æ„
    jdbc:
      # é¡¹ç›®å¯åŠ¨æ—¶åˆå§‹åŒ–æ•°æ®åº“  never ä»ä¸ ; always æ¯æ¬¡å¯åŠ¨éƒ½åˆå§‹åŒ–
      initialize-schema: always
    # æ˜¯å¦è¦†ç›–å·²ç»æŒä¹…åŒ–çš„job
    overwrite-existing-jobs: true
</code></pre>
<p><a href="https://github.com/quartz-scheduler/quartz/blob/master/docs/configuration.adoc">quartzå®˜æ–¹é…ç½®æ–‡æ¡£</a></p>
<h3 id="åˆ›å»ºjob">åˆ›å»ºJob</h3>
<pre><code class="language-java">import lombok.extern.slf4j.Slf4j;
import org.quartz.JobExecutionContext;
import org.quartz.JobExecutionException;
import org.springframework.scheduling.quartz.QuartzJobBean;
import java.text.SimpleDateFormat;
import java.util.Date;

@Slf4j
public class LogJob extends QuartzJobBean {

    private static final SimpleDateFormat DATE_FORMAT = new SimpleDateFormat(&quot;HH:mm:ss&quot;);

    @Override
    protected void executeInternal(JobExecutionContext jobExecutionContext) throws JobExecutionException {
        log.info(&quot;The time is now {}&quot;, DATE_FORMAT.format(new Date()));
    }
}
</code></pre>
<h3 id="æ³¨å†Œjobä¿¡æ¯">æ³¨å†ŒJobä¿¡æ¯</h3>
<pre><code class="language-java">import org.quartz.*;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class QuartzConfig {

    @Bean
    public JobDetail logJobDetail(){
        return JobBuilder.newJob(LogJob.class).storeDurably().build();
    }

    @Bean
    public Trigger logTrigger(){
        SimpleScheduleBuilder scheduleBuilder = SimpleScheduleBuilder.simpleSchedule()
                //æ¯ä¸€ç§’æ‰§è¡Œä¸€æ¬¡
                .withIntervalInSeconds(1)
                //æ°¸ä¹…é‡å¤ï¼Œä¸€ç›´æ‰§è¡Œä¸‹å»
                .repeatForever();
        return TriggerBuilder.newTrigger()
                .forJob(logJobDetail())
                .withSchedule(scheduleBuilder)
                .build();
    }

}
</code></pre>
<h3 id="å¯åŠ¨é¡¹ç›®æµ‹è¯•">å¯åŠ¨é¡¹ç›®,æµ‹è¯•</h3>
<pre><code class="language-verilog">2020-06-06 17:04:50.904  INFO 9920 --- [eduler_Worker-1] com.ldx.springboot.quartz.LogJob         : The time is now 17:04:50
2020-06-06 17:04:50.914  INFO 9920 --- [eduler_Worker-2] com.ldx.springboot.quartz.LogJob         : The time is now 17:04:50
2020-06-06 17:04:51.791  INFO 9920 --- [eduler_Worker-3] com.ldx.springboot.quartz.LogJob         : The time is now 17:04:51
2020-06-06 17:04:52.791  INFO 9920 --- [eduler_Worker-4] com.ldx.springboot.quartz.LogJob         : The time is now 17:04:52
2020-06-06 17:04:53.792  INFO 9920 --- [eduler_Worker-5] com.ldx.springboot.quartz.LogJob         : The time is now 17:04:53
2020-06-06 17:04:54.791  INFO 9920 --- [eduler_Worker-6] com.ldx.springboot.quartz.LogJob         : The time is now 17:04:54
2020-06-06 17:04:55.791  INFO 9920 --- [eduler_Worker-7] com.ldx.springboot.quartz.LogJob         : The time is now 17:04:55
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[OAuth2.0]]></title>
        <id>http://blog.ludangxin.club/post/oauth20/</id>
        <link href="http://blog.ludangxin.club/post/oauth20/">
        </link>
        <updated>2020-06-03T15:16:03.000Z</updated>
        <content type="html"><![CDATA[<h1 id="ç®€ä»‹">ç®€ä»‹</h1>
<p>OAUTHåè®®ä¸ºç”¨æˆ·èµ„æºçš„æˆæƒæä¾›äº†ä¸€ä¸ªå®‰å…¨çš„ã€å¼€æ”¾è€Œåˆç®€æ˜“çš„æ ‡å‡†ã€‚ä¸ä»¥å¾€çš„æˆæƒæ–¹å¼ä¸åŒä¹‹å¤„æ˜¯OAUTHçš„æˆæƒä¸ä¼šä½¿ç¬¬ä¸‰æ–¹è§¦åŠåˆ°ç”¨æˆ·çš„å¸å·ä¿¡æ¯ï¼ˆå¦‚ç”¨æˆ·åä¸å¯†ç ï¼‰ï¼Œå³ç¬¬ä¸‰æ–¹æ— éœ€ä½¿ç”¨ç”¨æˆ·çš„ç”¨æˆ·åä¸å¯†ç å°±å¯ä»¥ç”³è¯·è·å¾—è¯¥ç”¨æˆ·èµ„æºçš„æˆæƒï¼Œå› æ­¤OAUTHæ˜¯å®‰å…¨çš„ã€‚oAuthæ˜¯Open Authorizationçš„ç®€å†™ã€‚</p>
<p>OAuth2.0æ˜¯OAuthåè®®çš„å»¶ç»­ç‰ˆæœ¬ï¼Œä½†ä¸å‘å‰å…¼å®¹OAuth 1.0(å³å®Œå…¨åºŸæ­¢äº†OAuth1.0)ã€‚ OAuth 2.0å…³æ³¨å®¢æˆ·ç«¯å¼€å‘è€…çš„ç®€æ˜“æ€§ã€‚è¦ä¹ˆé€šè¿‡ç»„ç»‡åœ¨èµ„æºæ‹¥æœ‰è€…å’ŒHTTPæœåŠ¡å•†ä¹‹é—´çš„è¢«æ‰¹å‡†çš„äº¤äº’åŠ¨ä½œä»£è¡¨ç”¨æˆ·ï¼Œè¦ä¹ˆå…è®¸ç¬¬ä¸‰æ–¹åº”ç”¨ä»£è¡¨ç”¨æˆ·è·å¾—è®¿é—®çš„æƒé™ã€‚åŒæ—¶ä¸ºWebåº”ç”¨ï¼Œæ¡Œé¢åº”ç”¨å’Œæ‰‹æœºï¼Œå’Œèµ·å±…å®¤è®¾å¤‡æä¾›ä¸“é—¨çš„è®¤è¯æµç¨‹ã€‚<br>
<a href="https://tools.ietf.org/html/rfc6749">RFCæ–‡æ¡£</a></p>
<h2 id="è®¤è¯è¿‡ç¨‹">è®¤è¯è¿‡ç¨‹</h2>
<pre><code class="language-java">     +--------+                               +---------------+
     |        |--(A)- Authorization Request -&gt;|   Resource    |
     |        |                               |     Owner     |
     |        |&lt;-(B)-- Authorization Grant ---|               |
     |        |                               +---------------+
     |        |
     |        |                               +---------------+
     |        |--(C)-- Authorization Grant --&gt;| Authorization |
     | Client |                               |     Server    |
     |        |&lt;-(D)----- Access Token -------|               |
     |        |                               +---------------+
     |        |
     |        |                               +---------------+
     |        |--(E)----- Access Token ------&gt;|    Resource   |
     |        |                               |     Server    |
     |        |&lt;-(F)--- Protected Resource ---|               |
     +--------+                               +---------------+
</code></pre>
<p>ä¸Šå›¾ä¸­æ‰€æ¶‰åŠåˆ°çš„å¯¹è±¡åˆ†åˆ«ä¸ºï¼š</p>
<ul>
<li>Client ç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œæˆ‘ä»¬çš„åº”ç”¨å°±æ˜¯ä¸€ä¸ªClient</li>
<li>Resource Owner èµ„æºæ‰€æœ‰è€…ï¼Œå³ç”¨æˆ·</li>
<li>Authorization Server æˆæƒæœåŠ¡å™¨ï¼Œå³æä¾›ç¬¬ä¸‰æ–¹ç™»å½•æœåŠ¡çš„æœåŠ¡å™¨ï¼Œå¦‚Github</li>
<li>Resource Server æ‹¥æœ‰èµ„æºä¿¡æ¯çš„æœåŠ¡å™¨ï¼Œé€šå¸¸å’ŒæˆæƒæœåŠ¡å™¨å±äºåŒä¸€åº”ç”¨</li>
</ul>
<p>æ ¹æ®ä¸Šå›¾çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“OAuth2çš„åŸºæœ¬æµç¨‹ä¸ºï¼š</p>
<ol>
<li>ç¬¬ä¸‰æ–¹åº”ç”¨è¯·æ±‚ç”¨æˆ·æˆæƒã€‚</li>
<li>ç”¨æˆ·åŒæ„æˆæƒï¼Œå¹¶è¿”å›ä¸€ä¸ªå‡­è¯ï¼ˆcodeï¼‰</li>
<li>ç¬¬ä¸‰æ–¹åº”ç”¨é€šè¿‡ç¬¬äºŒæ­¥çš„å‡­è¯ï¼ˆcodeï¼‰å‘æˆæƒæœåŠ¡å™¨è¯·æ±‚æˆæƒ</li>
<li>æˆæƒæœåŠ¡å™¨éªŒè¯å‡­è¯ï¼ˆcodeï¼‰é€šè¿‡åï¼ŒåŒæ„æˆæƒï¼Œå¹¶è¿”å›ä¸€ä¸ªèµ„æºè®¿é—®çš„å‡­è¯ï¼ˆAccess Tokenï¼‰ã€‚</li>
<li>ç¬¬ä¸‰æ–¹åº”ç”¨é€šè¿‡ç¬¬å››æ­¥çš„å‡­è¯ï¼ˆAccess Tokenï¼‰å‘èµ„æºæœåŠ¡å™¨è¯·æ±‚ç›¸å…³èµ„æºã€‚</li>
<li>èµ„æºæœåŠ¡å™¨éªŒè¯å‡­è¯ï¼ˆAccess Tokenï¼‰é€šè¿‡åï¼Œå°†ç¬¬ä¸‰æ–¹åº”ç”¨è¯·æ±‚çš„èµ„æºè¿”å›ã€‚</li>
</ol>
<h2 id="oauth20çš„å…·ä½“å®ç°">OAuth2.0çš„å…·ä½“å®ç°</h2>
<p>çœ‹å®ŒOAuthçš„åŸºæœ¬æµç¨‹åï¼Œå¤§å®¶å®é™…ä¸Šå¯¹åˆ°åº•å¦‚ä½•åšOAuthéªŒè¯è¿˜æ˜¯ä¸å¤ªæ¸…æ¥šï¼ŒåŒæ—¶ï¼Œä¹Ÿä¼šäº§ç”Ÿç–‘é—®ï¼Œä¸ºä»€ä¹ˆéœ€è¦ä¸¤æ¬¡è·å–å‡­è¯ï¼Œè€Œä¸æ˜¯ç›´æ¥ç”¨æˆ·æˆæƒæ‹¿åˆ°å‡­è¯åå°±ç›´æ¥è·å–èµ„æºå‘¢ï¼Ÿè¿™å’ŒOAuthçš„å…·ä½“å®ç°æœ‰å…³ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹OAuth2çš„å…·ä½“å®ç°å§ã€‚</p>
<h3 id="ç”¨æˆ·æˆæƒ">ç”¨æˆ·æˆæƒ</h3>
<p>åœ¨ç”¨æˆ·æˆæƒè¿™ä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬å°†å¾—åˆ°ä¸€ä¸ªç”¨æˆ·å‡­è¯ï¼ˆcodeï¼‰ï¼Œæˆ‘ä»¬çš„åº”ç”¨å¯ä»¥é€šè¿‡è¯¥ç”¨æˆ·å‡­è¯ï¼ˆcodeï¼‰æ¥å’ŒæˆæƒæœåŠ¡å™¨äº¤æ¢ä¸€ä¸ªèµ„æºè®¿é—®å‡­è¯ï¼ˆAccess Tokenï¼‰ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬åªè®¨è®ºç¬¬ä¸‰æ–¹ç™»å½•åŠŸèƒ½çš„å®ç°æƒ…å†µï¼Œç»è¿‡åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºç”¨æˆ·å‡­è¯ï¼ˆcodeï¼‰å…·æœ‰ä¸‰ä¸ªç‰¹æ€§ï¼š</p>
<ul>
<li>ç”¨æˆ·å‡­è¯ï¼ˆcodeï¼‰éœ€è¦ç”±ç”¨æˆ·æˆæƒï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥è¡Œä¸ºæ˜¯ç”¨æˆ·çš„ä¸»åŠ¨è¡Œä¸ºï¼Œ æ­¤æ—¶ä¸ºäº†ä¿è¯ç”¨æˆ·èº«ä»½æ­£ç¡®ï¼Œå®é™…ä¸Šä¹Ÿéœ€è¦ç”¨æˆ·é€šè¿‡æˆæƒæœåŠ¡å™¨çš„éªŒè¯ï¼ˆç™»å½•æ“ä½œæˆ–è€…å·²ç™»å½•çŠ¶æ€ï¼‰</li>
<li>ç”¨æˆ·å‡­è¯ï¼ˆcodeï¼‰éœ€è¦æˆæƒæœåŠ¡å™¨é¢å‘ï¼Œå› ä¸ºæœ€ç»ˆç”¨æˆ·å‡­è¯ï¼ˆcodeï¼‰æ˜¯ç”±æˆæƒæœåŠ¡å™¨éªŒè¯çš„ï¼ŒåŒæ—¶ç”¨æˆ·æˆæƒæ“ä½œä¸ºäº†ä¿è¯ç”¨æˆ·èº«ä»½ï¼Œä¹Ÿéœ€è¦åœ¨æˆæƒæœåŠ¡å™¨ä¸Šè¿›è¡Œæ“ä½œï¼Œå› æ­¤ï¼Œç”¨æˆ·å‡­è¯ï¼ˆcodeï¼‰æ˜¯ç”±æˆæƒæœåŠ¡å™¨è¿›è¡Œé¢å‘çš„</li>
<li>ç”¨æˆ·å‡­è¯ï¼ˆcodeï¼‰éœ€è¦ç”±æˆæƒæœåŠ¡å™¨ä¼ é€’ç»™æˆ‘ä»¬çš„ç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œå¾ˆæ˜æ˜¾ï¼Œç”±ç”¨æˆ·åœ¨èµ„æºæœåŠ¡å™¨ä¸Šæ‹¿åˆ°å‡­è¯å†æ‰‹åŠ¨çš„æäº¤è‡³ç¬¬ä¸‰æ–¹åº”ç”¨å¤ªéº»çƒ¦ï¼Œå› æ­¤ï¼Œå½“ç”¨æˆ·ä¸»åŠ¨æˆæƒè¡Œä¸ºå‘ç”Ÿåï¼Œèµ„æºæœåŠ¡å™¨éœ€è¦å°†ç”¨æˆ·å‡­è¯ï¼ˆcodeï¼‰å‘é€ç»™ç¬¬ä¸‰æ–¹åº”ç”¨ã€‚</li>
</ul>
<p>æˆ‘ä»¬ä»¥Githubä¸ºä¾‹ï¼Œçœ‹çœ‹ä¸»æµçš„ç¬¬ä¸‰æ–¹ç™»å½•æ˜¯å¦‚ä½•æ»¡è¶³ä¸Šè¿°ä¸‰ä¸ªç‰¹æ€§çš„ã€‚</p>
<p>ç¬¬0æ­¥. å¼•å¯¼ç”¨æˆ·è¿›è¡Œæˆæƒï¼šgithub</p>
<p>å½“ç”¨æˆ·å¸Œæœ›ä½¿ç”¨ç¬¬ä¸‰æ–¹ç™»å½•è¿›è¡Œç™»å½•æ—¶ï¼Œç¬¬ä¸‰æ–¹åº”ç”¨ä¼šé€šè¿‡ç±»ä¼¼ä¸‹å›¾&quot;å¿«é€Ÿç™»é™†å›¾æ ‡&quot;çš„æ–¹å¼å°†ç”¨æˆ·å¼•å¯¼è‡³æˆæƒé¡µé¢ï¼Œä¸ºäº†å’ŒOAuthåŸºæœ¬æµç¨‹ä¸€è‡´ï¼Œæˆ‘ä»¬å°†è¿™ä¸€æ­¥å®šä¹‰ä¸ºç¬¬0æ­¥ã€‚</p>
<figure data-type="image" tabindex="1"><img src="http://blog.ludangxin.club/post-images/1591192836.jpg" alt="" loading="lazy"></figure>
<p>ç¬¬0.5æ­¥. ç”¨æˆ·èº«ä»½éªŒè¯</p>
<p>å½“æˆ‘ä»¬ç‚¹å‡»Githubçš„å›¾æ ‡ï¼Œæˆ‘ä»¬ä¼šè¿›å…¥åˆ°Githubåº”ç”¨ä¸‹é¢ï¼Œæ­¤æ—¶å®é™…ä¸Šè¿›è¡Œäº†ä¸€æ¬¡ç”¨æˆ·èº«ä»½çš„éªŒè¯ï¼Œä¹‹å‰æ²¡æœ‰ç™»å½•Githubçš„ç”¨æˆ·éœ€è¦è¾“å…¥Githubçš„è´¦å·å¯†ç ï¼Œå·²ç™»å½•çš„ç”¨æˆ·Githubä¼šæ ¹æ®Sessionè¿›è¡Œèº«ä»½ç¡®è®¤ã€‚æ­¤æ“ä½œæˆ‘ä»¬ç§°ä¸º0.5æ­¥ã€‚æ¥ä¸‹æ¥æ­£å¼è¿›å…¥OAuth2çš„æµç¨‹</p>
<figure data-type="image" tabindex="2"><img src="http://blog.ludangxin.club/post-images/1591193144.jpg" alt="" loading="lazy"></figure>
<p>ç¬¬1æ­¥. ç”¨æˆ·æˆæƒ</p>
<p>ç”¨æˆ·èº«ä»½ç¡®è®¤åä¼šè¿›å…¥ä¸‹é¢è¿™ä¸ªé¡µé¢ï¼Œè¯¥é¡µé¢ç”±æˆæƒæœåŠ¡å™¨æä¾›ï¼ŒæˆæƒæœåŠ¡å™¨ä¼šå‘Šè¯‰ç”¨æˆ·è¯¥ç¬¬ä¸‰æ–¹åœ¨æˆæƒæœåŠ¡å™¨ä¸­æäº¤çš„ç›¸å…³ä¿¡æ¯ï¼ˆå¦‚æœéœ€è¦å®ç°ç¬¬ä¸‰æ–¹ç™»å½•åŠŸèƒ½ï¼Œç¬¬ä¸‰æ–¹åº”ç”¨éœ€è¦å‘Githubã€å¾®åšç­‰åº”ç”¨ä¸­æäº¤åº”ç”¨çš„ç›¸å…³ä¿¡æ¯ï¼Œä¸åŒæœåŠ¡å¯èƒ½ä¼šéœ€è¦å®¡æ ¸ç­‰ä¸åŒçš„æ­¥éª¤ï¼‰ï¼Œä»¥åŠæˆæƒåç¬¬ä¸‰æ–¹åº”ç”¨èƒ½å¤Ÿè·å–å“ªäº›èµ„æºã€‚åœ¨Githubä¸­ï¼Œæœ€åŸºç¡€çš„è®¤è¯å¯ä»¥è®¿é—®ç”¨æˆ·çš„å…¬å…±ä¿¡æ¯ã€‚å¦‚æœç”¨æˆ·åŒæ„æˆæƒï¼Œéœ€è¦ä¸»åŠ¨çš„ç‚¹å‡»ã€Authorize applicationã€‘æŒ‰é’®ã€‚</p>
<figure data-type="image" tabindex="3"><img src="http://blog.ludangxin.club/post-images/1591193436.jpg" alt="" loading="lazy"></figure>
<p>ç¬¬2æ­¥. è¿”å›ç”¨æˆ·å‡­è¯ï¼ˆcodeï¼‰</p>
<p>å½“ç”¨æˆ·ç‚¹å‡»æŒ‰é’®åŒæ„æˆæƒåï¼ŒæˆæƒæœåŠ¡å™¨å°†ç”Ÿæˆä¸€ä¸ªç”¨æˆ·å‡­è¯ï¼ˆcodeï¼‰ï¼Œæ­¤æ—¶æˆæƒæœåŠ¡å™¨å¦‚ä½•å°†ç”¨æˆ·å‡­è¯ï¼ˆcodeï¼‰ä¼ é€’ç»™ç¬¬ä¸‰æ–¹åº”ç”¨å‘¢ï¼Ÿ</p>
<p>å½“æˆ‘ä»¬å‘æˆæƒæœåŠ¡å™¨æäº¤åº”ç”¨ä¿¡æ¯æ—¶ï¼Œé€šå¸¸éœ€è¦å¡«å†™ä¸€ä¸ªredirect_uriï¼Œå½“æˆ‘ä»¬å¼•å¯¼ç”¨æˆ·è¿›å…¥æˆæƒé¡µé¢æ—¶ï¼Œä¹Ÿä¼šé™„å¸¦ä¸€ä¸ªredirect_uriçš„ä¿¡æ¯ï¼Œå½“æˆæƒæœåŠ¡å™¨éªŒè¯ä¸¤ä¸ªURLä¸€è‡´æ—¶ï¼Œä¼šé€šçŸ¥æµè§ˆå™¨è·³è½¬åˆ°redirect_uriï¼ŒåŒæ—¶ï¼Œåœ¨redirect_uriåé™„åŠ ç”¨æˆ·å‡­è¯ï¼ˆcodeï¼‰çš„ç›¸å…³ä¿¡æ¯ï¼Œæ­¤æ—¶ï¼Œæµè§ˆå™¨è¿”å›ç¬¬ä¸‰æ–¹åº”ç”¨åŒæ—¶æºå¸¦ç”¨æˆ·å‡­è¯ï¼ˆcodeï¼‰çš„ç›¸å…³ä¿¡æ¯ã€‚æˆæƒåè®¿é—®çš„redirect_uriå¦‚ä¸‹ï¼š</p>
<pre><code class="language-wiki">https://www.csdn.net/oauth/github/callback?code=9e3efa6cea739f9aaab2&amp;state=XXX
</code></pre>
<p>è¿™æ ·ï¼Œç¬¬äºŒæ­¥è¿”å›ç”¨æˆ·å‡­è¯ï¼ˆcodeï¼‰å°±å®Œæˆäº†ã€‚</p>
<h3 id="æˆæƒæœåŠ¡å™¨æˆæƒ">æˆæƒæœåŠ¡å™¨æˆæƒ</h3>
<p>ä»è¿™ä¸€æ­¥å¼€å§‹ï¼ŒOAuth2 çš„æˆæƒå°†æœ‰ä¸¤ä¸ªé‡å¤§å˜åŒ–çš„å‘ç”Ÿï¼š</p>
<ul>
<li>ç”¨æˆ·ä¸»åŠ¨è¡Œä¸ºç»“æŸï¼Œç”¨æˆ·ç†è®ºä¸Šå¯ä»¥ä¸éœ€è¦å†åšä»»ä½•ä¸»åŠ¨çš„æ“ä½œï¼Œä½œä¸ºç¬¬ä¸‰æ–¹åº”ç”¨çš„æˆ‘ä»¬å¯ä»¥åœ¨åå°æ‹¿åˆ°èµ„æºæœåŠ¡å™¨ä¸Šçš„èµ„æºè€Œå¯¹ç”¨æˆ·æ˜¯ä¸å¯è§çš„ï¼Œå½“ç”¨æˆ·çš„æµè§ˆå™¨è·³åˆ°ä¸‹ä¸€ä¸ªé¡µé¢æ—¶ï¼Œæ•´ä¸ªOAuth2çš„æµç¨‹å·²ç»ç»“æŸ</li>
<li>æµè§ˆå™¨ç«¯è¡Œä¸ºç»“æŸï¼Œä»OAuth2 çš„åŸºæœ¬æµç¨‹å¯ä»¥çœ‹å‡ºï¼Œæ¥ä¸‹æ¥çš„æµç¨‹å·²ç»ä¸éœ€è¦å’Œç”¨æˆ·è¿›è¡Œäº¤äº’ï¼Œæ¥ä¸‹æ¥çš„è¡Œä¸ºéƒ½åœ¨ç¬¬ä¸‰æ–¹åº”ç”¨ä¸æˆæƒæœåŠ¡å™¨ã€èµ„æºæœåŠ¡å™¨ä¹‹é—´çš„äº¤äº’ã€‚</li>
</ul>
<p>æˆ‘ä»¬çŸ¥é“æµè§ˆå™¨ç«¯çš„è¡Œä¸ºå®é™…ä¸Šæ˜¯ä¸å®‰å…¨çš„ï¼Œç”šè‡³å®‰å…¨å‡­è¯çš„ä¼ é€’éƒ½æ˜¯é€šè¿‡URLç›´æ¥ä¼ é€’çš„ã€‚ä½†æ˜¯ç”±äºç”¨æˆ·å‡­è¯ï¼ˆcodeï¼‰ä¸æ˜¯é‚£ä¹ˆæ•æ„Ÿï¼Œå…¶ä»–æ”»å‡»è€…æ‹¿åˆ°ç”¨æˆ·å‡­è¯ï¼ˆcodeï¼‰åä¾ç„¶æ— æ³•è·å–åˆ°ç›¸åº”çš„ç”¨æˆ·èµ„æºï¼Œæ‰€ä»¥ä¹‹å‰çš„è¡Œä¸ºæ˜¯å…è®¸çš„ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹æœåŠ¡å™¨å¦‚ä½•äº¤äº’æ¥å®‰å…¨çš„è·å¾—æˆæƒæœåŠ¡å™¨æˆæƒã€‚</p>
<p>ç¬¬3æ­¥. è¯·æ±‚æˆæƒæœåŠ¡å™¨æˆæƒ</p>
<p>è¦æ‹¿åˆ°æˆæƒæœåŠ¡å™¨çš„æˆæƒï¼Œéœ€è¦ä»¥ä¸‹å‡ ä¸ªä¿¡æ¯ï¼š</p>
<ul>
<li>client_id æ ‡è¯†ç¬¬ä¸‰æ–¹åº”ç”¨çš„idï¼Œç”±æˆæƒæœåŠ¡å™¨ï¼ˆGithubï¼‰åœ¨ç¬¬ä¸‰æ–¹åº”ç”¨æäº¤æ—¶é¢å‘ç»™ç¬¬ä¸‰æ–¹åº”ç”¨</li>
<li>client_secret ç¬¬ä¸‰æ–¹åº”ç”¨å’ŒæˆæƒæœåŠ¡å™¨ä¹‹é—´çš„å®‰å…¨å‡­è¯ï¼Œç”±æˆæƒæœåŠ¡å™¨ï¼ˆGithubï¼‰åœ¨ç¬¬ä¸‰æ–¹åº”ç”¨æäº¤æ—¶é¢å‘ç»™ç¬¬ä¸‰æ–¹åº”ç”¨</li>
<li>code ç¬¬ä¸€æ­¥ä¸­è¿”å›çš„ç”¨æˆ·å‡­è¯redirect_uri ç¬¬ä¸€æ­¥ç”Ÿæˆç”¨æˆ·å‡­è¯åè·³è½¬åˆ°ç¬¬äºŒæ­¥æ—¶çš„åœ°å€</li>
<li>state ç”±ç¬¬ä¸‰æ–¹åº”ç”¨ç»™å‡ºçš„éšæœºç </li>
</ul>
<p>æˆ‘ä»¬çœ‹åˆ°ï¼Œä¸Šè¿°ä¿¡æ¯è¿˜æ¶‰åŠåˆ°ç¬¬ä¸‰æ–¹åº”ç”¨çš„å®‰å…¨å‡­è¯ï¼ˆclient_secretï¼‰ï¼Œå› æ­¤è¦æ±‚OAuthè¦æ±‚è¯¥è¯·æ±‚å¿…é¡»æ—¶POSTè¯·æ±‚ï¼ŒåŒæ—¶ï¼Œè¿˜å¿…é¡»æ—¶HTTPSæœåŠ¡ï¼Œä»¥æ­¤ä¿è¯è·å–åˆ°çš„éªŒè¯å‡­è¯ï¼ˆAccess Tokenï¼‰çš„å®‰å…¨æ€§ã€‚</p>
<p>ç¬¬4æ­¥. æ‹¿åˆ°éªŒè¯å‡­è¯ï¼ˆAccess Tokenï¼‰</p>
<p>å½“æˆæƒæœåŠ¡å™¨æ‹¿åˆ°ç¬¬3æ­¥ä¸­çš„æ‰€æœ‰ä¿¡æ¯ï¼ŒéªŒè¯é€šè¿‡åï¼Œä¼šå°†Access Tokenè¿”å›ç»™ç¬¬ä¸‰æ–¹åº”ç”¨ã€‚</p>
<h3 id="è®¿é—®èµ„æº">è®¿é—®èµ„æº</h3>
<p>ç¬¬5æ­¥. è¯·æ±‚è®¿é—®ç”¨æˆ·èµ„æº</p>
<p>æ‹¿åˆ°éªŒè¯å‡­è¯ï¼ˆAccess Tokenï¼‰åï¼Œå‰©ä¸‹çš„äº‹æƒ…å°±å¾ˆç®€å•äº†ï¼Œèµ„æºæœåŠ¡å™¨ä¼šæä¾›ä¸€ç³»åˆ—å…³äºç”¨æˆ·èµ„æºçš„APIï¼Œæ‹¿éªŒè¯å‡­è¯ï¼ˆAccess Tokenï¼‰è®¿é—®ç›¸åº”çš„APIå³å¯ï¼Œä¾‹å¦‚ï¼Œåœ¨GIthubä¸­ï¼Œå¦‚æœä½ æƒ³æ‹¿åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œå¯ä»¥è®¿é—®ä»¥ä¸‹APIï¼š</p>
<pre><code class="language-text">GET https://api.github.com/user?access_token=...
</code></pre>
<p>æ³¨æ„ï¼Œæ­¤æ—¶çš„è®¿é—®ä¸æ˜¯é€šè¿‡æµè§ˆå™¨è¿›è¡Œçš„ï¼Œè€Œæ˜¯æœåŠ¡å™¨ç›´æ¥å‘é€HTTPè¯·æ±‚ï¼Œå› æ­¤å…¶å®‰å…¨æ€§æ˜¯å¯ä»¥ä¿è¯çš„ã€‚</p>
<p>ç¬¬6æ­¥. è¿”å›èµ„æº</p>
<p>å¦‚æœéªŒè¯å‡­è¯ï¼ˆAccess Tokenï¼‰æ˜¯æ­£ç¡®çš„ï¼Œæ­¤æ—¶èµ„æºæœåŠ¡å™¨å°±ä¼šè¿”å›èµ„æºä¿¡æ¯ï¼Œæ­¤æ—¶æ•´ä¸ªOAuthæµç¨‹å°±ç»“æŸäº†ã€‚</p>
<h2 id="ç¬¬ä¸‰æ–¹ç™»å½•">ç¬¬ä¸‰æ–¹ç™»å½•</h2>
<p>çœ‹å®ŒOAuth2çš„èµ„æºè®¿é—®æµç¨‹ï¼Œæˆ‘ä»¬çš„ç¬¬ä¸‰æ–¹ç™»å½•æ˜¯å¦‚ä½•åšçš„å‘¢ï¼Ÿé¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“ä¸¤ç‚¹ï¼š</p>
<ul>
<li>ç”¨æˆ·æˆæƒä¿¡æ¯åœ¨æˆæƒæœåŠ¡å™¨ä¸­æ˜¯æœ‰è®°å½•çš„ï¼Œå½“ç”¨æˆ·ç¬¬ä¸€æ¬¡æˆæƒç»™ç›¸åº”çš„ç¬¬ä¸‰æ–¹åº”ç”¨åï¼Œä¸éœ€è¦è¿›è¡Œå†æ¬¡æˆæƒ</li>
<li>æ¯ä¸ªç”¨æˆ·åœ¨èµ„æºæœåŠ¡å™¨ä¸­éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„IDï¼Œç¬¬ä¸‰æ–¹åº”ç”¨å¯ä»¥å°†å…¶å­˜å‚¨èµ·æ¥å¹¶ä¸æœ¬åœ°ç”¨æˆ·ç³»ç»Ÿä¸€ä¸€å¯¹åº”èµ·æ¥<br>
è¿™æ ·ï¼Œå½“ç”¨æˆ·ç¬¬ä¸€æ¬¡æˆæƒå¹¶ä¸”æ³¨å†Œåï¼ˆä¸»åŠ¨æ³¨å†Œæˆ–è€…ç¬¬ä¸‰æ–¹åº”ç”¨ä½¿ç”¨ç”¨æˆ·ä¿¡æ¯é»˜è®¤æ³¨å†Œï¼‰ï¼Œå½“å†æ¬¡ç‚¹å‡»ç¬¬ä¸‰æ–¹ç™»å½•çš„æŒ‰é’®ï¼Œæµè§ˆå™¨è·³è½¬åˆ°æˆæƒæœåŠ¡å™¨ï¼ŒæˆæƒæœåŠ¡å™¨é€šè¿‡Sessionæ‰¾åˆ°ç”¨æˆ·çš„æˆæƒä¿¡æ¯ï¼Œå‘ç°è¯¥ç”¨æˆ·å·²ç»æˆæƒç»™è¯¥ç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œå°†ç›´æ¥è·³è½¬åˆ°redirect_uriï¼Œæ­¤æ—¶ç¬¬ä¸‰æ–¹åº”ç”¨é€šè¿‡å”¯ä¸€çš„ç”¨æˆ·IDæ‰¾åˆ°ç›¸åº”çš„æœ¬åœ°ç”¨æˆ·ï¼Œè‡ªåŠ¨å¸®åŠ©å…¶ç™»å½•ã€‚<br>
è¿™æ ·ï¼Œå°±å¯ä»¥è¾¾åˆ°ç›´æ¥ç‚¹å‡»ç¬¬ä¸‰æ–¹ç™»å½•æŒ‰é’®ï¼Œä¸éœ€è¦ä»»ä½•æ“ä½œï¼Œç»è¿‡å‡ æ¬¡è·³è½¬åè‡ªåŠ¨ç™»å½•çš„æ•ˆæœäº†ã€‚å¤§å®¶å¿«å»è¯•è¯•å§ã€‚</li>
</ul>
<h2 id="å®¢æˆ·ç«¯æˆæƒæ¨¡å¼">å®¢æˆ·ç«¯æˆæƒæ¨¡å¼</h2>
<p>å®¢æˆ·ç«¯å¿…é¡»å¾—åˆ°ç”¨æˆ·çš„æˆæƒï¼ˆauthorization grantï¼‰ï¼Œæ‰èƒ½è·å¾—ä»¤ç‰Œï¼ˆaccess tokenï¼‰ã€‚oAuth 2.0 å®šä¹‰äº†å››ç§æˆæƒæ–¹å¼ã€‚</p>
<ul>
<li>implicitï¼šç®€åŒ–æ¨¡å¼</li>
<li>authorization codeï¼šæˆæƒç æ¨¡å¼</li>
<li>resource owner password credentialsï¼šå¯†ç æ¨¡å¼</li>
<li>client credentialsï¼šå®¢æˆ·ç«¯æ¨¡å¼</li>
</ul>
<h3 id="æˆæƒç æ¨¡å¼">æˆæƒç æ¨¡å¼</h3>
<figure data-type="image" tabindex="4"><img src="http://blog.ludangxin.club/post-images/1591195997.jpg" alt="" loading="lazy"></figure>
<ol>
<li>èµ„æºæ‹¥æœ‰è€…æ‰“å¼€å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯è¦æ±‚èµ„æºæ‹¥æœ‰è€…ç»™äºˆæˆæƒï¼Œå®ƒå°†æµè§ˆå™¨è¢«é‡å®šå‘åˆ°æˆæƒæœåŠ¡å™¨ï¼Œé‡å®šå‘æ—¶ä¼š é™„åŠ å®¢æˆ·ç«¯çš„èº«ä»½ä¿¡æ¯ã€‚å¦‚ï¼š<pre><code class="language-wiki">/uaa/oauth/authorize?
client_id=c1&amp;response_type=code&amp;scope=all&amp;redirect_uri=http://www.baidu.com
</code></pre>
â€‹	å‚æ•°åˆ—è¡¨å¦‚ä¸‹ï¼š<br>
â€‹	client_idï¼šå®¢æˆ·ç«¯å‡†å…¥æ ‡è¯†ã€‚<br>
â€‹	response_typeï¼šæˆæƒç æ¨¡å¼å›ºå®šä¸ºcodeã€‚<br>
â€‹	scopeï¼šå®¢æˆ·ç«¯æƒé™ã€‚<br>
â€‹	redirect_uriï¼šè·³è½¬uriï¼Œå½“æˆæƒç ç”³è¯·æˆåŠŸåä¼šè·³è½¬åˆ°æ­¤åœ°å€ï¼Œå¹¶åœ¨åè¾¹å¸¦ä¸Šcodeå‚æ•°ï¼ˆæˆæƒç ï¼‰ã€‚</li>
<li>æµè§ˆå™¨å‡ºç°å‘æˆæƒæœåŠ¡å™¨æˆæƒé¡µé¢ï¼Œä¹‹åå°†ç”¨æˆ·åŒæ„æˆæƒã€‚</li>
<li>æˆæƒæœåŠ¡å™¨å°†æˆæƒç ï¼ˆ<strong>AuthorizationCode</strong>ï¼‰è½¬ç»æµè§ˆå™¨å‘é€ç»™<strong>client</strong>(é€šè¿‡redirect_uri)ã€‚</li>
<li>å®¢æˆ·ç«¯æ‹¿ç€æˆæƒç å‘æˆæƒæœåŠ¡å™¨ç´¢è¦è®¿é—®<strong>access_token</strong>ï¼Œè¯·æ±‚å¦‚ä¸‹ï¼š<pre><code class="language-wiki">/uaa/oauth/token? 
client_id=c1&amp;client_secret=secret&amp;grant_type=authorization_code&amp;code=5PgfcD&amp;redirect_uri=http://w ww.baidu.com
</code></pre>
â€‹	å‚æ•°åˆ—è¡¨å¦‚ä¸‹<br>
â€‹	client_idï¼šå®¢æˆ·ç«¯å‡†å…¥æ ‡è¯†ã€‚<br>
â€‹	client_secretï¼šå®¢æˆ·ç«¯ç§˜é’¥ã€‚<br>
â€‹	grant_typeï¼šæˆæƒç±»å‹ï¼Œå¡«å†™authorization_codeï¼Œè¡¨ç¤ºæˆæƒç æ¨¡å¼<br>
â€‹	codeï¼šæˆæƒç ï¼Œå°±æ˜¯åˆšåˆšè·å–çš„æˆæƒç ï¼Œæ³¨æ„ï¼šæˆæƒç åªä½¿ç”¨ä¸€æ¬¡å°±æ— æ•ˆäº†ï¼Œéœ€è¦é‡æ–°ç”³è¯·ã€‚<br>
â€‹	redirect_uriï¼šç”³è¯·æˆæƒç æ—¶çš„è·³è½¬urlï¼Œä¸€å®šå’Œç”³è¯·æˆæƒç æ—¶ç”¨çš„redirect_uriä¸€è‡´ã€‚</li>
<li>æˆæƒæœåŠ¡å™¨è¿”å›ä»¤ç‰Œ**(access_token)**</li>
</ol>
<p><strong>è¿™ç§æ¨¡å¼æ˜¯å››ç§æ¨¡å¼ä¸­æœ€å®‰å…¨çš„ä¸€ç§æ¨¡å¼ã€‚ä¸€èˆ¬ç”¨äºclientæ˜¯WebæœåŠ¡å™¨ç«¯åº”ç”¨æˆ–ç¬¬ä¸‰æ–¹çš„åŸç”ŸAppè°ƒç”¨èµ„æºæœåŠ¡çš„æ—¶å€™ã€‚å› ä¸ºåœ¨è¿™ç§æ¨¡å¼ä¸­access_tokenä¸ä¼šç»è¿‡æµè§ˆå™¨æˆ–ç§»åŠ¨ç«¯çš„Appï¼Œè€Œæ˜¯ç›´æ¥ä»æœåŠ¡ç«¯å»äº¤æ¢ï¼Œè¿™æ ·å°±æœ€å¤§é™åº¦çš„å‡å°äº†ä»¤ç‰Œæ³„æ¼çš„é£é™©ã€‚</strong></p>
<h3 id="ç®€åŒ–æ¨¡å¼">ç®€åŒ–æ¨¡å¼</h3>
<figure data-type="image" tabindex="5"><img src="http://blog.ludangxin.club/post-images/1591196409.jpg" alt="" loading="lazy"></figure>
<ol>
<li>èµ„æºæ‹¥æœ‰è€…æ‰“å¼€å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯è¦æ±‚èµ„æºæ‹¥æœ‰è€…ç»™äºˆæˆæƒï¼Œå®ƒå°†æµè§ˆå™¨è¢«é‡å®šå‘åˆ°æˆæƒæœåŠ¡å™¨ï¼Œé‡å®šå‘æ—¶ä¼šé™„åŠ å®¢æˆ·ç«¯çš„èº«ä»½ä¿¡æ¯ã€‚å¦‚ï¼š<pre><code class="language-wiki">/uaa/oauth/authorize?
client_id=c1&amp;response_type=token&amp;scope=all&amp;redirect_uri=http://www.baidu.com 
</code></pre>
å‚æ•°æè¿°åŒ<strong>æˆæƒç æ¨¡å¼</strong> ï¼Œæ³¨æ„response_type=tokenï¼Œè¯´æ˜æ˜¯ç®€åŒ–æ¨¡å¼ã€‚</li>
<li>æµè§ˆå™¨å‡ºç°å‘æˆæƒæœåŠ¡å™¨æˆæƒé¡µé¢ï¼Œä¹‹åå°†ç”¨æˆ·åŒæ„æˆæƒã€‚</li>
<li>æˆæƒæœåŠ¡å™¨å°†æˆæƒç å°†ä»¤ç‰Œï¼ˆ<strong>access_token</strong>ï¼‰ä»¥<strong>Hash</strong>çš„å½¢å¼å­˜æ”¾åœ¨é‡å®šå‘<strong>uri</strong>çš„<strong>fargment</strong>ä¸­å‘é€ç»™<strong>æµè§ˆå™¨ã€‚</strong><br>
æ³¨ï¼šfragment ä¸»è¦æ˜¯ç”¨æ¥æ ‡è¯† URI æ‰€æ ‡è¯†èµ„æºé‡Œçš„æŸä¸ªèµ„æºï¼Œåœ¨ URI çš„æœ«å°¾é€šè¿‡ ï¼ˆ#ï¼‰ä½œä¸º fragment çš„å¼€å¤´ï¼Œå…¶ä¸­ # ä¸å±äº fragment çš„å€¼ã€‚å¦‚https://domain/index#L18è¿™ä¸ª URI ä¸­ L18 å°±æ˜¯ fragment çš„å€¼ã€‚å¤§å®¶åªéœ€è¦çŸ¥é“jsé€šè¿‡å“åº”æµè§ˆå™¨åœ°å€æ å˜åŒ–çš„æ–¹å¼èƒ½è·å–åˆ°fragment å°±è¡Œäº†ã€‚</li>
</ol>
<p><strong>ä¸€èˆ¬æ¥è¯´ï¼Œç®€åŒ–æ¨¡å¼ç”¨äºæ²¡æœ‰æœåŠ¡å™¨ç«¯çš„ç¬¬ä¸‰æ–¹å•é¡µé¢åº”ç”¨ï¼Œå› ä¸ºæ²¡æœ‰æœåŠ¡å™¨ç«¯å°±æ— æ³•æ¥æ”¶æˆæƒç ã€‚</strong></p>
<h3 id="å¯†ç æ¨¡å¼">å¯†ç æ¨¡å¼</h3>
<figure data-type="image" tabindex="6"><img src="http://blog.ludangxin.club/post-images/1591196923.jpg" alt="" loading="lazy"></figure>
<ol>
<li>
<p>èµ„æºæ‹¥æœ‰è€…å°†ç”¨æˆ·åã€å¯†ç å‘é€ç»™å®¢æˆ·ç«¯</p>
</li>
<li>
<p>å®¢æˆ·ç«¯æ‹¿ç€èµ„æºæ‹¥æœ‰è€…çš„ç”¨æˆ·åã€å¯†ç å‘æˆæƒæœåŠ¡å™¨è¯·æ±‚ä»¤ç‰Œï¼ˆ<strong>access_token</strong>ï¼‰ï¼Œè¯·æ±‚å¦‚ä¸‹ï¼š</p>
<pre><code class="language-wiki">/uaa/oauth/token? 
client_id=c1&amp;client_secret=secret&amp;grant_type=password&amp;username=shangsan&amp;password=123 
</code></pre>
<p>â€‹	å‚æ•°åˆ—è¡¨å¦‚ä¸‹ï¼š<br>
â€‹	client_idï¼šå®¢æˆ·ç«¯å‡†å…¥æ ‡è¯†ã€‚<br>
â€‹	client_secretï¼šå®¢æˆ·ç«¯ç§˜é’¥ã€‚<br>
â€‹	grant_typeï¼šæˆæƒç±»å‹ï¼Œå¡«å†™passwordè¡¨ç¤ºå¯†ç æ¨¡å¼<br>
â€‹	usernameï¼šèµ„æºæ‹¥æœ‰è€…ç”¨æˆ·åã€‚<br>
â€‹	passwordï¼šèµ„æºæ‹¥æœ‰è€…å¯†ç ã€‚</p>
</li>
<li>
<p>æˆæƒæœåŠ¡å™¨å°†ä»¤ç‰Œï¼ˆ<strong>access_token</strong>ï¼‰å‘é€ç»™<strong>client</strong></p>
</li>
</ol>
<p><strong>è¿™ç§æ¨¡å¼ååˆ†ç®€å•ï¼Œä½†æ˜¯å´æ„å‘³ç€ç›´æ¥å°†ç”¨æˆ·æ•æ„Ÿä¿¡æ¯æ³„æ¼ç»™äº†clientï¼Œå› æ­¤è¿™å°±è¯´æ˜è¿™ç§æ¨¡å¼åªèƒ½ç”¨äºclientæ˜¯æˆ‘ä»¬è‡ªå·±å¼€å‘çš„æƒ…å†µä¸‹ã€‚å› æ­¤å¯†ç æ¨¡å¼ä¸€èˆ¬ç”¨äºæˆ‘ä»¬è‡ªå·±å¼€å‘çš„ï¼Œç¬¬ä¸€æ–¹åŸç”ŸAppæˆ–ç¬¬ä¸€æ–¹å•é¡µé¢åº”ç”¨ã€‚</strong></p>
<h3 id="å®¢æˆ·ç«¯æ¨¡å¼">å®¢æˆ·ç«¯æ¨¡å¼</h3>
<figure data-type="image" tabindex="7"><img src="http://blog.ludangxin.club/post-images/1591197128.jpg" alt="" loading="lazy"></figure>
<ol>
<li>å®¢æˆ·ç«¯å‘æˆæƒæœåŠ¡å™¨å‘é€è‡ªå·±çš„èº«ä»½ä¿¡æ¯ï¼Œå¹¶è¯·æ±‚ä»¤ç‰Œï¼ˆ<strong>access_token</strong>ï¼‰</li>
<li>ç¡®è®¤å®¢æˆ·ç«¯èº«ä»½æ— è¯¯åï¼Œå°†ä»¤ç‰Œï¼ˆ<strong>access_token</strong>ï¼‰å‘é€ç»™<strong>client</strong>ï¼Œè¯·æ±‚å¦‚ä¸‹ï¼š<pre><code class="language-wiki">/uaa/oauth/token?client_id=c1&amp;client_secret=secret&amp;grant_type=client_credentials 
</code></pre>
â€‹	å‚æ•°åˆ—è¡¨å¦‚ä¸‹ï¼š<br>
â€‹	client_idï¼šå®¢æˆ·ç«¯å‡†å…¥æ ‡è¯†ã€‚<br>
â€‹	client_secretï¼šå®¢æˆ·ç«¯ç§˜é’¥ã€‚<br>
â€‹	grant_typeï¼šæˆæƒç±»å‹ï¼Œå¡«å†™client_credentialsè¡¨ç¤ºå®¢æˆ·ç«¯æ¨¡å¼</li>
</ol>
<p><strong>è¿™ç§æ¨¡å¼æ˜¯æœ€æ–¹ä¾¿ä½†æœ€ä¸å®‰å…¨çš„æ¨¡å¼ã€‚å› æ­¤è¿™å°±è¦æ±‚æˆ‘ä»¬å¯¹clientå®Œå…¨çš„ä¿¡ä»»ï¼Œè€Œclientæœ¬èº«ä¹Ÿæ˜¯å®‰å…¨çš„ã€‚å› æ­¤è¿™ç§æ¨¡å¼ä¸€èˆ¬ç”¨æ¥æä¾›ç»™æˆ‘ä»¬å®Œå…¨ä¿¡ä»»çš„æœåŠ¡å™¨ç«¯æœåŠ¡ã€‚æ¯”å¦‚ï¼Œåˆä½œæ–¹ç³»ç»Ÿå¯¹æ¥ï¼Œæ‹‰å–ä¸€ç»„ç”¨æˆ·ä¿¡æ¯ã€‚</strong></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Spring Security è¯¦è§£ åŠ å¿«é€Ÿä¸Šæ‰‹]]></title>
        <id>http://blog.ludangxin.club/post/spring-security-xiang-jie-ji-kuai-su-shang-shou/</id>
        <link href="http://blog.ludangxin.club/post/spring-security-xiang-jie-ji-kuai-su-shang-shou/">
        </link>
        <updated>2020-06-02T15:13:26.000Z</updated>
        <content type="html"><![CDATA[<h1 id="ä»€ä¹ˆæ˜¯è®¤è¯">ä»€ä¹ˆæ˜¯è®¤è¯</h1>
<p>ç”¨æˆ·è®¤è¯å°±æ˜¯åˆ¤æ–­ä¸€ä¸ªç”¨æˆ·çš„èº«ä»½æ˜¯å¦åˆæ³•çš„è¿‡ç¨‹ï¼Œç”¨æˆ·å»è®¿é—®ç³»ç»Ÿèµ„æºæ—¶ç³»ç»Ÿè¦æ±‚éªŒè¯ç”¨æˆ·çš„èº«ä»½ä¿¡ æ¯ï¼Œèº«ä»½åˆæ³•æ–¹å¯ç»§ç»­è®¿é—®ï¼Œä¸åˆæ³•åˆ™æ‹’ç»è®¿é—®ã€‚å¸¸è§çš„ç”¨æˆ·èº«ä»½è®¤è¯æ–¹å¼æœ‰ï¼šç”¨æˆ·åå¯†ç ç™»å½•ï¼ŒäºŒç»´ç ç™»å½•ï¼Œæ‰‹æœºçŸ­ä¿¡ç™»å½•ï¼ŒæŒ‡çº¹è®¤è¯ç­‰æ–¹å¼ã€‚<br>
<strong>ç³»ç»Ÿä¸ºä»€ä¹ˆè¦è®¤è¯ï¼Ÿ</strong><br>
è®¤è¯æ˜¯ä¸ºäº†ä¿æŠ¤ç³»ç»Ÿçš„éšç§æ•°æ®ä¸èµ„æºï¼Œç”¨æˆ·çš„èº«ä»½åˆæ³•æ–¹å¯è®¿é—®è¯¥ç³»ç»Ÿçš„èµ„æºã€‚</p>
<h1 id="ä»€ä¹ˆæ˜¯ä¼šè¯">ä»€ä¹ˆæ˜¯ä¼šè¯</h1>
<p>ç”¨æˆ·è®¤è¯é€šè¿‡åï¼Œä¸ºäº†é¿å…ç”¨æˆ·çš„æ¯æ¬¡æ“ä½œéƒ½è¿›è¡Œè®¤è¯å¯å°†ç”¨æˆ·çš„ä¿¡æ¯ä¿è¯åœ¨ä¼šè¯ä¸­ã€‚ä¼šè¯å°±æ˜¯ç³»ç»Ÿä¸ºäº†ä¿æŒå½“å‰ ç”¨æˆ·çš„ç™»å½•çŠ¶æ€æ‰€æä¾›çš„æœºåˆ¶ï¼Œå¸¸è§çš„æœ‰åŸºäºsessionæ–¹å¼ã€åŸºäºtokenæ–¹å¼ç­‰ã€‚</p>
<h2 id="session-ä¼šè¯">session ä¼šè¯</h2>
<p>ç”¨æˆ·è®¤è¯æˆåŠŸåï¼Œåœ¨æœåŠ¡ç«¯ç”Ÿæˆç”¨æˆ·ç›¸å…³çš„æ•°æ®ä¿å­˜åœ¨session(å½“å‰ä¼šè¯)ä¸­ï¼Œå‘ç»™å®¢æˆ·ç«¯çš„ sesssion_id å­˜æ”¾åˆ° cookie ä¸­ï¼Œè¿™æ ·ç”¨æˆ·å®¢æˆ·ç«¯è¯·æ±‚æ—¶å¸¦ä¸Š session_id å°±å¯ä»¥éªŒè¯æœåŠ¡å™¨ç«¯æ˜¯å¦å­˜åœ¨ session æ•° æ®ï¼Œä»¥æ­¤å®Œæˆç”¨æˆ·çš„åˆæ³•æ ¡éªŒï¼Œå½“ç”¨æˆ·é€€å‡ºç³»ç»Ÿæˆ–sessionè¿‡æœŸé”€æ¯æ—¶,å®¢æˆ·ç«¯çš„session_idä¹Ÿå°±æ— æ•ˆäº†ã€‚<br>
<img src="http://blog.ludangxin.club/post-images/1591110991875.jpg" alt="" loading="lazy"></p>
<h2 id="token-ä¼šè¯">token ä¼šè¯</h2>
<p>ç”¨æˆ·è®¤è¯æˆåŠŸåï¼ŒæœåŠ¡ç«¯ç”Ÿæˆä¸€ä¸ªtokenå‘ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯å¯ä»¥æ”¾åˆ° cookie æˆ– localStorageç­‰å­˜å‚¨ä¸­ï¼Œæ¯æ¬¡è¯·æ±‚æ—¶å¸¦ä¸Š tokenï¼ŒæœåŠ¡ç«¯æ”¶åˆ°tokené€šè¿‡éªŒè¯åå³å¯ç¡®è®¤ç”¨æˆ·èº«ä»½ã€‚<br>
<img src="http://blog.ludangxin.club/post-images/1591111017782.jpg" alt="" loading="lazy"><br>
åŸºäºsessionçš„è®¤è¯æ–¹å¼ç”±Servletè§„èŒƒå®šåˆ¶ï¼ŒæœåŠ¡ç«¯è¦å­˜å‚¨sessionä¿¡æ¯éœ€è¦å ç”¨å†…å­˜èµ„æºï¼Œå®¢æˆ·ç«¯éœ€è¦æ”¯æŒ cookieï¼›åŸºäºtokençš„æ–¹å¼åˆ™ä¸€èˆ¬ä¸éœ€è¦æœåŠ¡ç«¯å­˜å‚¨tokenï¼Œå¹¶ä¸”ä¸é™åˆ¶å®¢æˆ·ç«¯çš„å­˜å‚¨æ–¹å¼ã€‚å¦‚ä»Šç§»åŠ¨äº’è”ç½‘æ—¶ä»£ æ›´å¤šç±»å‹çš„å®¢æˆ·ç«¯éœ€è¦æ¥å…¥ç³»ç»Ÿï¼Œç³»ç»Ÿå¤šæ˜¯é‡‡ç”¨å‰åç«¯åˆ†ç¦»çš„æ¶æ„è¿›è¡Œå®ç°ï¼Œæ‰€ä»¥åŸºäºtokençš„æ–¹å¼æ›´é€‚åˆã€‚</p>
<h1 id="ä»€ä¹ˆæ˜¯æˆæƒ">ä»€ä¹ˆæ˜¯æˆæƒ</h1>
<p>æˆæƒæ˜¯ç”¨æˆ·è®¤è¯é€šè¿‡æ ¹æ®ç”¨æˆ·çš„æƒé™æ¥æ§åˆ¶ç”¨æˆ·è®¿é—®èµ„æºçš„è¿‡ç¨‹ï¼Œæ‹¥æœ‰èµ„æºçš„è®¿é—®æƒé™åˆ™æ­£å¸¸è®¿é—®ï¼Œæ²¡æœ‰æƒé™åˆ™æ‹’ç»è®¿é—®ã€‚<br>
<strong>ä¸ºä»€ä¹ˆè¦æˆæƒï¼Ÿ</strong><br>
è®¤è¯æ˜¯ä¸ºäº†ä¿è¯ç”¨æˆ·èº«ä»½çš„åˆæ³•æ€§ï¼Œæˆæƒåˆ™æ˜¯ä¸ºäº†æ›´ç»†ç²’åº¦çš„å¯¹éšç§æ•°æ®è¿›è¡Œåˆ’åˆ†ï¼Œæˆæƒæ˜¯åœ¨è®¤è¯é€šè¿‡åå‘ç”Ÿçš„ï¼Œæ§åˆ¶ä¸åŒçš„ç”¨æˆ·èƒ½å¤Ÿè®¿é—®ä¸åŒçš„èµ„æºã€‚</p>
<h1 id="springsecurity">SpringSecurity</h1>
<p>Spring Securityæ˜¯ä¸€ä¸ªèƒ½å¤Ÿä¸ºåŸºäºSpringçš„ä¼ä¸šåº”ç”¨ç³»ç»Ÿæä¾›å£°æ˜å¼çš„å®‰å…¨è®¿é—®æ§åˆ¶è§£å†³æ–¹æ¡ˆçš„å®‰å…¨æ¡†æ¶ã€‚ç”±äºå®ƒæ˜¯Springç”Ÿæ€ç³»ç»Ÿä¸­çš„ä¸€å‘˜ï¼Œå› æ­¤å®ƒä¼´éšç€æ•´ä¸ªSpringç”Ÿæ€ç³»ç»Ÿä¸æ–­ä¿®æ­£ã€å‡çº§ï¼Œåœ¨spring booté¡¹ç›®ä¸­åŠ å…¥spring securityæ›´æ˜¯ååˆ†ç®€å•ï¼Œä½¿ç”¨Spring Security å‡å°‘äº†ä¸ºä¼ä¸šç³»ç»Ÿå®‰å…¨æ§åˆ¶ç¼–å†™å¤§é‡é‡å¤ä»£ç çš„å·¥ä½œã€‚</p>
<h2 id="å¿«é€Ÿä¸Šæ‰‹">å¿«é€Ÿä¸Šæ‰‹</h2>
<h3 id="å¼•å…¥æ‰€éœ€ä¾èµ–">å¼•å…¥æ‰€éœ€ä¾èµ–</h3>
<pre><code class="language-xml">        &lt;!-- spring security ä¾èµ– --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!-- webæ”¯æŒ --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;
</code></pre>
<h3 id="æ·»åŠ spring-security-é…ç½®ç±»">æ·»åŠ spring security é…ç½®ç±»</h3>
<pre><code class="language-java">package com.ldx.springboot.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.crypto.password.NoOpPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.provisioning.InMemoryUserDetailsManager;

/**
 * springsecurity é…ç½®ç±»
 * @author ludangxin
 * @Date 2020-06-01
 **/
@Configuration
@EnableGlobalMethodSecurity(securedEnabled = true,prePostEnabled = true)
public class WebSecurityConfig extends WebSecurityConfigurerAdapter {

    /**
     * å®šä¹‰ç”¨æˆ·ä¿¡æ¯æœåŠ¡ï¼ˆæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼‰
     */
    @Bean
    @Override
    public UserDetailsService userDetailsService(){
        //åŸºäºå†…å­˜çš„userDetail
        InMemoryUserDetailsManager manager = new InMemoryUserDetailsManager();
        //ç”¨æˆ·zhangsan æ‹¥æœ‰è®¿é—®p1èµ„æºæƒé™
        manager.createUser(User.withUsername(&quot;zhangsan&quot;).password(&quot;123&quot;).authorities(&quot;p1&quot;).build());
        //ç”¨æˆ·lisi æ‹¥æœ‰è®¿é—®p2èµ„æºæƒé™
        manager.createUser(User.withUsername(&quot;lisi&quot;).password(&quot;456&quot;).authorities(&quot;p2&quot;).build());
        return manager;
    }

    /**
     * å¯†ç ç¼–ç å™¨
     */
    @Bean
    public PasswordEncoder passwordEncoder(){
        //æ— åŠ å¯†æœºåˆ¶
        return NoOpPasswordEncoder.getInstance();
    }

    /**
     * å®‰å…¨æ‹¦æˆªæœºåˆ¶ï¼ˆæœ€é‡è¦ï¼‰
     */
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.authorizeRequests()
                .antMatchers(&quot;/r/r1&quot;).hasAuthority(&quot;p1&quot;)
                .antMatchers(&quot;/r/r2&quot;).hasAuthority(&quot;p2&quot;)
                //æ‰€æœ‰çš„è¯·æ±‚å¿…é¡»é€šè¿‡è®¤è¯
                .anyRequest().authenticated()
                .and()
                //å…è®¸è¡¨å•ç™»å½•
                .formLogin()
                //è‡ªå®šä¹‰ç™»å½•æˆåŠŸçš„é¡µé¢åœ°å€
                .successForwardUrl(&quot;/login-success&quot;);
    }
}

</code></pre>
<h3 id="ç¼–å†™æµ‹è¯•æ¥å£">ç¼–å†™æµ‹è¯•æ¥å£</h3>
<pre><code class="language-java">import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class TestController {

    @RequestMapping(value = &quot;/login-success&quot;)
    public String loginSuccess(){
        return &quot; ç™»å½•æˆåŠŸ&quot;;
    }

    /**
     * æµ‹è¯•èµ„æº1
     * @return
     */
    @GetMapping(value = &quot;/r/r1&quot;)
    public String r1(){
        return &quot; è®¿é—®èµ„æº1&quot;;
    }

    /**
     * æµ‹è¯•èµ„æº2
     * @return
     */
    @GetMapping(value = &quot;/r/r2&quot;)
    public String r2(){
        return &quot; è®¿é—®èµ„æº2&quot;;
    }
}
</code></pre>
<h3 id="æµ‹è¯•">æµ‹è¯•</h3>
<ol>
<li>æµ‹è¯•ç™»é™†åŠŸèƒ½,è®¿é—® <code>localhost:8080</code><br>
<img src="http://blog.ludangxin.club/post-images/1591111117908.jpg" alt="" loading="lazy"></li>
<li>è¾“å…¥ è´¦å·:<code>zhangsan</code> å¯†ç : <code>123</code>ç™»é™†æˆåŠŸ<br>
<img src="http://blog.ludangxin.club/post-images/1591111121642.jpg" alt="" loading="lazy"></li>
<li>è®¿é—® <code>/r/r1</code>èµ„æº<br>
<img src="http://blog.ludangxin.club/post-images/1591111124609.jpg" alt="" loading="lazy"></li>
<li>è®¿é—®<code>r/r2</code>èµ„æº, 403æ— æƒé™<br>
<img src="http://blog.ludangxin.club/post-images/1591111127688.jpg" alt="" loading="lazy"></li>
</ol>
<h3 id="å°ç»“">å°ç»“</h3>
<p>é€šè¿‡å¿«é€Ÿä¸Šæ‰‹ï¼Œå’±ä»¬ä½¿ç”¨Spring Securityå®ç°äº†è®¤è¯å’Œæˆæƒï¼ŒSpring Securityæä¾›äº†åŸºäºè´¦å·å’Œå¯†ç çš„è®¤è¯æ–¹å¼ï¼Œé€šè¿‡å®‰å…¨é…ç½®å³å¯å®ç°è¯·æ±‚æ‹¦æˆªï¼ŒæˆæƒåŠŸèƒ½ï¼ŒSpring Securityèƒ½å®Œæˆçš„ä¸ä»…ä»…æ˜¯è¿™äº›ã€‚</p>
<h2 id="å·¥ä½œåŸç†">å·¥ä½œåŸç†</h2>
<h3 id="ç»“æ„æ€»è§ˆ">ç»“æ„æ€»è§ˆ</h3>
<p>Spring Securityæ‰€è§£å†³çš„é—®é¢˜å°±æ˜¯<strong>å®‰å…¨è®¿é—®æ§åˆ¶</strong>ï¼Œè€Œå®‰å…¨è®¿é—®æ§åˆ¶åŠŸèƒ½å…¶å®å°±æ˜¯å¯¹æ‰€æœ‰è¿›å…¥ç³»ç»Ÿçš„è¯·æ±‚è¿›è¡Œæ‹¦æˆªï¼Œæ ¡éªŒæ¯ä¸ªè¯·æ±‚æ˜¯å¦èƒ½å¤Ÿè®¿é—®å®ƒæ‰€æœŸæœ›çš„èµ„æºã€‚<br>
å½“åˆå§‹åŒ–Spring Securityæ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªåä¸º SpringSecurityFilterChain çš„Servletè¿‡æ»¤å™¨ï¼Œç±»å‹ä¸º org.springframework.security.web.FilterChainProxyï¼Œå®ƒå®ç°äº†javax.servlet.Filterï¼Œå› æ­¤å¤–éƒ¨çš„è¯·æ±‚ä¼šç»è¿‡æ­¤ç±»ï¼Œä¸‹å›¾æ˜¯Spring Securityè¿‡è™‘å™¨é“¾ç»“æ„å›¾ï¼š<br>
<img src="http://blog.ludangxin.club/post-images/1591111142292.jpg" alt="" loading="lazy"><br>
FilterChainProxyæ˜¯ä¸€ä¸ªä»£ç†ï¼ŒçœŸæ­£èµ·ä½œç”¨çš„æ˜¯FilterChainProxyä¸­SecurityFilterChainæ‰€åŒ…å«çš„å„ä¸ªFilterï¼ŒåŒæ—¶è¿™äº›Filterä½œä¸ºBeanè¢«Springç®¡ç†ï¼Œå®ƒä»¬æ˜¯Spring Securityæ ¸å¿ƒï¼Œå„æœ‰å„çš„èŒè´£ï¼Œä½†ä»–ä»¬å¹¶ä¸ç›´æ¥å¤„ç†ç”¨æˆ·çš„<strong>è®¤è¯</strong>ï¼Œä¹Ÿä¸ç›´æ¥å¤„ç†ç”¨æˆ·çš„<strong>æˆæƒ</strong>ï¼Œè€Œæ˜¯æŠŠå®ƒä»¬äº¤ç»™äº†è®¤è¯ç®¡ç†ï¼ˆAuthenticationManagerï¼‰å’Œå†³ç­–ç®¡ç†å™¨ï¼ˆAccessDecisionManagerï¼‰è¿›è¡Œå¤„ç†.<br>
ä¸‹é¢ä»‹ç»è¿‡æ»¤å™¨é“¾ä¸­ä¸»è¦çš„å‡ ä¸ªè¿‡æ»¤å™¨åŠå…¶ä½œç”¨ï¼š<br>
<img src="http://blog.ludangxin.club/post-images/1591111150999.jpg" alt="" loading="lazy"><br>
<strong>SecurityContextPersistenceFilter :</strong><br>
è¿™ä¸ªFilteræ˜¯æ•´ä¸ªæ‹¦æˆªè¿‡ç¨‹çš„å…¥å£å’Œå‡ºå£ï¼ˆä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªæ‹¦æˆªå™¨ï¼‰ï¼Œä¼šåœ¨è¯·æ±‚å¼€å§‹æ—¶ä»é…ç½®å¥½çš„ SecurityContextRepository ä¸­è·å– SecurityContextï¼Œç„¶åæŠŠå®ƒè®¾ç½®ç»™SecurityContextHolderã€‚åœ¨è¯·æ±‚å®Œæˆåå°† SecurityContextHolder æŒæœ‰çš„ SecurityContext å†ä¿å­˜åˆ°é…ç½®å¥½çš„ SecurityContextRepositoryï¼ŒåŒæ—¶æ¸…é™¤ securityContextHolder æ‰€æŒæœ‰çš„SecurityContextï¼›<br>
<strong>UsernamePasswordAuthenticationFilter :</strong><br>
ç”¨äºå¤„ç†æ¥è‡ªè¡¨å•æäº¤çš„è®¤è¯ã€‚è¯¥è¡¨å•å¿…é¡»æä¾›å¯¹åº”çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œå…¶å†…éƒ¨è¿˜æœ‰ç™»å½•æˆåŠŸæˆ–å¤±è´¥åè¿›è¡Œå¤„ç†çš„ AuthenticationSuccessHandler å’Œ AuthenticationFailureHandlerï¼Œè¿™äº›éƒ½å¯ä»¥æ ¹æ®éœ€æ±‚åšç›¸å…³æ”¹å˜ï¼›<br>
<strong>FilterSecurityInterceptor :</strong><br>
æ˜¯ç”¨äºä¿æŠ¤webèµ„æºçš„ï¼Œä½¿ç”¨AccessDecisionManagerå¯¹å½“å‰ç”¨æˆ·è¿›è¡Œæˆæƒè®¿é—®ï¼›<br>
<strong>ExceptionTranslationFilter :</strong><br>
èƒ½å¤Ÿæ•è·æ¥è‡ª FilterChain æ‰€æœ‰çš„å¼‚å¸¸ï¼Œå¹¶è¿›è¡Œå¤„ç†ã€‚ä½†æ˜¯å®ƒåªä¼šå¤„ç†ä¸¤ç±»å¼‚å¸¸ï¼šAuthenticationException å’Œ AccessDeniedExceptionï¼Œå…¶å®ƒçš„å¼‚å¸¸å®ƒä¼šç»§ç»­æŠ›å‡ºã€‚</p>
<h3 id="è®¤è¯">è®¤è¯</h3>
<h4 id="æµç¨‹">æµç¨‹</h4>
<figure data-type="image" tabindex="1"><img src="http://blog.ludangxin.club/post-images/1591111163947.jpg" alt="" loading="lazy"></figure>
<ol>
<li>ç”¨æˆ·æäº¤ç”¨æˆ·åã€å¯†ç è¢«SecurityFilterChainä¸­çš„ UsernamePasswordAuthenticationFilter è¿‡æ»¤å™¨è·å–åˆ°ï¼Œå°è£…ä¸ºè¯·æ±‚Authenticationï¼Œé€šå¸¸æƒ…å†µä¸‹æ˜¯UsernamePasswordAuthenticationTokenè¿™ä¸ªå®ç°ç±»ã€‚</li>
<li>ç„¶åè¿‡æ»¤å™¨å°†Authenticationæäº¤è‡³è®¤è¯ç®¡ç†å™¨ï¼ˆAuthenticationManagerï¼‰è¿›è¡Œè®¤è¯</li>
<li>è®¤è¯æˆåŠŸåï¼Œ AuthenticationManager èº«ä»½ç®¡ç†å™¨è¿”å›ä¸€ä¸ªè¢«å¡«å……æ»¡äº†ä¿¡æ¯çš„ï¼ˆåŒ…æ‹¬ä¸Šé¢æåˆ°çš„æƒé™ä¿¡æ¯ï¼Œèº«ä»½ä¿¡æ¯ï¼Œç»†èŠ‚ä¿¡æ¯ï¼Œä½†å¯†ç é€šå¸¸ä¼šè¢«ç§»é™¤ï¼‰ Authentication å®ä¾‹ã€‚</li>
<li>SecurityContextHolder å®‰å…¨ä¸Šä¸‹æ–‡å®¹å™¨å°†ç¬¬3æ­¥å¡«å……äº†ä¿¡æ¯çš„ Authentication ï¼Œé€šè¿‡SecurityContextHolder.getContext().setAuthentication(â€¦)æ–¹æ³•ï¼Œè®¾ç½®åˆ°å…¶ä¸­ã€‚å¯ä»¥çœ‹å‡ºAuthenticationManageræ¥å£ï¼ˆè®¤è¯ç®¡ç†å™¨ï¼‰æ˜¯è®¤è¯ç›¸å…³çš„æ ¸å¿ƒæ¥å£ï¼Œä¹Ÿæ˜¯å‘èµ·è®¤è¯çš„å‡ºå‘ç‚¹ï¼Œå®ƒ çš„å®ç°ç±»ä¸ºProviderManagerã€‚è€ŒSpring Securityæ”¯æŒå¤šç§è®¤è¯æ–¹å¼ï¼Œå› æ­¤ProviderManagerç»´æŠ¤ç€ä¸€ä¸ª List<AuthenticationProvider> åˆ—è¡¨ï¼Œå­˜æ”¾å¤šç§è®¤è¯æ–¹å¼ï¼Œæœ€ç»ˆå®é™…çš„è®¤è¯å·¥ä½œæ˜¯ç”± AuthenticationProviderå®Œæˆçš„ã€‚å’±ä»¬çŸ¥é“webè¡¨å•çš„å¯¹åº”çš„AuthenticationProviderå®ç°ç±»ä¸º DaoAuthenticationProviderï¼Œå®ƒçš„å†…éƒ¨åˆç»´æŠ¤ç€ä¸€ä¸ªUserDetailsServiceè´Ÿè´£UserDetailsçš„è·å–ã€‚æœ€ç»ˆAuthenticationProviderå°†UserDetailså¡«å……è‡³Authenticationã€‚</li>
</ol>
<h4 id="authenticationprovider">AuthenticationProvider</h4>
<p>é€šè¿‡å‰é¢çš„<strong>Spring Securityè®¤è¯æµç¨‹</strong>æˆ‘ä»¬å¾—çŸ¥ï¼Œè®¤è¯ç®¡ç†å™¨ï¼ˆAuthenticationManagerï¼‰å§”æ‰˜AuthenticationProviderå®Œæˆè®¤è¯å·¥ä½œã€‚<br>
AuthenticationProvideræ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<pre><code class="language-java">public interface AuthenticationProvider { 
    Authentication authenticate(Authentication authentication) throws AuthenticationException; 
    boolean supports(Class&lt;?&gt; var1); 
}
</code></pre>
<p><strong>authenticate</strong>()æ–¹æ³•å®šä¹‰äº†<strong>è®¤è¯çš„å®ç°è¿‡ç¨‹</strong>ï¼Œå®ƒçš„å‚æ•°æ˜¯ä¸€ä¸ªAuthenticationï¼Œé‡Œé¢åŒ…å«äº†ç™»å½•ç”¨æˆ·æ‰€æäº¤çš„ç”¨æˆ·ã€å¯†ç ç­‰ã€‚è€Œè¿”å›å€¼ä¹Ÿæ˜¯ä¸€ä¸ªAuthenticationï¼Œè¿™ä¸ªAuthenticationåˆ™æ˜¯åœ¨è®¤è¯æˆåŠŸåï¼Œå°†ç”¨æˆ·çš„æƒé™åŠå…¶ä»–ä¿¡æ¯é‡æ–°ç»„è£…åç”Ÿæˆã€‚<br>
Spring Securityä¸­ç»´æŠ¤ç€ä¸€ä¸ª List<AuthenticationProvider> åˆ—è¡¨ï¼Œå­˜æ”¾å¤šç§è®¤è¯æ–¹å¼ï¼Œä¸åŒçš„è®¤è¯æ–¹å¼ä½¿ç”¨ä¸åŒçš„AuthenticationProviderã€‚å¦‚ä½¿ç”¨ç”¨æˆ·åå¯†ç ç™»å½•æ—¶ï¼Œä½¿ç”¨AuthenticationProvider1ï¼ŒçŸ­ä¿¡ç™»å½•æ—¶ä½¿ç”¨AuthenticationProvider2ç­‰ç­‰è¿™æ ·çš„ä¾‹å­å¾ˆå¤šã€‚<br>
æ¯ä¸ªAuthenticationProvideréœ€è¦å®ç°<strong>supports()<strong>æ–¹æ³•æ¥è¡¨æ˜è‡ªå·±æ”¯æŒçš„è®¤è¯æ–¹å¼ï¼Œå¦‚æˆ‘ä»¬ä½¿ç”¨è¡¨å•æ–¹å¼è®¤è¯ï¼Œåœ¨æäº¤è¯·æ±‚æ—¶Spring Securityä¼šç”ŸæˆUsernamePasswordAuthenticationTokenï¼Œå®ƒæ˜¯ä¸€ä¸ªAuthenticationï¼Œé‡Œé¢å°è£…ç€ç”¨æˆ·æäº¤çš„ç”¨æˆ·åã€å¯†ç ä¿¡æ¯ã€‚è€Œå¯¹åº”çš„ï¼Œå“ªä¸ªAuthenticationProvideræ¥å¤„ç†å®ƒï¼Ÿ<br>
æˆ‘ä»¬åœ¨</strong>DaoAuthenticationProvider</strong>çš„åŸºç±»AbstractUserDetailsAuthenticationProviderå‘ç°ä»¥ä¸‹ä»£ç ï¼š</p>
<pre><code class="language-java">public boolean supports(Class&lt;?&gt; authentication) { 
    return UsernamePasswordAuthenticationToken.class.isAssignableFrom(authentication);
}
</code></pre>
<p><strong>ä¹Ÿå°±æ˜¯è¯´å½“webè¡¨å•æäº¤ç”¨æˆ·åå¯†ç æ—¶ï¼ŒSpring Securityç”±DaoAuthenticationProviderå¤„ç†ã€‚</strong><br>
æœ€åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹<strong>Authentication</strong>(è®¤è¯ä¿¡æ¯)çš„ç»“æ„ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ¥å£ï¼Œæˆ‘ä»¬ä¹‹å‰æåˆ°çš„<br>
UsernamePasswordAuthenticationTokenå°±æ˜¯å®ƒçš„å®ç°ä¹‹ä¸€ï¼š</p>
<pre><code class="language-java">public interface Authentication extends Principal, Serializable { 
    Collection&lt;? extends GrantedAuthority&gt; getAuthorities(); 
    Object getCredentials(); 
    Object getDetails(); 
    Object getPrincipal();
    boolean isAuthenticated(); 
    void setAuthenticated(boolean var1) throws IllegalArgumentException; 
}
</code></pre>
<ol>
<li>Authenticationæ˜¯spring securityåŒ…ä¸­çš„æ¥å£ï¼Œç›´æ¥ç»§æ‰¿è‡ªPrincipalç±»ï¼Œè€ŒPrincipalæ˜¯ä½äº java.securityåŒ…ä¸­çš„ã€‚å®ƒæ˜¯è¡¨ç¤ºç€ä¸€ä¸ªæŠ½è±¡ä¸»ä½“èº«ä»½ï¼Œä»»ä½•ä¸»ä½“éƒ½æœ‰ä¸€ä¸ªåç§°ï¼Œå› æ­¤åŒ…å«ä¸€ä¸ªgetName()æ–¹æ³•ã€‚</li>
<li>getAuthorities()ï¼Œæƒé™ä¿¡æ¯åˆ—è¡¨ï¼Œé»˜è®¤æ˜¯GrantedAuthorityæ¥å£çš„ä¸€äº›å®ç°ç±»ï¼Œé€šå¸¸æ˜¯ä»£è¡¨æƒé™ä¿¡æ¯çš„ä¸€ç³»åˆ—å­—ç¬¦ä¸²ã€‚</li>
<li>getCredentials()ï¼Œå‡­è¯ä¿¡æ¯ï¼Œç”¨æˆ·è¾“å…¥çš„å¯†ç å­—ç¬¦ä¸²ï¼Œåœ¨è®¤è¯è¿‡åé€šå¸¸ä¼šè¢«ç§»é™¤ï¼Œç”¨äºä¿éšœå®‰å…¨ã€‚</li>
<li>getDetails()ï¼Œç»†èŠ‚ä¿¡æ¯ï¼Œwebåº”ç”¨ä¸­çš„å®ç°æ¥å£é€šå¸¸ä¸º WebAuthenticationDetailsï¼Œå®ƒè®°å½•äº†è®¿é—®è€…çš„ipåœ°å€å’ŒsessionIdçš„å€¼ã€‚</li>
<li><strong>getPrincipal()</strong>ï¼Œèº«ä»½ä¿¡æ¯ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹è¿”å›çš„æ˜¯UserDetailsæ¥å£çš„å®ç°ç±»ï¼ŒUserDetailsä»£è¡¨ç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯ï¼Œé‚£ä»Authenticationä¸­å–å‡ºæ¥çš„UserDetailså°±æ˜¯å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼Œå®ƒä¹Ÿæ˜¯æ¡†æ¶ä¸­çš„å¸¸ç”¨æ¥å£ä¹‹ä¸€ã€‚</li>
</ol>
<h4 id="userdetailsservice">UserDetailsService</h4>
<ol>
<li>è®¤è¯†UserDetailsService<br>
ç°åœ¨å’±ä»¬ç°åœ¨çŸ¥é“DaoAuthenticationProviderå¤„ç†äº†webè¡¨å•çš„è®¤è¯é€»è¾‘ï¼Œè®¤è¯æˆåŠŸåæ—¢å¾—åˆ°ä¸€ä¸ª Authentication(UsernamePasswordAuthenticationTokenå®ç°)ï¼Œé‡Œé¢åŒ…å«äº†èº«ä»½ä¿¡æ¯ï¼ˆPrincipalï¼‰ã€‚è¿™ä¸ªèº«ä»½ä¿¡æ¯å°±æ˜¯ä¸€ä¸ª Object ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹å®ƒå¯ä»¥è¢«å¼ºè½¬ä¸ºUserDetailså¯¹è±¡ã€‚ DaoAuthenticationProviderä¸­åŒ…å«äº†ä¸€ä¸ªUserDetailsServiceå®ä¾‹ï¼Œå®ƒè´Ÿè´£æ ¹æ®ç”¨æˆ·åæå–ç”¨æˆ·ä¿¡æ¯UserDetails(åŒ…å«å¯†ç )ï¼Œè€ŒåDaoAuthenticationProviderä¼šå»å¯¹æ¯”UserDetailsServiceæå–çš„ç”¨æˆ·å¯†ç ä¸ç”¨æˆ·æäº¤çš„å¯†ç æ˜¯å¦åŒ¹é…ä½œä¸ºè®¤è¯æˆåŠŸçš„å…³é”®ä¾æ®ï¼Œå› æ­¤å¯ä»¥é€šè¿‡å°†è‡ªå®šä¹‰çš„ UserDetailsService å…¬å¼€ä¸ºspring beanæ¥å®šä¹‰è‡ªå®šä¹‰èº«ä»½éªŒè¯ã€‚</li>
</ol>
<pre><code class="language-java">public interface UserDetailsService { 
    UserDetails loadUserByUsername(String username) throws UsernameNotFoundException; 
}
</code></pre>
<p>å¾ˆå¤šäººæŠŠDaoAuthenticationProviderå’ŒUserDetailsServiceçš„èŒè´£ææ··æ·†ï¼Œå…¶å®UserDetailsServiceåªè´Ÿè´£ä»ç‰¹å®šçš„åœ°æ–¹ï¼ˆé€šå¸¸æ˜¯æ•°æ®åº“ï¼‰åŠ è½½ç”¨æˆ·ä¿¡æ¯ï¼Œä»…æ­¤è€Œå·²ã€‚è€ŒDaoAuthenticationProviderçš„èŒè´£æ›´å¤§ï¼Œå®ƒå®Œæˆå®Œæ•´çš„è®¤è¯æµç¨‹ï¼ŒåŒæ—¶ä¼šæŠŠUserDetailså¡«å……è‡³Authenticationã€‚ä¸Šé¢ä¸€ç›´æåˆ°UserDetailsæ˜¯ç”¨æˆ·ä¿¡æ¯ï¼Œå’±ä»¬çœ‹ä¸€ä¸‹å®ƒçš„çœŸé¢ç›®ï¼š</p>
<pre><code class="language-java">public interface UserDetails extends Serializable { 
    Collection&lt;? extends GrantedAuthority&gt; getAuthorities(); 
    String getPassword(); 
    String getUsername();
    boolean isAccountNonExpired(); 
    boolean isAccountNonLocked(); 
    boolean isCredentialsNonExpired();
    boolean isEnabled(); 
}
</code></pre>
<p>å®ƒå’ŒAuthenticationæ¥å£å¾ˆç±»ä¼¼ï¼Œæ¯”å¦‚å®ƒä»¬éƒ½æ‹¥æœ‰usernameï¼Œauthoritiesã€‚Authenticationçš„getCredentials()ä¸UserDetailsä¸­çš„getPassword()éœ€è¦è¢«åŒºåˆ†å¯¹å¾…ï¼Œå‰è€…æ˜¯ç”¨æˆ·æäº¤çš„å¯†ç å‡­è¯ï¼Œåè€…æ˜¯ç”¨æˆ·å®é™…å­˜å‚¨çš„å¯†ç ï¼Œè®¤è¯å…¶å®å°±æ˜¯å¯¹è¿™ä¸¤è€…çš„æ¯”å¯¹ã€‚Authenticationä¸­çš„getAuthorities()å®é™…æ˜¯ç”±UserDetailsçš„getAuthorities()ä¼ é€’è€Œå½¢æˆçš„ã€‚è¿˜è®°å¾—Authenticationæ¥å£ä¸­çš„getDetails()æ–¹æ³•å—ï¼Ÿå…¶ä¸­çš„UserDetailsç”¨æˆ·è¯¦ç»†ä¿¡æ¯ä¾¿æ˜¯ç»è¿‡äº†AuthenticationProviderè®¤è¯ä¹‹åè¢«å¡«å……çš„ã€‚ é€šè¿‡å®ç°UserDetailsServiceå’ŒUserDetailsï¼Œæˆ‘ä»¬å¯ä»¥å®Œæˆå¯¹ç”¨æˆ·ä¿¡æ¯è·å–æ–¹å¼ä»¥åŠç”¨æˆ·ä¿¡æ¯å­—æ®µçš„æ‰©å±•ã€‚<br>
Spring Securityæä¾›çš„InMemoryUserDetailsManager(å†…å­˜è®¤è¯)ï¼ŒJdbcUserDetailsManager(jdbcè®¤è¯)å°±æ˜¯UserDetailsServiceçš„å®ç°ç±»ï¼Œä¸»è¦åŒºåˆ«æ— éå°±æ˜¯ä»å†…å­˜è¿˜æ˜¯ä»æ•°æ®åº“åŠ è½½ç”¨æˆ·ã€‚<br>
2. è‡ªå®šä¹‰UserDetailsService</p>
<pre><code class="language-java">@Service 
public class SpringDataUserDetailsService implements UserDetailsService { 
    @Override 
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException { 
        //ç™»å½•è´¦å· 
        System.out.println(&quot;username=&quot;+username); 
        //æ ¹æ®è´¦å·å»æ•°æ®åº“æŸ¥è¯¢... 
        //è¿™é‡Œæš‚æ—¶ä½¿ç”¨é™æ€æ•°æ® 
        UserDetails userDetails = User.withUsername(username).password(&quot;123&quot;).authorities(&quot;p1&quot;).build(); return userDetails; 
    } 
}
</code></pre>
<h4 id="passwordencoder">PasswordEncoder</h4>
<ol>
<li>è®¤è¯†PasswordEncoder<br>
DaoAuthenticationProviderè®¤è¯å¤„ç†å™¨é€šè¿‡UserDetailsServiceè·å–åˆ°UserDetailsåï¼Œå®ƒæ˜¯å¦‚ä½•ä¸è¯·æ±‚Authenticationä¸­çš„å¯†ç åšå¯¹æ¯”å‘¢ï¼Ÿ<br>
åœ¨è¿™é‡ŒSpring Securityä¸ºäº†é€‚åº”å¤šç§å¤šæ ·çš„åŠ å¯†ç±»å‹ï¼Œåˆåšäº†æŠ½è±¡ï¼ŒDaoAuthenticationProvideré€šè¿‡PasswordEncoderæ¥å£çš„matchesæ–¹æ³•è¿›è¡Œå¯†ç çš„å¯¹æ¯”ï¼Œè€Œå…·ä½“çš„å¯†ç å¯¹æ¯”ç»†èŠ‚å–å†³äºå®ç°ï¼š</li>
</ol>
<pre><code class="language-java">public interface PasswordEncoder { 
    String encode(CharSequence var1);
    boolean matches(CharSequence var1, String var2); 
    default boolean upgradeEncoding(String encodedPassword) { 
        return false; 
    } 
}
</code></pre>
<p>è€ŒSpring Securityæä¾›å¾ˆå¤šå†…ç½®çš„PasswordEncoderï¼Œèƒ½å¤Ÿå¼€ç®±å³ç”¨ï¼Œä½¿ç”¨æŸç§PasswordEncoderåªéœ€è¦è¿›è¡Œå¦‚ä¸‹å£°æ˜å³å¯ï¼Œå¦‚ä¸‹ï¼š</p>
<pre><code class="language-java">@Bean 
public PasswordEncoder passwordEncoder() { 
    //NoOpPasswordEncoderé‡‡ç”¨å­—ç¬¦ä¸²åŒ¹é…æ–¹æ³•ï¼Œä¸å¯¹å¯†ç è¿›è¡ŒåŠ å¯†æ¯”è¾ƒå¤„ç†
    return NoOpPasswordEncoder.getInstance(); 
}
</code></pre>
<ol start="2">
<li>å¯†ç æ¯”è¾ƒæµç¨‹å¦‚ä¸‹
<ol>
<li>ç”¨æˆ·è¾“å…¥å¯†ç ï¼ˆæ˜æ–‡ ï¼‰</li>
<li>DaoAuthenticationProviderè·å–UserDetailsï¼ˆå…¶ä¸­å­˜å‚¨äº†ç”¨æˆ·çš„æ­£ç¡®å¯†ç ï¼‰</li>
<li>DaoAuthenticationProviderä½¿ç”¨PasswordEncoderå¯¹è¾“å…¥çš„å¯†ç å’Œæ­£ç¡®çš„å¯†ç è¿›è¡Œæ ¡éªŒï¼Œå¯†ç ä¸€è‡´åˆ™æ ¡éªŒé€šè¿‡ï¼Œå¦åˆ™æ ¡éªŒå¤±è´¥ã€‚<br>
NoOpPasswordEncoderçš„æ ¡éªŒè§„åˆ™æ‹¿ è¾“å…¥çš„å¯†ç å’ŒUserDetailsä¸­çš„æ­£ç¡®å¯†ç è¿›è¡Œå­—ç¬¦ä¸²æ¯”è¾ƒï¼Œå­—ç¬¦ä¸²å†…å®¹ä¸€è‡´åˆ™æ ¡éªŒé€šè¿‡ï¼Œå¦åˆ™ æ ¡éªŒå¤±è´¥ã€‚<br>
å®é™…é¡¹ç›®ä¸­æ¨èä½¿ç”¨BCryptPasswordEncoder, Pbkdf2PasswordEncoder, SCryptPasswordEncoderç­‰ï¼Œæ„Ÿå…´è¶£çš„å¤§å®¶å¯ä»¥çœ‹çœ‹è¿™äº›PasswordEncoderçš„å…·ä½“å®ç°ã€‚</li>
</ol>
</li>
<li>ä½¿ç”¨BCryptPasswordEncoder
<ol>
<li>é…ç½®BCryptPasswordEncoder<br>
åœ¨å®‰å…¨é…ç½®ç±»ä¸­å®šä¹‰ï¼š</li>
</ol>
</li>
</ol>
<pre><code class="language-java">@Bean 
public PasswordEncoder passwordEncoder() { 
    return new BCryptPasswordEncoder(); 
}
</code></pre>
<p>æµ‹è¯•å‘ç°è®¤è¯å¤±è´¥ï¼Œæç¤ºï¼š<code>Encoded password does not look like BCrypt</code>ã€‚<br>
åŸå› ï¼š<br>
ç”±äºUserDetailsä¸­å­˜å‚¨çš„æ˜¯åŸå§‹å¯†ç ï¼ˆæ¯”å¦‚ï¼š123ï¼‰ï¼Œå®ƒä¸æ˜¯BCryptæ ¼å¼ã€‚è·Ÿè¸ª DaoAuthenticationProviderç¬¬33è¡Œä»£ç æŸ¥çœ‹ userDetailsä¸­çš„å†…å®¹ ï¼Œè·Ÿè¸ªç¬¬38è¡Œä»£ç æŸ¥çœ‹PasswordEncoderçš„ç±»å‹ã€‚<br>
â€‹	2. æµ‹è¯•BCrypt<br>
é€šè¿‡ä¸‹è¾¹çš„ä»£ç æµ‹è¯•BCryptåŠ å¯†åŠæ ¡éªŒçš„æ–¹æ³•<br>
ç¼–å†™æµ‹è¯•æ–¹æ³•ï¼š</p>
<pre><code class="language-java">@RunWith(SpringRunner.class) 
public class TestBCrypt {
    @Test
    public void test1(){ 
        //å¯¹åŸå§‹å¯†ç åŠ å¯† 
        String hashpw = BCrypt.hashpw(&quot;123&quot;,BCrypt.gensalt()); 
        System.out.println(hashpw);
        //æ ¡éªŒåŸå§‹å¯†ç å’ŒBCryptå¯†ç æ˜¯å¦ä¸€è‡´ 
        boolean checkpw = BCrypt.checkpw(&quot;123&quot;, &quot;$2a$10$NlBC84MVb7F95EXYTXwLneXgCca6/GipyWR5NHm8K0203bSQMLpvm&quot;); 
        System.out.println(checkpw); 
    } 
}
</code></pre>
<h3 id="æˆæƒ">æˆæƒ</h3>
<h4 id="æµç¨‹-2">æµç¨‹</h4>
<p>é€šè¿‡<strong>å¿«é€Ÿä¸Šæ‰‹</strong>æˆ‘ä»¬çŸ¥é“ï¼ŒSpring Securityå¯ä»¥é€šè¿‡ http.authorizeRequests() å¯¹webè¯·æ±‚è¿›è¡Œæˆæƒä¿æŠ¤ã€‚Spring Securityä½¿ç”¨æ ‡å‡†Filterå»ºç«‹äº†å¯¹webè¯·æ±‚çš„æ‹¦æˆªï¼Œæœ€ç»ˆå®ç°å¯¹èµ„æºçš„æˆæƒè®¿é—®ã€‚<br>
Spring Securityçš„æˆæƒæµç¨‹å¦‚ä¸‹ï¼š<br>
<img src="http://blog.ludangxin.club/post-images/1591111185336.jpg" alt="" loading="lazy"></p>
<ol>
<li><strong>æ‹¦æˆªè¯·æ±‚</strong>ï¼Œå·²è®¤è¯ç”¨æˆ·è®¿é—®å—ä¿æŠ¤çš„webèµ„æºå°†è¢«SecurityFilterChainä¸­çš„ FilterSecurityInterceptor çš„å­ç±»æ‹¦æˆªã€‚</li>
<li><strong>è·å–èµ„æºè®¿é—®ç­–ç•¥</strong>ï¼ŒFilterSecurityInterceptorä¼šä» SecurityMetadataSource çš„å­ç±» DefaultFilterInvocationSecurityMetadataSource è·å–è¦è®¿é—®å½“å‰èµ„æºæ‰€éœ€è¦çš„æƒé™Collection<ConfigAttribute> ã€‚ SecurityMetadataSourceå…¶å®å°±æ˜¯è¯»å–è®¿é—®ç­–ç•¥çš„æŠ½è±¡ï¼Œè€Œè¯»å–çš„å†…å®¹ï¼Œå…¶å®å°±æ˜¯æˆ‘ä»¬é…ç½®çš„è®¿é—®è§„åˆ™ï¼Œ è¯» å–è®¿é—®ç­–ç•¥å¦‚ï¼š</li>
</ol>
<pre><code class="language-java">http.authorizeRequests() 
    .antMatchers(&quot;/r/r1&quot;).hasAuthority(&quot;p1&quot;) 
    .antMatchers(&quot;/r/r2&quot;).hasAuthority(&quot;p2&quot;) ...
</code></pre>
<ol start="3">
<li>æœ€åï¼ŒFilterSecurityInterceptorä¼šè°ƒç”¨ AccessDecisionManager è¿›è¡Œæˆæƒå†³ç­–ï¼Œè‹¥å†³ç­–é€šè¿‡ï¼Œåˆ™å…è®¸è®¿é—®èµ„æºï¼Œå¦åˆ™å°†ç¦æ­¢è®¿é—®ã€‚<br>
AccessDecisionManagerï¼ˆè®¿é—®å†³ç­–ç®¡ç†å™¨ï¼‰çš„æ ¸å¿ƒæ¥å£å¦‚ä¸‹:</li>
</ol>
<pre><code class="language-java">public interface AccessDecisionManager { 
    /** * é€šè¿‡ä¼ é€’çš„å‚æ•°æ¥å†³å®šç”¨æˆ·æ˜¯å¦æœ‰è®¿é—®å¯¹åº”å—ä¿æŠ¤èµ„æºçš„æƒé™ */
    void decide(Authentication authentication , Object object, Collection&lt;ConfigAttribute&gt; configAttributes ) throws AccessDeniedException, InsufficientAuthenticationException;
    //ç•¥.. 
}
</code></pre>
<p>è¿™é‡Œç€é‡è¯´æ˜ä¸€ä¸‹decideçš„å‚æ•°ï¼š<br>
authenticationï¼šè¦è®¿é—®èµ„æºçš„è®¿é—®è€…çš„èº«ä»½<br>
objectï¼šè¦è®¿é—®çš„å—ä¿æŠ¤èµ„æºï¼Œwebè¯·æ±‚å¯¹åº”FilterInvocation<br>
confifigAttributesï¼šæ˜¯å—ä¿æŠ¤èµ„æºçš„è®¿é—®ç­–ç•¥ï¼Œé€šè¿‡SecurityMetadataSourceè·å–ã€‚<br>
<strong>decideæ¥å£å°±æ˜¯ç”¨æ¥é‰´å®šå½“å‰ç”¨æˆ·æ˜¯å¦æœ‰è®¿é—®å¯¹åº”å—ä¿æŠ¤èµ„æºçš„æƒé™ã€‚</strong></p>
<h4 id="æˆæƒå†³ç­–">æˆæƒå†³ç­–</h4>
<p>AccessDecisionManageré‡‡ç”¨<strong>æŠ•ç¥¨</strong>çš„æ–¹å¼æ¥ç¡®å®šæ˜¯å¦èƒ½å¤Ÿè®¿é—®å—ä¿æŠ¤èµ„æºã€‚<br>
AccessDecisionManagerä¸­åŒ…å«çš„ä¸€ç³»åˆ—AccessDecisionVoterå°†ä¼šè¢«ç”¨æ¥å¯¹Authenticationæ˜¯å¦æœ‰æƒè®¿é—®å—ä¿æŠ¤å¯¹è±¡è¿›è¡ŒæŠ•ç¥¨ï¼ŒAccessDecisionManageræ ¹æ®æŠ•ç¥¨ç»“æœï¼Œåšå‡ºæœ€ç»ˆå†³ç­–ã€‚<br>
AccessDecisionVoteræ˜¯ä¸€ä¸ªæ¥å£ï¼Œå…¶ä¸­å®šä¹‰æœ‰ä¸‰ä¸ªæ–¹æ³•ï¼Œå…·ä½“ç»“æ„å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<pre><code class="language-java">public interface AccessDecisionVoter&lt;S&gt; { 
    int ACCESS_GRANTED = 1; 
    int ACCESS_ABSTAIN = 0; 
    int ACCESS_DENIED = â€1; 
    boolean supports(ConfigAttribute var1); 
    boolean supports(Class&lt;?&gt; var1); 
    int vote(Authentication var1, S var2, Collection&lt;ConfigAttribute&gt; var3); 
}
</code></pre>
<p>vote()æ–¹æ³•çš„è¿”å›ç»“æœä¼šæ˜¯AccessDecisionVoterä¸­å®šä¹‰çš„ä¸‰ä¸ªå¸¸é‡ä¹‹ä¸€ã€‚ACCESS_GRANTEDè¡¨ç¤ºåŒæ„ï¼ŒACCESS_DENIEDè¡¨ç¤ºæ‹’ç»ï¼ŒACCESS_ABSTAINè¡¨ç¤ºå¼ƒæƒã€‚å¦‚æœä¸€ä¸ªAccessDecisionVoterä¸èƒ½åˆ¤å®šå½“å‰Authenticationæ˜¯å¦æ‹¥æœ‰è®¿é—®å¯¹åº”å—ä¿æŠ¤å¯¹è±¡çš„æƒé™ï¼Œåˆ™å…¶vote()æ–¹æ³•çš„è¿”å›å€¼åº”å½“ä¸ºå¼ƒæƒACCESS_ABSTAINã€‚<br>
Spring Securityå†…ç½®äº†ä¸‰ä¸ªåŸºäºæŠ•ç¥¨çš„AccessDecisionManagerå®ç°ç±»å¦‚ä¸‹ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯<br>
<strong>AffirmativeBased</strong>ã€<strong>ConsensusBased</strong>å’Œ<strong>UnanimousBased</strong>ï¼Œ<strong>Spring securityé»˜è®¤ä½¿ç”¨çš„æ˜¯AffirmativeBasedã€‚</strong></p>
<p><strong>AffirmativeBased</strong>ï¼š</p>
<ol>
<li>åªè¦æœ‰AccessDecisionVoterçš„æŠ•ç¥¨ä¸ºACCESS_GRANTEDåˆ™åŒæ„ç”¨æˆ·è¿›è¡Œè®¿é—®ï¼›</li>
<li>å¦‚æœå…¨éƒ¨å¼ƒæƒä¹Ÿè¡¨ç¤ºé€šè¿‡ï¼›</li>
<li>å¦‚æœæ²¡æœ‰ä¸€ä¸ªäººæŠ•èµæˆç¥¨ï¼Œä½†æ˜¯æœ‰äººæŠ•åå¯¹ç¥¨ï¼Œåˆ™å°†æŠ›å‡ºAccessDeniedExceptionã€‚</li>
</ol>
<p><strong>ConsensusBased</strong>ï¼š</p>
<ol>
<li>å¦‚æœèµæˆç¥¨å¤šäºåå¯¹ç¥¨åˆ™è¡¨ç¤ºé€šè¿‡ã€‚</li>
<li>åè¿‡æ¥ï¼Œå¦‚æœåå¯¹ç¥¨å¤šäºèµæˆç¥¨åˆ™å°†æŠ›å‡ºAccessDeniedExceptionã€‚</li>
<li>å¦‚æœèµæˆç¥¨ä¸åå¯¹ç¥¨ç›¸åŒä¸”ä¸ç­‰äº0ï¼Œå¹¶ä¸”å±æ€§allowIfEqualGrantedDeniedDecisionsçš„å€¼ä¸ºtrueï¼Œåˆ™è¡¨ç¤ºé€šè¿‡ï¼Œå¦åˆ™å°†æŠ›å‡ºå¼‚å¸¸AccessDeniedExceptionã€‚å‚æ•°allowIfEqualGrantedDeniedDecisionsçš„å€¼é»˜è®¤ä¸ºtrueã€‚</li>
<li>å¦‚æœæ‰€æœ‰çš„AccessDecisionVoteréƒ½å¼ƒæƒäº†ï¼Œåˆ™å°†è§†å‚æ•°allowIfAllAbstainDecisionsçš„å€¼è€Œå®šï¼Œå¦‚æœè¯¥å€¼ä¸ºtrueåˆ™è¡¨ç¤ºé€šè¿‡ï¼Œå¦åˆ™å°†æŠ›å‡ºå¼‚å¸¸AccessDeniedExceptionã€‚å‚æ•°allowIfAllAbstainDecisionsçš„å€¼é»˜è®¤ä¸ºfalseã€‚</li>
</ol>
<p><strong>UnanimousBased</strong>:<br>
UnanimousBasedä¸å¦å¤–ä¸¤ç§å®ç°æœ‰ç‚¹ä¸ä¸€æ ·ï¼Œå¦å¤–ä¸¤ç§ä¼šä¸€æ¬¡æ€§æŠŠå—ä¿æŠ¤å¯¹è±¡çš„é…ç½®å±æ€§å…¨éƒ¨ä¼ é€’ç»™AccessDecisionVoterè¿›è¡ŒæŠ•ç¥¨ï¼Œè€ŒUnanimousBasedä¼šä¸€æ¬¡åªä¼ é€’ä¸€ä¸ªConfifigAttributeç»™AccessDecisionVoterè¿›è¡ŒæŠ•ç¥¨ã€‚è¿™ä¹Ÿå°±æ„å‘³ç€å¦‚æœæˆ‘ä»¬çš„AccessDecisionVoterçš„é€»è¾‘æ˜¯åªè¦ä¼ é€’è¿›æ¥çš„ ConfifigAttributeä¸­æœ‰ä¸€ä¸ªèƒ½å¤ŸåŒ¹é…åˆ™æŠ•èµæˆç¥¨ï¼Œä½†æ˜¯æ”¾åˆ°UnanimousBasedä¸­å…¶æŠ•ç¥¨ç»“æœå°±ä¸ä¸€å®šæ˜¯èµæˆäº†ã€‚</p>
<ol>
<li>å¦‚æœå—ä¿æŠ¤å¯¹è±¡é…ç½®çš„æŸä¸€ä¸ªConfifigAttributeè¢«ä»»æ„çš„AccessDecisionVoteråå¯¹äº†ï¼Œåˆ™å°†æŠ›å‡ºAccessDeniedExceptionã€‚</li>
<li>å¦‚æœæ²¡æœ‰åå¯¹ç¥¨ï¼Œä½†æ˜¯æœ‰èµæˆç¥¨ï¼Œåˆ™è¡¨ç¤ºé€šè¿‡ã€‚</li>
<li>å¦‚æœå…¨éƒ¨å¼ƒæƒäº†ï¼Œåˆ™å°†è§†å‚æ•°allowIfAllAbstainDecisionsçš„å€¼è€Œå®šï¼Œtrueåˆ™é€šè¿‡ï¼Œfalseåˆ™æŠ›å‡º AccessDeniedExceptionã€‚<br>
Spring Securityä¹Ÿå†…ç½®ä¸€äº›æŠ•ç¥¨è€…å®ç°ç±»å¦‚<strong>RoleVoter</strong>ã€<strong>AuthenticatedVoter</strong>å’Œ<strong>WebExpressionVoter</strong>ç­‰ã€‚</li>
</ol>
<h2 id="è‡ªå®šä¹‰è®¤è¯">è‡ªå®šä¹‰è®¤è¯</h2>
<h3 id="åˆ›å»ºæ•°æ®åº“è¡¨">åˆ›å»ºæ•°æ®åº“è¡¨</h3>
<pre><code class="language-sql">CREATE DATABASE `test` CHARACTER SET 'utf8' COLLATE 'utf8_general_ci';
CREATE TABLE `t_user` ( 
    `id` bigint(20) NOT NULL COMMENT 'ç”¨æˆ·id', 
    `username` varchar(64) NOT NULL, 
    `password` varchar(64) NOT NULL, 
    `fullname` varchar(255) NOT NULL COMMENT 'ç”¨æˆ·å§“å', 
    `mobile` varchar(11) DEFAULT NULL COMMENT 'æ‰‹æœºå·', 
    PRIMARY KEY (`id`) USING BTREE 
) ENGINE=InnoDB DEFAULT CHARSET=utf8 ROW_FORMAT=DYNAMIC
</code></pre>
<h3 id="æ·»åŠ æ‰€éœ€ä¾èµ–">æ·»åŠ æ‰€éœ€ä¾èµ–</h3>
<pre><code class="language-xml">        &lt;!-- spring security ä¾èµ– --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!-- webæ”¯æŒ --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!-- mysqlä¾èµ– --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;mysql&lt;/groupId&gt;
            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
            &lt;version&gt;5.1.47&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!-- mybatis --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;
            &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;
            &lt;version&gt;2.1.1&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!-- lombok å·¥å…·--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
            &lt;artifactId&gt;lombok&lt;/artifactId&gt;
            &lt;optional&gt;true&lt;/optional&gt;
        &lt;/dependency&gt;
        &lt;!-- å•å…ƒæµ‹è¯• --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
            &lt;exclusions&gt;
                &lt;exclusion&gt;
                    &lt;groupId&gt;org.junit.vintage&lt;/groupId&gt;
                    &lt;artifactId&gt;junit-vintage-engine&lt;/artifactId&gt;
                &lt;/exclusion&gt;
            &lt;/exclusions&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;junit&lt;/groupId&gt;
            &lt;artifactId&gt;junit&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
</code></pre>
<h3 id="é…ç½®applicationyml">é…ç½®application.yml</h3>
<pre><code class="language-yaml">spring:
  datasource:
    type: com.zaxxer.hikari.HikariDataSource
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/test?useUnicode=true&amp;zeroDateTimeBehavior=convertToNull&amp;autoReconnect=true&amp;characterEncoding=utf-8
    username: root
    password: root
    hikari:
      minimum-idle: 5
      idle-timeout: 600000
      maximum-pool-size: 10
      auto-commit: true
      pool-name: MyHikariCP
      max-lifetime: 1800000
      connection-timeout: 30000
      connection-test-query: SELECT 1
</code></pre>
<h3 id="ä¿®æ”¹springboot-å¯åŠ¨ç±»">ä¿®æ”¹springboot å¯åŠ¨ç±»</h3>
<pre><code class="language-java">import org.mybatis.spring.annotation.MapperScan;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
@MapperScan(basePackages = &quot;com.ldx.springboot.dao&quot;)
public class SpringbootSpringSecurityApplication {

    public static void main(String[] args) {
        SpringApplication.run(SpringbootSpringSecurityApplication.class, args);
    }
}
</code></pre>
<h3 id="åˆ›å»ºsecurityconfig">åˆ›å»ºsecurityConfig</h3>
<pre><code class="language-java">/**
 * springsecurity é…ç½®ç±»
 * @author ludangxin
 * @Date 2020-06-01
 **/
@Configuration
@EnableGlobalMethodSecurity(securedEnabled = true,prePostEnabled = true)
public class WebSecurityConfig extends WebSecurityConfigurerAdapter {

    /**
     * å¯†ç ç¼–ç å™¨
     */
    @Bean public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

    /**
     * å®‰å…¨æ‹¦æˆªæœºåˆ¶ï¼ˆæœ€é‡è¦ï¼‰
     */
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.
                //å±è”½CSRFæ§åˆ¶ï¼Œå³spring securityä¸å†é™åˆ¶CSRF
                csrf().disable().
                authorizeRequests()
                .antMatchers(&quot;/r/r1&quot;).hasAuthority(&quot;p1&quot;)
                .antMatchers(&quot;/r/r2&quot;).hasAuthority(&quot;p2&quot;)
                //æ‰€æœ‰çš„è¯·æ±‚å¿…é¡»é€šè¿‡è®¤è¯
                .anyRequest().authenticated()
                .and()
                //å…è®¸è¡¨å•ç™»å½•
                .formLogin()
                //è‡ªå®šä¹‰ç™»å½•æˆåŠŸçš„é¡µé¢åœ°å€
                .successForwardUrl(&quot;/login-success&quot;);
    }
}
</code></pre>
<h3 id="åˆ›å»ºmodel">åˆ›å»ºmodel</h3>
<pre><code class="language-java">import lombok.Data;

@Data
public class UserDto {

    private String id;

    private String username;

    private String password;

    private String fullname;

    private String mobile;
}
</code></pre>
<h3 id="åˆ›å»ºcontroller">åˆ›å»ºcontroller</h3>
<pre><code class="language-java">import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class LoginController {

    /**
     *  ç”¨æˆ·ç™»å½•æˆåŠŸ
    */
    @RequestMapping(value = &quot;/login-success&quot;)
    public String loginSuccess() {
        String username = getUsername();
        return username + &quot; ç™»å½•æˆåŠŸ&quot;;
    }

    /**
     *  è·å–å½“å‰ç™»å½•ç”¨æˆ·å
     */
    private String getUsername() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        if (!authentication.isAuthenticated()) {
            return null;
        }
        Object principal = authentication.getPrincipal();
        String username = null;
        if (principal instanceof org.springframework.security.core.userdetails.UserDetails) {
            username = ((org.springframework.security.core.userdetails.UserDetails) principal).getUsername();
        } else {
            username = principal.toString();
        }
        return username;
    }

    /**
     * æµ‹è¯•èµ„æº1
     */
    @GetMapping(value = &quot;/r/r1&quot;)
    public String r1() {
        String username = getUsername();
        return username + &quot; è®¿é—®èµ„æº1&quot;;
    }

    /**
     * æµ‹è¯•èµ„æº2
     */
    @GetMapping(value = &quot;/r/r2&quot;)
    public String r2() {
        String username = getUsername();
        return username + &quot; è®¿é—®èµ„æº2&quot;;
    }
}
</code></pre>
<h3 id="åˆ›å»ºuserdetailsservice">åˆ›å»ºuserdetailsService</h3>
<pre><code class="language-java">import com.ldx.springboot.dao.UserMapper;
import com.ldx.springboot.model.UserDto;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;

@Service
public class SpringDataUserDetailsService implements UserDetailsService {

    @Autowired
    UserMapper userMapper;

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        //ç™»å½•è´¦å·
        System.out.println(&quot;username=&quot; + username);
        //æ ¹æ®è´¦å·å»æ•°æ®åº“æŸ¥è¯¢...
        UserDto user = userMapper.getUserByUsername(username);
        if (user == null) {
            return null;
        }
        //è¿™é‡Œæš‚æ—¶ä½¿ç”¨é™æ€æ•°æ®
        UserDetails userDetails = User.withUsername(user.getFullname()).password(user.getPassword()).authorities(&quot;p1&quot;).build();
        return userDetails;
    }
}
</code></pre>
<h3 id="åˆ›å»ºmapper">åˆ›å»ºmapper</h3>
<pre><code class="language-java">import com.ldx.springboot.model.UserDto;
import org.apache.ibatis.annotations.Select;

public interface UserMapper {

    @Select(&quot;select id,username,password,fullname from t_user where username = #{username}&quot;)
    UserDto getUserByUsername(String username);
}
</code></pre>
<h3 id="åˆ›å»ºbcryptå¯†ç æµ‹è¯•ç±»">åˆ›å»ºBCryptå¯†ç æµ‹è¯•ç±»</h3>
<pre><code class="language-java">import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.security.crypto.bcrypt.BCrypt;
import org.springframework.test.context.junit4.SpringRunner;

@RunWith(SpringRunner.class)
public class TestBCrypt {

    @Test
    public void test1(){ 
        //å¯¹åŸå§‹å¯†ç åŠ å¯† 
        String hashpw = BCrypt.hashpw(&quot;123&quot;,BCrypt.gensalt());
        System.out.println(hashpw);
        //æ ¡éªŒåŸå§‹å¯†ç å’ŒBCryptå¯†ç æ˜¯å¦ä¸€è‡´ 
        boolean checkpw = BCrypt.checkpw(&quot;123&quot;, &quot;$2a$10$NlBC84MVb7F95EXYTXwLneXgCca6/GipyWR5NHm8K0203bSQMLpvm&quot;); 
        System.out.println(checkpw); 
    } 
}
</code></pre>
<h3 id="æµ‹è¯•ç»“æœ">æµ‹è¯•ç»“æœ</h3>
<ol>
<li>ä½¿ç”¨BCryptå¯†ç æµ‹è¯•ç±»ç”ŸæˆæŒ‡å®šå¯†ç ä¸”å°†ç”¨æˆ·ä¿¡æ¯å†™å…¥æ•°æ®åº“ç”¨æˆ·è¡¨</li>
<li>å¯åŠ¨é¡¹ç›®è®¿é—®<code>localhost:8080</code></li>
<li>è¾“å…¥ç”¨æˆ·åå¯†ç è¿›è¡Œæµ‹è¯•</li>
<li>æš‚æ—¶ä½¿ç”¨é™æ€æƒé™æ•°æ®,æµ‹è¯•<code>r/r1</code>: æ­£å¸¸,<code>r/r2</code>:æ— æƒé™</li>
</ol>
<h2 id="ä¼šè¯">ä¼šè¯</h2>
<p>ç”¨æˆ·è®¤è¯é€šè¿‡åï¼Œä¸ºäº†é¿å…ç”¨æˆ·çš„æ¯æ¬¡æ“ä½œéƒ½è¿›è¡Œè®¤è¯å¯å°†ç”¨æˆ·çš„ä¿¡æ¯ä¿å­˜åœ¨ä¼šè¯ä¸­ã€‚spring securityæä¾›ä¼šè¯ç®¡ç†ï¼Œè®¤è¯é€šè¿‡åå°†èº«ä»½ä¿¡æ¯æ”¾å…¥SecurityContextHolderä¸Šä¸‹æ–‡ï¼ŒSecurityContextä¸å½“å‰çº¿ç¨‹è¿›è¡Œç»‘å®šï¼Œæ–¹ä¾¿è·å–ç”¨æˆ·èº«ä»½ã€‚</p>
<h3 id="è·å–å½“å‰ç”¨æˆ·å">è·å–å½“å‰ç”¨æˆ·å</h3>
<pre><code class="language-java">/**
     *  è·å–å½“å‰ç™»å½•ç”¨æˆ·å
     */
    private String getUsername() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        if (!authentication.isAuthenticated()) {
            return null;
        }
        Object principal = authentication.getPrincipal();
        String username = null;
        if (principal instanceof org.springframework.security.core.userdetails.UserDetails) {
            username = ((org.springframework.security.core.userdetails.UserDetails) principal).getUsername();
        } else {
            username = principal.toString();
        }
        return username;
    }
</code></pre>
<h3 id="ä¼šè¯æ§åˆ¶">ä¼šè¯æ§åˆ¶</h3>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹é€‰é¡¹å‡†ç¡®æ§åˆ¶ä¼šè¯ä½•æ—¶åˆ›å»ºä»¥åŠSpring Securityå¦‚ä½•ä¸ä¹‹äº¤äº’ï¼š</p>
<table>
<thead>
<tr>
<th>æœºåˆ¶</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>always</td>
<td>å¦‚æœæ²¡æœ‰sessionå­˜åœ¨å°±åˆ›å»ºä¸€ä¸ª</td>
</tr>
<tr>
<td>ifRequired</td>
<td>å¦‚æœéœ€è¦å°±åˆ›å»ºä¸€ä¸ªSessionï¼ˆé»˜è®¤ï¼‰ç™»å½•æ—¶</td>
</tr>
<tr>
<td>never</td>
<td>SpringSecurity å°†ä¸ä¼šåˆ›å»ºSessionï¼Œä½†æ˜¯å¦‚æœåº”ç”¨ä¸­å…¶ä»–åœ°æ–¹åˆ›å»ºäº†Sessionï¼Œé‚£ä¹ˆSpringSecurityå°†ä¼šä½¿ç”¨å®ƒã€‚</td>
</tr>
<tr>
<td>stateles</td>
<td>SpringSecurityå°†ç»å¯¹ä¸ä¼šåˆ›å»ºSessionï¼Œä¹Ÿä¸ä½¿ç”¨Session</td>
</tr>
</tbody>
</table>
<p>é€šè¿‡ä»¥ä¸‹é…ç½®æ–¹å¼å¯¹è¯¥é€‰é¡¹è¿›è¡Œé…ç½®ï¼š</p>
<pre><code class="language-java">@Override 
protected void configure(HttpSecurity http) throws Exception { 
    http.sessionManagement() .sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED) 
}
</code></pre>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒSpring Securityä¼šä¸ºæ¯ä¸ªç™»å½•æˆåŠŸçš„ç”¨æˆ·ä¼šæ–°å»ºä¸€ä¸ªSessionï¼Œå°±æ˜¯<strong>ifRequired</strong> ã€‚<br>
è‹¥é€‰ç”¨<strong>never</strong>ï¼Œåˆ™æŒ‡ç¤ºSpring Securityå¯¹ç™»å½•æˆåŠŸçš„ç”¨æˆ·ä¸åˆ›å»ºSessionäº†ï¼Œä½†è‹¥ä½ çš„åº”ç”¨ç¨‹åºåœ¨æŸåœ°æ–¹æ–°å»ºäº†sessionï¼Œé‚£ä¹ˆSpring Securityä¼šç”¨å®ƒçš„ã€‚<br>
è‹¥ä½¿ç”¨<strong>stateless</strong>ï¼Œåˆ™è¯´æ˜Spring Securityå¯¹ç™»å½•æˆåŠŸçš„ç”¨æˆ·ä¸ä¼šåˆ›å»ºSessionäº†ï¼Œä½ çš„åº”ç”¨ç¨‹åºä¹Ÿä¸ä¼šå…è®¸æ–°å»ºsessionã€‚å¹¶ä¸”å®ƒä¼šæš—ç¤ºä¸ä½¿ç”¨cookieï¼Œæ‰€ä»¥æ¯ä¸ªè¯·æ±‚éƒ½éœ€è¦é‡æ–°è¿›è¡Œèº«ä»½éªŒè¯ã€‚è¿™ç§æ— çŠ¶æ€æ¶æ„é€‚ç”¨äºREST APIåŠå…¶æ— çŠ¶æ€è®¤è¯æœºåˆ¶ã€‚</p>
<h3 id="ä¼šè¯è¶…æ—¶">ä¼šè¯è¶…æ—¶</h3>
<p>å¯ä»¥å†sevletå®¹å™¨ä¸­è®¾ç½®Sessionçš„è¶…æ—¶æ—¶é—´ï¼Œå¦‚ä¸‹è®¾ç½®Sessionæœ‰æ•ˆæœŸä¸º3600sï¼›<br>
springbooté…ç½®:</p>
<pre><code class="language-properties">server.servlet.session.timeout=3600s
</code></pre>
<p>sessionè¶…æ—¶ä¹‹åï¼Œå¯ä»¥é€šè¿‡Spring Security è®¾ç½®è·³è½¬çš„è·¯å¾„ã€‚</p>
<pre><code class="language-java">http.sessionManagement() 
    .expiredUrl(&quot;/loginâ€view?error=EXPIRED_SESSION&quot;) 
    .invalidSessionUrl(&quot;/loginâ€view?error=INVALID_SESSION&quot;);
</code></pre>
<p>expiredæŒ‡sessionè¿‡æœŸï¼ŒinvalidSessionæŒ‡ä¼ å…¥çš„sessionidæ— æ•ˆã€‚</p>
<h3 id="å®‰å…¨ä¼šè¯cookie">å®‰å…¨ä¼šè¯cookie</h3>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨httpOnlyå’Œsecureæ ‡ç­¾æ¥ä¿æŠ¤æˆ‘ä»¬çš„ä¼šè¯cookieï¼š<br>
<strong>httpOnly</strong>ï¼šå¦‚æœä¸ºtrueï¼Œé‚£ä¹ˆæµè§ˆå™¨è„šæœ¬å°†æ— æ³•è®¿é—®cookie<br>
<strong>secure</strong>ï¼šå¦‚æœä¸ºtrueï¼Œåˆ™cookieå°†ä»…é€šè¿‡HTTPSè¿æ¥å‘é€<br>
spring boot é…ç½®æ–‡ä»¶ï¼š</p>
<pre><code class="language-properties">server.servlet.session.cookie.httpâ€only=true 
server.servlet.session.cookie.secure=true
</code></pre>
<h2 id="é€€å‡º">é€€å‡º</h2>
<p>Spring securityé»˜è®¤å®ç°äº†logouté€€å‡ºï¼Œè®¿é—®<code>/logout</code>å®ç°é€€å‡ºæ“ä½œã€‚<br>
è¿™é‡Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰é€€å‡ºæˆåŠŸçš„é¡µé¢ï¼š<br>
åœ¨WebSecurityConfifigçš„protected void confifigure(HttpSecurity http)ä¸­é…ç½®ï¼š</p>
<pre><code class="language-java">.and() 
    .logout() 
    .logoutUrl(&quot;/logout&quot;) 
    .logoutSuccessUrl(&quot;/loginâ€view?logout&quot;);
</code></pre>
<p>å½“é€€å‡ºæ“ä½œå‡ºå‘æ—¶ï¼Œå°†å‘ç”Ÿï¼š</p>
<ul>
<li>ä½¿HTTP Session æ— æ•ˆ</li>
<li>æ¸…é™¤ SecurityContextHolder</li>
<li>è·³è½¬åˆ° /login-view?logout<br>
ä½†æ˜¯ï¼Œç±»ä¼¼äºé…ç½®ç™»å½•åŠŸèƒ½ï¼Œå’±ä»¬å¯ä»¥è¿›ä¸€æ­¥è‡ªå®šä¹‰é€€å‡ºåŠŸèƒ½ï¼š</li>
</ul>
<pre><code class="language-java">@Override protected void configure(HttpSecurity http) throws Exception { 
    http 
        .authorizeRequests() //... 
        .and() 
        .logout() (1) 
        .logoutUrl(&quot;/logout&quot;) (2) 
        .logoutSuccessUrl(&quot;/loginâ€view?logout&quot;) (3) 
        .logoutSuccessHandler(logoutSuccessHandler) (4) 
        .addLogoutHandler(logoutHandler) (5) 
        .invalidateHttpSession(true); (6) }
</code></pre>
<p>ï¼ˆ1ï¼‰æä¾›ç³»ç»Ÿé€€å‡ºæ”¯æŒï¼Œä½¿ç”¨ WebSecurityConfigurerAdapter ä¼šè‡ªåŠ¨è¢«åº”ç”¨<br>
ï¼ˆ2ï¼‰è®¾ç½®è§¦å‘é€€å‡ºæ“ä½œçš„URL (é»˜è®¤æ˜¯ /logout ).<br>
ï¼ˆ3ï¼‰é€€å‡ºä¹‹åè·³è½¬çš„URLã€‚é»˜è®¤æ˜¯ /login?logout ã€‚<br>
ï¼ˆ4ï¼‰å®šåˆ¶çš„ LogoutSuccessHandler ï¼Œç”¨äºå®ç°ç”¨æˆ·é€€å‡ºæˆåŠŸæ—¶çš„å¤„ç†ã€‚å¦‚æœæŒ‡å®šäº†è¿™ä¸ªé€‰é¡¹é‚£ä¹ˆlogoutSuccessUrl() çš„è®¾ç½®ä¼šè¢«å¿½ç•¥ã€‚<br>
ï¼ˆ5ï¼‰æ·»åŠ ä¸€ä¸ª LogoutHandler ï¼Œç”¨äºå®ç°ç”¨æˆ·é€€å‡ºæ—¶çš„æ¸…ç†å·¥ä½œ.é»˜è®¤ SecurityContextLogoutHandler ä¼šè¢«æ·»åŠ ä¸ºæœ€åä¸€ä¸ª LogoutHandler ã€‚<br>
ï¼ˆ6ï¼‰æŒ‡å®šæ˜¯å¦åœ¨é€€å‡ºæ—¶è®© HttpSession æ— æ•ˆã€‚ é»˜è®¤è®¾ç½®ä¸º <strong>true</strong>ã€‚<br>
<strong>æ³¨æ„ï¼šå¦‚æœè®©logoutåœ¨GETè¯·æ±‚ä¸‹ç”Ÿæ•ˆï¼Œå¿…é¡»å…³é—­é˜²æ­¢CSRFæ”»å‡»csrf().disable()ã€‚å¦‚æœå¼€å¯äº†CSRFï¼Œå¿…é¡»ä½¿ç”¨postæ–¹å¼è¯·æ±‚/logout</strong><br>
<strong>logoutHandlerï¼š</strong><br>
ä¸€èˆ¬æ¥è¯´ï¼Œ LogoutHandler çš„å®ç°ç±»è¢«ç”¨æ¥æ‰§è¡Œå¿…è¦çš„æ¸…ç†ï¼Œå› è€Œä»–ä»¬ä¸åº”è¯¥æŠ›å‡ºå¼‚å¸¸ã€‚<br>
ä¸‹é¢æ˜¯Spring Securityæä¾›çš„ä¸€äº›å®ç°ï¼š</p>
<ol>
<li>PersistentTokenBasedRememberMeServices åŸºäºæŒä¹…åŒ–tokençš„<strong>RememberMe</strong>åŠŸèƒ½çš„ç›¸å…³æ¸…ç†</li>
<li>TokenBasedRememberMeService åŸºäºtokençš„<strong>RememberMe</strong>åŠŸèƒ½çš„ç›¸å…³æ¸…ç†</li>
<li>CookieClearingLogoutHandler é€€å‡ºæ—¶Cookieçš„ç›¸å…³æ¸…ç†</li>
<li>CsrfLogoutHandler è´Ÿè´£åœ¨é€€å‡ºæ—¶ç§»é™¤csrfToken</li>
<li>SecurityContextLogoutHandler é€€å‡ºæ—¶SecurityContextçš„ç›¸å…³æ¸…ç†<br>
é“¾å¼APIæä¾›äº†è°ƒç”¨ç›¸åº”çš„ LogoutHandler å®ç°çš„å¿«æ·æ–¹å¼ï¼Œæ¯”å¦‚deleteCookies()ã€‚</li>
</ol>
<h2 id="è‡ªå®šä¹‰æˆæƒ">è‡ªå®šä¹‰æˆæƒ</h2>
<p>æˆæƒçš„æ–¹å¼åŒ…æ‹¬ webæˆæƒå’Œæ–¹æ³•æˆæƒï¼Œwebæˆæƒæ˜¯é€šè¿‡ urlæ‹¦æˆªè¿›è¡Œæˆæƒï¼Œæ–¹æ³•æˆæƒæ˜¯é€šè¿‡ æ–¹æ³•æ‹¦æˆªè¿›è¡Œæˆæƒã€‚ä»–ä»¬éƒ½ä¼šè°ƒç”¨accessDecisionManagerè¿›è¡Œæˆæƒå†³ç­–ï¼Œè‹¥ä¸ºwebæˆæƒåˆ™æ‹¦æˆªå™¨ä¸ºFilterSecurityInterceptorï¼›è‹¥ä¸ºæ–¹æ³•æˆæƒåˆ™æ‹¦æˆªå™¨ä¸ºMethodSecurityInterceptorã€‚å¦‚æœåŒæ—¶é€šè¿‡webæˆæƒå’Œæ–¹æ³•æˆæƒåˆ™å…ˆæ‰§è¡Œwebæˆæƒï¼Œå†æ‰§è¡Œæ–¹æ³•æˆæƒï¼Œæœ€åå†³ç­–é€šè¿‡ï¼Œåˆ™å…è®¸è®¿é—®èµ„æºï¼Œå¦åˆ™å°†ç¦æ­¢è®¿é—®ã€‚</p>
<h3 id="åˆ›å»ºæ•°æ®åº“è¡¨-2">åˆ›å»ºæ•°æ®åº“è¡¨</h3>
<pre><code class="language-sql"># è§’è‰²è¡¨
CREATE TABLE `t_role` ( 
    `id` varchar(32) NOT NULL, 
    `role_name` varchar(255) DEFAULT NULL,
    `description` varchar(255) DEFAULT NULL, 
    `create_time` datetime DEFAULT NULL,
    `update_time` datetime DEFAULT NULL, 
    `status` char(1) NOT NULL, PRIMARY KEY (`id`), 
    UNIQUE KEY `unique_role_name` (`role_name`) 
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
    insert into 
    `t_role`
    (`id`,`role_name`,`description`,`create_time`,`update_time`,`status`)
    values 
    ('1','ç®¡ç†å‘˜',NULL,NULL,NULL,'');
# ç”¨æˆ·è§’è‰²å…³ç³»è¡¨
CREATE TABLE `t_user_role` (
    `user_id` varchar(32) NOT NULL,
    `role_id` varchar(32) NOT NULL, 
    `create_time` datetime DEFAULT NULL,
    `creator` varchar(255) DEFAULT NULL, 
    PRIMARY KEY (`user_id`,`role_id`) 
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
    insert into 
    `t_user_role`
    (`user_id`,`role_id`,`create_time`,`creator`)
    values 
    ('1','1',NULL,NULL);
# æƒé™è¡¨
CREATE TABLE `t_permission`( 
    `id` varchar(32) NOT NULL, 
    `code` varchar(32) NOT NULL COMMENT 'æƒé™æ ‡è¯†ç¬¦', 
    `description` varchar(64) DEFAULT NULL COMMENT 'æè¿°', 
    `url` varchar(128) DEFAULT NULL COMMENT 'è¯·æ±‚åœ°å€', PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
    insert into 
    `t_permission`
    (`id`,`code`,`description`,`url`)
    values 
    ('1','p1','æµ‹è¯•èµ„æº 1','/r/r1'),('2','p3','æµ‹è¯•èµ„æº2','/r/r2');
# è§’è‰²æƒé™å…³ç³»è¡¨
CREATE TABLE `t_role_permission` ( 
    `role_id` varchar(32) NOT NULL,
    `permission_id` varchar(32) NOT NULL, 
    PRIMARY KEY (`role_id`,`permission_id`) 
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
    insert into 
    `t_role_permission`
    (`role_id`,`permission_id`)
    values 
    ('1','1'),('1','2');
</code></pre>
<h3 id="åˆ›å»ºmodel-2">åˆ›å»ºmodel</h3>
<pre><code class="language-java">import lombok.Data;

@Data
public class PermissionDto {

    private String id;

    private String code;

    private String description;

    private String url;
}
</code></pre>
<h3 id="ä¿®æ”¹userdatailsservice">ä¿®æ”¹userdatailsService</h3>
<pre><code class="language-java">import com.ldx.springboot.dao.PermissionMapper;
import com.ldx.springboot.dao.UserMapper;
import com.ldx.springboot.model.PermissionDto;
import com.ldx.springboot.model.UserDto;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;
import java.util.List;
import java.util.stream.Collectors;

@Service
public class SpringDataUserDetailsService implements UserDetailsService {

    @Autowired
    UserMapper userMapper;

    @Autowired
    PermissionMapper permissionMapper;

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        //ç™»å½•è´¦å·
        System.out.println(&quot;username=&quot; + username);
        //æ ¹æ®è´¦å·å»æ•°æ®åº“æŸ¥è¯¢...
        UserDto user = userMapper.getUserByUsername(username);
        if (user == null) {
            return null;
        }
        //æŸ¥è¯¢ç”¨æˆ·æƒé™
        List&lt;PermissionDto&gt; permissions = permissionMapper.findPermissionsByUserId(user.getId());
        List&lt;String&gt; permissionCodes = permissions.stream().map(PermissionDto::getCode).collect(Collectors.toList());
        String[] permissionCodeArr = permissionCodes.toArray(new String[permissionCodes.size()]);
        //åˆ›å»ºuserDetails
        UserDetails userDetails = User.withUsername(user.getFullname()).password(user.getPassword()).authorities(permissionCodeArr).build();
        return userDetails;
    }
}
</code></pre>
<h3 id="åˆ›å»ºmapper-2">åˆ›å»ºmapper</h3>
<pre><code class="language-java">import com.ldx.springboot.model.PermissionDto;
import org.apache.ibatis.annotations.Select;

import java.util.List;

public interface PermissionMapper {

    @Select(&quot;SELECT * FROM t_permission WHERE id &quot; +
            &quot;IN(SELECT permission_id FROM t_role_permission WHERE role_id &quot; +
            &quot;IN(SELECT role_id FROM t_user_role WHERE user_id = #{id}))&quot;)
    List&lt;PermissionDto&gt; findPermissionsByUserId(String id);
}
</code></pre>
<h3 id="æµ‹è¯•-2">æµ‹è¯•</h3>
<ol>
<li>å¯åŠ¨é¡¹ç›®è®¿é—®<code>localhost:8080</code></li>
<li>ç™»é™†ç”¨æˆ·</li>
<li>æµ‹è¯•è®¿é—®<code>r/r1</code>,<code>r/r2</code> èµ„æº</li>
</ol>
<h2 id="webæˆæƒ">webæˆæƒ</h2>
<p>åœ¨ä¸Šé¢ä¾‹å­ä¸­æˆ‘ä»¬å®Œæˆäº†è®¤è¯æ‹¦æˆªï¼Œå¹¶å¯¹/r/**ä¸‹çš„æŸäº›èµ„æºè¿›è¡Œç®€å•çš„æˆæƒä¿æŠ¤ï¼Œä½†æ˜¯æˆ‘ä»¬æƒ³è¿›è¡Œçµæ´»çš„æˆæƒæ§åˆ¶è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿé€šè¿‡ç»™ http.authorizeRequests() æ·»åŠ å¤šä¸ªå­èŠ‚ç‚¹æ¥å®šåˆ¶éœ€æ±‚åˆ°æˆ‘ä»¬çš„URLï¼Œå¦‚ä¸‹ä»£ç ï¼š</p>
<pre><code class="language-java">@Override protected void configure(HttpSecurity http) throws Exception { 
    http 
        .authorizeRequests() (1) 
        .antMatchers(&quot;/r/r1&quot;)
        .hasAuthority(&quot;p1&quot;) (2) 
        .antMatchers(&quot;/r/r2&quot;)
        .hasAuthority(&quot;p2&quot;) (3) 
        .antMatchers(&quot;/r/r3&quot;)
        .access(&quot;hasAuthority('p1') and hasAuthority('p2')&quot;) (4) 
        .antMatchers(&quot;/r/**&quot;)
        .authenticated() (5) 
        .anyRequest().permitAll() (6) 
        .and() .formLogin() 
        // ... 
}
</code></pre>
<p>ï¼ˆ1ï¼‰ http.authorizeRequests() æ–¹æ³•æœ‰å¤šä¸ªå­èŠ‚ç‚¹ï¼Œæ¯ä¸ªmacheræŒ‰ç…§ä»–ä»¬çš„å£°æ˜é¡ºåºæ‰§è¡Œã€‚</p>
<p>ï¼ˆ2ï¼‰æŒ‡å®š&quot;/r/r1&quot;URLï¼Œæ‹¥æœ‰p1æƒé™èƒ½å¤Ÿè®¿é—®</p>
<p>ï¼ˆ3ï¼‰æŒ‡å®š&quot;/r/r2&quot;URLï¼Œæ‹¥æœ‰p2æƒé™èƒ½å¤Ÿè®¿é—®</p>
<p>ï¼ˆ4ï¼‰æŒ‡å®šäº†&quot;/r/r3&quot;URLï¼ŒåŒæ—¶æ‹¥æœ‰p1å’Œp2æƒé™æ‰èƒ½å¤Ÿè®¿é—®</p>
<p>ï¼ˆ5ï¼‰æŒ‡å®šäº†é™¤äº†r1ã€r2ã€r3ä¹‹å¤–&quot;/r/**&quot;èµ„æºï¼ŒåŒæ—¶é€šè¿‡èº«ä»½è®¤è¯å°±èƒ½å¤Ÿè®¿é—®ï¼Œè¿™é‡Œä½¿ç”¨SpELï¼ˆSpring Expression Languageï¼‰è¡¨è¾¾å¼ã€‚ã€‚</p>
<p>ï¼ˆ6ï¼‰å‰©ä½™çš„å°šæœªåŒ¹é…çš„èµ„æºï¼Œä¸åšä¿æŠ¤ã€‚</p>
<p><strong>æ³¨æ„</strong>ï¼š</p>
<p><strong>è§„åˆ™çš„é¡ºåºæ˜¯é‡è¦çš„,æ›´å…·ä½“çš„è§„åˆ™åº”è¯¥å…ˆå†™</strong>.ç°åœ¨ä»¥/ adminå¼€å§‹çš„æ‰€æœ‰å†…å®¹éƒ½éœ€è¦å…·æœ‰ADMINè§’è‰²çš„èº«ä»½éªŒè¯ç”¨</p>
<p>æˆ·,å³ä½¿æ˜¯/ admin / loginè·¯å¾„(å› ä¸º/ admin / loginå·²ç»è¢«/ admin / **è§„åˆ™åŒ¹é…,å› æ­¤ç¬¬äºŒä¸ªè§„åˆ™è¢«å¿½ç•¥).</p>
<pre><code class="language-java">.antMatchers(&quot;/admin/**&quot;).hasRole(&quot;ADMIN&quot;) 
.antMatchers(&quot;/admin/login&quot;).permitAll()
</code></pre>
<p>å› æ­¤,ç™»å½•é¡µé¢çš„è§„åˆ™åº”è¯¥åœ¨/ admin / **è§„åˆ™ä¹‹å‰.ä¾‹å¦‚.</p>
<pre><code class="language-java">.antMatchers(&quot;/admin/login&quot;).permitAll() 
.antMatchers(&quot;/admin/**&quot;).hasRole(&quot;ADMIN&quot;)
</code></pre>
<p>ä¿æŠ¤URLå¸¸ç”¨çš„æ–¹æ³•æœ‰ï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>authenticated()</strong></td>
<td>ä¿æŠ¤URLï¼Œéœ€è¦ç”¨æˆ·ç™»å½•</td>
</tr>
<tr>
<td><strong>permitAll()</strong></td>
<td>æŒ‡å®šURLæ— éœ€ä¿æŠ¤ï¼Œä¸€èˆ¬åº”ç”¨ä¸é™æ€èµ„æºæ–‡ä»¶</td>
</tr>
<tr>
<td><strong>hasRole(String role)</strong></td>
<td>é™åˆ¶å•ä¸ªè§’è‰²è®¿é—®ï¼Œè§’è‰²å°†è¢«å¢åŠ  â€œROLE_â€ .æ‰€ä»¥â€ADMINâ€ å°†å’Œ â€œROLE_ADMINâ€è¿›è¡Œæ¯”è¾ƒ.</td>
</tr>
<tr>
<td><strong>hasAuthority(String authority)</strong></td>
<td>é™åˆ¶å•ä¸ªæƒé™è®¿é—®</td>
</tr>
<tr>
<td><strong>hasAnyRole(Stringâ€¦ roles)</strong></td>
<td>å…è®¸å¤šä¸ªè§’è‰²è®¿é—®.</td>
</tr>
<tr>
<td><strong>hasAnyAuthority(Stringâ€¦ authorities)</strong></td>
<td>å…è®¸å¤šä¸ªæƒé™è®¿é—®.</td>
</tr>
<tr>
<td><strong>access(String attribute)</strong></td>
<td>è¯¥æ–¹æ³•ä½¿ç”¨ SpELè¡¨è¾¾å¼, æ‰€ä»¥å¯ä»¥åˆ›å»ºå¤æ‚çš„é™åˆ¶.</td>
</tr>
<tr>
<td><strong>hasIpAddress(String ipaddressExpression)</strong></td>
<td>é™åˆ¶IPåœ°å€æˆ–å­ç½‘</td>
</tr>
</tbody>
</table>
<h2 id="æ–¹æ³•æˆæƒ">æ–¹æ³•æˆæƒ</h2>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»æŒæ¡äº†ä½¿ç”¨å¦‚ä½•ä½¿ç”¨ http.authorizeRequests() å¯¹webèµ„æºè¿›è¡Œæˆæƒä¿æŠ¤ï¼Œä»Spring Security2.0ç‰ˆ æœ¬å¼€å§‹ï¼Œå®ƒæ”¯æŒæœåŠ¡å±‚æ–¹æ³•çš„å®‰å…¨æ€§çš„æ”¯æŒã€‚æœ¬èŠ‚å­¦ä¹ @PreAuthorize,@PostAuthorize, @Securedä¸‰ç±»æ³¨è§£ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ä»»ä½• @Configuration å®ä¾‹ä¸Šä½¿ç”¨ @EnableGlobalMethodSecurity æ³¨é‡Šæ¥å¯ç”¨åŸºäºæ³¨è§£çš„å®‰å…¨æ€§ã€‚ä»¥ä¸‹å†…å®¹å°†å¯ç”¨Spring Securityçš„ @Secured æ³¨é‡Šã€‚</p>
<pre><code class="language-java">@EnableGlobalMethodSecurity(securedEnabled = true) 
public class MethodSecurityConfig {
    // ...
}
</code></pre>
<p>ç„¶åå‘æ–¹æ³•ï¼ˆåœ¨ç±»æˆ–æ¥å£ä¸Šï¼‰æ·»åŠ æ³¨è§£å°±ä¼šé™åˆ¶å¯¹è¯¥æ–¹æ³•çš„è®¿é—®ã€‚ Spring Securityçš„åŸç”Ÿæ³¨é‡Šæ”¯æŒä¸ºè¯¥æ–¹æ³•å®šä¹‰äº†ä¸€ç»„å±æ€§ã€‚ è¿™äº›å°†è¢«ä¼ é€’ç»™AccessDecisionManagerä»¥ä¾›å®ƒä½œå‡ºå®é™…çš„å†³å®šï¼š</p>
<pre><code class="language-java">public interface BankService { 
    @Secured(&quot;IS_AUTHENTICATED_ANONYMOUSLY&quot;) 
    public Account readAccount(Long id); 
    @Secured(&quot;IS_AUTHENTICATED_ANONYMOUSLY&quot;) 
    public Account[] findAccounts();
    @Secured(&quot;ROLE_TELLER&quot;) 
    public Account post(Account account, double amount); 
}
</code></pre>
<p>ä»¥ä¸Šé…ç½®æ ‡æ˜readAccountã€findAccountsæ–¹æ³•å¯åŒ¿åè®¿é—®ï¼Œåº•å±‚ä½¿ç”¨WebExpressionVoteræŠ•ç¥¨å™¨ï¼Œå¯ä» AffirmativeBasedç¬¬23è¡Œä»£ç è·Ÿè¸ªã€‚ã€‚</p>
<p>postæ–¹æ³•éœ€è¦æœ‰TELLERè§’è‰²æ‰èƒ½è®¿é—®ï¼Œåº•å±‚ä½¿ç”¨RoleVoteræŠ•ç¥¨å™¨ã€‚</p>
<p>ä½¿ç”¨å¦‚ä¸‹ä»£ç å¯å¯ç”¨prePostæ³¨è§£çš„æ”¯æŒ</p>
<pre><code class="language-java">@EnableGlobalMethodSecurity(prePostEnabled = true)
public class MethodSecurityConfig { 
    // ... 
}
</code></pre>
<p>ç›¸åº”Javaä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-java">public interface BankService { 
    @PreAuthorize(&quot;isAnonymous()&quot;) 
    public Account readAccount(Long id);
    @PreAuthorize(&quot;isAnonymous()&quot;)
    public Account[] findAccounts(); 
    @PreAuthorize(&quot;hasAuthority('p_transfer') and hasAuthority('p_read_account')&quot;) 
    public Account post(Account account, double amount); 
}
</code></pre>
<p>ä»¥ä¸Šé…ç½®æ ‡æ˜readAccountã€findAccountsæ–¹æ³•å¯åŒ¿åè®¿é—®ï¼Œpostæ–¹æ³•éœ€è¦åŒæ—¶æ‹¥æœ‰p_transferå’Œp_read_account æƒé™æ‰èƒ½è®¿é—®ï¼Œåº•å±‚ä½¿ç”¨WebExpressionVoteræŠ•ç¥¨å™¨ï¼Œå¯ä»AffirmativeBasedç¬¬23è¡Œä»£ç è·Ÿè¸ªã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[åˆè¯† Dubbo]]></title>
        <id>http://blog.ludangxin.club/post/chu-shi-dubbo/</id>
        <link href="http://blog.ludangxin.club/post/chu-shi-dubbo/">
        </link>
        <updated>2020-05-25T12:43:50.000Z</updated>
        <content type="html"><![CDATA[<h1 id="dubboæ˜¯ä»€ä¹ˆ">dubboæ˜¯ä»€ä¹ˆ</h1>
<h2 id="ç®€ä»‹">ç®€ä»‹</h2>
<p>Apache Dubboæ˜¯ä¸€æ¬¾é«˜æ€§èƒ½çš„java <strong>RPC</strong>æ¡†æ¶. å…¶å‰èº«æ˜¯é˜¿é‡Œå·´å·´å…¬å¸å¼€æºçš„ä¸€ä¸ªé«˜æ€§èƒ½,è½»é‡çº§çš„å¼€æºjava RPC æ¡†æ¶,å¯ä»¥å’ŒSpringæ¡†æ¶æ— ç¼é›†æˆ.<br>
Dubboæä¾›äº†ä¸‰å¤§æ ¸å¿ƒèƒ½åŠ›: é¢å‘æ¥å£çš„è¿œç¨‹æ–¹æ³•è°ƒç”¨, æ™ºèƒ½å®¹é”™å’Œè´Ÿè½½å‡è¡¡,ä»¥åŠæœåŠ¡æ³¨å†Œå’Œå‘ç°.<br>
å®˜æ–¹:http://dubbo.apache.org/zh-cn/</p>
<h2 id="æ¶æ„">æ¶æ„</h2>
<figure data-type="image" tabindex="1"><img src="http://blog.ludangxin.club/post-images/1590410698368.jpg" alt="" loading="lazy"></figure>
<h3 id="èŠ‚ç‚¹è§’è‰²è¯´æ˜">èŠ‚ç‚¹è§’è‰²è¯´æ˜</h3>
<table>
<thead>
<tr>
<th>èŠ‚ç‚¹</th>
<th>è§’è‰²è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Provider</code></td>
<td>æš´éœ²æœåŠ¡çš„æœåŠ¡æä¾›æ–¹</td>
</tr>
<tr>
<td><code>Consumer</code></td>
<td>è°ƒç”¨è¿œç¨‹æœåŠ¡çš„æœåŠ¡æ¶ˆè´¹æ–¹</td>
</tr>
<tr>
<td><code>Registry</code></td>
<td>æœåŠ¡æ³¨å†Œä¸å‘ç°çš„æ³¨å†Œä¸­å¿ƒ</td>
</tr>
<tr>
<td><code>Monitor</code></td>
<td>ç»Ÿè®¡æœåŠ¡çš„è°ƒç”¨æ¬¡æ•°å’Œè°ƒç”¨æ—¶é—´çš„ç›‘æ§ä¸­å¿ƒ</td>
</tr>
<tr>
<td><code>Container</code></td>
<td>æœåŠ¡è¿è¡Œå®¹å™¨</td>
</tr>
</tbody>
</table>
<h3 id="è°ƒç”¨å…³ç³»è¯´æ˜">è°ƒç”¨å…³ç³»è¯´æ˜</h3>
<ol>
<li>æœåŠ¡å®¹å™¨è´Ÿè´£å¯åŠ¨ï¼ŒåŠ è½½ï¼Œè¿è¡ŒæœåŠ¡æä¾›è€…ã€‚</li>
<li>æœåŠ¡æä¾›è€…åœ¨å¯åŠ¨æ—¶ï¼Œå‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œè‡ªå·±æä¾›çš„æœåŠ¡ã€‚</li>
<li>æœåŠ¡æ¶ˆè´¹è€…åœ¨å¯åŠ¨æ—¶ï¼Œå‘æ³¨å†Œä¸­å¿ƒè®¢é˜…è‡ªå·±æ‰€éœ€çš„æœåŠ¡ã€‚</li>
<li>æ³¨å†Œä¸­å¿ƒè¿”å›æœåŠ¡æä¾›è€…åœ°å€åˆ—è¡¨ç»™æ¶ˆè´¹è€…ï¼Œå¦‚æœæœ‰å˜æ›´ï¼Œæ³¨å†Œä¸­å¿ƒå°†åŸºäºé•¿è¿æ¥æ¨é€å˜æ›´æ•°æ®ç»™æ¶ˆè´¹è€…ã€‚</li>
<li>æœåŠ¡æ¶ˆè´¹è€…ï¼Œä»æä¾›è€…åœ°å€åˆ—è¡¨ä¸­ï¼ŒåŸºäºè½¯è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œé€‰ä¸€å°æä¾›è€…è¿›è¡Œè°ƒç”¨ï¼Œå¦‚æœè°ƒç”¨å¤±è´¥ï¼Œå†é€‰å¦ä¸€å°è°ƒç”¨ã€‚</li>
<li>æœåŠ¡æ¶ˆè´¹è€…å’Œæä¾›è€…ï¼Œåœ¨å†…å­˜ä¸­ç´¯è®¡è°ƒç”¨æ¬¡æ•°å’Œè°ƒç”¨æ—¶é—´ï¼Œå®šæ—¶æ¯åˆ†é’Ÿå‘é€ä¸€æ¬¡ç»Ÿè®¡æ•°æ®åˆ°ç›‘æ§ä¸­å¿ƒã€‚</li>
</ol>
<h1 id="rpc">RPC</h1>
<p>RPCå…¨ç§°ä¸ºremote procedure call. å³<strong>è¿œç¨‹è°ƒç”¨è¿‡ç¨‹</strong> ,è¿‡ç¨‹å…¶å®å°±æ˜¯æ–¹æ³•, æ‰€ä»¥å¯ä»¥æŠŠRPCç†è§£ä¸ºâ€œè¿œç¨‹æ–¹æ³•è°ƒç”¨â€ã€‚<br>
æ¯”å¦‚ä¸¤å°æœåŠ¡å™¨Aå’ŒB, AæœåŠ¡å™¨ä¸Šéƒ¨ç½²ä¸€ä¸ªåº”ç”¨, BæœåŠ¡å™¨ä¸Šéƒ¨ç½²ä¸€ä¸ªåº”ç”¨, AæœåŠ¡å™¨ä¸Šçš„åº”ç”¨æƒ³è°ƒç”¨BæœåŠ¡å™¨ä¸Šçš„åº”ç”¨æä¾›çš„æ–¹æ³•,ç”±äºä¸¤ä¸ªåº”ç”¨ä¸åœ¨ä¸€ä¸ªå†…å­˜ç©ºé—´, ä¸èƒ½ç›´æ¥è°ƒç”¨, æ‰€ä»¥éœ€è¦é€šè¿‡ç½‘ç»œæ¥è¡¨è¾¾è°ƒç”¨çš„è¯­ä¹‰å’Œä¼ è¾¾è°ƒç”¨çš„æ•°æ®.<br>
éœ€è¦æ³¨æ„çš„æ˜¯RPCå¹¶ä¸æ˜¯ä¸€ä¸ªå…·ä½“çš„æŠ€æœ¯, è€Œæ˜¯æŒ‡æ•´ä¸ªç½‘ç»œè¿œç¨‹è°ƒç”¨è¿‡ç¨‹.<br>
è€Œä¸éœ€è¦äº†è§£åº•å±‚ç½‘ç»œæŠ€æœ¯çš„åè®®,åœ¨é¢å‘å¯¹è±¡çš„ç¼–ç¨‹è¯­è¨€ä¸­, è¿œç¨‹è¿‡ç¨‹è°ƒç”¨å³æ˜¯ è¿œç¨‹æ–¹æ³•è°ƒç”¨<br>
<img src="http://blog.ludangxin.club/post-images/1590410726668.jpg" alt="" loading="lazy"></p>
<h1 id="æ™ºèƒ½å®¹é”™">æ™ºèƒ½å®¹é”™</h1>
<p>ä¸ºäº†é¿å…å•ç‚¹æ•…éšœï¼Œç°åœ¨çš„åº”ç”¨é€šå¸¸è‡³å°‘ä¼šéƒ¨ç½²åœ¨ä¸¤å°æœåŠ¡å™¨ä¸Šã€‚å¯¹äºä¸€äº›è´Ÿè½½æ¯”è¾ƒé«˜çš„æœåŠ¡ï¼Œä¼šéƒ¨ç½²æ›´å¤šçš„æœåŠ¡å™¨ã€‚è¿™æ ·ï¼Œåœ¨åŒä¸€ç¯å¢ƒä¸‹çš„æœåŠ¡æä¾›è€…æ•°é‡ä¼šå¤§äº1ã€‚å¯¹äºæœåŠ¡æ¶ˆè´¹è€…æ¥è¯´ï¼ŒåŒä¸€ç¯å¢ƒä¸‹å‡ºç°äº†å¤šä¸ªæœåŠ¡æä¾›è€…ã€‚è¿™æ—¶ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼ŒæœåŠ¡æ¶ˆè´¹è€…éœ€è¦å†³å®šé€‰æ‹©å“ªä¸ªæœåŠ¡æä¾›è€…è¿›è¡Œè°ƒç”¨ã€‚å¦å¤–æœåŠ¡è°ƒç”¨å¤±è´¥æ—¶çš„å¤„ç†æªæ–½ä¹Ÿæ˜¯éœ€è¦è€ƒè™‘çš„ï¼Œæ˜¯é‡è¯•å‘¢ï¼Œè¿˜æ˜¯æŠ›å‡ºå¼‚å¸¸ï¼Œäº¦æˆ–æ˜¯åªæ‰“å°å¼‚å¸¸ç­‰ã€‚ä¸ºäº†å¤„ç†è¿™äº›é—®é¢˜ï¼ŒDubbo å®šä¹‰äº†é›†ç¾¤æ¥å£ Cluster ä»¥åŠ Cluster Invokerã€‚é›†ç¾¤ Cluster ç”¨é€”æ˜¯å°†å¤šä¸ªæœåŠ¡æä¾›è€…åˆå¹¶ä¸ºä¸€ä¸ª Cluster Invokerï¼Œå¹¶å°†è¿™ä¸ª Invoker æš´éœ²ç»™æœåŠ¡æ¶ˆè´¹è€…ã€‚è¿™æ ·ä¸€æ¥ï¼ŒæœåŠ¡æ¶ˆè´¹è€…åªéœ€é€šè¿‡è¿™ä¸ª Invoker è¿›è¡Œè¿œç¨‹è°ƒç”¨å³å¯ï¼Œè‡³äºå…·ä½“è°ƒç”¨å“ªä¸ªæœåŠ¡æä¾›è€…ï¼Œä»¥åŠè°ƒç”¨å¤±è´¥åå¦‚ä½•å¤„ç†ç­‰é—®é¢˜ï¼Œç°åœ¨éƒ½äº¤ç»™é›†ç¾¤æ¨¡å—å»å¤„ç†ã€‚é›†ç¾¤æ¨¡å—æ˜¯æœåŠ¡æä¾›è€…å’ŒæœåŠ¡æ¶ˆè´¹è€…çš„ä¸­é—´å±‚ï¼Œä¸ºæœåŠ¡æ¶ˆè´¹è€…å±è”½äº†æœåŠ¡æä¾›è€…çš„æƒ…å†µï¼Œè¿™æ ·æœåŠ¡æ¶ˆè´¹è€…å°±å¯ä»¥ä¸“å¿ƒå¤„ç†è¿œç¨‹è°ƒç”¨ç›¸å…³äº‹å®œã€‚æ¯”å¦‚å‘è¯·æ±‚ï¼Œæ¥å—æœåŠ¡æä¾›è€…è¿”å›çš„æ•°æ®ç­‰ã€‚è¿™å°±æ˜¯é›†ç¾¤çš„ä½œç”¨ã€‚<br>
Dubbo æä¾›äº†å¤šç§é›†ç¾¤å®ç°ï¼ŒåŒ…å«ä½†ä¸é™äº Failover Clusterã€Failfast Cluster å’Œ Failsafe Cluster ç­‰ã€‚æ¯ç§é›†ç¾¤å®ç°ç±»çš„ç”¨é€”ä¸åŒï¼Œæ¥ä¸‹æ¥ä¼šä¸€ä¸€è¿›è¡Œåˆ†æã€‚<br>
åœ¨å¯¹é›†ç¾¤ç›¸å…³ä»£ç è¿›è¡Œåˆ†æä¹‹å‰ï¼Œè¿™é‡Œæœ‰å¿…è¦å…ˆæ¥ä»‹ç»ä¸€ä¸‹é›†ç¾¤å®¹é”™çš„æ‰€æœ‰ç»„ä»¶ã€‚åŒ…å« Clusterã€Cluster Invokerã€Directoryã€Router å’Œ LoadBalance ç­‰ã€‚<br>
<img src="http://blog.ludangxin.club/post-images/1590410921569.jpg" alt="" loading="lazy"><br>
é›†ç¾¤å·¥ä½œè¿‡ç¨‹å¯åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œç¬¬ä¸€ä¸ªé˜¶æ®µæ˜¯åœ¨æœåŠ¡æ¶ˆè´¹è€…åˆå§‹åŒ–æœŸé—´ï¼Œé›†ç¾¤ Cluster å®ç°ç±»ä¸ºæœåŠ¡æ¶ˆè´¹è€…åˆ›å»º Cluster Invoker å®ä¾‹ï¼Œå³ä¸Šå›¾ä¸­çš„ merge æ“ä½œã€‚ç¬¬äºŒä¸ªé˜¶æ®µæ˜¯åœ¨æœåŠ¡æ¶ˆè´¹è€…è¿›è¡Œè¿œç¨‹è°ƒç”¨æ—¶ã€‚ä»¥ FailoverClusterInvoker ä¸ºä¾‹ï¼Œè¯¥ç±»å‹ Cluster Invoker é¦–å…ˆä¼šè°ƒç”¨ Directory çš„ list æ–¹æ³•åˆ—ä¸¾ Invoker åˆ—è¡¨ï¼ˆå¯å°† Invoker ç®€å•ç†è§£ä¸ºæœåŠ¡æä¾›è€…ï¼‰ã€‚Directory çš„ç”¨é€”æ˜¯ä¿å­˜ Invokerï¼Œå¯ç®€å•ç±»æ¯”ä¸º List<Invoker>ã€‚å…¶å®ç°ç±» RegistryDirectory æ˜¯ä¸€ä¸ªåŠ¨æ€æœåŠ¡ç›®å½•ï¼Œå¯æ„ŸçŸ¥æ³¨å†Œä¸­å¿ƒé…ç½®çš„å˜åŒ–ï¼Œå®ƒæ‰€æŒæœ‰çš„ Invoker åˆ—è¡¨ä¼šéšç€æ³¨å†Œä¸­å¿ƒå†…å®¹çš„å˜åŒ–è€Œå˜åŒ–ã€‚æ¯æ¬¡å˜åŒ–åï¼ŒRegistryDirectory ä¼šåŠ¨æ€å¢åˆ  Invokerï¼Œå¹¶è°ƒç”¨ Router çš„ route æ–¹æ³•è¿›è¡Œè·¯ç”±ï¼Œè¿‡æ»¤æ‰ä¸ç¬¦åˆè·¯ç”±è§„åˆ™çš„ Invokerã€‚å½“ FailoverClusterInvoker æ‹¿åˆ° Directory è¿”å›çš„ Invoker åˆ—è¡¨åï¼Œå®ƒä¼šé€šè¿‡ LoadBalance ä» Invoker åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ª Invokerã€‚æœ€å FailoverClusterInvoker ä¼šå°†å‚æ•°ä¼ ç»™ LoadBalance é€‰æ‹©å‡ºçš„ Invoker å®ä¾‹çš„ invoke æ–¹æ³•ï¼Œè¿›è¡ŒçœŸæ­£çš„è¿œç¨‹è°ƒç”¨ã€‚<br>
ä»¥ä¸Šå°±æ˜¯é›†ç¾¤å·¥ä½œçš„æ•´ä¸ªæµç¨‹ï¼Œè¿™é‡Œå¹¶æ²¡ä»‹ç»é›†ç¾¤æ˜¯å¦‚ä½•å®¹é”™çš„ã€‚Dubbo ä¸»è¦æä¾›äº†è¿™æ ·å‡ ç§å®¹é”™æ–¹å¼ï¼š</p>
<ul>
<li>Failover Cluster - å¤±è´¥è‡ªåŠ¨åˆ‡æ¢</li>
<li>Failfast Cluster - å¿«é€Ÿå¤±è´¥</li>
<li>Failsafe Cluster - å¤±è´¥å®‰å…¨</li>
<li>Failback Cluster - å¤±è´¥è‡ªåŠ¨æ¢å¤</li>
<li>Forking Cluster - å¹¶è¡Œè°ƒç”¨å¤šä¸ªæœåŠ¡æä¾›è€…</li>
</ul>
<h2 id="failover-cluster">Failover Cluster</h2>
<p>FailoverClusterInvoker åœ¨è°ƒç”¨å¤±è´¥æ—¶ï¼Œä¼šè‡ªåŠ¨åˆ‡æ¢ Invoker è¿›è¡Œé‡è¯•ã€‚é»˜è®¤é…ç½®ä¸‹ï¼ŒDubbo ä¼šä½¿ç”¨è¿™ä¸ªç±»ä½œä¸ºç¼ºçœ Cluster Invoker<br>
å¯é€šè¿‡ <code>retries=&quot;2&quot;</code> æ¥è®¾ç½®é‡è¯•æ¬¡æ•°(ä¸å«ç¬¬ä¸€æ¬¡)ã€‚<br>
é‡è¯•æ¬¡æ•°é…ç½®å¦‚ä¸‹ï¼š</p>
<pre><code class="language-xml">&lt;dubbo:service retries=&quot;2&quot; /&gt;
</code></pre>
<p>æˆ–</p>
<pre><code class="language-xml">&lt;dubbo:reference retries=&quot;2&quot; /&gt;
</code></pre>
<p>æˆ–</p>
<pre><code class="language-xml">&lt;dubbo:reference&gt;
    &lt;dubbo:method name=&quot;findFoo&quot; retries=&quot;2&quot; /&gt;
&lt;/dubbo:reference&gt;
</code></pre>
<h2 id="failfast-cluster">Failfast Cluster</h2>
<p>FailfastClusterInvoker åªä¼šè¿›è¡Œä¸€æ¬¡è°ƒç”¨ï¼Œå¤±è´¥åç«‹å³æŠ›å‡ºå¼‚å¸¸ã€‚é€‚ç”¨äºéå¹‚ç­‰æ“ä½œï¼Œæ¯”å¦‚æ–°å¢è®°å½•ã€‚</p>
<h2 id="failsafe-cluster">Failsafe Cluster</h2>
<p>FailsafeClusterInvoker æ˜¯ä¸€ç§å¤±è´¥å®‰å…¨çš„ Cluster Invokerã€‚æ‰€è°“çš„å¤±è´¥å®‰å…¨æ˜¯æŒ‡ï¼Œå½“è°ƒç”¨è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸æ—¶ï¼ŒFailsafeClusterInvoker ä»…ä¼šæ‰“å°å¼‚å¸¸ï¼Œè€Œä¸ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚é€‚ç”¨äºå†™å…¥å®¡è®¡æ—¥å¿—ç­‰æ“ä½œã€‚</p>
<h2 id="failback-cluster">Failback Cluster</h2>
<p>FailbackClusterInvoker ä¼šåœ¨è°ƒç”¨å¤±è´¥åï¼Œè¿”å›ä¸€ä¸ªç©ºç»“æœç»™æœåŠ¡æ¶ˆè´¹è€…ã€‚å¹¶é€šè¿‡å®šæ—¶ä»»åŠ¡å¯¹å¤±è´¥çš„è°ƒç”¨è¿›è¡Œé‡ä¼ ï¼Œé€‚åˆæ‰§è¡Œæ¶ˆæ¯é€šçŸ¥ç­‰æ“ä½œã€‚</p>
<h2 id="forking-cluster">Forking Cluster</h2>
<p>ForkingClusterInvoker ä¼šåœ¨è¿è¡Œæ—¶é€šè¿‡çº¿ç¨‹æ± åˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Œå¹¶å‘è°ƒç”¨å¤šä¸ªæœåŠ¡æä¾›è€…ã€‚åªè¦æœ‰ä¸€ä¸ªæœåŠ¡æä¾›è€…æˆåŠŸè¿”å›äº†ç»“æœï¼ŒdoInvoke æ–¹æ³•å°±ä¼šç«‹å³ç»“æŸè¿è¡Œã€‚ForkingClusterInvoker çš„åº”ç”¨åœºæ™¯æ˜¯åœ¨ä¸€äº›å¯¹å®æ—¶æ€§è¦æ±‚æ¯”è¾ƒé«˜<strong>è¯»æ“ä½œ</strong>ï¼ˆæ³¨æ„æ˜¯è¯»æ“ä½œï¼Œå¹¶è¡Œå†™æ“ä½œå¯èƒ½ä¸å®‰å…¨ï¼‰ä¸‹ä½¿ç”¨ï¼Œä½†è¿™å°†ä¼šè€—è´¹æ›´å¤šçš„èµ„æºã€‚</p>
<h1 id="æœåŠ¡æ²»ç†å’Œé…ç½®ç®¡ç†">æœåŠ¡æ²»ç†å’Œé…ç½®ç®¡ç†</h1>
<h2 id="æœåŠ¡æ²»ç†">æœåŠ¡æ²»ç†</h2>
<p>æœåŠ¡æ²»ç†ä¸»è¦ä½œç”¨æ˜¯æ”¹å˜è¿è¡Œæ—¶æœåŠ¡çš„è¡Œä¸ºå’Œé€‰å€é€»è¾‘ï¼Œè¾¾åˆ°é™æµï¼Œæƒé‡é…ç½®ç­‰ç›®çš„ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªåŠŸèƒ½ï¼š</p>
<h3 id="åº”ç”¨çº§åˆ«çš„æœåŠ¡æ²»ç†">åº”ç”¨çº§åˆ«çš„æœåŠ¡æ²»ç†</h3>
<p>åœ¨Dubbo2.6åŠæ›´æ—©ç‰ˆæœ¬ä¸­ï¼Œæ‰€æœ‰çš„æœåŠ¡æ²»ç†è§„åˆ™éƒ½åªé’ˆå¯¹æœåŠ¡ç²’åº¦ï¼Œå¦‚æœè¦æŠŠæŸæ¡è§„åˆ™ä½œç”¨åˆ°åº”ç”¨ç²’åº¦ä¸Šï¼Œéœ€è¦ä¸ºåº”ç”¨ä¸‹çš„æ‰€æœ‰æœåŠ¡é…åˆç›¸åŒçš„è§„åˆ™ï¼Œå˜æ›´ï¼Œåˆ é™¤çš„æ—¶å€™ä¹Ÿéœ€è¦å¯¹åº”çš„æ“ä½œï¼Œè¿™æ ·çš„æ“ä½œå¾ˆä¸å‹å¥½ï¼Œå› æ­¤Dubbo2.7ç‰ˆæœ¬ä¸­å¢åŠ äº†åº”ç”¨ç²’åº¦çš„æœåŠ¡æ²»ç†æ“ä½œï¼Œå¯¹äºæ¡ä»¶è·¯ç”±(åŒ…æ‹¬é»‘ç™½åå•)ï¼ŒåŠ¨æ€é…ç½®(åŒ…æ‹¬æƒé‡ï¼Œè´Ÿè½½å‡è¡¡)éƒ½å¯ä»¥åšåº”ç”¨çº§åˆ«çš„é…ç½®ï¼š<br>
<img src="http://dubbo.apache.org/img/blog/admin/conditionRoute.jpg" alt="condition" loading="lazy"><br>
ä¸Šå›¾æ˜¯æ¡ä»¶è·¯ç”±çš„é…ç½®ï¼Œå¯ä»¥æŒ‰ç…§åº”ç”¨åï¼ŒæœåŠ¡åä¸¤ä¸ªç»´åº¦æ¥å¡«å†™ï¼Œä¹Ÿå¯ä»¥æŒ‰ç…§è¿™ä¸¤ä¸ªç»´åº¦æ¥æŸ¥è¯¢ã€‚</p>
<h3 id="æ ‡ç­¾è·¯ç”±">æ ‡ç­¾è·¯ç”±</h3>
<p>æ ‡ç­¾è·¯ç”±æ˜¯Dubbo2.7å¼•å…¥çš„æ–°åŠŸèƒ½ï¼Œé…ç½®ä»¥åº”ç”¨ä½œä¸ºç»´åº¦ï¼Œç»™ä¸åŒçš„æœåŠ¡å™¨æ‰“ä¸Šä¸åŒåå­—çš„æ ‡ç­¾ï¼Œé…ç½®å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š <img src="http://dubbo.apache.org/img/blog/admin/route.jpg" alt="tag" loading="lazy"> è°ƒç”¨çš„æ—¶å€™ï¼Œå®¢æˆ·ç«¯å¯ä»¥é€šè¿‡<code>setAttachment</code>çš„æ–¹å¼ï¼Œæ¥è®¾ç½®ä¸åŒçš„æ ‡ç­¾åç§°ï¼Œæ¯”å¦‚æœ¬ä¾‹ä¸­ï¼Œ<code>setAttachment(tag1)</code>ï¼Œå®¢æˆ·ç«¯çš„é€‰å€èŒƒå›´å°±åœ¨å¦‚å›¾æ‰€ç¤ºçš„ä¸‰å°æœºå™¨ä¸­ï¼Œå¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼æ¥å®ç°æµé‡éš”ç¦»ï¼Œç°åº¦å‘å¸ƒç­‰åŠŸèƒ½ã€‚</p>
<h3 id="æ¡ä»¶è·¯ç”±">æ¡ä»¶è·¯ç”±</h3>
<p>æ¡ä»¶è·¯ç”±æ˜¯Dubboä¸€ç›´ä»¥æ¥å°±æœ‰çš„åŠŸèƒ½ï¼Œç›®å‰å¯ä»¥é…ç½®æœåŠ¡å’Œåº”ç”¨ä¸¤ä¸ªç»´åº¦ï¼Œæ¡ä»¶è·¯ç”±ä¸º<code>yaml</code>æ ¼å¼ï¼Œå…·ä½“çš„è§„åˆ™ä½“ä»¥åŠå„ç§é€‚ç”¨åœºæ™¯ï¼Œè¯·å‚è€ƒ<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/routing-rule.html">è¿™é‡Œ</a></p>
<h3 id="é»‘ç™½åå•">é»‘ç™½åå•</h3>
<p>é»‘ç™½åå•æ˜¯æ¡ä»¶è·¯ç”±çš„ä¸€éƒ¨åˆ†ï¼Œè§„åˆ™å­˜å‚¨å’Œæ¡ä»¶è·¯ç”±æ”¾åœ¨ä¸€èµ·ï¼Œä¸ºäº†æ–¹ä¾¿é…ç½®æ‰€ä»¥å•ç‹¬æ‹¿å‡ºæ¥ï¼ŒåŒæ ·å¯ä»¥é€šè¿‡æœåŠ¡å’Œåº”ç”¨ä¸¤ä¸ªç»´åº¦ï¼ŒæŒ‡å®šé»‘åå•å’Œç™½åå•:<br>
<img src="http://dubbo.apache.org/docs/zh-cn/admin/sources/images/blackList.jpg" alt="blackList" loading="lazy"></p>
<h3 id="åŠ¨æ€é…ç½®">åŠ¨æ€é…ç½®</h3>
<p>åŠ¨æ€é…ç½®æ˜¯å’Œè·¯ç”±è§„åˆ™å¹³è¡Œçš„å¦ä¸€ç±»æœåŠ¡æ²»ç†æ²»ç†åŠŸèƒ½ï¼Œä¸»è¦ä½œç”¨æ˜¯åœ¨ä¸é‡å¯æœåŠ¡çš„æƒ…å†µä¸‹ï¼ŒåŠ¨æ€æ”¹å˜è°ƒç”¨è¡Œä¸ºï¼Œä»Dubbo2.7ç‰ˆæœ¬å¼€å§‹ï¼Œæ”¯æŒæœåŠ¡å’Œåº”ç”¨ä¸¤ä¸ªç»´åº¦çš„é…ç½®ï¼Œé‡‡ç”¨<code>yaml</code>æ ¼å¼ï¼Œç•Œé¢å¦‚ä¸‹ï¼š<br>
<img src="http://dubbo.apache.org/docs/zh-cn/admin/sources/images/config.jpg" alt="config" loading="lazy"> å…·ä½“çš„è§„åˆ™ä½“è¯´æ˜è¯·å‚è€ƒ<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/config-rule.html">è¿™é‡Œ</a></p>
<h3 id="æƒé‡è°ƒèŠ‚">æƒé‡è°ƒèŠ‚</h3>
<p>æƒé‡è°ƒèŠ‚æ˜¯åŠ¨æ€é…ç½®çš„å­åŠŸèƒ½ï¼Œä¸»è¦ä½œç”¨æ˜¯æ”¹å˜æœåŠ¡ç«¯çš„æƒé‡ï¼Œæ›´å¤§çš„æƒé‡ä¼šæœ‰æ›´å¤§çš„å‡ ç‡è¢«å®¢æˆ·ç«¯é€‰ä¸­ä½œä¸ºæœåŠ¡æä¾›è€…ï¼Œä»è€Œè¾¾åˆ°æµé‡åˆ†é…çš„ç›®çš„ï¼š<br>
<img src="http://dubbo.apache.org/docs/zh-cn/admin/sources/images/weight.jpg" alt="weight" loading="lazy"></p>
<h3 id="è´Ÿè½½å‡è¡¡">è´Ÿè½½å‡è¡¡</h3>
<p>è´Ÿè½½å‡è¡¡ä¹Ÿæ˜¯åŠ¨æ€é…ç½®çš„å­åŠŸèƒ½ï¼Œä¸»è¦ä½œç”¨æ˜¯è°ƒæ•´å®¢æˆ·ç«¯çš„é€‰å€é€»è¾‘ï¼Œç›®å‰å¯é€‰çš„è´Ÿè½½å‡è¡¡ç­–ç•¥æœ‰éšæœºï¼Œè½®è®­å’Œæœ€å°æ´»è·ƒï¼Œå…³äºå„ä¸ªç­–ç•¥çš„è§£é‡Šè¯·å‚è€ƒ<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/loadbalance.html">è¿™é‡Œ</a></p>
<h2 id="é…ç½®ç®¡ç†">é…ç½®ç®¡ç†</h2>
<p>é…ç½®ç®¡ç†ä¹Ÿæ˜¯é…åˆDubbo2.7æ–°å¢çš„åŠŸèƒ½ï¼Œåœ¨Dubbo2.7ä¸­ï¼Œå¢åŠ äº†å…¨å±€å’Œåº”ç”¨ç»´åº¦çš„é…ç½®ï¼Œåˆ†åˆ«åœ¨å…¨å±€å’Œåº”ç”¨èŒƒå›´å†…ç”Ÿæ•ˆï¼Œå…¶ä¸­åº”ç”¨é…ç½®ä¹Ÿå¯ä»¥æŒ‡å®šè¯¥åº”ç”¨ä¸­çš„æœåŠ¡çº§åˆ«çš„é…ç½®ï¼Œå¯ä»¥åœ¨æ§åˆ¶å°ä¸­æŸ¥çœ‹ï¼Œä¿®æ”¹é…ç½®è§„åˆ™ï¼Œé»˜è®¤å±•ç¤ºå…¨å±€ç»´åº¦çš„é…ç½®ã€‚</p>
<ul>
<li>å…¨å±€é…ç½®ï¼š <img src="http://dubbo.apache.org/img/blog/admin/config.jpg" alt="config" loading="lazy"><br>
å…¨å±€é…ç½®é‡Œå¯ä»¥æŒ‡å®šæ³¨å†Œä¸­å¿ƒï¼Œå…ƒæ•°æ®ä¸­å¿ƒçš„åœ°å€ï¼ŒæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„è¶…æ—¶æ—¶é—´ç­‰ï¼Œè¿™äº›é…ç½®åœ¨å…¨å±€å†…ç”Ÿæ•ˆã€‚é™¤äº†é…ç½®å†™å…¥ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥æŸ¥çœ‹ã€‚å¦‚æœä½¿ç”¨zookeeperä½œä¸ºæ³¨å†Œä¸­å¿ƒå’Œå…ƒæ•°æ®ä¸­å¿ƒï¼Œè¿˜å¯ä»¥çœ‹åˆ°é…ç½®æ–‡ä»¶æ‰€åœ¨ä½ç½®çš„ç›®å½•ç»“æ„ã€‚</li>
<li>åº”ç”¨ï¼Œ æœåŠ¡é…ç½®<br>
<img src="http://dubbo.apache.org/img/blog/admin/appConfig.jpg" alt="appConfig" loading="lazy"><br>
åº”ç”¨çº§åˆ«çš„é…ç½®å¯ä»¥ä¸ºåº”ç”¨æˆ–è€…åº”ç”¨å†…çš„æœåŠ¡æŒ‡å®šé…ç½®ï¼Œåœ¨æœåŠ¡ç»´åº¦ä¸Šï¼Œéœ€è¦åŒºåˆ†æä¾›è€…å’Œæ¶ˆè´¹è€…ã€‚<code>dubbo.reference.{serviceName}</code>è¡¨ç¤ºä½œä¸ºè¯¥æœåŠ¡æ¶ˆè´¹è€…çš„é…ç½®ï¼Œ<code>dubbo.provider.{servcieName}</code>è¡¨ç¤ºä½œä¸ºè¯¥æœåŠ¡æä¾›è€…çš„é…ç½®ã€‚å…¶ä¸­æ³¨å†Œä¸­å¿ƒå’Œå…ƒæ•°æ®ä¸­å¿ƒçš„åœ°å€ï¼Œåªèƒ½åœ¨å…¨å±€é…ç½®ä¸­æŒ‡å®šï¼Œè¿™ä¹Ÿæ˜¯Dubbo2.7ä¸­æ¨èçš„ä½¿ç”¨æ–¹å¼ã€‚</li>
<li>ä¼˜å…ˆçº§ï¼š æœåŠ¡é…ç½® &gt; åº”ç”¨é…ç½® &gt; å…¨å±€é…ç½®</li>
</ul>
<h1 id="æ—¢ç„¶æœ‰-http-è¯·æ±‚ä¸ºä»€ä¹ˆè¿˜è¦ç”¨-rpc-è°ƒç”¨">æ—¢ç„¶æœ‰ HTTP è¯·æ±‚ï¼Œä¸ºä»€ä¹ˆè¿˜è¦ç”¨ RPC è°ƒç”¨ï¼Ÿ</h1>
<p>HTTPåè®®ï¼Œä»¥å…¶ä¸­çš„Restfulè§„èŒƒä¸ºä»£è¡¨ï¼Œå…¶ä¼˜åŠ¿å¾ˆå¤§ã€‚å®ƒ<strong>å¯è¯»æ€§å¥½</strong>ï¼Œä¸”<strong>å¯ä»¥å¾—åˆ°é˜²ç«å¢™çš„æ”¯æŒã€è·¨è¯­è¨€çš„æ”¯æŒ</strong>ã€‚è€Œä¸”ï¼Œåœ¨å»å¹´çš„æŠ¥å‘Šä¸­ï¼ŒRestful<strong>å¤§æœ‰è¶…è¿‡RPCçš„è¶‹åŠ¿</strong>ã€‚<br>
ä½†æ˜¯HTTPä¹Ÿæœ‰å…¶ç¼ºç‚¹ï¼Œè¿™æ˜¯ä¸å…¶ä¼˜ç‚¹ç›¸å¯¹åº”çš„ã€‚é¦–å…ˆæ˜¯<strong>æœ‰ç”¨ä¿¡æ¯å æ¯”å°‘</strong>ï¼Œæ¯•ç«ŸHTTPå·¥ä½œåœ¨ç¬¬ä¸ƒå±‚ï¼ŒåŒ…å«äº†å¤§é‡çš„HTTPå¤´ç­‰ä¿¡æ¯ã€‚å…¶æ¬¡æ˜¯<strong>æ•ˆç‡ä½</strong>ï¼Œè¿˜æ˜¯å› ä¸ºç¬¬ä¸ƒå±‚çš„ç¼˜æ•…ã€‚è¿˜æœ‰ï¼Œå…¶<strong>å¯è¯»æ€§ä¼¼ä¹æ²¡æœ‰å¿…è¦</strong>ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥å¼•å…¥ç½‘å…³å¢åŠ å¯è¯»æ€§ã€‚æ­¤å¤–ï¼Œä½¿ç”¨HTTPåè®®<strong>è°ƒç”¨è¿œç¨‹æ–¹æ³•æ¯”è¾ƒå¤æ‚</strong>ï¼Œè¦å°è£…å„ç§å‚æ•°åå’Œå‚æ•°å€¼ã€‚<br>
ä½†éœ€è¦å†è¯´ä¸€å¥ï¼Œä¸æ˜¯è¯´RPCå¥½ï¼Œä¹Ÿä¸æ˜¯è¯´HTTPå¥½ï¼Œ<strong>ä¸¤è€…å„æœ‰åƒç§‹ï¼Œè¿˜åœ¨æ¯”æ‹¼ä¸­</strong>ã€‚</p>
<ol>
<li><strong>HTTPå’ŒRPCåŒä¸€çº§åˆ«ï¼Œè¿˜æ˜¯è¢«RPCåŒ…å«ï¼Ÿ</strong></li>
<li><strong>Restfulä¹Ÿå±äºRPCä¹ˆï¼Ÿ</strong><br>
<img src="http://blog.ludangxin.club/post-images/1590410838192.jpg" alt="" loading="lazy"><br>
ä¸Šå›¾æ˜¯ä¸€ä¸ªæ¯”è¾ƒå®Œæ•´çš„å…³ç³»å›¾ï¼Œè¿™æ—¶æˆ‘ä»¬å‘ç°HTTPï¼ˆå›¾ä¸­è“è‰²æ¡†ï¼‰å‡ºç°äº†ä¸¤æ¬¡ã€‚å…¶ä¸­ä¸€ä¸ªæ˜¯å’ŒRPCå¹¶åˆ—çš„ï¼Œéƒ½æ˜¯è·¨åº”ç”¨è°ƒç”¨æ–¹æ³•çš„è§£å†³æ–¹æ¡ˆï¼›å¦ä¸€ä¸ªåˆ™æ˜¯è¢«RPCåŒ…å«çš„ï¼Œæ˜¯RPCé€šä¿¡è¿‡ç¨‹çš„å¯é€‰åè®®ä¹‹ä¸€ã€‚<br>
å› æ­¤ï¼Œ**ç¬¬ä¸€ä¸ªé—®é¢˜çš„ç­”æ¡ˆæ˜¯éƒ½å¯¹ã€‚çœ‹æŒ‡çš„æ˜¯å“ªä¸€ä¸ªè“è‰²æ¡†ã€‚**ä»é¢˜ä¸»çš„æé—®çœ‹ï¼Œæ—¢ç„¶é¢˜ä¸»åœ¨çº ç»“è¿™ä¸¤è€…ï¼Œåº”è¯¥æ˜¯æŒ‡ä¸RPCå¹¶åˆ—çš„è“è‰²æ¡†ã€‚<br>
ç¬¬äºŒä¸ªé—®é¢˜æ˜¯åœ¨é—®è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆçº¢è‰²æ¡†ï¼‰æ˜¯ä¸æ˜¯åŒ…å«äº†Restfulï¼ˆé»„è‰²æ¡†ï¼‰ï¼Œè¿™ç§ç†è§£çš„å…³é”®åœ¨äºå¯¹RPCçš„ç†è§£ã€‚<br>
RPCå­—é¢ç†è§£æ˜¯è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼Œå³åœ¨ä¸€ä¸ªåº”ç”¨ä¸­è°ƒç”¨å¦ä¸€ä¸ªåº”ç”¨çš„æ–¹æ³•ã€‚é‚£Restfulæ˜¯æ»¡è¶³çš„ï¼Œé€šè¿‡å®ƒå¯ä»¥å®ç°åœ¨ä¸€ä¸ªåº”ç”¨ä¸­è°ƒç”¨å¦ä¸€ä¸ªåº”ç”¨çš„æ–¹æ³•ã€‚<br>
ä½†æ˜¯ï¼Œä¸Šè¿°ç†è§£ä½¿å¾—RPCçš„å®šä¹‰è¿‡äºå®½æ³›ã€‚RPCé€šå¸¸ç‰¹æŒ‡åœ¨ä¸€ä¸ªåº”ç”¨ä¸­è°ƒç”¨å¦ä¸€ä¸ªåº”ç”¨çš„æ¥å£è€Œå®ç°çš„è¿œç¨‹è°ƒç”¨ï¼Œå³çº¢è‰²æ¡†æ‰€æŒ‡çš„èŒƒå›´ã€‚è¿™æ ·ï¼ŒRPCæ˜¯ä¸åŒ…å«Restfulçš„ã€‚<br>
å› æ­¤ï¼Œ<strong>ç¬¬äºŒä¸ªé—®é¢˜çš„ç­”æ¡ˆæ˜¯Restfulä¸å±äºRPCï¼Œé™¤éå¯¹RPCæœ‰ç€éå¸¸è§„çš„å®½æ³›ç†è§£ã€‚</strong><br>
RPCçš„è‹±æ–‡å…¨ç§°æ˜¯Remote Procedure Callï¼Œç¿»è¯‘ä¸ºä¸­æ–‡å«â€œè¿œç¨‹è¿‡ç¨‹è°ƒç”¨â€ã€‚å…¶ä¸­ç¨æ˜¾æ™¦æ¶©çš„å…¶å®å°±æ˜¯â€œè¿‡ç¨‹â€ï¼Œè¿‡ç¨‹å…¶å®å°±æ˜¯æ–¹æ³•ã€‚æ‰€ä»¥ï¼Œå¯ä»¥æŠŠRPCç†è§£ä¸ºâ€œè¿œç¨‹æ–¹æ³•è°ƒç”¨â€ã€‚<br>
è¦äº†è§£è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼Œé‚£å…ˆç†è§£è¿‡ç¨‹è°ƒç”¨ã€‚éå¸¸ç®€å•ï¼Œå¦‚ä¸‹å›¾ï¼Œå°±æ˜¯è°ƒç”¨ä¸€ä¸ªæ–¹æ³•ã€‚è¿™å¤ªå¸¸è§äº†ï¼Œä¸å¤šè§£é‡Šã€‚<br>
<img src="http://blog.ludangxin.club/post-images/1590410853225.jpg" alt="" loading="lazy"><br>
è€Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå› ä¸ºæ¯ä¸ªæœåŠ¡çš„è¾¹ç•Œéƒ½å¾ˆå°ï¼Œå¾ˆæœ‰å¯èƒ½è°ƒç”¨åˆ«çš„æœåŠ¡æä¾›çš„æ–¹æ³•ã€‚è¿™å°±å‡ºç°äº†æœåŠ¡Aè°ƒç”¨æœåŠ¡Bä¸­æ–¹æ³•çš„éœ€æ±‚ï¼Œå³è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ã€‚<br>
è¦æƒ³è®©æœåŠ¡Aè°ƒç”¨æœåŠ¡Bä¸­çš„æ–¹æ³•ï¼Œæœ€å…ˆæƒ³åˆ°çš„å°±æ˜¯é€šè¿‡HTTPè¯·æ±‚å®ç°ã€‚æ˜¯çš„ï¼Œè¿™æ˜¯å¾ˆå¸¸è§çš„ï¼Œä¾‹å¦‚æœåŠ¡Bæš´éœ²Restfulæ¥å£ï¼Œç„¶åè®©æœåŠ¡Aè°ƒç”¨å®ƒçš„æ¥å£ã€‚åŸºäºRestfulçš„è°ƒç”¨æ–¹å¼å› ä¸ºå¯è¯»æ€§å¥½ï¼ˆæœåŠ¡Bæš´éœ²å‡ºçš„æ˜¯Restfulæ¥å£ï¼Œå¯è¯»æ€§å½“ç„¶å¥½ï¼‰è€Œä¸”HTTPè¯·æ±‚å¯ä»¥é€šè¿‡å„ç§é˜²ç«å¢™ï¼Œå› æ­¤éå¸¸ä¸é”™ã€‚<br>
ç„¶è€Œï¼Œå¦‚å‰é¢æ‰€è¿°ï¼ŒåŸºäºRestfulçš„è¿œç¨‹è¿‡ç¨‹è°ƒç”¨æœ‰ç€æ˜æ˜¾çš„ç¼ºç‚¹ï¼Œä¸»è¦æ˜¯æ•ˆç‡ä½ã€å°è£…è°ƒç”¨å¤æ‚ã€‚å½“å­˜åœ¨å¤§é‡çš„æœåŠ¡é—´è°ƒç”¨æ—¶ï¼Œè¿™äº›ç¼ºç‚¹å˜å¾—æ›´ä¸ºçªå‡ºã€‚<br>
æœåŠ¡Aè°ƒç”¨æœåŠ¡Bçš„è¿‡ç¨‹æ˜¯åº”ç”¨é—´çš„å†…éƒ¨è¿‡ç¨‹ï¼Œ<strong>ç‰ºç‰²å¯è¯»æ€§æå‡æ•ˆç‡ã€æ˜“ç”¨æ€§æ˜¯å¯å–çš„</strong>ã€‚åŸºäºè¿™ç§æ€è·¯ï¼ŒRPCäº§ç”Ÿäº†ã€‚<br>
é€šå¸¸ï¼ŒRPCè¦æ±‚åœ¨è°ƒç”¨æ–¹ä¸­æ”¾ç½®è¢«è°ƒç”¨çš„æ–¹æ³•çš„æ¥å£ã€‚<strong>è°ƒç”¨æ–¹åªè¦è°ƒç”¨äº†è¿™äº›æ¥å£ï¼Œå°±ç›¸å½“äºè°ƒç”¨äº†è¢«è°ƒç”¨æ–¹çš„å®é™…æ–¹æ³•ï¼Œååˆ†æ˜“ç”¨</strong>ã€‚äºæ˜¯ï¼Œè°ƒç”¨æ–¹å¯ä»¥åƒè°ƒç”¨å†…éƒ¨æ¥å£ä¸€æ ·è°ƒç”¨è¿œç¨‹çš„æ–¹æ³•ï¼Œè€Œä¸ç”¨å°è£…å‚æ•°åå’Œå‚æ•°å€¼ç­‰æ“ä½œã€‚<br>
<img src="http://blog.ludangxin.club/post-images/1590410865791.jpg" alt="" loading="lazy"><br>
é‚£è¦æƒ³å®ç°è¿™ä¸ªè¿‡ç¨‹è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿåˆ«æ€¥ï¼Œå’±ä»¬ä¸€æ­¥ä¸€æ­¥æ¥ã€‚<br>
é¦–å…ˆï¼Œè°ƒç”¨æ–¹è°ƒç”¨çš„æ˜¯æ¥å£ï¼Œå¿…é¡»å¾—ä¸ºæ¥å£æ„é€ ä¸€ä¸ªå‡çš„å®ç°ã€‚æ˜¾ç„¶ï¼Œè¦ä½¿ç”¨åŠ¨æ€ä»£ç†ã€‚è¿™æ ·ï¼Œè°ƒç”¨æ–¹çš„è°ƒç”¨å°±è¢«åŠ¨æ€ä»£ç†æ¥æ”¶åˆ°äº†ã€‚<br>
ç¬¬äºŒï¼ŒåŠ¨æ€ä»£ç†æ¥æ”¶åˆ°è°ƒç”¨åï¼Œåº”è¯¥æƒ³åŠæ³•è°ƒç”¨è¿œç¨‹çš„å®é™…å®ç°ã€‚è¿™åŒ…æ‹¬ä¸‹é¢å‡ æ­¥ï¼š</li>
</ol>
<ul>
<li>è¯†åˆ«å…·ä½“è¦è°ƒç”¨çš„è¿œç¨‹æ–¹æ³•çš„IPã€ç«¯å£</li>
<li>å°†è°ƒç”¨æ–¹æ³•çš„å…¥å‚è¿›è¡Œåºåˆ—åŒ–</li>
<li>é€šè¿‡é€šä¿¡å°†è¯·æ±‚å‘é€åˆ°è¿œç¨‹çš„æ–¹æ³•ä¸­<br>
è¿™æ ·ï¼Œè¿œç¨‹çš„æœåŠ¡å°±æ¥æ”¶åˆ°äº†è°ƒç”¨æ–¹çš„è¯·æ±‚ã€‚å®ƒåº”è¯¥ï¼š</li>
<li>ååºåˆ—åŒ–å„ä¸ªè°ƒç”¨å‚æ•°</li>
<li>å®šä½åˆ°å®é™…è¦è°ƒç”¨çš„æ–¹æ³•ï¼Œç„¶åè¾“å…¥å‚æ•°ï¼Œæ‰§è¡Œæ–¹æ³•</li>
<li>æŒ‰ç…§è°ƒç”¨çš„è·¯å¾„è¿”å›è°ƒç”¨çš„ç»“æœ<br>
æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤º:<br>
<img src="http://blog.ludangxin.club/post-images/1590410877190.jpg" alt="" loading="lazy"><br>
è°ƒç”¨æ–¹è°ƒç”¨å†…éƒ¨çš„ä¸€ä¸ªæ–¹æ³•ï¼Œä½†æ˜¯è¢«RPCæ¡†æ¶å·æ¢æ¢æŸ±ä¸ºè¿œç¨‹çš„ä¸€ä¸ªæ–¹æ³•ã€‚ä¹‹é—´çš„<strong>é€šä¿¡æ•°æ®å¯è¯»æ€§ä¸éœ€è¦å¥½</strong>ï¼Œåªéœ€è¦RPCæ¡†æ¶èƒ½è¯»æ‡‚å³å¯ï¼Œå› æ­¤<strong>æ•ˆç‡å¯ä»¥æ›´é«˜</strong>ã€‚é€šå¸¸ä½¿ç”¨UDPæˆ–è€…TCPä½œä¸ºé€šè®¯åè®®ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨HTTPã€‚<br>
æ‰€ä»¥ï¼Œä¸è¦è¢«RPCå“åˆ°ï¼Œå®ƒå°±æ˜¯<strong>è®©ä¸€ä¸ªåº”ç”¨è°ƒç”¨å¦ä¸€ä¸ªåº”ç”¨ä¸­æ–¹æ³•çš„ä¸€ç§å®ç°æ–¹å¼</strong>ã€‚ä¸è°ƒç”¨è¿œç¨‹æ¥å£åŒºåˆ«ä¸å¤§ï¼Œæ¡æ¡å¤§è·¯é€šç½—é©¬ã€‚<br>
å†è¯´ä¸€æ¬¡ï¼Œä¸æ˜¯è¯´RPCå¥½ï¼Œä¹Ÿä¸æ˜¯è¯´HTTPå¥½ï¼Œä¸¤è€…å„æœ‰åƒç§‹ã€‚æœ¬è´¨ä¸Šï¼Œä¸¤è€…æ˜¯<strong>å¯è¯»æ€§å’Œæ•ˆç‡ä¹‹é—´çš„æŠ‰æ‹©</strong>ï¼Œ<strong>é€šç”¨æ€§å’Œæ˜“ç”¨æ€§ä¹‹é—´çš„æŠ‰æ‹©</strong>ã€‚æœ€ç»ˆè°èƒ½å‘å±•æ›´å¥½ï¼Œå¾ˆéš¾è¯´ã€‚<br>
è¦é—®æˆ‘ç«™è°ï¼Ÿæˆ‘<strong>æ ¹æ®ä¸šåŠ¡åœºæ™¯ï¼Œçµæ´»ç«™ä½â€¦â€¦</strong><br>
æ¥æºï¼šçŸ¥ä¹<br>
é“¾æ¥ï¼šhttps://www.zhihu.com/question/41609070/answer/1030913797</li>
</ul>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[åˆè¯† Zookeeper]]></title>
        <id>http://blog.ludangxin.club/post/chu-shi-zookeeper/</id>
        <link href="http://blog.ludangxin.club/post/chu-shi-zookeeper/">
        </link>
        <updated>2020-05-24T05:14:12.000Z</updated>
        <content type="html"><![CDATA[<h1 id="zookeeperæ˜¯ä»€ä¹ˆ">zookeeperæ˜¯ä»€ä¹ˆ</h1>
<p>zookeeperæ˜¯ä¸€ä¸ªå¼€æºçš„åˆ†å¸ƒå¼<strong>åè°ƒ</strong>æœåŠ¡, æä¾›åˆ†å¸ƒå¼<strong>æ•°æ®ä¸€è‡´æ€§</strong>è§£å†³æ–¹æ¡ˆ,åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºå¯ä»¥å®ç°<strong>æ•°æ®ç»Ÿä¸€é…ç½®ç®¡ç†ã€ç»Ÿä¸€å‘½åæœåŠ¡ã€åˆ†å¸ƒå¼é”ã€é›†ç¾¤ç®¡ç†</strong>ç­‰åŠŸèƒ½.</p>
<p>ZooKeeperä¸»è¦<strong>æœåŠ¡äºåˆ†å¸ƒå¼ç³»ç»Ÿ</strong>ï¼Œä½¿ç”¨åˆ†å¸ƒå¼ç³»ç»Ÿå°±æ— æ³•é¿å…å¯¹èŠ‚ç‚¹ç®¡ç†çš„é—®é¢˜(éœ€è¦å®æ—¶æ„ŸçŸ¥èŠ‚ç‚¹çš„çŠ¶æ€ã€å¯¹èŠ‚ç‚¹è¿›è¡Œç»Ÿä¸€ç®¡ç†ç­‰ç­‰)ï¼Œè€Œç”±äºè¿™äº›é—®é¢˜å¤„ç†èµ·æ¥å¯èƒ½ç›¸å¯¹éº»çƒ¦å’Œæé«˜äº†ç³»ç»Ÿçš„å¤æ‚æ€§ï¼ŒZooKeeperä½œä¸ºä¸€ä¸ªèƒ½å¤Ÿ<strong>é€šç”¨</strong>è§£å†³è¿™äº›é—®é¢˜çš„ä¸­é—´ä»¶å°±åº”è¿è€Œç”Ÿäº†ã€‚</p>
<h1 id="zookeeperä¸ºä»€ä¹ˆèƒ½å¹²è¿™ä¹ˆå¤š">zookeeperä¸ºä»€ä¹ˆèƒ½å¹²è¿™ä¹ˆå¤š</h1>
<p>ä»ä¸Šé¢æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå¯ä»¥ç”¨ZooKeeperæ¥åšï¼šç»Ÿä¸€é…ç½®ç®¡ç†ã€ç»Ÿä¸€å‘½åæœåŠ¡ã€åˆ†å¸ƒå¼é”ã€é›†ç¾¤ç®¡ç†ã€‚</p>
<ul>
<li>è¿™é‡Œæˆ‘ä»¬<strong>å…ˆ</strong>ä¸ç®¡<code>ç»Ÿä¸€é…ç½®ç®¡ç†ã€ç»Ÿä¸€å‘½åæœåŠ¡ã€åˆ†å¸ƒå¼é”ã€é›†ç¾¤ç®¡ç†</code>æ¯ä¸ªå…·ä½“çš„å«ä¹‰(åé¢ä¼šè®²)</li>
</ul>
<p>é‚£ä¸ºä»€ä¹ˆZooKeeperå¯ä»¥å¹²é‚£ä¹ˆå¤šäº‹ï¼Ÿæ¥çœ‹çœ‹ZooKeeperç©¶ç«Ÿæ˜¯ä½•æ–¹ç¥ç‰©ï¼Œåœ¨Wikiä¸­å…¶å®ä¹Ÿæœ‰æåˆ°ï¼š</p>
<blockquote>
<p>ZooKeeper nodes store their data in a hierarchical name space, much like a file system or a <a href="https://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/Tree_(data_structure)">tree</a> data structure</p>
<p>è¯‘æ–‡: ZooKeeperèŠ‚ç‚¹å°†å…¶æ•°æ®å­˜å‚¨åœ¨åˆ†å±‚åç§°ç©ºé—´ä¸­ï¼Œè¿™ä¸æ–‡ä»¶ç³»ç»Ÿæˆ–æ ‘æ•°æ®ç»“æ„éå¸¸ç›¸ä¼¼</p>
</blockquote>
<p><strong>Zookeeper ä¸€ä¸ªæœ€å¸¸ç”¨çš„ä½¿ç”¨åœºæ™¯å°±æ˜¯ç”¨äºæ‹…ä»»æœåŠ¡ç”Ÿäº§è€…å’ŒæœåŠ¡æ¶ˆè´¹è€…çš„æ³¨å†Œä¸­å¿ƒ</strong> ã€‚æœåŠ¡ç”Ÿäº§è€…å°†è‡ªå·±æä¾›çš„æœåŠ¡æ³¨å†Œåˆ°Zookeeperä¸­å¿ƒï¼ŒæœåŠ¡çš„æ¶ˆè´¹è€…åœ¨è¿›è¡ŒæœåŠ¡è°ƒç”¨çš„æ—¶å€™å…ˆåˆ°Zookeeperä¸­æŸ¥æ‰¾æœåŠ¡ï¼Œè·å–åˆ°æœåŠ¡ç”Ÿäº§è€…çš„è¯¦ç»†ä¿¡æ¯ä¹‹åï¼Œå†å»è°ƒç”¨æœåŠ¡ç”Ÿäº§è€…çš„å†…å®¹ä¸æ•°æ®ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåœ¨ Dubboæ¶æ„ä¸­ Zookeeper å°±æ‹…ä»»äº†æ³¨å†Œä¸­å¿ƒè¿™ä¸€è§’è‰²ã€‚<br>
<img src="http://blog.ludangxin.club/post-images/1590297452731.jpg" alt="" loading="lazy"></p>
<h2 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h2>
<p>ZooKeeperçš„æ•°æ®ç»“æ„ï¼Œè·ŸUnixæ–‡ä»¶ç³»ç»Ÿéå¸¸ç±»ä¼¼ï¼Œå¯ä»¥çœ‹åšæ˜¯ä¸€é¢—<strong>æ ‘</strong>ï¼Œæ¯ä¸ªèŠ‚ç‚¹å«åš<strong>ZNode</strong>ã€‚æ¯ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥é€šè¿‡<strong>è·¯å¾„</strong>æ¥æ ‡è¯†ï¼Œç»“æ„å›¾å¦‚ä¸‹ï¼š<br>
<img src="http://blog.ludangxin.club/post-images/1590297465572.jpg" alt="" loading="lazy"><br>
é‚£ZooKeeperè¿™é¢—&quot;æ ‘&quot;æœ‰ä»€ä¹ˆç‰¹ç‚¹å‘¢ï¼Ÿï¼ŸZooKeeperçš„èŠ‚ç‚¹æˆ‘ä»¬ç§°ä¹‹ä¸º<strong>Znode</strong>ï¼ŒZnodeåˆ†ä¸º<strong>ä¸¤ç§</strong>ç±»å‹ï¼š</p>
<ul>
<li><strong>çŸ­æš‚/ä¸´æ—¶(Ephemeral)</strong>ï¼šå½“å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ–­å¼€è¿æ¥åï¼Œæ‰€åˆ›å»ºçš„Znode(èŠ‚ç‚¹)<strong>ä¼šè‡ªåŠ¨åˆ é™¤</strong></li>
<li><strong>æŒä¹…(Persistent)</strong>ï¼šå½“å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ–­å¼€è¿æ¥åï¼Œæ‰€åˆ›å»ºçš„Znode(èŠ‚ç‚¹)<strong>ä¸ä¼šåˆ é™¤</strong></li>
</ul>
<blockquote>
<p>ZooKeeperå’ŒRedisä¸€æ ·ï¼Œä¹Ÿæ˜¯C/Sç»“æ„(åˆ†æˆå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯)<br>
<img src="http://blog.ludangxin.club/post-images/1590297481498.jpg" alt="" loading="lazy"></p>
</blockquote>
<h2 id="ç›‘å¬å™¨">ç›‘å¬å™¨</h2>
<p>åœ¨ä¸Šé¢æˆ‘ä»¬å·²ç»ç®€å•çŸ¥é“äº†ZooKeeperçš„æ•°æ®ç»“æ„äº†ï¼ŒZooKeeperè¿˜é…åˆäº†<strong>ç›‘å¬å™¨</strong>æ‰èƒ½å¤Ÿåšé‚£ä¹ˆå¤šäº‹çš„ã€‚<br>
<strong>å¸¸è§</strong>çš„ç›‘å¬åœºæ™¯æœ‰ä»¥ä¸‹ä¸¤é¡¹ï¼š</p>
<ul>
<li>ç›‘å¬ZnodeèŠ‚ç‚¹çš„<strong>æ•°æ®å˜åŒ–</strong></li>
<li>ç›‘å¬å­èŠ‚ç‚¹çš„<strong>å¢å‡å˜åŒ–</strong><br>
<img src="http://blog.ludangxin.club/post-images/1590297499784.jpg" alt="" loading="lazy"><br>
<img src="http://blog.ludangxin.club/post-images/1590297527050.jpg" alt="" loading="lazy"><br>
æ²¡é”™ï¼Œé€šè¿‡<strong>ç›‘å¬+ZnodeèŠ‚ç‚¹(æŒä¹…/çŸ­æš‚[ä¸´æ—¶])</strong>ï¼ŒZooKeeperå°±å¯ä»¥ç©å‡ºè¿™ä¹ˆå¤šèŠ±æ ·äº†ã€‚</li>
</ul>
<h1 id="zookeeperå…·ä½“èƒ½å¹²ä»€ä¹ˆ">zookeeperå…·ä½“èƒ½å¹²ä»€ä¹ˆ</h1>
<h2 id="ç»Ÿä¸€é…ç½®ç®¡ç†">ç»Ÿä¸€é…ç½®ç®¡ç†</h2>
<p>æ¯”å¦‚æˆ‘ä»¬ç°åœ¨æœ‰ä¸‰ä¸ªç³»ç»ŸAã€Bã€Cï¼Œä»–ä»¬æœ‰ä¸‰ä»½é…ç½®ï¼Œåˆ†åˆ«æ˜¯<code>ASystem.ymlã€BSystem.ymlã€CSystem.yml</code>ï¼Œç„¶åï¼Œè¿™ä¸‰ä»½é…ç½®åˆéå¸¸ç±»ä¼¼ï¼Œå¾ˆå¤šçš„é…ç½®é¡¹å‡ ä¹éƒ½ä¸€æ ·ã€‚</p>
<ul>
<li>æ­¤æ—¶ï¼Œå¦‚æœæˆ‘ä»¬è¦æ”¹å˜å…¶ä¸­ä¸€ä»½é…ç½®é¡¹çš„ä¿¡æ¯ï¼Œå¾ˆå¯èƒ½å…¶ä»–ä¸¤ä»½éƒ½è¦æ”¹ã€‚å¹¶ä¸”ï¼Œæ”¹å˜äº†é…ç½®é¡¹çš„ä¿¡æ¯<strong>å¾ˆå¯èƒ½å°±è¦é‡å¯ç³»ç»Ÿ</strong><br>
äºæ˜¯ï¼Œæˆ‘ä»¬å¸Œæœ›æŠŠ<code>ASystem.ymlã€BSystem.ymlã€CSystem.yml</code>ç›¸åŒçš„é…ç½®é¡¹æŠ½å–å‡ºæ¥æˆä¸€ä»½<strong>å…¬ç”¨</strong>çš„é…ç½®<code>common.yml</code>ï¼Œå¹¶ä¸”å³ä¾¿<code>common.yml</code>æ”¹äº†ï¼Œä¹Ÿä¸éœ€è¦ç³»ç»ŸAã€Bã€Cé‡å¯ã€‚<br>
<img src="http://blog.ludangxin.club/post-images/1590297542591.jpg" alt="" loading="lazy"><br>
åšæ³•ï¼šæˆ‘ä»¬å¯ä»¥å°†<code>common.yml</code>è¿™ä»½é…ç½®æ”¾åœ¨ZooKeeperçš„ZnodeèŠ‚ç‚¹ä¸­ï¼Œç³»ç»ŸAã€Bã€Cç›‘å¬ç€è¿™ä¸ªZnodeèŠ‚ç‚¹æœ‰æ— å˜æ›´ï¼Œå¦‚æœå˜æ›´äº†ï¼Œ<strong>åŠæ—¶</strong>å“åº”ã€‚<br>
<img src="http://blog.ludangxin.club/post-images/1590297551378.jpg" alt="" loading="lazy"></li>
</ul>
<h2 id="ç»Ÿä¸€å‘½åæœåŠ¡">ç»Ÿä¸€å‘½åæœåŠ¡</h2>
<p>ç»Ÿä¸€å‘½åæœåŠ¡çš„ç†è§£å…¶å®è·Ÿ<strong>åŸŸå</strong>ä¸€æ ·ï¼Œæ˜¯æˆ‘ä»¬ä¸ºè¿™æŸä¸€éƒ¨åˆ†çš„èµ„æºç»™å®ƒ<strong>å–ä¸€ä¸ªåå­—</strong>ï¼Œåˆ«äººé€šè¿‡è¿™ä¸ªåå­—å°±å¯ä»¥æ‹¿åˆ°å¯¹åº”çš„èµ„æºã€‚<br>
æ¯”å¦‚è¯´ï¼Œç°åœ¨æˆ‘æœ‰ä¸€ä¸ªåŸŸå<code>www.java3y.com</code>ï¼Œä½†æˆ‘è¿™ä¸ªåŸŸåä¸‹æœ‰å¤šå°æœºå™¨ï¼š</p>
<ul>
<li>192.168.1.1</li>
<li>192.168.1.2</li>
<li>192.168.1.3</li>
<li>192.168.1.4<br>
åˆ«äººè®¿é—®<code>www.java3y.com</code>å³å¯è®¿é—®åˆ°æˆ‘çš„æœºå™¨ï¼Œè€Œä¸æ˜¯é€šè¿‡IPå»è®¿é—®ã€‚<br>
<img src="http://blog.ludangxin.club/post-images/1590297563202.jpg" alt="" loading="lazy"></li>
</ul>
<h2 id="åˆ†å¸ƒå¼é”">åˆ†å¸ƒå¼é”</h2>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ZooKeeperæ¥å®ç°åˆ†å¸ƒå¼é”ï¼Œé‚£æ˜¯æ€ä¹ˆåšçš„å‘¢ï¼Ÿï¼Ÿä¸‹é¢æ¥çœ‹çœ‹ï¼š<br>
ç³»ç»ŸAã€Bã€Céƒ½å»è®¿é—®<code>/locks</code>èŠ‚ç‚¹<br>
<img src="http://blog.ludangxin.club/post-images/1590297574406.jpg" alt="" loading="lazy"><br>
è®¿é—®çš„æ—¶å€™ä¼šåˆ›å»º<strong>å¸¦é¡ºåºå·çš„ä¸´æ—¶/çŸ­æš‚</strong>(<code>EPHEMERAL_SEQUENTIAL</code>)èŠ‚ç‚¹ï¼Œæ¯”å¦‚ï¼Œç³»ç»ŸAåˆ›å»ºäº†<code>id_000000</code>èŠ‚ç‚¹ï¼Œç³»ç»ŸBåˆ›å»ºäº†<code>id_000002</code>èŠ‚ç‚¹ï¼Œç³»ç»ŸCåˆ›å»ºäº†<code>id_000001</code>èŠ‚ç‚¹ã€‚<br>
<img src="http://blog.ludangxin.club/post-images/1590297582628.jpg" alt="" loading="lazy"><br>
æ¥ç€ï¼Œæ‹¿åˆ°<code>/locks</code>èŠ‚ç‚¹ä¸‹çš„æ‰€æœ‰å­èŠ‚ç‚¹(id_000000,id_000001,id_000002)ï¼Œ<strong>åˆ¤æ–­è‡ªå·±åˆ›å»ºçš„æ˜¯ä¸æ˜¯æœ€å°çš„é‚£ä¸ªèŠ‚ç‚¹</strong></p>
<ul>
<li>å¦‚æœæ˜¯ï¼Œåˆ™æ‹¿åˆ°é”ã€‚</li>
<li>
<ul>
<li>é‡Šæ”¾é”ï¼šæ‰§è¡Œå®Œæ“ä½œåï¼ŒæŠŠåˆ›å»ºçš„èŠ‚ç‚¹ç»™åˆ æ‰</li>
</ul>
</li>
<li>å¦‚æœä¸æ˜¯ï¼Œåˆ™ç›‘å¬æ¯”è‡ªå·±è¦å°1çš„èŠ‚ç‚¹å˜åŒ–<br>
ä¸¾ä¸ªä¾‹å­ï¼š</li>
<li>ç³»ç»ŸAæ‹¿åˆ°<code>/locks</code>èŠ‚ç‚¹ä¸‹çš„æ‰€æœ‰å­èŠ‚ç‚¹ï¼Œç»è¿‡æ¯”è¾ƒï¼Œå‘ç°è‡ªå·±(<code>id_000000</code>)ï¼Œæ˜¯æ‰€æœ‰å­èŠ‚ç‚¹æœ€å°çš„ã€‚æ‰€ä»¥å¾—åˆ°é”</li>
<li>ç³»ç»ŸBæ‹¿åˆ°<code>/locks</code>èŠ‚ç‚¹ä¸‹çš„æ‰€æœ‰å­èŠ‚ç‚¹ï¼Œç»è¿‡æ¯”è¾ƒï¼Œå‘ç°è‡ªå·±(<code>id_000002</code>)ï¼Œä¸æ˜¯æ‰€æœ‰å­èŠ‚ç‚¹æœ€å°çš„ã€‚æ‰€ä»¥ç›‘å¬æ¯”è‡ªå·±å°1çš„èŠ‚ç‚¹<code>id_000001</code>çš„çŠ¶æ€</li>
<li>ç³»ç»ŸCæ‹¿åˆ°<code>/locks</code>èŠ‚ç‚¹ä¸‹çš„æ‰€æœ‰å­èŠ‚ç‚¹ï¼Œç»è¿‡æ¯”è¾ƒï¼Œå‘ç°è‡ªå·±(<code>id_000001</code>)ï¼Œä¸æ˜¯æ‰€æœ‰å­èŠ‚ç‚¹æœ€å°çš„ã€‚æ‰€ä»¥ç›‘å¬æ¯”è‡ªå·±å°1çš„èŠ‚ç‚¹<code>id_000000</code>çš„çŠ¶æ€</li>
<li>â€¦...</li>
<li>ç­‰åˆ°ç³»ç»ŸAæ‰§è¡Œå®Œæ“ä½œä»¥åï¼Œå°†è‡ªå·±åˆ›å»ºçš„èŠ‚ç‚¹åˆ é™¤(<code>id_000000</code>)ã€‚é€šè¿‡ç›‘å¬ï¼Œç³»ç»ŸCå‘ç°<code>id_000000</code>èŠ‚ç‚¹å·²ç»åˆ é™¤äº†ï¼Œå‘ç°è‡ªå·±å·²ç»æ˜¯æœ€å°çš„èŠ‚ç‚¹äº†ï¼Œäºæ˜¯é¡ºåˆ©æ‹¿åˆ°é”</li>
<li>â€¦.ç³»ç»ŸBå¦‚ä¸Š</li>
</ul>
<h2 id="é›†ç¾¤çŠ¶æ€">é›†ç¾¤çŠ¶æ€</h2>
<p>ç»è¿‡ä¸Šé¢å‡ ä¸ªä¾‹å­ï¼Œæˆ‘ç›¸ä¿¡å¤§å®¶ä¹Ÿå¾ˆå®¹æ˜“æƒ³åˆ°ZooKeeperæ˜¯æ€ä¹ˆ&quot;<strong>æ„ŸçŸ¥</strong>&quot;èŠ‚ç‚¹çš„åŠ¨æ€æ–°å¢æˆ–è€…åˆ é™¤çš„äº†ã€‚<br>
è¿˜æ˜¯ä»¥æˆ‘ä»¬ä¸‰ä¸ªç³»ç»ŸAã€Bã€Cä¸ºä¾‹ï¼Œåœ¨ZooKeeperä¸­åˆ›å»º<strong>ä¸´æ—¶èŠ‚ç‚¹</strong>å³å¯ï¼š<br>
<img src="http://blog.ludangxin.club/post-images/1590297610379.jpg" alt="" loading="lazy"><br>
åªè¦ç³»ç»ŸAæŒ‚äº†ï¼Œé‚£<code>/groupMember/A</code>è¿™ä¸ªèŠ‚ç‚¹å°±ä¼šåˆ é™¤ï¼Œé€šè¿‡<strong>ç›‘å¬</strong><code>groupMember</code>ä¸‹çš„å­èŠ‚ç‚¹ï¼Œç³»ç»ŸBå’ŒCå°±èƒ½å¤Ÿæ„ŸçŸ¥åˆ°ç³»ç»ŸAå·²ç»æŒ‚äº†ã€‚(æ–°å¢ä¹Ÿæ˜¯åŒç†)<br>
é™¤äº†èƒ½å¤Ÿæ„ŸçŸ¥èŠ‚ç‚¹çš„ä¸Šä¸‹çº¿å˜åŒ–ï¼ŒZooKeeperè¿˜å¯ä»¥å®ç°<strong>åŠ¨æ€é€‰ä¸¾Master</strong>çš„åŠŸèƒ½ã€‚(å¦‚æœé›†ç¾¤æ˜¯ä¸»ä»æ¶æ„æ¨¡å¼ä¸‹)<br>
åŸç†ä¹Ÿå¾ˆç®€å•ï¼Œå¦‚æœæƒ³è¦å®ç°åŠ¨æ€é€‰ä¸¾Masterçš„åŠŸèƒ½ï¼ŒZnodeèŠ‚ç‚¹çš„ç±»å‹æ˜¯å¸¦<strong>é¡ºåºå·çš„ä¸´æ—¶èŠ‚ç‚¹</strong>(<code>EPHEMERAL_SEQUENTIAL</code>)å°±å¥½äº†ã€‚</p>
<ul>
<li>Zookeeperä¼šæ¯æ¬¡é€‰ä¸¾æœ€å°ç¼–å·çš„ä½œä¸ºMasterï¼Œå¦‚æœMasteræŒ‚äº†ï¼Œè‡ªç„¶å¯¹åº”çš„ZnodeèŠ‚ç‚¹å°±ä¼šåˆ é™¤ã€‚ç„¶åè®©<strong>æ–°çš„æœ€å°ç¼–å·ä½œä¸ºMaster</strong>ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°åŠ¨æ€é€‰ä¸¾çš„åŠŸèƒ½äº†ã€‚<br>
è½¬è‡ª: <a href="https://www.zhihu.com/question/65852003/answer/656091418">Java3y-zookeeper</a></li>
</ul>
<h1 id="zab-åè®®paxosç®—æ³•">ZAB åè®®&amp;Paxosç®—æ³•</h1>
<p><a href="https://www.zhihu.com/question/19787937/answer/107750652">paxos ç®—æ³•</a><br>
Paxos ç®—æ³•åº”è¯¥å¯ä»¥è¯´æ˜¯ ZooKeeper çš„çµé­‚äº†ã€‚ä½†æ˜¯ï¼ŒZooKeeper å¹¶æ²¡æœ‰å®Œå…¨é‡‡ç”¨ Paxosç®—æ³• ï¼Œè€Œæ˜¯ä½¿ç”¨ ZAB åè®®ä½œä¸ºå…¶ä¿è¯æ•°æ®ä¸€è‡´æ€§çš„æ ¸å¿ƒç®—æ³•ã€‚å¦å¤–ï¼Œåœ¨ZooKeeperçš„å®˜æ–¹æ–‡æ¡£ä¸­ä¹ŸæŒ‡å‡ºï¼ŒZABåè®®å¹¶ä¸åƒ Paxos ç®—æ³•é‚£æ ·ï¼Œæ˜¯ä¸€ç§é€šç”¨çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•ï¼Œå®ƒæ˜¯ä¸€ç§ç‰¹åˆ«ä¸ºZookeeperè®¾è®¡çš„å´©æºƒå¯æ¢å¤çš„åŸå­æ¶ˆæ¯å¹¿æ’­ç®—æ³•ã€‚</p>
<h2 id="zab-åè®®ä»‹ç»">ZAB åè®®ä»‹ç»</h2>
<p><strong>ZABï¼ˆZooKeeper Atomic Broadcast åŸå­å¹¿æ’­ï¼‰ åè®®æ˜¯ä¸ºåˆ†å¸ƒå¼åè°ƒæœåŠ¡ ZooKeeper ä¸“é—¨è®¾è®¡çš„ä¸€ç§æ”¯æŒå´©æºƒæ¢å¤çš„åŸå­å¹¿æ’­åè®®ã€‚ åœ¨ ZooKeeper ä¸­ï¼Œä¸»è¦ä¾èµ– ZAB åè®®æ¥å®ç°åˆ†å¸ƒå¼æ•°æ®ä¸€è‡´æ€§ï¼ŒåŸºäºè¯¥åè®®ï¼ŒZooKeeper å®ç°äº†ä¸€ç§ä¸»å¤‡æ¨¡å¼çš„ç³»ç»Ÿæ¶æ„æ¥ä¿æŒé›†ç¾¤ä¸­å„ä¸ªå‰¯æœ¬ä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§ã€‚</strong><br>
<strong>ZAB åè®®ä¸¤ç§åŸºæœ¬çš„æ¨¡å¼ï¼šå´©æºƒæ¢å¤å’Œæ¶ˆæ¯å¹¿æ’­</strong><br>
ZABåè®®åŒ…æ‹¬ä¸¤ç§åŸºæœ¬çš„æ¨¡å¼ï¼Œåˆ†åˆ«æ˜¯ <strong>å´©æºƒæ¢å¤å’Œæ¶ˆæ¯å¹¿æ’­</strong>ã€‚å½“æ•´ä¸ªæœåŠ¡æ¡†æ¶åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œæˆ–æ˜¯å½“ Leader æœåŠ¡å™¨å‡ºç°ç½‘ç»œä¸­æ–­ã€å´©æºƒé€€å‡ºä¸é‡å¯ç­‰å¼‚å¸¸æƒ…å†µæ—¶ï¼ŒZAB åè®®å°±ä¼šè¿›äººæ¢å¤æ¨¡å¼å¹¶é€‰ä¸¾äº§ç”Ÿæ–°çš„LeaderæœåŠ¡å™¨ã€‚å½“é€‰ä¸¾äº§ç”Ÿäº†æ–°çš„ Leader æœåŠ¡å™¨ï¼ŒåŒæ—¶é›†ç¾¤ä¸­å·²ç»æœ‰è¿‡åŠçš„æœºå™¨ä¸è¯¥LeaderæœåŠ¡å™¨å®Œæˆäº†çŠ¶æ€åŒæ­¥ä¹‹åï¼ŒZABåè®®å°±ä¼šé€€å‡ºæ¢å¤æ¨¡å¼ã€‚å…¶ä¸­ï¼Œ<strong>æ‰€è°“çš„çŠ¶æ€åŒæ­¥æ˜¯æŒ‡æ•°æ®åŒæ­¥ï¼Œç”¨æ¥ä¿è¯é›†ç¾¤ä¸­å­˜åœ¨è¿‡åŠçš„æœºå™¨èƒ½å¤Ÿå’ŒLeaderæœåŠ¡å™¨çš„æ•°æ®çŠ¶æ€ä¿æŒä¸€è‡´</strong>ã€‚<br>
<strong>å½“é›†ç¾¤ä¸­å·²ç»æœ‰è¿‡åŠçš„FolloweræœåŠ¡å™¨å®Œæˆäº†å’ŒLeaderæœåŠ¡å™¨çš„çŠ¶æ€åŒæ­¥ï¼Œé‚£ä¹ˆæ•´ä¸ªæœåŠ¡æ¡†æ¶å°±å¯ä»¥è¿›äººæ¶ˆæ¯å¹¿æ’­æ¨¡å¼äº†ã€‚</strong> å½“ä¸€å°åŒæ ·éµå®ˆZABåè®®çš„æœåŠ¡å™¨å¯åŠ¨ååŠ äººåˆ°é›†ç¾¤ä¸­æ—¶ï¼Œå¦‚æœæ­¤æ—¶é›†ç¾¤ä¸­å·²ç»å­˜åœ¨ä¸€ä¸ªLeaderæœåŠ¡å™¨åœ¨è´Ÿè´£è¿›è¡Œæ¶ˆæ¯å¹¿æ’­ï¼Œé‚£ä¹ˆæ–°åŠ äººçš„æœåŠ¡å™¨å°±ä¼šè‡ªè§‰åœ°è¿›äººæ•°æ®æ¢å¤æ¨¡å¼ï¼šæ‰¾åˆ°Leaderæ‰€åœ¨çš„æœåŠ¡å™¨ï¼Œå¹¶ä¸å…¶è¿›è¡Œæ•°æ®åŒæ­¥ï¼Œç„¶åä¸€èµ·å‚ä¸åˆ°æ¶ˆæ¯å¹¿æ’­æµç¨‹ä¸­å»ã€‚æ­£å¦‚ä¸Šæ–‡ä»‹ç»ä¸­æ‰€è¯´çš„ï¼ŒZooKeeperè®¾è®¡æˆåªå…è®¸å”¯ä¸€çš„ä¸€ä¸ªLeaderæœåŠ¡å™¨æ¥è¿›è¡Œäº‹åŠ¡è¯·æ±‚çš„å¤„ç†ã€‚LeaderæœåŠ¡å™¨åœ¨æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„äº‹åŠ¡è¯·æ±‚åï¼Œä¼šç”Ÿæˆå¯¹åº”çš„äº‹åŠ¡ææ¡ˆå¹¶å‘èµ·ä¸€è½®å¹¿æ’­åè®®ï¼›è€Œå¦‚æœé›†ç¾¤ä¸­çš„å…¶ä»–æœºå™¨æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„äº‹åŠ¡è¯·æ±‚ï¼Œé‚£ä¹ˆè¿™äº›éLeaderæœåŠ¡å™¨ä¼šé¦–å…ˆå°†è¿™ä¸ªäº‹åŠ¡è¯·æ±‚è½¬å‘ç»™LeaderæœåŠ¡å™¨ã€‚</p>
<h1 id="zookeeperç¯å¢ƒæ­å»º">zookeeperç¯å¢ƒæ­å»º</h1>
<h2 id="å•æœºç¯å¢ƒ">å•æœºç¯å¢ƒ</h2>
<ol>
<li>ä¸Šä¼ zookeeperåˆ°linuxæœåŠ¡å™¨</li>
<li>è§£å‹ç¼©å‹ç¼©åŒ…</li>
</ol>
<pre><code class="language-bash">tar -zxvf zookeeper-3.5.8.tar
</code></pre>
<ol start="3">
<li>è¿›å…¥zookeeper-3.5.8ç›®å½•,åˆ›å»ºdataæ–‡ä»¶å¤¹ä¸”åˆ›å»ºcfgæ–‡ä»¶</li>
</ol>
<pre><code class="language-bash">mkdir data
cd conf
# zookeeperé»˜è®¤è¯»å–zoo.cfgçš„é…ç½®æ–‡ä»¶ä¿¡æ¯
cp zoo_sample.cfg zoo.cfg
</code></pre>
<ol start="4">
<li>ä¿®æ”¹zoo.cfg dataç›®å½•</li>
</ol>
<pre><code class="language-bash">dataDir=/usr/local/zookeeper-3.5.8/data
# zkæœåŠ¡å™¨é»˜è®¤8080ç«¯å£,ä¸ºé˜²æ­¢ç«¯å£å ç”¨,å¢åŠ serverPorté…ç½®
admin.serverPort=6666
</code></pre>
<ol start="5">
<li>åˆ°binç›®å½•å¯åŠ¨zookeeper</li>
</ol>
<pre><code class="language-bash">./zkServer.sh start
</code></pre>
<ol start="6">
<li>æŸ¥çœ‹zookeeperçŠ¶æ€</li>
</ol>
<pre><code class="language-bash">./zkServer.sh status
</code></pre>
<h2 id="é›†ç¾¤ç¯å¢ƒ">é›†ç¾¤ç¯å¢ƒ</h2>
<ol>
<li>å°†zookeeperåˆ†åˆ«å®‰è£…åˆ°ä¸‰å°æœåŠ¡å™¨ä¸Šå¹¶é…ç½®å¥½åŸºæœ¬ä¿¡æ¯(é‡å¤å•æœºç¯å¢ƒæ­å»ºè¿‡ç¨‹)</li>
<li>åœ¨æ¯ä¸ªzookeeperçš„dataç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªmyidæ–‡ä»¶,å†…å®¹åˆ†åˆ«æ˜¯1,2,3 è¿™ä¸ªæ–‡ä»¶å°±æ˜¯è®°å½•æ¯ä¸ªæœåŠ¡å™¨çš„id</li>
</ol>
<pre><code class="language-bash"># 192.168.1.110 æœåŠ¡å™¨
echo 1 &gt; myid 
# 192.168.1.111 æœåŠ¡å™¨
echo 2 &gt; myid 
# 192.168.1.112 æœåŠ¡å™¨
echo 3 &gt; myid 
</code></pre>
<ol start="3">
<li>åœ¨æ¯ä¸€ä¸ªzookeeperçš„zoo.cfgé…ç½®å®¢æˆ·ç«¯è®¿é—®ç«¯å£å’Œé›†ç¾¤æœåŠ¡å™¨ipåˆ—è¡¨</li>
</ol>
<pre><code class="language-bash"># server.æœåŠ¡å™¨id=æœåŠ¡å™¨ipåœ°å€:æœåŠ¡å™¨ä¹‹é—´é€šä¿¡ç«¯å£:æœåŠ¡å™¨ä¹‹é—´æŠ•ç¥¨é€‰ä¸¾ç«¯å£
server.1=192.168.1.110:2181:3881
server.2=192.168.1.111:2181:3881
server.3=192.168.1.112:2181:3881
</code></pre>
<ol start="4">
<li>å¯åŠ¨é›†ç¾¤<br>
ä¾æ¬¡å¯åŠ¨ä¸‰ä¸ªzkå®ä¾‹,å…¶ä¸­æœ‰ä¸€ä¸ªleaderå’Œä¸¤ä¸ªfollower</li>
<li>é€šè¿‡<code>./zkServer.sh status</code>å‘½ä»¤å¯ä»¥æŸ¥çœ‹å½“å‰zkæ˜¯ leader è¿˜æ˜¯ follower</li>
<li>å¯ä»¥é€šè¿‡<code>./zkServer.sh stop</code>å‘½ä»¤åœæ­¢zkæœåŠ¡æ¥æµ‹è¯•zkçš„é€‰ä¸¾æ¨¡å¼</li>
</ol>
<h1 id="zookeeperåŸºæœ¬ä½¿ç”¨">zookeeperåŸºæœ¬ä½¿ç”¨</h1>
<h2 id="æ•°æ®ç»“æ„-2">æ•°æ®ç»“æ„</h2>
<p>zookeeperæ•°æ®æ¨¡å‹çš„ç»“æ„ä¸Unixæ–‡ä»¶ç³»ç»Ÿå¾ˆç±»ä¼¼,æ•´ä½“ä¸Šå¯ä»¥çœ‹ä½œæ˜¯ä¸€æ£µæ ‘,æ¯ä¸ªèŠ‚ç‚¹ç§°ä½œä¸€ä¸ªZNode,æ¯ä¸ªZNodeéƒ½å¯ä»¥é€šè¿‡å…¶è·¯å¾„å”¯ä¸€æ ‡è¯†. å¦‚å›¾ç¤º<br>
<img src="http://blog.ludangxin.club/post-images/1590297680104.jpg" alt="" loading="lazy"><br>
ZNodeèŠ‚ç‚¹ç±»å‹</p>
<ul>
<li>æŒä¹…åŒ–ç›®å½•èŠ‚ç‚¹(PERSISTENT)<br>
å®¢æˆ·ç«¯ä¸zookeeperæ–­å¼€è¿æ¥å,è¯¥èŠ‚ç‚¹ä¾æ—§å­˜åœ¨</li>
<li>æŒä¹…åŒ–é¡ºåºç¼–å·ç›®å½•èŠ‚ç‚¹(PERSISTENT_SEQUENTIAL)<br>
å®¢æˆ·ç«¯ä¸zookeeperæ–­å¼€è¿æ¥å,è¯¥èŠ‚ç‚¹ä¾æ—§å­˜åœ¨,zookeeperä¼šç»™è¯¥èŠ‚ç‚¹æŒ‰ç…§é¡ºåºç¼–å·</li>
<li>ä¸´æ—¶ç›®å½•èŠ‚ç‚¹(EPHEMERAL)<br>
å®¢æˆ·ç«¯ä¸zookeeperæ–­å¼€è¿æ¥å,è¯¥èŠ‚ç‚¹è¢«åˆ é™¤</li>
<li>ä¸´æ—¶é¡ºåºç¼–å·ç›®å½•èŠ‚ç‚¹(EPHEMERAL_SEQUENTIAL)<br>
å®¢æˆ·ç«¯ä¸zookeeperæ–­å¼€è¿æ¥å,è¯¥èŠ‚ç‚¹è¢«åˆ é™¤,zookeeperä¼šç»™è¯¥èŠ‚ç‚¹æŒ‰ç…§é¡ºåºç¼–å·</li>
</ul>
<h2 id="å‘½ä»¤è¡Œä½¿ç”¨">å‘½ä»¤è¡Œä½¿ç”¨</h2>
<ol>
<li>åœ¨zookeeper binç›®å½•ä¸­è¾“å…¥ <code>./zkCli.sh</code> è¿›å…¥å®¢æˆ·ç«¯</li>
<li>è¾“å…¥helpæŸ¥çœ‹ç›¸å…³å‘½ä»¤æ“ä½œ,ç»“æœå¦‚ä¸‹<br>
<img src="http://blog.ludangxin.club/post-images/1590297708595.jpg" alt="" loading="lazy"><br>
å¸¸ç”¨å‘½ä»¤è®²è§£:</li>
</ol>
<h2 id="èŠ‚ç‚¹ç›®å½•æ“ä½œ">èŠ‚ç‚¹ç›®å½•æ“ä½œ</h2>
<ol>
<li>ä½¿ç”¨lså‘½ä»¤æ¥æŸ¥çœ‹å½“å‰znodeä¸­é”åŒ…å«çš„å†…å®¹</li>
</ol>
<pre><code class="language-bash"># ls [-s] [-w] [-R] path
[zk: localhost:2181(CONNECTED) 3] ls /
[ludangxin, zookeeper]
</code></pre>
<ol start="2">
<li>ä½¿ç”¨ls2æŸ¥çœ‹å½“å‰èŠ‚ç‚¹æ•°æ®å¹¶èƒ½çœ‹åˆ°æ›´æ–°æ¬¡æ•°ç­‰æ•°æ®</li>
</ol>
<pre><code class="language-bash"># ls2 path [watch] å®˜æ–¹ä¸æ¨èç›´æ¥ä½¿ç”¨ls2æŸ¥çœ‹, ä½¿ç”¨ ls -s path æ•ˆæœä¸€æ ·
[zk: localhost:2181(CONNECTED) 4] ls2 /
'ls2' has been deprecated. Please use 'ls [-s] path' instead.
[ludangxin, zookeeper]
cZxid = 0x0
ctime = Thu Jan 01 00:00:00 UTC 1970
mZxid = 0x0
mtime = Thu Jan 01 00:00:00 UTC 1970
pZxid = 0x2
cversion = 0
dataVersion = 0
aclVersion = 0
ephemeralOwner = 0x0
dataLength = 0
numChildren = 2
</code></pre>
<ol start="3">
<li>ä½¿ç”¨createåˆ›å»ºèŠ‚ç‚¹  -s å«æœ‰åºåˆ—  -e ä¸´æ—¶</li>
</ol>
<pre><code class="language-bash"># create [-s] [-e] [-c] [-t ttl] path [data] [acl]
# zkå®¢æˆ·ç«¯ä¸èƒ½é€’å½’åˆ›å»ºç›®å½•,åªèƒ½ä¸€çº§ä¸€çº§åˆ›å»º
[zk: localhost:2181(CONNECTED) 6] create /ludangxin/app1
Created /ludangxin/app1
</code></pre>
<ol start="4">
<li>ä½¿ç”¨setè®¾ç½®èŠ‚ç‚¹å€¼</li>
</ol>
<pre><code class="language-bash"># set [-s] [-v version] path data
[zk: localhost:2181(CONNECTED) 8] set /ludangxin/app1 helloworld
</code></pre>
<ol start="5">
<li>ä½¿ç”¨getè·å¾—èŠ‚ç‚¹çš„å€¼</li>
</ol>
<pre><code class="language-bash"># get [-s] [-w] path 
[zk: localhost:2181(CONNECTED) 9] get /ludangxin/app1
helloworld
</code></pre>
<ol start="6">
<li>ä½¿ç”¨statæŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€</li>
</ol>
<pre><code class="language-bash"># stat [-w] path
[zk: localhost:2181(CONNECTED) 1] stat /ludangxin/app1
cZxid = 0x3
ctime = Sat May 23 13:03:07 UTC 2020
mZxid = 0x4
mtime = Sat May 23 13:05:56 UTC 2020
pZxid = 0x3
cversion = 0
dataVersion = 1
aclVersion = 0
ephemeralOwner = 0x0
dataLength = 10
numChildren = 0
</code></pre>
<ol start="7">
<li>ä½¿ç”¨deleteåˆ é™¤èŠ‚ç‚¹</li>
</ol>
<pre><code class="language-bash"># delete [-v version] path
# deleteä¸èƒ½é€’å½’åˆ é™¤ç›®å½•,åªèƒ½ä¸€çº§ä¸€çº§åˆ é™¤
[zk: localhost:2181(CONNECTED) 3] delete /ludangxin/app1
</code></pre>
<ol start="8">
<li>ä½¿ç”¨rmræˆ–deleteallé€’å½’åˆ é™¤èŠ‚ç‚¹</li>
</ol>
<pre><code class="language-bash"># rmr path å®˜æ–¹ä¸æ¨èä½¿ç”¨rmr æ¨èä½¿ç”¨deleteall
[zk: localhost:2181(CONNECTED) 4] create /ludangxin/app1
Created /ludangxin/app1
[zk: localhost:2181(CONNECTED) 5] create /ludangxin/app1/test1
Created /ludangxin/app1/test1
[zk: localhost:2181(CONNECTED) 7] rmr /ludangxin
The command 'rmr' has been deprecated. Please use 'deleteall' instead.
[zk: localhost:2181(CONNECTED) 8] ls /ludangxin
Node does not exist: /ludangxin
[zk: localhost:2181(CONNECTED) 9] ls /
[zookeeper]
</code></pre>
<h2 id="ç›‘å¬æ“ä½œ">ç›‘å¬æ“ä½œ</h2>
<p><strong>ç›‘å¬åªèƒ½ç›‘å¬ä¸€æ¬¡,è§¦å‘åå°±é”€æ¯äº†</strong></p>
<ol>
<li>ä½¿ç”¨lsåˆ›å»ºç›‘å¬</li>
</ol>
<pre><code class="language-bash"># ls -w path å½“ç›‘å¬çš„èŠ‚ç‚¹åŒ…æ‹¬ä»–çš„å­èŠ‚ç‚¹å‘ç›®å½•å‘ç”Ÿå˜åŒ–çš„æ—¶å€™æ‰è§¦å‘ç›‘å¬
# ä¾‹:å½“å‰ç›‘å¬ /a/b å¦‚æœåˆ é™¤bèŠ‚ç‚¹,æˆ–è€…åˆ›å»º /a/b/c çš„æ—¶å€™ä¼šè§¦å‘ç›‘å¬ä¸”åªèƒ½è§¦å‘ä¸€æ¬¡
[zk: localhost:2181(CONNECTED) 15] ls -w  /ludangxin/app1
[]
[zk: localhost:2181(CONNECTED) 16] set /ludangxin/app1 helloworld
[zk: localhost:2181(CONNECTED) 17] create /ludangxin/app1/testwatch
Created /ludangxin/app1/testwatch
WATCHER::
WatchedEvent state:SyncConnected type:NodeChildrenChanged path:/ludangxin/app1
</code></pre>
<ol start="2">
<li>ä½¿ç”¨getåˆ›å»ºç›‘å¬(åªèƒ½å½“å‰èŠ‚ç‚¹ç›‘å¬èŠ‚ç‚¹å€¼çš„å˜åŒ–)</li>
</ol>
<pre><code class="language-bash"># get -w path
get -w /ludangxin/app1
</code></pre>
<ol start="3">
<li>ä½¿ç”¨statåˆ›å»ºç›‘å¬(å½“ å½“å‰èŠ‚ç‚¹çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜çš„æ—¶å€™è§¦å‘)</li>
</ol>
<pre><code class="language-bash"># stat -w path
stat -w /ludangxin/app1
</code></pre>
<h1 id="zookeeper-apiä½¿ç”¨">zookeeper apiä½¿ç”¨</h1>
<h2 id="å¼•å…¥ä¾èµ–">å¼•å…¥ä¾èµ–</h2>
<p><strong>æ³¨</strong>: å¼•å…¥ä¾èµ–çš„ç‰ˆæœ¬æœ€å¥½å’Œå®‰è£…çš„zkæœåŠ¡çš„ç‰ˆæœ¬ä¸€è‡´</p>
<pre><code class="language-xml">&lt;!-- zookeeper --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.zookeeper&lt;/groupId&gt;
    &lt;artifactId&gt;zookeeper&lt;/artifactId&gt;
    &lt;version&gt;3.5.8&lt;/version&gt;
&lt;/dependency&gt;
&lt;!-- lombok --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
    &lt;artifactId&gt;lombok&lt;/artifactId&gt;
    &lt;optional&gt;true&lt;/optional&gt;
&lt;/dependency&gt;
</code></pre>
<h2 id="åˆ›å»ºæµ‹è¯•ç±»">åˆ›å»ºæµ‹è¯•ç±»</h2>
<pre><code class="language-java">import lombok.extern.slf4j.Slf4j;
import org.apache.zookeeper.*;
import org.apache.zookeeper.data.Stat;
import org.junit.jupiter.api.Test;
import java.io.IOException;
import java.util.List;

@Slf4j
public class ZkApiTest {

    public static final String URL = &quot;192.168.128.130:2181&quot;;

    public static final int SESSION_TIME_OUT = 20000;

    @Test
    public void test() throws IOException, KeeperException, InterruptedException {
        //1. åˆ›å»ºzookeeperè¿æ¥
        ZooKeeper zooKeeper = new ZooKeeper(URL,SESSION_TIME_OUT, watch -&gt;
                log.info(&quot;è§¦å‘äº†&quot;+ watch.getType() +&quot;äº‹ä»¶&quot;)
        );
        //2. åˆ›å»ºçˆ¶èŠ‚ç‚¹
        //Ids.OPEN_ACL_UNSAFE æ— æƒé™ CreateMode.PERSISTENT æŒä¹…åŒ–èŠ‚ç‚¹
        String testParentPath = zooKeeper.create(&quot;/testPath1&quot;, &quot;testParentValue&quot;.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
        log.info(&quot;testParentPath===&quot;+testParentPath);
        //3. åˆ›å»ºå­èŠ‚ç‚¹
        String testChildPath = zooKeeper.create(testParentPath+&quot;/child1&quot;, &quot;testChildValue&quot;.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
        log.info(&quot;testChildPath===&quot;+testChildPath);
        //4. è·å–èŠ‚ç‚¹ä¸­çš„å€¼(çˆ¶èŠ‚ç‚¹å’Œå­èŠ‚ç‚¹)
        byte[] parentData = zooKeeper.getData(testParentPath, false, null);
        byte[] childData = zooKeeper.getData(testChildPath, false, null);
        List&lt;String&gt; childrenNodes = zooKeeper.getChildren(testParentPath, false);
        log.info(&quot;parentData===&quot;+new String(parentData));
        log.info(&quot;childData===&quot;+new String(childData));
        for (String childrenNode : childrenNodes) {
            log.info(&quot;childrenNode===&quot;+childrenNode);
        }
        //5. ä¿®æ”¹èŠ‚ç‚¹çš„å€¼
        //version èŠ‚ç‚¹ç‰ˆæœ¬ -1 åŒ¹é…ä»»ä½•ç‰ˆæœ¬
        zooKeeper.setData(testParentPath, &quot;testValueUpdate&quot;.getBytes(), -1);
        byte[] parentNewData = zooKeeper.getData(testParentPath, false, null);
        log.info(&quot;parentNewData===&quot;+new String(parentNewData));
        //6. åˆ¤æ–­æŸä¸ªèŠ‚ç‚¹æ˜¯å¦å­˜åœ¨
        Stat exists = zooKeeper.exists(testChildPath, false);
        log.info(exists.toString());
        //7. åˆ é™¤èŠ‚ç‚¹
        zooKeeper.delete(testChildPath,-1);
    }
}
</code></pre>
<h2 id="è¾“å‡ºç»“æœ">è¾“å‡ºç»“æœ</h2>
<pre><code class="language-java">23:37:36.574 [main-EventThread] INFO com.ldx.springboot.ZkApiTest - è§¦å‘äº†Noneäº‹ä»¶
23:37:36.581 [main] INFO com.ldx.springboot.ZkApiTest - testParentPath===/testPath1
23:37:36.585 [main] INFO com.ldx.springboot.ZkApiTest - testChildPath===/testPath1/child1
23:37:36.595 [main] INFO com.ldx.springboot.ZkApiTest - parentData===testParentValue
23:37:36.595 [main] INFO com.ldx.springboot.ZkApiTest - childData===testChildValue
23:37:36.595 [main] INFO com.ldx.springboot.ZkApiTest - childrenNode===child1
23:37:36.603 [main] INFO com.ldx.springboot.ZkApiTest - parentNewData===testValueUpdate
23:37:36.606 [main] INFO com.ldx.springboot.ZkApiTest - 111,111,1590248257090,1590248257090,0,0,0,0,14,0,111
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[æµ…è°ˆ åˆ†å¸ƒå¼ é›†ç¾¤ å¾®æœåŠ¡]]></title>
        <id>http://blog.ludangxin.club/post/fen-bu-shi-ji-qun-wei-fu-wu/</id>
        <link href="http://blog.ludangxin.club/post/fen-bu-shi-ji-qun-wei-fu-wu/">
        </link>
        <updated>2020-05-23T05:46:39.000Z</updated>
        <content type="html"><![CDATA[<h1 id="æ¦‚å¿µ">æ¦‚å¿µ</h1>
<p><strong>é›†ç¾¤æ˜¯ä¸ªç‰©ç†å½¢æ€ï¼Œåˆ†å¸ƒå¼æ˜¯ç³»ç»Ÿéƒ¨ç½²æ–¹å¼ï¼Œå¾®æœåŠ¡æ˜¯æ¶æ„è®¾è®¡æ–¹å¼ã€‚</strong></p>
<h2 id="é›†ç¾¤æ˜¯å•¥">é›†ç¾¤æ˜¯å•¥?</h2>
<p>å•æœºå¤„ç†åˆ°è¾¾ç“¶é¢ˆçš„æ—¶å€™ï¼Œä½ å°±æŠŠå•æœºå¤åˆ¶å‡ ä»½ï¼Œè¿™æ ·å°±æ„æˆäº†ä¸€ä¸ªâ€œé›†ç¾¤â€ã€‚é›†ç¾¤ä¸­æ¯å°æœåŠ¡å™¨å°±å«åšè¿™ä¸ªé›†ç¾¤çš„ä¸€ä¸ªâ€œèŠ‚ç‚¹â€ï¼Œæ‰€æœ‰èŠ‚ç‚¹æ„æˆäº†ä¸€ä¸ªé›†ç¾¤ã€‚æ¯ä¸ªèŠ‚ç‚¹éƒ½æä¾›ç›¸åŒçš„æœåŠ¡ï¼Œé‚£ä¹ˆè¿™æ ·ç³»ç»Ÿçš„å¤„ç†èƒ½åŠ›å°±ç›¸å½“äºæå‡äº†å¥½å‡ å€ï¼ˆæœ‰å‡ ä¸ªèŠ‚ç‚¹å°±ç›¸å½“äºæå‡äº†è¿™ä¹ˆå¤šå€ï¼‰ã€‚ä»å•æœºç»“æ„åˆ°é›†ç¾¤ç»“æ„ï¼Œä½ çš„ä»£ç åŸºæœ¬æ— éœ€è¦ä½œä»»ä½•ä¿®æ”¹ã€‚ä½ è¦åšçš„ä»…ä»…æ˜¯å¤šéƒ¨ç½²å‡ å°æœåŠ¡å™¨ï¼Œæ¯å°æœåŠ¡å™¨ä¸Šè¿è¡Œç›¸åŒçš„ä»£ç å°±è¡Œäº†ã€‚</p>
<h2 id="åˆ†å¸ƒå¼æ˜¯å•¥">åˆ†å¸ƒå¼æ˜¯å•¥ï¼Ÿ</h2>
<p>åˆ†å¸ƒå¼æœåŠ¡é¡¾åæ€ä¹‰æœåŠ¡æ˜¯åˆ†æ•£éƒ¨ç½²åœ¨ä¸åŒçš„æœºå™¨ä¸Šçš„ï¼Œä¸€ä¸ªæœåŠ¡å¯èƒ½è´Ÿè´£å‡ ä¸ªåŠŸèƒ½ï¼Œæ˜¯ä¸€ç§é¢å‘SOAæ¶æ„çš„ï¼ŒæœåŠ¡ä¹‹é—´ä¹Ÿæ˜¯é€šè¿‡rpcæ¥äº¤äº’æˆ–è€…æ˜¯webserviceæ¥äº¤äº’çš„ã€‚é€»è¾‘æ¶æ„è®¾è®¡å®Œåå°±è¯¥åšç‰©ç†æ¶æ„è®¾è®¡ï¼Œç³»ç»Ÿåº”ç”¨éƒ¨ç½²åœ¨è¶…è¿‡ä¸€å°æœåŠ¡å™¨æˆ–è™šæ‹Ÿæœºä¸Šï¼Œä¸”å„åˆ†å¼€éƒ¨ç½²çš„éƒ¨åˆ†å½¼æ­¤é€šè¿‡å„ç§é€šè®¯åè®®äº¤äº’ä¿¡æ¯ï¼Œå°±å¯ç®—ä½œåˆ†å¸ƒå¼éƒ¨ç½²ï¼Œç”Ÿäº§ç¯å¢ƒä¸‹çš„å¾®æœåŠ¡è‚¯å®šæ˜¯åˆ†å¸ƒå¼éƒ¨ç½²çš„ï¼Œåˆ†å¸ƒå¼éƒ¨ç½²çš„åº”ç”¨ä¸ä¸€å®šæ˜¯å¾®æœåŠ¡æ¶æ„çš„ï¼Œæ¯”å¦‚é›†ç¾¤éƒ¨ç½²ï¼Œå®ƒæ˜¯æŠŠç›¸åŒåº”ç”¨å¤åˆ¶åˆ°ä¸åŒæœåŠ¡å™¨ä¸Šï¼Œä½†æ˜¯é€»è¾‘åŠŸèƒ½ä¸Šè¿˜æ˜¯å•ä½“åº”ç”¨ã€‚</p>
<h2 id="å¾®æœåŠ¡åˆæ˜¯å•¥">å¾®æœåŠ¡åˆæ˜¯å•¥?</h2>
<p>ç®€å•æ¥è¯´å¾®æœåŠ¡å°±æ˜¯å¾ˆå°çš„æœåŠ¡ï¼Œå°åˆ°ä¸€ä¸ªæœåŠ¡åªå¯¹åº”ä¸€ä¸ªå•ä¸€çš„åŠŸèƒ½ï¼Œåªåšä¸€ä»¶äº‹ã€‚<br>
è¿™ä¸ªæœåŠ¡å¯ä»¥å•ç‹¬éƒ¨ç½²è¿è¡Œï¼ŒæœåŠ¡ä¹‹é—´å¯ä»¥é€šè¿‡RPCæ¥ç›¸äº’äº¤äº’ï¼Œæ¯ä¸ªå¾®æœåŠ¡éƒ½æ˜¯ç”±ç‹¬ç«‹çš„å°å›¢é˜Ÿå¼€å‘ï¼Œæµ‹è¯•ï¼Œéƒ¨ç½²ï¼Œä¸Šçº¿ï¼Œè´Ÿè´£å®ƒçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸã€‚</p>
<h2 id="å¾®æœåŠ¡æ¶æ„åˆåˆæ˜¯å•¥">å¾®æœåŠ¡æ¶æ„åˆåˆæ˜¯å•¥ï¼Ÿ</h2>
<p>åœ¨åšæ¶æ„è®¾è®¡çš„æ—¶å€™ï¼Œå…ˆåšé€»è¾‘æ¶æ„ï¼Œå†åšç‰©ç†æ¶æ„ï¼Œå½“ä½ æ‹¿åˆ°éœ€æ±‚åï¼Œä¼°ç®—è¿‡æœ€å¤§ç”¨æˆ·é‡å’Œå¹¶å‘é‡åï¼Œè®¡ç®—å•ä¸ªåº”ç”¨æœåŠ¡å™¨èƒ½å¦æ»¡è¶³éœ€æ±‚ã€‚<br>
å¦‚æœç”¨æˆ·é‡åªæœ‰å‡ ç™¾äººçš„å°åº”ç”¨ï¼Œå•ä½“åº”ç”¨å°±èƒ½æå®šï¼Œå³æ‰€æœ‰åº”ç”¨éƒ¨ç½²åœ¨ä¸€ä¸ªåº”ç”¨æœåŠ¡å™¨é‡Œï¼Œå¦‚æœæ˜¯å¾ˆå¤§ç”¨æˆ·é‡ï¼Œä¸”æŸäº›åŠŸèƒ½ä¼šè¢«é¢‘ç¹è®¿é—®ï¼Œæˆ–è€…æŸäº›åŠŸèƒ½è®¡ç®—é‡å¾ˆå¤§ï¼Œå»ºè®®å°†åº”ç”¨æ‹†è§£ä¸ºå¤šä¸ªå­ç³»ç»Ÿï¼Œå„è‡ªè´Ÿè´£å„è‡ªåŠŸèƒ½ï¼Œè¿™å°±æ˜¯å¾®æœåŠ¡æ¶æ„ã€‚</p>
<h2 id="åŒºåˆ«">åŒºåˆ«</h2>
<ol>
<li>
<p>åˆ†å¸ƒå¼æ˜¯æŒ‡å°†ä¸åŒçš„ä¸šåŠ¡åˆ†å¸ƒåœ¨ä¸åŒçš„åœ°æ–¹ã€‚</p>
</li>
<li>
<p>é›†ç¾¤æŒ‡çš„æ˜¯å°†å‡ å°æœåŠ¡å™¨é›†ä¸­åœ¨ä¸€èµ·ï¼Œå®ç°åŒä¸€ä¸šåŠ¡ã€‚<br>
ç®€å•è¯´ï¼Œåˆ†å¸ƒå¼æ˜¯ä»¥ç¼©çŸ­å•ä¸ªä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´æ¥æå‡æ•ˆç‡çš„ï¼Œè€Œé›†ç¾¤åˆ™æ˜¯é€šè¿‡æé«˜å•ä½æ—¶é—´å†…æ‰§è¡Œçš„ä»»åŠ¡æ•°æ¥æå‡æ•ˆç‡ã€‚</p>
</li>
<li>
<p>å¾®æœåŠ¡ä¸åˆ†å¸ƒå¼çš„ç»†å¾®å·®åˆ«æ˜¯ï¼Œå¾®æœåŠ¡çš„åº”ç”¨ä¸ä¸€å®šæ˜¯åˆ†æ•£åœ¨å¤šä¸ªæœåŠ¡å™¨ä¸Šï¼Œä»–ä¹Ÿå¯ä»¥æ˜¯åŒä¸€ä¸ªæœåŠ¡å™¨ã€‚å¾®æœåŠ¡ç›¸æ¯”åˆ†å¸ƒå¼æœåŠ¡æ¥è¯´ï¼Œå®ƒçš„ç²’åº¦æ›´å°ï¼ŒæœåŠ¡ä¹‹é—´è€¦åˆåº¦æ›´ä½ï¼Œç”±äºæ¯ä¸ªå¾®æœåŠ¡éƒ½ç”±ç‹¬ç«‹çš„å°å›¢é˜Ÿè´Ÿè´£ï¼Œå› æ­¤å®ƒæ•æ·æ€§æ›´é«˜ï¼Œåˆ†å¸ƒå¼æœåŠ¡æœ€åéƒ½ä¼šå‘å¾®æœåŠ¡æ¶æ„æ¼”åŒ–ï¼Œè¿™æ˜¯ä¸€ç§è¶‹åŠ¿ï¼Œ ä¸è¿‡æœåŠ¡å¾®æœåŠ¡åŒ–åå¸¦æ¥çš„æŒ‘æˆ˜ä¹Ÿæ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œä¾‹å¦‚æœåŠ¡ç²’åº¦å°ï¼Œæ•°é‡å¤§ï¼ŒåæœŸè¿ç»´å°†ä¼šå¾ˆéš¾</p>
</li>
</ol>
<p>å›¾ç¤º:</p>
<figure data-type="image" tabindex="1"><img src="http://blog.ludangxin.club/post-images/1590216688867.jpg" alt="" loading="lazy"></figure>
<h1 id="æ¶æ„çš„æ¼”å˜è¿‡ç¨‹">æ¶æ„çš„æ¼”å˜è¿‡ç¨‹</h1>
<p>ä¸‹é¢æˆ‘ä»¬æ¥ç®€å•æ¨¡æ‹Ÿä¸€ä¸ªæ¶æ„æ¼”å˜è¿‡ç¨‹ã€‚ æˆ‘ä»¬ä»¥ javaweb ä¸ºä¾‹ï¼Œæ¥æ­å»ºä¸€ä¸ªç®€å•çš„ç”µå•†ç³»ç»Ÿï¼Œä»è¿™ä¸ªç³»ç»Ÿä¸­æ¥çœ‹ç³»ç»Ÿçš„æ¼”å˜è¿‡ç¨‹ã€‚è¦æ³¨æ„çš„æ˜¯æ¥ä¸‹æ¥çš„æ¼”ç¤ºæ¨¡å‹ï¼Œ å…³æ³¨çš„æ˜¯æ•°æ®é‡ã€è®¿é—®é‡æå‡ï¼Œç½‘ç«™ç»“æ„çš„å˜åŒ–ï¼Œ è€Œä¸å…³æ³¨å…·ä½“ä¸šåŠ¡çš„åŠŸèƒ½ç‚¹ã€‚å…¶æ¬¡ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯ä¸ºäº†è®©å¤§å®¶èƒ½æ›´å¥½çš„äº†è§£ç½‘ç«™æ¼”è¿›è¿‡ç¨‹ä¸­çš„ä¸€äº›é—®é¢˜å’Œåº”å¯¹ç­–ç•¥ã€‚</p>
<p>å‡å¦‚æˆ‘ä»¬ç³»ç»Ÿå…·å¤‡ä»¥ä¸‹åŠŸèƒ½:</p>
<ul>
<li>ç”¨æˆ·æ¨¡å—:ç”¨æˆ·æ³¨å†Œå’Œç®¡ç†ã€‚</li>
<li>å•†å“æ¨¡å—:å•†å“å±•ç¤ºå’Œç®¡ç†ã€‚</li>
<li>äº¤æ˜“æ¨¡å—:åˆ›å»ºäº¤æ˜“åŠæ”¯ä»˜ç»“ç®—ã€‚</li>
</ul>
<h2 id="é˜¶æ®µä¸€å•åº”ç”¨æ¶æ„">é˜¶æ®µä¸€ï¼šå•åº”ç”¨æ¶æ„</h2>
<p><img src="http://blog.ludangxin.club/post-images/1590216730582.jpg" alt="" loading="lazy"><br>
ã€€ã€€è¿™ä¸ªé˜¶æ®µæ˜¯ç½‘ç«™çš„åˆæœŸï¼Œä¹Ÿå¯ä»¥è®¤ä¸ºæ˜¯äº’è”ç½‘å‘å±•çš„æ—©æœŸï¼Œç³»ç»Ÿæ¶æ„å¦‚ä¸Šå›¾æ‰€ç¤ºã€‚æˆ‘ä»¬ç»å¸¸ä¼šåœ¨å•å°æœåŠ¡å™¨ä¸Šè¿è¡Œæˆ‘ä»¬æ‰€æœ‰çš„ç¨‹åºå’Œè½¯ä»¶ã€‚ æŠŠæ‰€æœ‰è½¯ä»¶å’Œåº”ç”¨éƒ½éƒ¨ç½²åœ¨ä¸€å°æœºå™¨ä¸Šï¼Œè¿™æ ·å°±å®Œæˆä¸€ä¸ªç®€å•ç³»ç»Ÿçš„æ­å»ºï¼Œè¿™ä¸ªé˜¶æ®µçš„è®²ç©¶çš„æ˜¯æ•ˆç‡ã€‚æ•ˆç‡å†³å®šç”Ÿæ­»ã€‚</p>
<h2 id="é˜¶æ®µäºŒåº”ç”¨æœåŠ¡å™¨å’Œæ•°æ®åº“æœåŠ¡å™¨åˆ†ç¦»">é˜¶æ®µäºŒï¼šåº”ç”¨æœåŠ¡å™¨å’Œæ•°æ®åº“æœåŠ¡å™¨åˆ†ç¦»</h2>
<p>éšç€ç½‘ç«™çš„ä¸Šçº¿ï¼Œè®¿é—®é‡é€æ­¥ä¸Šå‡ï¼ŒæœåŠ¡å™¨çš„è´Ÿè½½æ…¢æ…¢æé«˜ï¼Œæˆ‘ä»¬åº”è¯¥åœ¨æœåŠ¡å™¨è¿˜æ²¡æœ‰è¶…è½½çš„æ—¶å€™å°±åšå¥½è§„åˆ’ã€æå‡ç½‘ç«™çš„è´Ÿè½½èƒ½åŠ›ã€‚å‡è‹¥æ­¤æ—¶å·²ç»æ²¡åŠæ³•åœ¨ä»£ç å±‚é¢ç»§ç»­ä¼˜åŒ–æé«˜ï¼Œé‚£ä¹ˆåœ¨å•å°æœºå™¨çš„æ€§èƒ½é‡åˆ°ç“¶é¢ˆçš„æ—¶å€™ï¼Œå¢åŠ æœºå™¨æ˜¯ä¸€ä¸ªæ¯”è¾ƒç®€å•å¥½ç”¨çš„æ–¹å¼ï¼ŒæŠ•å…¥äº§å‡ºæ¯”ç›¸å½“é«˜ã€‚è¿™ä¸ªé˜¶æ®µå¢åŠ æœºå™¨çš„ä¸»è¦ç›®çš„æ˜¯å°† web æœåŠ¡å™¨å’Œ æ•°æ®åº“æœåŠ¡å™¨æ‹†åˆ†å¼€æ¥ï¼Œè¿™æ ·åšçš„è¯ä¸ä»…æé«˜äº†å•æœºçš„è´Ÿè½½èƒ½åŠ›ï¼Œä¹Ÿæé«˜äº†æ•´ä¸ªç³»ç»Ÿçš„å®¹ç¾èƒ½åŠ›ã€‚<br>
<img src="http://blog.ludangxin.club/post-images/1590216749619.jpg" alt="" loading="lazy"><br>
ã€€ã€€è¿™ä¸ªé˜¶æ®µçš„ç³»ç»Ÿæ¶æ„å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåº”ç”¨æœåŠ¡å™¨å’Œæ•°æ®åº“æœåŠ¡å™¨å®Œå…¨éš”ç¦»å¼€æ¥ï¼Œç›¸äº’äº’ä¸å½±å“ï¼Œå¤§å¤§å‡å°‘äº†ç½‘ç«™å®•æœºçš„é£é™©ï¼Œæ­¤é˜¶æ®µæˆ‘ä»¬å·²ç»å¼€å§‹å…³æ³¨åˆ°åº”ç”¨æœåŠ¡å™¨çš„ç®¡ç†äº†ã€‚</p>
<h2 id="é˜¶æ®µä¸‰åº”ç”¨æœåŠ¡å™¨é›†ç¾¤">é˜¶æ®µä¸‰ï¼šåº”ç”¨æœåŠ¡å™¨é›†ç¾¤</h2>
<p>è¿™ä¸ªé˜¶æ®µï¼Œéšç€è®¿é—®é‡çš„ç»§ç»­ä¸æ–­å¢åŠ ï¼Œå•å°åº”ç”¨æœåŠ¡å™¨å·²ç»æ— æ³•æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚ å‡è®¾æˆ‘çš„æ•°æ®åº“æœåŠ¡å™¨è¿˜æ²¡æœ‰é‡åˆ°æ€§èƒ½é—®é¢˜ï¼Œé‚£æˆ‘ä»¬å¯ä»¥é€šè¿‡å¢åŠ åº”ç”¨æœåŠ¡å™¨çš„æ–¹å¼æ¥å°†åº”ç”¨æœåŠ¡å™¨é›†ç¾¤åŒ–ï¼Œè¿™æ ·å°±å¯ä»¥å°†ç”¨æˆ·è¯·æ±‚åˆ†æµåˆ°å„ä¸ªæœåŠ¡å™¨ä¸­ï¼Œä»è€Œè¾¾åˆ°ç»§ç»­æå‡ç³»ç»Ÿè´Ÿè½½èƒ½åŠ›çš„ç›®çš„ã€‚æ­¤æ—¶å„ä¸ªåº”ç”¨æœåŠ¡å™¨ä¹‹é—´æ²¡æœ‰ç›´æ¥çš„äº¤äº’ï¼Œä»–ä»¬éƒ½æ˜¯ä¾èµ–æ•°æ®åº“å„è‡ªå¯¹å¤–æä¾›æœåŠ¡ã€‚<br>
<img src="http://blog.ludangxin.club/post-images/1590216760176.jpg" alt="" loading="lazy"><br>
ç³»ç»Ÿæ¶æ„å‘å±•åˆ°è¿™ä¸ªé˜¶æ®µï¼Œå„ç§é—®é¢˜ä¹Ÿä¼šæ¥è¸µè€Œè‡³ï¼š</p>
<ul>
<li>ç”¨æˆ·è¯·æ±‚äº¤ç”±è°æ¥è½¬å‘åˆ°å…·ä½“çš„åº”ç”¨æœåŠ¡å™¨ä¸Š(è°æ¥è´Ÿè´£è´Ÿè½½å‡è¡¡)</li>
<li>ç”¨æˆ·å¦‚æœæ¯æ¬¡è®¿é—®åˆ°çš„æœåŠ¡å™¨ä¸ä¸€æ ·ï¼Œé‚£ä¹ˆå¦‚ä½•ç»´æŠ¤sessionï¼Œè¾¾åˆ°sessionå…±äº«çš„ç›®çš„ã€‚<br>
é‚£ä¹ˆæ­¤æ—¶ï¼Œç³»ç»Ÿæ¶æ„åˆä¼šå˜æˆå¦‚ä¸‹æ–¹å¼ï¼š<br>
<img src="http://blog.ludangxin.club/post-images/1590216771958.jpg" alt="" loading="lazy"><br>
ã€€ã€€è´Ÿè½½å‡è¡¡åˆå¯ä»¥åˆ†ä¸ºè½¯è´Ÿè½½å’Œç¡¬è´Ÿè½½ã€‚è½¯è´Ÿè½½æˆ‘ä»¬å¯ä»¥é€‰æ‹©Nginxã€Apacheç­‰ï¼Œç¡¬è´Ÿè½½æˆ‘ä»¬å¯ä»¥é€‰æ‹©F5ç­‰ã€‚è€Œsessionå…±äº«é—®é¢˜æˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½®tomcatçš„sessionå…±äº«è§£å†³ã€‚</li>
</ul>
<h2 id="é˜¶æ®µå››æ•°æ®åº“å‹åŠ›å˜å¤§æ•°æ®åº“è¯»å†™åˆ†ç¦»">é˜¶æ®µå››ï¼šæ•°æ®åº“å‹åŠ›å˜å¤§ï¼Œæ•°æ®åº“è¯»å†™åˆ†ç¦»</h2>
<p>æ¶æ„æ¼”å˜åˆ°ä¸Šé¢çš„é˜¶æ®µï¼Œå¹¶ä¸æ˜¯ç»ˆç‚¹ã€‚é€šè¿‡ä¸Šé¢çš„è®¾è®¡ï¼Œåº”ç”¨å±‚çš„æ€§èƒ½è¢«æˆ‘ä»¬æ‹‰ä¸Šæ¥äº†ï¼Œ ä½†æ•°æ®åº“çš„è´Ÿè½½ä¹Ÿåœ¨é€æ¸å¢å¤§ï¼Œé‚£å¦‚ä½•å»æé«˜æ•°æ®åº“å±‚é¢çš„æ€§èƒ½å‘¢ï¼Ÿæœ‰äº†å‰é¢çš„è®¾è®¡æ€è·¯ä»¥åï¼Œæˆ‘ä»¬è‡ªç„¶ä¹Ÿä¼šæƒ³åˆ°é€šè¿‡å¢åŠ æœåŠ¡å™¨æ¥æé«˜æ€§èƒ½ã€‚ä½†å‡å¦‚æˆ‘ä»¬å•çº¯çš„æŠŠæ•°æ®åº“ä¸€åˆ†ä¸ºäºŒï¼Œç„¶åå¯¹äºæ•°æ®åº“çš„è¯·æ±‚ï¼Œåˆ†åˆ«è´Ÿè½½åˆ°ä¸¤å°æ•°æ®åº“æœåŠ¡å™¨ä¸Šï¼Œé‚£å¿…å®šä¼šé€ æˆæ•°æ®åº“æ•°æ®ä¸ç»Ÿä¸€çš„é—®é¢˜ã€‚ æ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬å…ˆè€ƒè™‘å°†æ•°æ®åº“è¯»å†™åˆ†ç¦»ã€‚<br>
<img src="http://blog.ludangxin.club/post-images/1590216784417.jpg" alt="" loading="lazy"><br>
è¿™ä¸ªæ¶æ„è®¾è®¡çš„å˜åŒ–ä¼šå¸¦æ¥å¦‚ä¸‹å‡ ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li>ä¸»ä»æ•°æ®åº“ä¹‹é—´çš„æ•°æ®éœ€è¦åŒæ­¥(å¯ä»¥ä½¿ç”¨ mysql è‡ªå¸¦çš„ master-slave æ–¹å¼å®ç°ä¸»ä»å¤åˆ¶ )</li>
<li>åº”ç”¨ä¸­éœ€è¦æ ¹æ®ä¸šåŠ¡è¿›è¡Œå¯¹åº”æ•°æ®æºçš„é€‰æ‹©( é‡‡ç”¨ç¬¬ä¸‰æ–¹æ•°æ®åº“ä¸­é—´ä»¶ï¼Œä¾‹å¦‚ mycat )</li>
</ul>
<h2 id="é˜¶æ®µäº”ä½¿ç”¨æœç´¢å¼•æ“ç¼“è§£è¯»åº“çš„å‹åŠ›">é˜¶æ®µäº”ï¼šä½¿ç”¨æœç´¢å¼•æ“ç¼“è§£è¯»åº“çš„å‹åŠ›</h2>
<p>æˆ‘ä»¬éƒ½çŸ¥é“æ•°æ®åº“å¸¸å¸¸å¯¹æ¨¡ç³ŠæŸ¥æ‰¾æ•ˆç‡ä¸æ˜¯å¾ˆé«˜ï¼Œåƒç”µå•†ç±»çš„ç½‘ç«™ï¼Œæœç´¢æ˜¯éå¸¸æ ¸å¿ƒçš„åŠŸèƒ½ï¼Œå³ä½¿æ˜¯åšäº†è¯»å†™åˆ†ç¦»ï¼Œè¿™ä¸ªé—®é¢˜ä¹Ÿä¸èƒ½å¾—åˆ°æœ‰æ•ˆè§£å†³ã€‚é‚£ä¹ˆè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±éœ€è¦å¼•å…¥æœç´¢å¼•æ“äº†ï¼Œä½¿ç”¨æœç´¢å¼•æ“èƒ½å¤Ÿå¤§å¤§æå‡æˆ‘ä»¬ç³»ç»Ÿçš„æŸ¥è¯¢é€Ÿåº¦ï¼Œä½†åŒæ—¶ä¹Ÿä¼šå¸¦æ¥ä¸€ äº›é™„åŠ çš„é—®é¢˜ï¼Œæ¯”å¦‚ç»´æŠ¤ç´¢å¼•çš„æ„å»ºã€æ•°æ®åŒæ­¥åˆ°æœç´¢å¼•æ“ç­‰ã€‚<br>
<img src="http://blog.ludangxin.club/post-images/1590216793033.jpg" alt="" loading="lazy"></p>
<h2 id="é˜¶æ®µå…­å¼•å…¥ç¼“å­˜æœºåˆ¶ç¼“è§£æ•°æ®åº“çš„å‹åŠ›">é˜¶æ®µå…­ï¼šå¼•å…¥ç¼“å­˜æœºåˆ¶ç¼“è§£æ•°æ®åº“çš„å‹åŠ›</h2>
<p>ç„¶åï¼Œéšç€è®¿é—®é‡çš„æŒç»­ä¸æ–­å¢åŠ ï¼Œé€æ¸ä¼šå‡ºç°è®¸å¤šç”¨æˆ·è®¿é—®åŒä¸€å†…å®¹çš„æƒ…å†µï¼Œé‚£ä¹ˆå¯¹äºè¿™äº›çƒ­ç‚¹æ•°æ®ï¼Œæ²¡å¿…è¦æ¯æ¬¡éƒ½ä»æ•°æ®åº“é‡è¯»å–ï¼Œè¿™æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨åˆ°ç¼“å­˜æŠ€æœ¯ï¼Œæ¯”å¦‚ redisã€memcache æ¥ä½œä¸ºæˆ‘ä»¬åº”ç”¨å±‚çš„ç¼“å­˜ã€‚å¦å¤–åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œå¦‚æˆ‘ä»¬å¯¹ç”¨æˆ·çš„æŸäº› IP çš„è®¿é—®é¢‘ç‡åšé™åˆ¶ï¼Œ é‚£è¿™ä¸ªæ”¾å†…å­˜ä¸­å°±åˆä¸åˆé€‚ï¼Œæ”¾æ•°æ®åº“åˆå¤ªéº»çƒ¦äº†ï¼Œé‚£è¿™ä¸ªæ—¶å€™å¯ä»¥ä½¿ç”¨ Nosql çš„æ–¹å¼æ¯”å¦‚ mongDB æ¥ä»£æ›¿ä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®åº“ã€‚<br>
<img src="http://blog.ludangxin.club/post-images/1590216802188.jpg" alt="" loading="lazy"></p>
<h2 id="é˜¶æ®µä¸ƒæ•°æ®åº“çš„æ°´å¹³å‚ç›´æ‹†åˆ†">é˜¶æ®µä¸ƒï¼šæ•°æ®åº“çš„æ°´å¹³/å‚ç›´æ‹†åˆ†</h2>
<p>æˆ‘ä»¬çš„ç½‘ç«™æ¼”è¿›çš„å˜åŒ–è¿‡ç¨‹ï¼Œäº¤æ˜“ã€å•†å“ã€ç”¨æˆ·çš„æ•°æ®éƒ½è¿˜åœ¨åŒä¸€ ä¸ªæ•°æ®åº“ä¸­ï¼Œå°½ç®¡é‡‡å–äº†å¢åŠ ç¼“å­˜ï¼Œè¯»å†™åˆ†ç¦»çš„æ–¹å¼ï¼Œä½†æ˜¯éšç€æ•° æ®åº“çš„å‹åŠ›æŒç»­å¢åŠ ï¼Œæ•°æ®åº“çš„ç“¶é¢ˆä»ç„¶æ˜¯ä¸ªæœ€å¤§çš„é—®é¢˜ã€‚å› æ­¤æˆ‘ ä»¬å¯ä»¥è€ƒè™‘å¯¹æ•°æ®çš„å‚ç›´æ‹†åˆ†å’Œæ°´å¹³æ‹†åˆ†ã€‚<br>
<img src="http://blog.ludangxin.club/post-images/1590216810460.jpg" alt="" loading="lazy"><br>
å‚ç›´æ‹†åˆ†:æŠŠæ•°æ®åº“ä¸­ä¸åŒä¸šåŠ¡æ•°æ®æ‹†åˆ†åˆ°ä¸åŒçš„æ•°æ®åº“ã€‚<br>
æ°´å¹³æ‹†åˆ†:æŠŠåŒä¸€ä¸ªè¡¨ä¸­çš„æ•°æ®æ‹†åˆ†åˆ°ä¸¤ä¸ªç”šè‡³æ›´å¤šçš„æ•°æ®åº“ä¸­ï¼Œæ°´å¹³æ‹†åˆ†çš„åŸå› æ˜¯æŸäº›ä¸šåŠ¡æ•°æ®é‡å·²ç»è¾¾åˆ°äº†å•ä¸ªæ•°æ®åº“çš„ç“¶é¢ˆï¼Œè¿™æ—¶å¯ä»¥é‡‡å–å°†è¡¨æ‹†åˆ†åˆ°å¤šä¸ªæ•°æ®åº“ä¸­ã€‚<br>
<img src="http://blog.ludangxin.club/post-images/1590216821835.jpg" alt="" loading="lazy"></p>
<h2 id="é˜¶æ®µå…«åº”ç”¨çš„æ‹†åˆ†">é˜¶æ®µå…«ï¼šåº”ç”¨çš„æ‹†åˆ†</h2>
<p>éšç€ä¸šåŠ¡çš„å‘å±•ï¼Œä¸šåŠ¡é‡è¶Šæ¥è¶Šå¤§ï¼Œåº”ç”¨çš„å‹åŠ›è¶Šæ¥è¶Šå¤§ã€‚å·¥ç¨‹è§„æ¨¡ä¹Ÿè¶Šæ¥è¶Šåºå¤§ã€‚è¿™ä¸ªæ—¶å€™å°±å¯ä»¥è€ƒè™‘å°†åº”ç”¨æ‹†åˆ†ï¼ŒæŒ‰ç…§é¢†åŸŸæ¨¡å‹å°†æˆ‘ä»¬çš„ç”¨æˆ·ã€å•†å“ã€äº¤æ˜“æ‹†åˆ†æˆå¤šä¸ªå­ç³»ç»Ÿã€‚<br>
<img src="http://blog.ludangxin.club/post-images/1590216830257.jpg" alt="" loading="lazy"><br>
ã€€ã€€è¿™æ ·æ‹†åˆ†ä»¥åï¼Œå¯èƒ½ä¼šæœ‰ä¸€äº›ç›¸åŒçš„ä»£ç ï¼Œæ¯”å¦‚ç”¨æˆ·æ“ä½œï¼Œåœ¨å•†å“å’Œäº¤æ˜“éƒ½éœ€è¦æŸ¥è¯¢ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´æ¯ä¸ªç³»ç»Ÿéƒ½ä¼šæœ‰ç”¨æˆ·æŸ¥è¯¢è®¿é—®ç›¸å…³æ“ä½œã€‚è¿™äº›ç›¸åŒçš„æ“ä½œä¸€å®šæ˜¯è¦æŠ½è±¡å‡ºæ¥ï¼Œå¦åˆ™å°±æ˜¯ä¸€ä¸ªå‘ã€‚æ‰€ä»¥é€šè¿‡èµ°æœåŠ¡åŒ–è·¯çº¿çš„æ–¹å¼æ¥è§£å†³ã€‚<br>
<img src="http://blog.ludangxin.club/post-images/1590216837471.jpg" alt="" loading="lazy"><br>
ã€€ã€€é‚£ä¹ˆæœåŠ¡æ‹†åˆ†ä»¥åï¼Œå„ä¸ªæœåŠ¡ä¹‹é—´å¦‚ä½•è¿›è¡Œè¿œç¨‹é€šä¿¡å‘¢? é€šè¿‡ RPC æŠ€æœ¯ï¼Œæ¯”è¾ƒå…¸å‹çš„æœ‰:dubboã€webserviceã€hessianã€httpã€RMI ç­‰ç­‰ã€‚å‰æœŸé€šè¿‡è¿™äº›æŠ€æœ¯èƒ½å¤Ÿå¾ˆå¥½çš„è§£å†³å„ä¸ªæœåŠ¡ä¹‹é—´é€šä¿¡é—®é¢˜ï¼Œä½†æ˜¯ï¼Œ äº’è”ç½‘çš„å‘å±•æ˜¯æŒç»­çš„ï¼Œæ‰€ä»¥æ¶æ„çš„æ¼”å˜å’Œä¼˜åŒ–ä¹Ÿè¿˜åœ¨æŒç»­ã€‚</p>
<p>è½¬è‡ª:<a href="https://www.cnblogs.com/zhy-1992/">é¢†æ‚Ÿ.æµ·æ´‹-åˆ†å¸ƒå¼æ¶æ„çš„æ€»ç»“</a></p>
<h1 id="capç†è®ºæ¦‚è¿°">CAPç†è®ºæ¦‚è¿°</h1>
<p><strong>ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿæœ€å¤šåªèƒ½åŒæ—¶æ»¡è¶³ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ã€å¯ç”¨æ€§ï¼ˆAvailabilityï¼‰å’Œåˆ†åŒºå®¹é”™æ€§ï¼ˆPartition toleranceï¼‰è¿™ä¸‰é¡¹ä¸­çš„ä¸¤é¡¹</strong>ã€‚<br>
<img src="http://blog.ludangxin.club/post-images/1590304044178.jpg" alt="" loading="lazy"></p>
<h2 id="capçš„å®šä¹‰">CAPçš„å®šä¹‰</h2>
<h3 id="consistency-ä¸€è‡´æ€§">Consistency ä¸€è‡´æ€§</h3>
<p>ä¸€è‡´æ€§æŒ‡â€œ<code>all nodes see the same data at the same time</code>â€ï¼Œå³æ‰€æœ‰èŠ‚ç‚¹åœ¨åŒä¸€æ—¶é—´çš„æ•°æ®å®Œå…¨ä¸€è‡´ã€‚<br>
ä¸€è‡´æ€§æ˜¯å› ä¸ºå¤šä¸ªæ•°æ®æ‹·è´ä¸‹å¹¶å‘è¯»å†™æ‰æœ‰çš„é—®é¢˜ï¼Œå› æ­¤ç†è§£æ—¶ä¸€å®šè¦æ³¨æ„ç»“åˆè€ƒè™‘å¤šä¸ªæ•°æ®æ‹·è´ä¸‹å¹¶å‘è¯»å†™çš„åœºæ™¯ã€‚<br>
å¯¹äºä¸€è‡´æ€§ï¼Œå¯ä»¥åˆ†ä¸ºä»å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¸¤ä¸ªä¸åŒçš„è§†è§’ã€‚</p>
<ul>
<li>å®¢æˆ·ç«¯<br>
ä»å®¢æˆ·ç«¯æ¥çœ‹ï¼Œä¸€è‡´æ€§ä¸»è¦æŒ‡çš„æ˜¯å¤šå¹¶å‘è®¿é—®æ—¶æ›´æ–°è¿‡çš„æ•°æ®å¦‚ä½•è·å–çš„é—®é¢˜ã€‚</li>
<li>æœåŠ¡ç«¯<br>
ä»æœåŠ¡ç«¯æ¥çœ‹ï¼Œåˆ™æ˜¯æ›´æ–°å¦‚ä½•åˆ†å¸ƒåˆ°æ•´ä¸ªç³»ç»Ÿï¼Œä»¥ä¿è¯æ•°æ®æœ€ç»ˆä¸€è‡´ã€‚<br>
å¯¹äºä¸€è‡´æ€§ï¼Œå¯ä»¥åˆ†ä¸ºå¼º/å¼±/æœ€ç»ˆä¸€è‡´æ€§ä¸‰ç±»<br>
ä»å®¢æˆ·ç«¯è§’åº¦ï¼Œå¤šè¿›ç¨‹å¹¶å‘è®¿é—®æ—¶ï¼Œæ›´æ–°è¿‡çš„æ•°æ®åœ¨ä¸åŒè¿›ç¨‹å¦‚ä½•è·å–çš„ä¸åŒç­–ç•¥ï¼Œå†³å®šäº†ä¸åŒçš„ä¸€è‡´æ€§ã€‚</li>
<li>å¼ºä¸€è‡´æ€§<br>
å¯¹äºå…³ç³»å‹æ•°æ®åº“ï¼Œè¦æ±‚æ›´æ–°è¿‡çš„æ•°æ®èƒ½è¢«åç»­çš„è®¿é—®éƒ½èƒ½çœ‹åˆ°ï¼Œè¿™æ˜¯å¼ºä¸€è‡´æ€§ã€‚</li>
<li>å¼±ä¸€è‡´æ€§<br>
å¦‚æœèƒ½å®¹å¿åç»­çš„éƒ¨åˆ†æˆ–è€…å…¨éƒ¨è®¿é—®ä¸åˆ°ï¼Œåˆ™æ˜¯å¼±ä¸€è‡´æ€§ã€‚</li>
<li>æœ€ç»ˆä¸€è‡´æ€§<br>
å¦‚æœç»è¿‡ä¸€æ®µæ—¶é—´åè¦æ±‚èƒ½è®¿é—®åˆ°æ›´æ–°åçš„æ•°æ®ï¼Œåˆ™æ˜¯æœ€ç»ˆä¸€è‡´æ€§ã€‚</li>
</ul>
<h3 id="availability-å¯ç”¨æ€§">Availability å¯ç”¨æ€§</h3>
<p>å¯ç”¨æ€§æŒ‡â€œ<code>Reads and writes always succeed</code>â€ï¼Œå³æœåŠ¡åœ¨æ­£å¸¸å“åº”æ—¶é—´å†…ä¸€ç›´å¯ç”¨ã€‚<br>
å¥½çš„å¯ç”¨æ€§ä¸»è¦æ˜¯æŒ‡ç³»ç»Ÿèƒ½å¤Ÿå¾ˆå¥½çš„ä¸ºç”¨æˆ·æœåŠ¡ï¼Œä¸å‡ºç°ç”¨æˆ·æ“ä½œå¤±è´¥æˆ–è€…è®¿é—®è¶…æ—¶ç­‰ç”¨æˆ·ä½“éªŒä¸å¥½çš„æƒ…å†µã€‚å¯ç”¨æ€§é€šå¸¸æƒ…å†µä¸‹å¯ç”¨æ€§å’Œåˆ†å¸ƒå¼æ•°æ®å†—ä½™ï¼Œè´Ÿè½½å‡è¡¡ç­‰æœ‰ç€å¾ˆå¤§çš„å…³è”ã€‚</p>
<h3 id="partition-toleranceåˆ†åŒºå®¹é”™æ€§">Partition Toleranceåˆ†åŒºå®¹é”™æ€§</h3>
<p>åˆ†åŒºå®¹é”™æ€§æŒ‡â€œ<code>the system continues to operate despite arbitrary message loss or failure of part of the system</code>â€ï¼Œå³åˆ†å¸ƒå¼ç³»ç»Ÿåœ¨é‡åˆ°æŸèŠ‚ç‚¹æˆ–ç½‘ç»œåˆ†åŒºæ•…éšœçš„æ—¶å€™ï¼Œä»ç„¶èƒ½å¤Ÿå¯¹å¤–æä¾›æ»¡è¶³ä¸€è‡´æ€§æˆ–å¯ç”¨æ€§çš„æœåŠ¡ã€‚</p>
<h2 id="capçš„è¯æ˜">CAPçš„è¯æ˜</h2>
<p><img src="http://blog.ludangxin.club/post-images/1590304055359.jpg" alt="" loading="lazy"><br>
ä¸Šå›¾æ˜¯æˆ‘ä»¬è¯æ˜CAPçš„åŸºæœ¬åœºæ™¯ï¼Œç½‘ç»œä¸­æœ‰ä¸¤ä¸ªèŠ‚ç‚¹N1å’ŒN2ï¼Œå¯ä»¥ç®€å•çš„ç†è§£N1å’ŒN2åˆ†åˆ«æ˜¯ä¸¤å°è®¡ç®—æœºï¼Œä»–ä»¬ä¹‹é—´ç½‘ç»œå¯ä»¥è¿é€šï¼ŒN1ä¸­æœ‰ä¸€ä¸ªåº”ç”¨ç¨‹åºAï¼Œå’Œä¸€ä¸ªæ•°æ®åº“Vï¼ŒN2ä¹Ÿæœ‰ä¸€ä¸ªåº”ç”¨ç¨‹åºB2å’Œä¸€ä¸ªæ•°æ®åº“Vã€‚ç°åœ¨ï¼ŒAå’ŒBæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸¤ä¸ªéƒ¨åˆ†ï¼ŒVæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ•°æ®å­˜å‚¨çš„ä¸¤ä¸ªå­æ•°æ®åº“ã€‚</p>
<p>åœ¨æ»¡è¶³ä¸€è‡´æ€§çš„æ—¶å€™ï¼ŒN1å’ŒN2ä¸­çš„æ•°æ®æ˜¯ä¸€æ ·çš„ï¼ŒV0=V0ã€‚åœ¨æ»¡è¶³å¯ç”¨æ€§çš„æ—¶å€™ï¼Œç”¨æˆ·ä¸ç®¡æ˜¯è¯·æ±‚N1æˆ–è€…N2ï¼Œéƒ½ä¼šå¾—åˆ°ç«‹å³å“åº”ã€‚åœ¨æ»¡è¶³åˆ†åŒºå®¹é”™æ€§çš„æƒ…å†µä¸‹ï¼ŒN1å’ŒN2æœ‰ä»»ä½•ä¸€æ–¹å®•æœºï¼Œæˆ–è€…ç½‘ç»œä¸é€šçš„æ—¶å€™ï¼Œéƒ½ä¸ä¼šå½±å“N1å’ŒN2å½¼æ­¤ä¹‹é—´çš„æ­£å¸¸è¿ä½œã€‚<br>
<img src="http://blog.ludangxin.club/post-images/1590304064859.jpg" alt="" loading="lazy"><br>
ä¸Šå›¾æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿæ­£å¸¸è¿è½¬çš„æµç¨‹ï¼Œç”¨æˆ·å‘N1æœºå™¨è¯·æ±‚æ•°æ®æ›´æ–°ï¼Œç¨‹åºAæ›´æ–°æ•°æ®åº“Voä¸ºV1ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿå°†æ•°æ®è¿›è¡ŒåŒæ­¥æ“ä½œMï¼Œå°†V1åŒæ­¥çš„N2ä¸­V0ï¼Œä½¿å¾—N2ä¸­çš„æ•°æ®V0ä¹Ÿæ›´æ–°ä¸ºV1ï¼ŒN2ä¸­çš„æ•°æ®å†å“åº”N2çš„è¯·æ±‚ã€‚</p>
<p>è¿™é‡Œï¼Œå¯ä»¥å®šä¹‰N1å’ŒN2çš„æ•°æ®åº“Vä¹‹é—´çš„æ•°æ®æ˜¯å¦ä¸€æ ·ä¸ºä¸€è‡´æ€§ï¼›å¤–éƒ¨å¯¹N1å’ŒN2çš„è¯·æ±‚å“åº”ä¸ºå¯ç”¨æ€§ï¼›N1å’ŒN2ä¹‹é—´çš„ç½‘ç»œç¯å¢ƒä¸ºåˆ†åŒºå®¹é”™æ€§ã€‚</p>
<p>è¿™æ˜¯æ­£å¸¸è¿ä½œçš„åœºæ™¯ï¼Œä¹Ÿæ˜¯ç†æƒ³çš„åœºæ™¯ï¼Œç„¶è€Œç°å®æ˜¯æ®‹é…·çš„ï¼Œå½“é”™è¯¯å‘ç”Ÿçš„æ—¶å€™ï¼Œä¸€è‡´æ€§å’Œå¯ç”¨æ€§è¿˜æœ‰åˆ†åŒºå®¹é”™æ€§ï¼Œæ˜¯å¦èƒ½åŒæ—¶æ»¡è¶³ï¼Œè¿˜æ˜¯è¯´è¦è¿›è¡Œå–èˆå‘¢ï¼Ÿ</p>
<p>ä½œä¸ºä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå®ƒå’Œå•æœºç³»ç»Ÿçš„æœ€å¤§åŒºåˆ«ï¼Œå°±åœ¨äºç½‘ç»œï¼Œç°åœ¨å‡è®¾ä¸€ç§æç«¯æƒ…å†µï¼ŒN1å’ŒN2ä¹‹é—´çš„ç½‘ç»œæ–­å¼€äº†ï¼Œæˆ‘ä»¬è¦æ”¯æŒè¿™ç§ç½‘ç»œå¼‚å¸¸ï¼Œç›¸å½“äºè¦æ»¡è¶³åˆ†åŒºå®¹é”™æ€§ï¼Œèƒ½ä¸èƒ½åŒæ—¶æ»¡è¶³ä¸€è‡´æ€§å’Œå“åº”æ€§å‘¢ï¼Ÿè¿˜æ˜¯è¯´è¦å¯¹ä»–ä»¬è¿›è¡Œå–èˆã€‚<br>
<img src="http://blog.ludangxin.club/post-images/1590304075502.jpg" alt="" loading="lazy"><br>
å‡è®¾åœ¨N1å’ŒN2ä¹‹é—´ç½‘ç»œæ–­å¼€çš„æ—¶å€™ï¼Œæœ‰ç”¨æˆ·å‘N1å‘é€æ•°æ®æ›´æ–°è¯·æ±‚ï¼Œé‚£N1ä¸­çš„æ•°æ®V0å°†è¢«æ›´æ–°ä¸ºV1ï¼Œç”±äºç½‘ç»œæ˜¯æ–­å¼€çš„ï¼Œæ‰€ä»¥åˆ†å¸ƒå¼ç³»ç»ŸåŒæ­¥æ“ä½œMï¼Œæ‰€ä»¥N2ä¸­çš„æ•°æ®ä¾æ—§æ˜¯V0ï¼›è¿™ä¸ªæ—¶å€™ï¼Œæœ‰ç”¨æˆ·å‘N2å‘é€æ•°æ®è¯»å–è¯·æ±‚ï¼Œç”±äºæ•°æ®è¿˜æ²¡æœ‰è¿›è¡ŒåŒæ­¥ï¼Œåº”ç”¨ç¨‹åºæ²¡åŠæ³•ç«‹å³ç»™ç”¨æˆ·è¿”å›æœ€æ–°çš„æ•°æ®V1ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿ</p>
<p>æœ‰äºŒç§é€‰æ‹©ï¼Œç¬¬ä¸€ï¼Œç‰ºç‰²æ•°æ®ä¸€è‡´æ€§ï¼Œå“åº”æ—§çš„æ•°æ®V0ç»™ç”¨æˆ·ï¼›ç¬¬äºŒï¼Œç‰ºç‰²å¯ç”¨æ€§ï¼Œé˜»å¡ç­‰å¾…ï¼Œç›´åˆ°ç½‘ç»œè¿æ¥æ¢å¤ï¼Œæ•°æ®æ›´æ–°æ“ä½œMå®Œæˆä¹‹åï¼Œå†ç»™ç”¨æˆ·å“åº”æœ€æ–°çš„æ•°æ®V1ã€‚</p>
<p>è¿™ä¸ªè¿‡ç¨‹ï¼Œè¯æ˜äº†è¦æ»¡è¶³åˆ†åŒºå®¹é”™æ€§çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œåªèƒ½åœ¨ä¸€è‡´æ€§å’Œå¯ç”¨æ€§ä¸¤è€…ä¸­ï¼Œé€‰æ‹©å…¶ä¸­ä¸€ä¸ªã€‚</p>
<h2 id="capæƒè¡¡">CAPæƒè¡¡</h2>
<p>é€šè¿‡CAPç†è®ºï¼Œæˆ‘ä»¬çŸ¥é“æ— æ³•åŒæ—¶æ»¡è¶³ä¸€è‡´æ€§ã€å¯ç”¨æ€§å’Œåˆ†åŒºå®¹é”™æ€§è¿™ä¸‰ä¸ªç‰¹æ€§ï¼Œé‚£è¦èˆå¼ƒå“ªä¸ªå‘¢ï¼Ÿ</p>
<blockquote>
<p>CA without Pï¼šå¦‚æœä¸è¦æ±‚Pï¼ˆä¸å…è®¸åˆ†åŒºï¼‰ï¼Œåˆ™Cï¼ˆå¼ºä¸€è‡´æ€§ï¼‰å’ŒAï¼ˆå¯ç”¨æ€§ï¼‰æ˜¯å¯ä»¥ä¿è¯çš„ã€‚ä½†å…¶å®åˆ†åŒºä¸æ˜¯ä½ æƒ³ä¸æƒ³çš„é—®é¢˜ï¼Œè€Œæ˜¯å§‹ç»ˆä¼šå­˜åœ¨ï¼Œå› æ­¤CAçš„ç³»ç»Ÿæ›´å¤šçš„æ˜¯å…è®¸åˆ†åŒºåå„å­ç³»ç»Ÿä¾ç„¶ä¿æŒCAã€‚<br>
CP without Aï¼šå¦‚æœä¸è¦æ±‚Aï¼ˆå¯ç”¨ï¼‰ï¼Œç›¸å½“äºæ¯ä¸ªè¯·æ±‚éƒ½éœ€è¦åœ¨Serverä¹‹é—´å¼ºä¸€è‡´ï¼Œè€ŒPï¼ˆåˆ†åŒºï¼‰ä¼šå¯¼è‡´åŒæ­¥æ—¶é—´æ— é™å»¶é•¿ï¼Œå¦‚æ­¤CPä¹Ÿæ˜¯å¯ä»¥ä¿è¯çš„ã€‚å¾ˆå¤šä¼ ç»Ÿçš„æ•°æ®åº“åˆ†å¸ƒå¼äº‹åŠ¡éƒ½å±äºè¿™ç§æ¨¡å¼ã€‚<br>
AP wihtout Cï¼šè¦é«˜å¯ç”¨å¹¶å…è®¸åˆ†åŒºï¼Œåˆ™éœ€æ”¾å¼ƒä¸€è‡´æ€§ã€‚ä¸€æ—¦åˆ†åŒºå‘ç”Ÿï¼ŒèŠ‚ç‚¹ä¹‹é—´å¯èƒ½ä¼šå¤±å»è”ç³»ï¼Œä¸ºäº†é«˜å¯ç”¨ï¼Œæ¯ä¸ªèŠ‚ç‚¹åªèƒ½ç”¨æœ¬åœ°æ•°æ®æä¾›æœåŠ¡ï¼Œè€Œè¿™æ ·ä¼šå¯¼è‡´å…¨å±€æ•°æ®çš„ä¸ä¸€è‡´æ€§ã€‚ç°åœ¨ä¼—å¤šçš„NoSQLéƒ½å±äºæ­¤ç±»ã€‚</p>
</blockquote>
<p>å¯¹äºå¤šæ•°å¤§å‹äº’è”ç½‘åº”ç”¨çš„åœºæ™¯ï¼Œä¸»æœºä¼—å¤šã€éƒ¨ç½²åˆ†æ•£ï¼Œè€Œä¸”ç°åœ¨çš„é›†ç¾¤è§„æ¨¡è¶Šæ¥è¶Šå¤§ï¼Œæ‰€ä»¥èŠ‚ç‚¹æ•…éšœã€ç½‘ç»œæ•…éšœæ˜¯å¸¸æ€ï¼Œè€Œä¸”è¦ä¿è¯æœåŠ¡å¯ç”¨æ€§è¾¾åˆ°Nä¸ª9ï¼Œå³ä¿è¯På’ŒAï¼Œèˆå¼ƒCï¼ˆé€€è€Œæ±‚å…¶æ¬¡ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ï¼‰ã€‚è™½ç„¶æŸäº›åœ°æ–¹ä¼šå½±å“å®¢æˆ·ä½“éªŒï¼Œä½†æ²¡è¾¾åˆ°é€ æˆç”¨æˆ·æµç¨‹çš„ä¸¥é‡ç¨‹åº¦ã€‚</p>
<p>å¯¹äºæ¶‰åŠåˆ°é’±è´¢è¿™æ ·ä¸èƒ½æœ‰ä¸€ä¸è®©æ­¥çš„åœºæ™¯ï¼ŒCå¿…é¡»ä¿è¯ã€‚ç½‘ç»œå‘ç”Ÿæ•…éšœå®å¯åœæ­¢æœåŠ¡ï¼Œè¿™æ˜¯ä¿è¯CAï¼Œèˆå¼ƒPã€‚è²Œä¼¼è¿™å‡ å¹´å›½å†…é“¶è¡Œä¸šå‘ç”Ÿäº†ä¸ä¸‹10èµ·äº‹æ•…ï¼Œä½†å½±å“é¢ä¸å¤§ï¼ŒæŠ¥é“ä¹Ÿä¸å¤šï¼Œå¹¿å¤§ç¾¤ä¼—çŸ¥é“çš„å°‘ã€‚è¿˜æœ‰ä¸€ç§æ˜¯ä¿è¯CPï¼Œèˆå¼ƒAã€‚ä¾‹å¦‚ç½‘ç»œæ•…éšœäº‹åªè¯»ä¸å†™ã€‚</p>
<p>å­°ä¼˜å­°ç•¥ï¼Œæ²¡æœ‰å®šè®ºï¼Œåªèƒ½æ ¹æ®åœºæ™¯å®šå¤ºï¼Œé€‚åˆçš„æ‰æ˜¯æœ€å¥½çš„ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[SpringBoot é›†æˆ è¡¨å•éªŒè¯ å’Œ å¼‚å¸¸ç»Ÿä¸€å¤„ç†]]></title>
        <id>http://blog.ludangxin.club/post/springboot-ji-cheng-biao-dan-yan-zheng-he-yi-chang-tong-yi-chu-li/</id>
        <link href="http://blog.ludangxin.club/post/springboot-ji-cheng-biao-dan-yan-zheng-he-yi-chang-tong-yi-chu-li/">
        </link>
        <updated>2020-05-20T13:18:29.000Z</updated>
        <content type="html"><![CDATA[<h1 id="è¡¨å•éªŒè¯æ³¨è§£æ¸…å•">è¡¨å•éªŒè¯æ³¨è§£æ¸…å•</h1>
<table>
<thead>
<tr>
<th style="text-align:center">æ³¨è§£</th>
<th style="text-align:center">è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">@Null</td>
<td style="text-align:center">é™åˆ¶åªèƒ½ä¸ºnull</td>
</tr>
<tr>
<td style="text-align:center">@NotNull</td>
<td style="text-align:center">é™åˆ¶å¿…é¡»ä¸ä¸ºnull</td>
</tr>
<tr>
<td style="text-align:center">@AssertFalse</td>
<td style="text-align:center">é™åˆ¶å¿…é¡»ä¸ºfalse</td>
</tr>
<tr>
<td style="text-align:center">@AssertTrue</td>
<td style="text-align:center">é™åˆ¶å¿…é¡»ä¸ºtrue</td>
</tr>
<tr>
<td style="text-align:center">@DecimalMax(value)</td>
<td style="text-align:center">é™åˆ¶å¿…é¡»ä¸ºä¸€ä¸ªä¸å¤§äºæŒ‡å®šå€¼çš„æ•°å­—</td>
</tr>
<tr>
<td style="text-align:center">@DecimalMin(value)</td>
<td style="text-align:center">é™åˆ¶å¿…é¡»ä¸ºä¸€ä¸ªä¸å°äºæŒ‡å®šå€¼çš„æ•°å­—</td>
</tr>
<tr>
<td style="text-align:center">@Digits(integer,fraction)</td>
<td style="text-align:center">é™åˆ¶å¿…é¡»ä¸ºä¸€ä¸ªå°æ•°ï¼Œä¸”æ•´æ•°éƒ¨åˆ†çš„ä½æ•°ä¸èƒ½è¶…è¿‡integerï¼Œå°æ•°éƒ¨åˆ†çš„ä½æ•°ä¸èƒ½è¶…è¿‡fraction</td>
</tr>
<tr>
<td style="text-align:center">@Future</td>
<td style="text-align:center">é™åˆ¶å¿…é¡»æ˜¯ä¸€ä¸ªå°†æ¥çš„æ—¥æœŸ</td>
</tr>
<tr>
<td style="text-align:center">@Max(value)</td>
<td style="text-align:center">é™åˆ¶å¿…é¡»ä¸ºä¸€ä¸ªä¸å¤§äºæŒ‡å®šå€¼çš„æ•°å­—</td>
</tr>
<tr>
<td style="text-align:center">@Min(value)</td>
<td style="text-align:center">é™åˆ¶å¿…é¡»ä¸ºä¸€ä¸ªä¸å°äºæŒ‡å®šå€¼çš„æ•°å­—</td>
</tr>
<tr>
<td style="text-align:center">@Past</td>
<td style="text-align:center">é™åˆ¶å¿…é¡»æ˜¯ä¸€ä¸ªè¿‡å»çš„æ—¥æœŸ</td>
</tr>
<tr>
<td style="text-align:center">@Pattern(value)</td>
<td style="text-align:center">é™åˆ¶å¿…é¡»ç¬¦åˆæŒ‡å®šçš„æ­£åˆ™è¡¨è¾¾å¼</td>
</tr>
<tr>
<td style="text-align:center">@Size(max,min)</td>
<td style="text-align:center">é™åˆ¶å­—ç¬¦é•¿åº¦å¿…é¡»åœ¨minåˆ°maxä¹‹é—´</td>
</tr>
<tr>
<td style="text-align:center">@Past</td>
<td style="text-align:center">éªŒè¯æ³¨è§£çš„å…ƒç´ å€¼ï¼ˆæ—¥æœŸç±»å‹ï¼‰æ¯”å½“å‰æ—¶é—´æ—©</td>
</tr>
<tr>
<td style="text-align:center">@NotEmpty</td>
<td style="text-align:center">éªŒè¯æ³¨è§£çš„å…ƒç´ å€¼ä¸ä¸ºnullä¸”ä¸ä¸ºç©ºï¼ˆå­—ç¬¦ä¸²é•¿åº¦ä¸ä¸º0ã€é›†åˆå¤§å°ä¸ä¸º0ï¼‰</td>
</tr>
<tr>
<td style="text-align:center">@NotBlank</td>
<td style="text-align:center">éªŒè¯æ³¨è§£çš„å…ƒç´ å€¼ä¸ä¸ºç©ºï¼ˆä¸ä¸ºnullã€å»é™¤é¦–ä½ç©ºæ ¼åé•¿åº¦ä¸º0ï¼‰ï¼Œä¸åŒäº@NotEmptyï¼Œ@NotBlank</td>
</tr>
<tr>
<td style="text-align:center">@Email</td>
<td style="text-align:center">éªŒè¯æ³¨è§£çš„å…ƒç´ å€¼æ˜¯Emailï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼å’ŒflagæŒ‡å®šè‡ªå®šä¹‰çš„emailæ ¼å¼</td>
</tr>
</tbody>
</table>
<h1 id="é¡¹ç›®ç»“æ„å›¾ç¤º">é¡¹ç›®ç»“æ„å›¾ç¤º</h1>
<figure data-type="image" tabindex="1"><img src="http://blog.ludangxin.club/post-images/1589985070594.jpg" alt="" loading="lazy"></figure>
<h1 id="å¼•å…¥æ‰€éœ€ä¾èµ–">å¼•å…¥æ‰€éœ€ä¾èµ–</h1>
<pre><code class="language-xml">        &lt;!-- SpringBoot Webå®¹å™¨ --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!-- è¡¨å•éªŒè¯ --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-validation&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!-- lombok --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
            &lt;artifactId&gt;lombok&lt;/artifactId&gt;
            &lt;optional&gt;true&lt;/optional&gt;
        &lt;/dependency&gt;
</code></pre>
<h1 id="åˆ›å»ºvalidatoré…ç½®ç±»">åˆ›å»ºValidatoré…ç½®ç±»</h1>
<pre><code class="language-java">import lombok.extern.slf4j.Slf4j;
import org.hibernate.validator.HibernateValidator;
import org.springframework.boot.autoconfigure.EnableAutoConfiguration;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.validation.beanvalidation.MethodValidationPostProcessor;
import javax.validation.Validation;
import javax.validation.Validator;
import javax.validation.ValidatorFactory;

/**
 * é…ç½® Hibernate å‚æ•°æ ¡éªŒ
 * @author ludangxin
 */
@Slf4j
@Configuration
@EnableAutoConfiguration
public class ValidatorConfig {
    @Bean
    public MethodValidationPostProcessor methodValidationPostProcessor() {
        MethodValidationPostProcessor postProcessor = new MethodValidationPostProcessor();
        //å¿«é€Ÿæ ¡éªŒï¼Œåªè¦æœ‰é”™é©¬ä¸Šè¿”å›
        postProcessor.setValidator(validator());
        return postProcessor;
    }

    @Bean
    public Validator validator(){
        ValidatorFactory validatorFactory = Validation.byProvider( HibernateValidator.class )
                .configure()
                .addProperty( &quot;hibernate.validator.fail_fast&quot;, &quot;true&quot; )
                .buildValidatorFactory();
        Validator validator = validatorFactory.getValidator();
        return validator;
    }
}
</code></pre>
<h1 id="åˆ›å»ºå®ä½“ç±»">åˆ›å»ºå®ä½“ç±»</h1>
<p>è¿™é‡Œç€é‡è®²ä¸€ä¸‹æ³¨è§£ä¸­groupsæ˜¯ç”¨æ¥å¹²ä»€ä¹ˆçš„?</p>
<pre><code class="language-wiki">  å› ä¸ºä¸€ä¸ªå®ä½“ä¸å¯èƒ½åªå¹²ä¸€ç§æ“ä½œ,ä¸€ä¸ªå®ä½“å¿…ç„¶å­˜åœ¨å¢åˆ æ”¹æŸ¥æ“ä½œ,é‚£ä¹ˆé—®é¢˜å°±æ¥äº†
  å¦‚æœæˆ‘è¦æ ¹æ®idè¿›è¡Œæ›´æ–°æ“ä½œ,é‚£ä¹ˆidè‚¯å®šä¸èƒ½ä¸ºç©º
  è¿™æ—¶å€™æˆ‘è¿˜è¦è¿›è¡Œæ–°å¢æ“ä½œ,å› ä¸ºidæ˜¯æ–°å¢æ•°æ®åº“æ“ä½œæ‰äº§ç”Ÿçš„,æ¥å—æ•°æ®çš„æ—¶å€™æˆ‘è‚¯å®šæ˜¯æ²¡æœ‰idçš„
  æ‰€ä»¥å°±äº§ç”ŸçŸ›ç›¾äº†
  é‚£ä¹ˆgroupsè¿™ä¸ªå‚æ•°å°±èµ·ä½œç”¨äº†,å®ƒå¯ä»¥è¡¨ç¤ºæˆ‘è¿™ä¸ªæ³¨è§£å±äºå“ªä¸ªç»„,è¿™æ ·å°±è§£å†³è¿™ä¸ªå°´å°¬çš„é—®é¢˜äº†.
</code></pre>
<p><strong>æ³¨</strong>: å½“åœ¨controllerä¸­æ ¡éªŒè¡¨å•æ•°æ®æ—¶,å¦‚æœä½¿ç”¨äº†groups,é‚£ä¹ˆæ²¡æœ‰åœ¨è¿™ä¸ªåˆ†ç»„ä¸‹çš„å±æ€§æ˜¯ä¸ä¼šæ ¡éªŒçš„</p>
<pre><code class="language-java">import lombok.*;
import javax.validation.constraints.*;
import java.io.Serializable;

/**
 * ç”¨æˆ·ä¿¡æ¯ç®¡ç†
 * @Author: ludangxin
 * @Date: 2020/5/20 16:09
 */
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class SysUser  implements Serializable {

    private static final long serialVersionUID = 1L;
    /**
     * ä¸»é”®
     */
    @NotNull(message = &quot;idä¸èƒ½ä¸ºç©º&quot;,groups = {ValidationInterface.update.class})
    private Long id;

    /**
     * ç”¨æˆ·å
     */
    @NotEmpty(message = &quot;ç”¨æˆ·åç§°ä¸èƒ½ä¸ºç©º&quot;
            , groups = {ValidationInterface.update.class,ValidationInterface.add.class})
    private String username;

    /**
     * å¯†ç 
     */
    @Size(min = 6, max = 16, message = &quot;å¯†ç é•¿åº¦å¿…é¡»åœ¨6-16ä¹‹é—´&quot;
            , groups = {ValidationInterface.update.class,ValidationInterface.add.class})
    private String password;

    /**
     * é‚®ç®±åœ°å€
     */
    @Email(message = &quot;é‚®ç®±åœ°å€ä¸åˆæ³•&quot;
            , groups = {ValidationInterface.update.class,ValidationInterface.add.class
                      , ValidationInterface.select.class})
    @NotEmpty(message = &quot;é‚®ç®±ä¸èƒ½ä¸ºç©º&quot;,groups = ValidationInterface.add.class)
    private String email;

    /**
     * ç”µè¯
     */
    @Size(min = 11, max = 11, message = &quot;æ‰‹æœºå·ä¸åˆæ³•&quot;
                , groups = {ValidationInterface.update.class, ValidationInterface.add.class
                          , ValidationInterface.select.class})
    @NotEmpty(message = &quot;æ‰‹æœºå·ä¸èƒ½ä¸ºç©º&quot;,groups = {ValidationInterface.add.class})
    private String phone;
}
</code></pre>
<h1 id="åˆ›å»ºè¡¨å•éªŒè¯çš„é€šç”¨åˆ†ç»„æ¥å£">åˆ›å»ºè¡¨å•éªŒè¯çš„é€šç”¨åˆ†ç»„æ¥å£</h1>
<pre><code class="language-wiki"> å¦‚æœè¿˜æœ‰å…¶å®ƒç‰¹æ®Šçš„åˆ†ç»„è¦æ±‚ ç›´æ¥åœ¨BOä¸­åˆ›å»ºinterfaceå³å¯
 ä¾‹:å¦‚æœè¿˜æœ‰ä¸ªéœ€è¦éªŒè¯username å’Œ password(åªæœ‰è¿™ä¸¤ä¸ªå‚æ•°) çš„ selectæ“ä½œ
 ç›´æ¥åœ¨SysUserä¸­åˆ›å»ºUsernamePasswordValidView çš„æ¥å£å³å¯
</code></pre>
<pre><code class="language-java">/**
 * ç”¨äºè¡¨å•éªŒè¯çš„é€šç”¨åˆ†ç»„æ¥å£
 * @Author: ludangxin
 * @Date: 2020/5/20 17:07
 */
public interface ValidationInterface {

    /**
     * æ–°å¢åˆ†ç»„
     */
    interface add{}

    /**
     * åˆ é™¤åˆ†ç»„
     */
    interface delete{}

    /**
     * æŸ¥è¯¢åˆ†ç»„
     */
    interface select{}

    /**
     * æ›´æ–°åˆ†ç»„
     */
    interface update{}
}
</code></pre>
<h1 id="åˆ›å»ºä¸šåŠ¡å¼‚å¸¸ç±»">åˆ›å»ºä¸šåŠ¡å¼‚å¸¸ç±»</h1>
<pre><code class="language-java">/**
 * ä¸šåŠ¡å¼‚å¸¸
 * @author ludangxin
 */
public class BusinessException extends RuntimeException{
    private static final long serialVersionUID = 1L;

    protected final String message;

    public BusinessException(String message)
    {
        this.message = message;
    }

    public BusinessException(String message, Throwable e)
    {
        super(message, e);
        this.message = message;
    }

    @Override
    public String getMessage()
    {
        return message;
    }
}
</code></pre>
<h1 id="åˆ›å»ºå…¨å±€å¼‚å¸¸å¤„ç†å™¨">åˆ›å»ºå…¨å±€å¼‚å¸¸å¤„ç†å™¨</h1>
<pre><code class="language-java">import com.ldx.springboot.util.AjaxResult;
import lombok.extern.slf4j.Slf4j;
import org.springframework.validation.BindException;
import org.springframework.web.HttpRequestMethodNotSupportedException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;
import javax.servlet.http.HttpServletRequest;
import javax.validation.ConstraintViolation;
import javax.validation.ConstraintViolationException;
import javax.validation.ValidationException;
import java.util.Set;

/**
 * å…¨å±€å¼‚å¸¸å¤„ç†å™¨
 * 
 */
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {

    /**
     * å‚æ•°ç»‘å®šå¼‚å¸¸ç±» ç”¨äºè¡¨å•éªŒè¯æ—¶æŠ›å‡ºçš„å¼‚å¸¸å¤„ç†
     */
    @ExceptionHandler(BindException.class)
    public AjaxResult validatedBindException(BindException e){
        log.error(e.getMessage(), e);
        String message = &quot;[&quot; + e.getAllErrors().get(0).getDefaultMessage() + &quot;]&quot;;
        return AjaxResult.error(message);
    }

    /**
     * å‚æ•°ç»‘å®šå¼‚å¸¸ç±» ç”¨äºJsonæ•°æ®ç»‘å®šéªŒè¯æ—¶æŠ›å‡ºçš„å¼‚å¸¸å¤„ç†
     */
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public AjaxResult methodArgumentNotValidException(MethodArgumentNotValidException e){
        log.error(e.getMessage(), e);
        String message = &quot;[&quot; + e.getBindingResult().getAllErrors().get(0).getDefaultMessage() + &quot;]&quot;;
        return AjaxResult.error(message);
    }

    /**
     * å‚æ•°ç»‘å®šå¼‚å¸¸ç±»  ç”¨äºæ–¹æ³•å½¢å‚ä¸­å‚æ•°æ ¡éªŒæ—¶æŠ›å‡ºçš„å¼‚å¸¸å¤„ç†
     * @param e
     * @return
     */
    @ExceptionHandler(ConstraintViolationException.class)
    public AjaxResult handle(ValidationException e) {
        log.error(e.getMessage(), e);
        String errorInfo = &quot;&quot;;
        if(e instanceof ConstraintViolationException){
            ConstraintViolationException exs = (ConstraintViolationException) e;
            Set&lt;ConstraintViolation&lt;?&gt;&gt; violations = exs.getConstraintViolations();
            for (ConstraintViolation&lt;?&gt; item : violations) {
                errorInfo = errorInfo + &quot;[&quot; + item.getMessage() + &quot;]&quot;;
            }
        }
        return AjaxResult.error(errorInfo);
    }

    /**
     * è¯·æ±‚æ–¹å¼ä¸æ”¯æŒ
     */
    @ExceptionHandler({ HttpRequestMethodNotSupportedException.class })
    public AjaxResult handleException(HttpRequestMethodNotSupportedException e){
        log.error(e.getMessage(), e);
        return AjaxResult.error(&quot;ä¸æ”¯æŒ' &quot; + e.getMethod() + &quot;'è¯·æ±‚&quot;);
    }

    /**
     * æ‹¦æˆªæœªçŸ¥çš„è¿è¡Œæ—¶å¼‚å¸¸
     */
    @ExceptionHandler(RuntimeException.class)
    public AjaxResult notFount(RuntimeException e) {
        log.error(&quot;è¿è¡Œæ—¶å¼‚å¸¸:&quot;, e);
        return AjaxResult.error(&quot;è¿è¡Œæ—¶å¼‚å¸¸:&quot; + e.getMessage());
    }

    /**
     * ç³»ç»Ÿå¼‚å¸¸
     */
    @ExceptionHandler(Exception.class)
    public AjaxResult handleException(Exception e) {
        log.error(e.getMessage(), e);
        return AjaxResult.error(&quot;æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜&quot;);
    }

    /**
     * ä¸šåŠ¡å¼‚å¸¸
     */
    @ExceptionHandler(BusinessException.class)
    public AjaxResult businessException(HttpServletRequest request, BusinessException e) {
        log.error(e.getMessage());
        return AjaxResult.error(e.getMessage());
    }
}
</code></pre>
<h1 id="åˆ›å»ºcontroller">åˆ›å»ºcontroller</h1>
<pre><code class="language-wiki">ç±»ä¸Šçš„ @Validated ä¸»è¦æ˜¯ä¸ºäº†ä½¿æ–¹æ³•å½¢å‚ä¸­çš„éªŒè¯ç”Ÿæ•ˆ.
å¦‚æœåªæ˜¯ç”¨å®ä½“ç±»ä¸Šçš„å‚æ•°ç»‘å®šæ ¡éªŒ,é‚£ä¹ˆå°±ä¸ç”¨åœ¨ç±»ä¸Šæ ‡æ³¨è¯¥æ³¨è§£
</code></pre>
<pre><code class="language-java">import com.ldx.springboot.exception.BusinessException;
import com.ldx.springboot.model.SysUser;
import com.ldx.springboot.model.ValidationInterface;
import com.ldx.springboot.util.AjaxResult;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;
import javax.validation.constraints.Email;
import javax.validation.constraints.NotEmpty;

@RequestMapping(&quot;sysuser&quot;)
@RestController
@Validated
public class SysUserController {

    /**
     * æ ¹æ®æ‰‹æœºå·å’Œé‚®ç®±æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
     * @param sysUser ç”¨æˆ·ä¿¡æ¯
     * @return
     */
    @GetMapping(&quot;selectByPhoneOrEmail&quot;)
    public AjaxResult selectByPhoneOrEmail(@Validated(value = ValidationInterface.select.class) SysUser sysUser){
        return AjaxResult.success(&quot;æŸ¥è¯¢æˆåŠŸ&quot;);
    }

    /**
     * æ ¹æ®æ‰‹æœºå·å’Œé‚®ç®±æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
     * @param phone æ‰‹æœºå·
     * @param email é‚®ç®±
     * @return
     */
    @GetMapping(&quot;selectByPhoneOrEmail2&quot;)
    public AjaxResult selectByPhoneOrEmail2(@NotEmpty(message = &quot;æ‰‹æœºå·ä¸èƒ½ä¸ºç©º&quot;) String phone
            ,@NotEmpty(message = &quot;é‚®ç®±ä¸èƒ½ä¸ºç©º&quot;)@Email(message = &quot;é‚®ç®±ä¿¡æ¯ä¸åˆæ³•&quot;) String email){
        return AjaxResult.success(&quot;æŸ¥è¯¢æˆåŠŸ&quot;);
    }

    /**
     * æ–°å¢ç”¨æˆ·ä¿¡æ¯
     * @param sysUser ç”¨æˆ·ä¿¡æ¯
     * @return
     */
    @PostMapping(&quot;add&quot;)
    public AjaxResult add(@Validated(value = ValidationInterface.add.class) SysUser sysUser){
        return AjaxResult.success(&quot;æ–°å¢æˆåŠŸ&quot;);
    }

    /**
     * æ–°å¢ç”¨æˆ·ä¿¡æ¯
     * @param sysUser ç”¨æˆ·ä¿¡æ¯
     * @return
     */
    @PostMapping(&quot;add1&quot;)
    public AjaxResult add1(@Validated(value = ValidationInterface.add.class) @RequestBody SysUser sysUser){
        return AjaxResult.success(&quot;æ–°å¢æˆåŠŸ&quot;);
    }

    /**
     * æ›´å…·Idæ›´æ–°ç”¨æˆ·ä¿¡æ¯
     * @param sysUser ç”¨æˆ·ä¿¡æ¯
     * @return
     */
    @PutMapping(&quot;updateById&quot;)
    public AjaxResult updateById(@Validated(value = ValidationInterface.update.class) SysUser sysUser){
        return AjaxResult.success(&quot;æ›´æ–°æˆåŠŸ&quot;);
    }

    /**
     * æ ¹æ®Idåˆ é™¤ç”¨æˆ·ä¿¡æ¯
     * @param id
     * @return
     */
    @DeleteMapping(&quot;deleteById/{id}&quot;)
    public AjaxResult deleteById( @PathVariable Long id){
        return AjaxResult.success(&quot;åˆ é™¤æˆåŠŸ&quot;);
    }

    /**
     * æµ‹è¯•ä¸šåŠ¡å¼‚å¸¸
     * @return
     */
    @GetMapping(&quot;testException&quot;)
    public AjaxResult testException(String name){
        if(!&quot;å¼ ä¸‰&quot;.equals(name)){
            throw new BusinessException(&quot;åªæœ‰å¼ ä¸‰æ‰å¯ä»¥è®¿é—®&quot;);
        }
        return AjaxResult.success();
    }
}
</code></pre>
<h1 id="åˆ›å»ºæ“ä½œæ¶ˆæ¯æé†’ç±»">åˆ›å»ºæ“ä½œæ¶ˆæ¯æé†’ç±»</h1>
<pre><code class="language-java">import lombok.Data;
import lombok.NoArgsConstructor;

/**
 * æ“ä½œæ¶ˆæ¯æé†’
 */
@Data
@NoArgsConstructor
public class AjaxResult {

    /**
     * çŠ¶æ€ç±»å‹
     */
    public enum Type{
        /** æˆåŠŸ */
        SUCCESS(200),
        /** è­¦å‘Š */
        WARN(301),
        /** é”™è¯¯ */
        ERROR(500),
        /*tokenå¤±æ•ˆ*/
        UNAUTHORIZED(401)
        ;
        private final int value;

        Type(int value){
            this.value = value;
        }

        public int value(){
            return this.value;
        }
    }

    /** çŠ¶æ€ç  */
    private int code;

    /** è¿”å›å†…å®¹ */
    private String msg;

    /** æ•°æ®å¯¹è±¡ */
    private Object data;

    /**
     * åˆå§‹åŒ–ä¸€ä¸ªæ–°åˆ›å»ºçš„ AjaxResult å¯¹è±¡
     *
     * @param type çŠ¶æ€ç±»å‹
     * @param msg è¿”å›å†…å®¹
     */
    public AjaxResult(Type type, String msg) {
        this.code = type.value;
        this.msg = msg;
    }

    /**
     * åˆå§‹åŒ–ä¸€ä¸ªæ–°åˆ›å»ºçš„ AjaxResult å¯¹è±¡
     *
     * @param type çŠ¶æ€ç±»å‹
     * @param msg è¿”å›å†…å®¹
     * @param data æ•°æ®å¯¹è±¡
     */
    public AjaxResult(Type type, String msg, Object data) {
        this.code = type.value;
        this.msg = msg;
        if (data != null)
        {
            this.data = data;
        }
    }

    /**
     * è¿”å›æˆåŠŸæ¶ˆæ¯
     *
     * @return æˆåŠŸæ¶ˆæ¯
     */
    public static AjaxResult success() {
        return AjaxResult.success(&quot;æ“ä½œæˆåŠŸ&quot;);
    }

    /**
     * è¿”å›æˆåŠŸæ•°æ®
     *
     * @return æˆåŠŸæ¶ˆæ¯
     */
    public static AjaxResult success(Object data) {
        return AjaxResult.success(&quot;æ“ä½œæˆåŠŸ&quot;, data);
    }

    /**
     * è¿”å›æˆåŠŸæ¶ˆæ¯
     *
     * @param msg è¿”å›å†…å®¹
     * @return æˆåŠŸæ¶ˆæ¯
     */
    public static AjaxResult success(String msg) {
        return AjaxResult.success(msg, null);
    }

    /**
     * è¿”å›æˆåŠŸæ¶ˆæ¯
     *
     * @param msg è¿”å›å†…å®¹
     * @param data æ•°æ®å¯¹è±¡
     * @return æˆåŠŸæ¶ˆæ¯
     */
    public static AjaxResult success(String msg, Object data) {
        return new AjaxResult(Type.SUCCESS, msg, data);
    }

    /**
     * è¿”å›è­¦å‘Šæ¶ˆæ¯
     *
     * @param msg è¿”å›å†…å®¹
     * @return è­¦å‘Šæ¶ˆæ¯
     */
    public static AjaxResult warn(String msg) {
        return AjaxResult.warn(msg, null);
    }

    /**
     * è¿”å›è­¦å‘Šæ¶ˆæ¯
     *
     * @param msg è¿”å›å†…å®¹
     * @param data æ•°æ®å¯¹è±¡
     * @return è­¦å‘Šæ¶ˆæ¯
     */
    public static AjaxResult warn(String msg, Object data) {
        return new AjaxResult(Type.WARN, msg, data);
    }

    /**
     * è¿”å›é”™è¯¯æ¶ˆæ¯
     *
     * @return
     */
    public static AjaxResult error() {
        return AjaxResult.error(&quot;æ“ä½œå¤±è´¥&quot;);
    }

    /**
     * è¿”å›é”™è¯¯æ¶ˆæ¯
     *
     * @param msg è¿”å›å†…å®¹
     * @return è­¦å‘Šæ¶ˆæ¯
     */
    public static AjaxResult error(String msg) {
        return AjaxResult.error(msg, null);
    }

    /**
     * è¿”å›é”™è¯¯æ¶ˆæ¯
     *
     * @param msg è¿”å›å†…å®¹
     * @param data æ•°æ®å¯¹è±¡
     * @return è­¦å‘Šæ¶ˆæ¯
     */
    public static AjaxResult error(String msg, Object data) {
        return new AjaxResult(Type.ERROR, msg, data);
    }

    /**
     * è¿”å›é”™è¯¯æ¶ˆæ¯
     *
     * @param msg è¿”å›å†…å®¹
     * @return è­¦å‘Šæ¶ˆæ¯
     */
    public static AjaxResult unauthorized(String msg) {
        return AjaxResult.unauthorized(msg, null);
    }

    /**
     * è¿”å›é”™è¯¯æ¶ˆæ¯
     *
     * @param msg è¿”å›å†…å®¹
     * @param data æ•°æ®å¯¹è±¡
     * @return è­¦å‘Šæ¶ˆæ¯
     */
    public static AjaxResult unauthorized(String msg, Object data) {
        return new AjaxResult(Type.UNAUTHORIZED, msg, data);
    }
}
</code></pre>
<h1 id="æ•ˆæœæ¼”ç¤º">æ•ˆæœæ¼”ç¤º</h1>
<p>è®¿é—®selectByPhoneOrEmailæ¥å£<br>
<img src="http://blog.ludangxin.club/post-images/1589987424474.jpg" alt="" loading="lazy"><br>
è®¿é—®selectByPhoneOrEmail2æ¥å£<br>
<img src="http://blog.ludangxin.club/post-images/1589987514865.jpg" alt="" loading="lazy"><br>
è®¿é—®addæ¥å£<br>
<img src="http://blog.ludangxin.club/post-images/1589987602210.jpg" alt="" loading="lazy"><br>
è®¿é—®testExceptionæ¥å£æµ‹è¯•ä¸šåŠ¡å¼‚å¸¸æç¤º<br>
<img src="http://blog.ludangxin.club/post-images/1589987670484.jpg" alt="" loading="lazy"></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Nginx]]></title>
        <id>http://blog.ludangxin.club/post/nginx/</id>
        <link href="http://blog.ludangxin.club/post/nginx/">
        </link>
        <updated>2020-05-17T04:18:57.000Z</updated>
        <content type="html"><![CDATA[<h1 id="nginxç®€ä»‹">nginxç®€ä»‹</h1>
<h2 id="nginxæ¦‚è¿°">nginxæ¦‚è¿°</h2>
<p>Nginx (&quot;engine x&quot;) æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ HTTP å’Œåå‘ä»£ç†æœåŠ¡å™¨,ç‰¹ç‚¹æ˜¯å æœ‰å†…å­˜å°‘ï¼Œå¹¶å‘èƒ½<br>
åŠ›å¼ºï¼Œäº‹å®ä¸Š nginx çš„å¹¶å‘èƒ½åŠ›ç¡®å®åœ¨åŒç±»å‹çš„ç½‘é¡µæœåŠ¡å™¨ä¸­è¡¨ç°è¾ƒå¥½ï¼Œä¸­å›½å¤§é™†ä½¿ç”¨ nginx<br>
ç½‘ç«™ç”¨æˆ·æœ‰ï¼šç™¾åº¦ã€äº¬ä¸œã€æ–°æµªã€ç½‘æ˜“ã€è…¾è®¯ã€æ·˜å®ç­‰</p>
<h2 id="nginxä½œä¸ºwebæœåŠ¡å™¨">nginxä½œä¸ºwebæœåŠ¡å™¨</h2>
<p>Nginx å¯ä»¥ä½œä¸ºé™æ€é¡µé¢çš„ web æœåŠ¡å™¨ï¼ŒåŒæ—¶è¿˜æ”¯æŒ CGI åè®®çš„åŠ¨æ€è¯­è¨€ï¼Œæ¯”å¦‚ perlã€php<br>
ç­‰ã€‚ä½†æ˜¯ä¸æ”¯æŒ javaã€‚Java ç¨‹åºåªèƒ½é€šè¿‡ä¸ tomcat é…åˆå®Œæˆã€‚Nginx ä¸“ä¸ºæ€§èƒ½ä¼˜åŒ–è€Œå¼€å‘ï¼Œ<br>
æ€§èƒ½æ˜¯å…¶æœ€é‡è¦çš„è€ƒé‡,å®ç°ä¸Šéå¸¸æ³¨é‡æ•ˆç‡ ï¼Œèƒ½ç»å—é«˜è´Ÿè½½çš„è€ƒéªŒ,æœ‰æŠ¥å‘Šè¡¨æ˜èƒ½æ”¯æŒé«˜<br>
è¾¾ 50,000 ä¸ªå¹¶å‘è¿æ¥æ•°ã€‚<br>
https://lnmp.org/nginx.html</p>
<h2 id="æ­£å‘ä»£ç†">æ­£å‘ä»£ç†</h2>
<p>Nginx ä¸ä»…å¯ä»¥åšåå‘ä»£ç†ï¼Œå®ç°è´Ÿè½½å‡è¡¡ã€‚è¿˜èƒ½ç”¨ä½œæ­£å‘ä»£ç†æ¥è¿›è¡Œä¸Šç½‘ç­‰åŠŸèƒ½ã€‚<br>
æ­£å‘ä»£ç†ï¼šå¦‚æœæŠŠå±€åŸŸç½‘å¤–çš„ Internet æƒ³è±¡æˆä¸€ä¸ªå·¨å¤§çš„èµ„æºåº“ï¼Œåˆ™å±€åŸŸç½‘ä¸­çš„å®¢æˆ·ç«¯è¦è®¿<br>
é—® Internetï¼Œåˆ™éœ€è¦é€šè¿‡ä»£ç†æœåŠ¡å™¨æ¥è®¿é—®ï¼Œè¿™ç§ä»£ç†æœåŠ¡å°±ç§°ä¸ºæ­£å‘ä»£ç†ã€‚<br>
<img src="https://i.loli.net/2020/04/16/LXnVcihqUCKS5FG.png" alt="image.png" loading="lazy"></p>
<h2 id="åå‘ä»£ç†">åå‘ä»£ç†</h2>
<p>åå‘ä»£ç†ï¼Œå…¶å®å®¢æˆ·ç«¯å¯¹ä»£ç†æ˜¯æ— æ„ŸçŸ¥çš„ï¼Œå› ä¸ºå®¢æˆ·ç«¯ä¸éœ€è¦ä»»ä½•é…ç½®å°±å¯ä»¥è®¿é—®ï¼Œæˆ‘ä»¬åª<br>
éœ€è¦å°†è¯·æ±‚å‘é€åˆ°åå‘ä»£ç†æœåŠ¡å™¨ï¼Œç”±åå‘ä»£ç†æœåŠ¡å™¨å»é€‰æ‹©ç›®æ ‡æœåŠ¡å™¨è·å–æ•°æ®åï¼Œåœ¨è¿”<br>
å›ç»™å®¢æˆ·ç«¯ï¼Œæ­¤æ—¶åå‘ä»£ç†æœåŠ¡å™¨å’Œç›®æ ‡æœåŠ¡å™¨å¯¹å¤–å°±æ˜¯ä¸€ä¸ªæœåŠ¡å™¨ï¼Œæš´éœ²çš„æ˜¯ä»£ç†æœåŠ¡å™¨<br>
åœ°å€ï¼Œéšè—äº†çœŸå®æœåŠ¡å™¨ IP åœ°å€ã€‚<br>
<img src="https://i.loli.net/2020/04/16/ecldAyw4K9MaufG.png" alt="image.png" loading="lazy"></p>
<h2 id="è´Ÿè½½å‡è¡¡">è´Ÿè½½å‡è¡¡</h2>
<p>å®¢æˆ·ç«¯å‘é€å¤šä¸ªè¯·æ±‚åˆ°æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨å¤„ç†è¯·æ±‚ï¼Œæœ‰ä¸€äº›å¯èƒ½è¦ä¸æ•°æ®åº“è¿›è¡Œäº¤äº’ï¼ŒæœåŠ¡å™¨å¤„ç†å®Œæ¯•åï¼Œå†å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚<br>
è¿™ç§æ¶æ„æ¨¡å¼å¯¹äºæ—©æœŸçš„ç³»ç»Ÿç›¸å¯¹å•ä¸€ï¼Œå¹¶å‘è¯·æ±‚ç›¸å¯¹è¾ƒå°‘çš„æƒ…å†µä¸‹æ˜¯æ¯”è¾ƒé€‚åˆçš„ï¼Œæˆæœ¬ä¹Ÿä½ã€‚ä½†æ˜¯éšç€ä¿¡æ¯æ•°é‡çš„ä¸æ–­å¢é•¿ï¼Œè®¿é—®é‡å’Œæ•°æ®é‡çš„é£é€Ÿå¢é•¿ï¼Œä»¥åŠç³»ç»Ÿä¸šåŠ¡çš„å¤æ‚åº¦å¢åŠ ï¼Œè¿™ç§æ¶æ„ä¼šé€ æˆæœåŠ¡å™¨ç›¸åº”å®¢æˆ·ç«¯çš„è¯·æ±‚æ—¥ç›Šç¼“æ…¢ï¼Œå¹¶å‘é‡ç‰¹åˆ«å¤§çš„æ—¶å€™ï¼Œè¿˜å®¹æ˜“é€ æˆæœåŠ¡å™¨ç›´æ¥å´©æºƒã€‚å¾ˆæ˜æ˜¾è¿™æ˜¯ç”±äºæœåŠ¡å™¨æ€§èƒ½çš„ç“¶é¢ˆé€ æˆçš„é—®é¢˜ï¼Œé‚£ä¹ˆå¦‚ä½•è§£å†³è¿™ç§æƒ…å†µå‘¢ï¼Ÿ<br>
æˆ‘ä»¬é¦–å…ˆæƒ³åˆ°çš„å¯èƒ½æ˜¯å‡çº§æœåŠ¡å™¨çš„é…ç½®ï¼Œæ¯”å¦‚æé«˜ CPU æ‰§è¡Œé¢‘ç‡ï¼ŒåŠ å¤§å†…å­˜ç­‰æé«˜æœºå™¨çš„ç‰©ç†æ€§èƒ½æ¥è§£å†³æ­¤é—®é¢˜ï¼Œä½†æ˜¯æˆ‘ä»¬çŸ¥é“æ‘©å°”å®šå¾‹çš„æ—¥ç›Šå¤±æ•ˆï¼Œç¡¬ä»¶çš„æ€§èƒ½æå‡å·²ç»ä¸èƒ½æ»¡è¶³æ—¥ç›Šæå‡çš„éœ€æ±‚äº†ã€‚æœ€æ˜æ˜¾çš„ä¸€ä¸ªä¾‹å­ï¼Œå¤©çŒ«åŒåä¸€å½“å¤©ï¼ŒæŸä¸ªçƒ­é”€å•†å“çš„ç¬æ—¶è®¿é—®é‡æ˜¯æå…¶åºå¤§çš„ï¼Œé‚£ä¹ˆç±»ä¼¼ä¸Šé¢çš„ç³»ç»Ÿæ¶æ„ï¼Œå°†æœºå™¨éƒ½å¢åŠ åˆ°ç°æœ‰çš„é¡¶çº§ç‰©ç†é…ç½®ï¼Œéƒ½æ˜¯ä¸èƒ½å¤Ÿæ»¡è¶³éœ€æ±‚çš„ã€‚é‚£ä¹ˆæ€ä¹ˆå‘¢ï¼Ÿ<br>
ä¸Šé¢çš„åˆ†ææˆ‘ä»¬å»æ‰äº†å¢åŠ æœåŠ¡å™¨ç‰©ç†é…ç½®æ¥è§£å†³é—®é¢˜çš„åŠæ³•ï¼Œä¹Ÿå°±æ˜¯è¯´çºµå‘è§£å†³é—®é¢˜çš„åŠæ³•è¡Œä¸é€šäº†ï¼Œé‚£ä¹ˆæ¨ªå‘å¢åŠ æœåŠ¡å™¨çš„æ•°é‡å‘¢ï¼Ÿè¿™æ—¶å€™é›†ç¾¤çš„æ¦‚å¿µäº§ç”Ÿäº†ï¼Œå•ä¸ªæœåŠ¡å™¨è§£å†³ä¸äº†ï¼Œæˆ‘ä»¬å¢åŠ æœåŠ¡å™¨çš„æ•°é‡ï¼Œç„¶åå°†è¯·æ±‚åˆ†å‘åˆ°å„ä¸ªæœåŠ¡å™¨ä¸Šï¼Œå°†åŸå…ˆè¯·æ±‚é›†ä¸­åˆ°å•ä¸ªæœåŠ¡å™¨ä¸Šçš„æƒ…å†µæ”¹ä¸ºå°†è¯·æ±‚åˆ†å‘åˆ°å¤šä¸ªæœåŠ¡å™¨ä¸Šï¼Œå°†è´Ÿè½½åˆ†å‘åˆ°ä¸åŒçš„æœåŠ¡å™¨ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„<strong>è´Ÿè½½å‡è¡¡</strong><br>
<img src="https://i.loli.net/2020/04/16/C6BqOvr3slDyTme.png" alt="image.png" loading="lazy"></p>
<h2 id="åŠ¨é™åˆ†ç¦»">åŠ¨é™åˆ†ç¦»</h2>
<p>ä¸ºäº†åŠ å¿«ç½‘ç«™çš„è§£æé€Ÿåº¦ï¼Œå¯ä»¥æŠŠåŠ¨æ€é¡µé¢å’Œé™æ€é¡µé¢ç”±ä¸åŒçš„æœåŠ¡å™¨æ¥è§£æï¼ŒåŠ å¿«è§£æé€Ÿåº¦ã€‚é™ä½åŸæ¥å•ä¸ªæœåŠ¡å™¨çš„å‹åŠ›ã€‚<br>
<img src="https://i.loli.net/2020/04/16/PbKDoymtFkT2fwn.png" alt="image.png" loading="lazy"></p>
<h1 id="nginx-å®‰è£…">nginx å®‰è£…</h1>
<h2 id="ç´ æä»‹ç»">ç´ æä»‹ç»</h2>
<h3 id="pcre">PCRE</h3>
<p>PCREåº“æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼ã€‚å¦‚æœæˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶nginx.confä¸­ä½¿ç”¨äº†æ­£åˆ™è¡¨è¾¾å¼ï¼Œé‚£ä¹ˆåœ¨ç¼–è¯‘Nginxæ—¶å°±å¿…é¡»æŠŠPCREåº“ç¼–è¯‘è¿›Nginxï¼Œå› ä¸ºNginxçš„HTTPæ¨¡å—éœ€è¦é å®ƒæ¥è§£ææ­£åˆ™è¡¨è¾¾å¼ã€‚å¦å¤–ï¼Œpcre-develæ˜¯ä½¿ç”¨PCREåšäºŒæ¬¡å¼€å‘æ—¶æ‰€éœ€è¦çš„å¼€å‘åº“ï¼ŒåŒ…æ‹¬å¤´æ–‡ä»¶ç­‰ï¼Œè¿™ä¹Ÿæ˜¯ç¼–è¯‘Nginxæ‰€å¿…é¡»ä½¿ç”¨çš„.</p>
<h3 id="zlib">zlib</h3>
<p>zlibåº“ç”¨äºå¯¹HTTPåŒ…çš„å†…å®¹åšgzipæ ¼å¼çš„å‹ç¼©ï¼Œå¦‚æœæˆ‘ä»¬åœ¨nginx.confä¸­é…ç½®äº†gzip onï¼Œå¹¶æŒ‡å®šå¯¹äºæŸäº›ç±»å‹ï¼ˆcontent-typeï¼‰çš„HTTPå“åº”ä½¿ç”¨gzipæ¥è¿›è¡Œå‹ç¼©ä»¥å‡å°‘ç½‘ç»œä¼ è¾“é‡ï¼Œåˆ™åœ¨ç¼–è¯‘æ—¶å°±å¿…é¡»æŠŠzlibç¼–è¯‘è¿›Nginxã€‚zlib-develæ˜¯äºŒæ¬¡å¼€å‘æ‰€éœ€è¦çš„åº“.</p>
<h3 id="openssl">openSSL</h3>
<p>å¦‚æœæœåŠ¡å™¨ä¸åªæ˜¯è¦æ”¯æŒHTTPï¼Œè¿˜éœ€è¦åœ¨æ›´å®‰å…¨çš„SSLåè®®ä¸Šä¼ è¾“HTTPï¼Œé‚£ä¹ˆéœ€è¦æ‹¥æœ‰OpenSSLã€‚å¦å¤–ï¼Œå¦‚æœæˆ‘ä»¬æƒ³ä½¿ç”¨MD5ã€SHA1ç­‰æ•£åˆ—å‡½æ•°ï¼Œé‚£ä¹ˆä¹Ÿéœ€è¦å®‰è£…å®ƒã€‚</p>
<h3 id="nginxå®‰è£…åŒ…">nginxå®‰è£…åŒ…</h3>
<h2 id="å¼€å§‹å®‰è£…">å¼€å§‹å®‰è£…</h2>
<h3 id="å®‰è£…pcre">å®‰è£…pcre</h3>
<ul>
<li><code>cd /usr/local/</code> : åˆ°å®‰è£…ç›®å½•ä¸‹</li>
<li><code>wget https://sourceforge.net/projects/pcre/files/pcre/8.44/pcre-8.44.tar.gz</code>:ä¸‹è½½pcre</li>
<li><code>tar -zxvf pcre-8.44.tar.gz</code>: è§£å‹</li>
<li><code>cd pcre-8.44</code>:åˆ‡æ¢åˆ°æ–‡ä»¶å¤¹ä¸‹</li>
<li><code>./configure</code>:æ‰§è¡Œé…ç½®æ–‡ä»¶</li>
<li><code>make &amp;&amp; make install</code>:ç¼–è¯‘å®‰è£…pcre</li>
</ul>
<p><strong>ç‰¹åˆ«æ³¨æ„</strong>:make å‘½ä»¤æ‰§è¡Œä¸äº†çš„åŒå­¦ <code>./configure</code>å æœ€åä¸€è¡Œä¼šå‡ºç°</p>
<p>configure: error: You need a C++ compiler for C++ support.</p>
<p>å®‰è£…ä¸€ä¸‹è¿™ä¸ªå³å¯ï¼š<code>yum install -y gcc gcc-c++</code></p>
<p>ï¼ˆå®‰è£…å®Œæ¯•ååœ¨æ‰§è¡Œ ./configure åœ¨æ‰§è¡Œmake å°±OKäº† æˆ‘å°±æ˜¯è¿™æ ·ï¼‰</p>
<h3 id="å®‰è£…opensslå’Œzlib">å®‰è£…opensslå’Œzlib</h3>
<p><code>yum -y install make zlib zlib-devel gcc-c++ libtool openssl openssl-devel</code>:ä¸€é”®å®‰è£…</p>
<h3 id="å®‰è£…nginx">å®‰è£…nginx</h3>
<ul>
<li><code>cd /usr/local/</code> : åˆ°å®‰è£…ç›®å½•ä¸‹å¹¶ä¸”æŠŠtaræ–‡ä»¶æ”¾åˆ°è¯¥ç›®å½•ä¸­</li>
<li><code>tar -zxvf nginx-1.16.1.tar.gz</code> : è§£å‹æ–‡ä»¶</li>
<li><code>cd nginx-1.16.1</code>: åˆ‡æ¢åˆ°æ–‡ä»¶ç›®å½•ä¸‹</li>
<li><code>./configure</code>: æ‰§è¡Œå®‰è£…é…ç½®æ–‡ä»¶</li>
<li><code>make &amp;&amp; make install</code>: ç¼–è¯‘å®‰è£…</li>
<li><code>cd /usr/local/nginx/sbin/</code>: è¿›å»nginxå¯æ‰§è¡Œæ–‡ä»¶ç›®å½•ä¸­</li>
<li><code>./nginx</code>:å¯åŠ¨nginxæœåŠ¡</li>
<li>è®¿é—®ç³»ç»Ÿ80ç«¯å£æŸ¥çœ‹æœåŠ¡æ˜¯å¦å¯åŠ¨</li>
</ul>
<p><strong>ç‰¹åˆ«æ³¨æ„</strong>:</p>
<p>åœ¨ windows ç³»ç»Ÿä¸­è®¿é—®linux ä¸­ <strong>nginx</strong>ï¼Œé»˜è®¤ä¸èƒ½è®¿é—®çš„ï¼Œå› ä¸º<strong>é˜²ç«å¢™</strong>é—®é¢˜</p>
<ul>
<li>
<p>æŸ¥çœ‹å¼€æ”¾çš„ç«¯å£å·</p>
<ul>
<li>firewall-cmd --list-all</li>
</ul>
</li>
<li>
<p>è®¾ç½®å¼€æ”¾çš„ç«¯å£å·</p>
<ul>
<li>firewall-cmd --add-service=http â€“permanent</li>
<li>firewall-cmd --add-port=80/tcp --permanent</li>
</ul>
</li>
<li>
<p>é‡å¯é˜²ç«å¢™</p>
<ul>
<li>firewall-cmd â€“reload</li>
</ul>
</li>
</ul>
<figure data-type="image" tabindex="1"><img src="https://i.loli.net/2020/04/18/vo1gCVjNGi2mYzE.png" alt="image.png" loading="lazy"></figure>
<h1 id="nginx-å¸¸ç”¨å‘½ä»¤å’Œé…ç½®æ–‡ä»¶">nginx å¸¸ç”¨å‘½ä»¤å’Œé…ç½®æ–‡ä»¶</h1>
<h2 id="å¸¸ç”¨å‘½ä»¤">å¸¸ç”¨å‘½ä»¤</h2>
<ul>
<li>
<p><code>cd /usr/local/nginx/sbin</code>: è¿›å…¥nginxç›®å½•ä¸­</p>
</li>
<li>
<p><code>./nginx -v</code>:æŸ¥çœ‹nginxç‰ˆæœ¬å·</p>
</li>
<li>
<p><code>./nginx</code>: å¯åŠ¨nginx</p>
</li>
<li>
<p><code>./nginx -s stop</code>: åœæ­¢nginx</p>
</li>
<li>
<p><code>./nginx -s reload</code>:é‡æ–°åŠ è½½nginx(ä¸æ˜¯é‡å¯)</p>
</li>
</ul>
<h2 id="é…ç½®æ–‡ä»¶">é…ç½®æ–‡ä»¶</h2>
<ul>
<li>
<p><code>cd /usr/local/nginx/conf/nginx.conf</code> : é…ç½®æ–‡ä»¶çš„ç›®å½•</p>
</li>
<li>
<p>é…ç½®æ–‡ä»¶ä¸­çš„å†…å®¹</p>
<ul>
<li>
<p>å…¨å±€å—</p>
</li>
<li>
<pre><code></code></pre>
</li>
</ul>
<p>worker_processes;</p>
<pre><code>
* ä»é…ç½®æ–‡ä»¶å¼€å§‹åˆ° events å—ä¹‹é—´çš„å†…å®¹ï¼Œä¸»è¦ä¼šè®¾ç½®ä¸€äº›å½±å“ nginx æœåŠ¡å™¨æ•´ä½“è¿è¡Œçš„é…ç½®æŒ‡ä»¤ï¼Œä¸»è¦åŒ…æ‹¬é…ç½®è¿è¡Œ Nginx æœåŠ¡å™¨çš„ç”¨æˆ·ï¼ˆç»„ï¼‰ã€å…è®¸ç”Ÿæˆçš„ worker process æ•°ï¼Œè¿›ç¨‹ PID å­˜æ”¾è·¯å¾„ã€æ—¥å¿—å­˜æ”¾è·¯å¾„å’Œç±»å‹ä»¥åŠé…ç½®æ–‡ä»¶çš„å¼•å…¥ç­‰ã€‚æ¯”å¦‚ä¸Šé¢ç¬¬ä¸€è¡Œé…ç½®çš„ `worker_processes  1;`
 è¿™æ˜¯ Nginx æœåŠ¡å™¨å¹¶å‘å¤„ç†æœåŠ¡çš„å…³é”®é…ç½®ï¼Œworker_processes å€¼è¶Šå¤§ï¼Œå¯ä»¥æ”¯æŒçš„å¹¶å‘å¤„ç†é‡ä¹Ÿè¶Šå¤šï¼Œä½†æ˜¯ä¼šå—åˆ°ç¡¬ä»¶ã€è½¯ä»¶ç­‰è®¾å¤‡çš„åˆ¶çº¦.

* eventså—
* ``````json
  events {
      worker_connections  1024;
  }
  ``````
* events å—æ¶‰åŠçš„æŒ‡ä»¤ä¸»è¦å½±å“ Nginx æœåŠ¡å™¨ä¸ç”¨æˆ·çš„ç½‘ç»œè¿æ¥ï¼Œå¸¸ç”¨çš„è®¾ç½®åŒ…æ‹¬æ˜¯å¦å¼€å¯å¯¹å¤š work process ä¸‹çš„ç½‘ç»œè¿æ¥è¿›è¡Œåºåˆ—åŒ–ï¼Œæ˜¯å¦å…è®¸åŒæ—¶æ¥æ”¶å¤šä¸ªç½‘ç»œè¿æ¥ï¼Œé€‰å–å“ªç§äº‹ä»¶é©±åŠ¨æ¨¡å‹æ¥å¤„ç†è¿æ¥è¯·æ±‚ï¼Œæ¯ä¸ª word  process å¯ä»¥åŒæ—¶æ”¯æŒçš„æœ€å¤§è¿æ¥æ•°ç­‰ã€‚
ä¸Šè¿°ä¾‹å­å°±è¡¨ç¤ºæ¯ä¸ª work process æ”¯æŒçš„æœ€å¤§è¿æ¥æ•°ä¸º 1024.
 è¿™éƒ¨åˆ†çš„é…ç½®å¯¹ Nginx çš„æ€§èƒ½å½±å“è¾ƒå¤§ï¼Œåœ¨å®é™…ä¸­åº”è¯¥çµæ´»é…ç½®ã€‚

* httpå—

* ``````json
  http {
      include       mime.types;
      default_type  application/octet-stream;
  
      #log_format  main  '$remote_addr - $remote_user [$time_local] &quot;$request&quot; '
      #                  '$status $body_bytes_sent &quot;$http_referer&quot; '
      #                  '&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;';
  
      #access_log  logs/access.log  main;
  
      sendfile        on;
      #tcp_nopush     on;
  
      #keepalive_timeout  0;
      keepalive_timeout  65;
  
      #gzip  on;
  
      server {
          listen       80;
          server_name  localhost;
  ``````

* è¿™ç®—æ˜¯ Nginx æœåŠ¡å™¨é…ç½®ä¸­æœ€é¢‘ç¹çš„éƒ¨åˆ†ï¼Œä»£ç†ã€ç¼“å­˜å’Œæ—¥å¿—å®šä¹‰ç­‰ç»å¤§å¤šæ•°åŠŸèƒ½å’Œç¬¬ä¸‰æ–¹æ¨¡å—çš„é…ç½®éƒ½åœ¨è¿™é‡Œã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼šhttp å—ä¹Ÿå¯ä»¥åŒ…æ‹¬ **http å…¨å±€å—**ã€**server å—**

* httpå…¨å±€å—

   * http å…¨å±€å—é…ç½®çš„æŒ‡ä»¤åŒ…æ‹¬æ–‡ä»¶å¼•å…¥ã€MIME-TYPE å®šä¹‰ã€æ—¥å¿—è‡ªå®šä¹‰ã€è¿æ¥è¶…æ—¶æ—¶é—´ã€å•é“¾æ¥è¯·æ±‚æ•°ä¸Šé™ç­‰ã€‚

* serverå—
  * è¿™å—å’Œè™šæ‹Ÿä¸»æœºæœ‰å¯†åˆ‡å…³ç³»ï¼Œè™šæ‹Ÿä¸»æœºä»ç”¨æˆ·è§’åº¦çœ‹ï¼Œå’Œä¸€å°ç‹¬ç«‹çš„ç¡¬ä»¶ä¸»æœºæ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œè¯¥æŠ€æœ¯çš„äº§ç”Ÿæ˜¯ä¸ºäº†èŠ‚çœäº’è”ç½‘æœåŠ¡å™¨ç¡¬ä»¶æˆæœ¬ã€‚æ¯ä¸ª http å—å¯ä»¥åŒ…æ‹¬å¤šä¸ªserver å—ï¼Œè€Œæ¯ä¸ª server å—å°±ç›¸å½“äºä¸€ä¸ªè™šæ‹Ÿä¸»æœºã€‚è€Œæ¯ä¸ª server å—ä¹Ÿåˆ†ä¸ºå…¨å±€server å—ï¼Œä»¥åŠå¯ä»¥åŒæ—¶åŒ…å«å¤šä¸ª locaton å—ã€‚
  * å…¨å±€serverå—
    * æœ€å¸¸è§çš„é…ç½®æ˜¯æœ¬è™šæ‹Ÿæœºä¸»æœºçš„ç›‘å¬é…ç½®å’Œæœ¬è™šæ‹Ÿä¸»æœºçš„åç§°æˆ– IP é…ç½®ã€‚
  * locationå—
    * ä¸€ä¸ª server å—å¯ä»¥é…ç½®å¤šä¸ª location å—ã€‚
</code></pre>
</li>
</ul>
<p>è¿™å—çš„ä¸»è¦ä½œç”¨æ˜¯åŸºäº Nginx æœåŠ¡å™¨æ¥æ”¶åˆ°çš„è¯·æ±‚å­—ç¬¦ä¸²ï¼ˆä¾‹å¦‚ server_name/uri-stringï¼‰ï¼Œå¯¹è™šæ‹Ÿ ä¸»æœºåç§°ï¼ˆä¹Ÿå¯ä»¥æ˜¯ IP åˆ«åï¼‰ä¹‹å¤–çš„å­—ç¬¦ä¸²ï¼ˆä¾‹å¦‚ å‰é¢çš„ /uri-stringï¼‰è¿›è¡ŒåŒ¹é…ï¼Œå¯¹ç‰¹å®šçš„è¯·æ±‚è¿›è¡Œå¤„ç†ã€‚åœ°å€å®šå‘ã€æ•°æ®ç¼“å­˜å’Œåº”ç­”æ§åˆ¶ç­‰åŠŸèƒ½ï¼Œè¿˜æœ‰è®¸å¤šç¬¬ä¸‰æ–¹æ¨¡å—çš„é…ç½®ä¹Ÿåœ¨è¿™é‡Œè¿›è¡Œã€‚</p>
<h2 id="location-æŒ‡ä»¤è¯´æ˜">location æŒ‡ä»¤è¯´æ˜</h2>
<p>è¯¥æŒ‡ä»¤ç”¨äºåŒ¹é…URL</p>
<p>è¯­æ³•å¦‚ä¸‹</p>
<pre><code class="language-json">location [ = | ~ | ~* | ^~] uri {

}
</code></pre>
<ul>
<li>
<p>= : ç”¨äºä¸å«æ­£åˆ™è¡¨è¾¾å¼çš„ uri å‰ï¼Œè¦æ±‚è¯·æ±‚å­—ç¬¦ä¸²ä¸ uri ä¸¥æ ¼åŒ¹é…ï¼Œå¦‚æœåŒ¹é…æˆåŠŸï¼Œå°±åœæ­¢ç»§ç»­å‘ä¸‹æœç´¢å¹¶ç«‹å³å¤„ç†è¯¥è¯·æ±‚</p>
</li>
<li>
<p>~ : ç”¨äºè¡¨ç¤º uri åŒ…å«æ­£åˆ™è¡¨è¾¾å¼ï¼Œå¹¶ä¸”åŒºåˆ†å¤§å°å†™</p>
</li>
<li>
<p>~* : ç”¨äºè¡¨ç¤º uri åŒ…å«æ­£åˆ™è¡¨è¾¾å¼ï¼Œå¹¶ä¸”ä¸åŒºåˆ†å¤§å°å†™</p>
</li>
<li>
<p>^~ : ç”¨äºä¸å«æ­£åˆ™è¡¨è¾¾å¼çš„ uri å‰ï¼Œè¦æ±‚ Nginx æœåŠ¡å™¨æ‰¾åˆ°æ ‡è¯† uri å’Œè¯·æ±‚å­—ç¬¦ä¸²åŒ¹é…åº¦æœ€é«˜çš„ location åï¼Œç«‹å³ä½¿ç”¨æ­¤ location å¤„ç†è¯·æ±‚ï¼Œè€Œä¸å†ä½¿ç”¨ location å—ä¸­çš„æ­£åˆ™ uri å’Œè¯·æ±‚å­—ç¬¦ä¸²åšåŒ¹é…</p>
</li>
</ul>
<p>*<em>æ³¨æ„ : ** å¦‚æœ uri åŒ…å«æ­£åˆ™è¡¨è¾¾å¼ï¼Œåˆ™å¿…é¡»è¦æœ‰ ~ æˆ–è€… ~</em> æ ‡è¯†</p>
<h1 id="nginxé…ç½®å®ä¾‹-åå‘ä»£ç†">nginxé…ç½®å®ä¾‹-åå‘ä»£ç†</h1>
<h2 id="åå‘ä»£ç†å®ä¾‹ä¸€">åå‘ä»£ç†å®ä¾‹ä¸€</h2>
<p>å®ç°æ•ˆæœ:ä½¿ç”¨nginxåå‘ä»£ç†,è®¿é—®www.123.comç›´æ¥è·³è½¬åˆ°127.0.0.1:8080</p>
<h3 id="å®ç°è¿‡ç¨‹">å®ç°è¿‡ç¨‹:</h3>
<ol>
<li>å¯åŠ¨ä¸€ä¸ªtomcat,æµè§ˆå™¨åœ°å€æ è¾“å…¥127.0.0.1:8080,å¯åŠ¨è®¿é—®æ­£å¸¸å</li>
<li>ä¿®æ”¹æœ¬åœ°host<code>C:\Windows\System32\drivers\etc\hosts</code>æ–‡ä»¶,å°†<code>www.123.com</code>æ˜ å°„åˆ°127.0.0.1</li>
</ol>
<pre><code class="language-tex">é…ç½®å®Œæˆä¹‹åï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥é€šè¿‡ www.123.com:8080 è®¿é—®åˆ°ç¬¬ä¸€æ­¥å‡ºç°çš„ Tomcat åˆå§‹ç•Œé¢ã€‚é‚£ä¹ˆå¦‚ä½•åªéœ€è¦è¾“å…¥ www.123.com ä¾¿å¯ä»¥è·³è½¬åˆ° Tomcat åˆå§‹ç•Œé¢å‘¢ï¼Ÿä¾¿ç”¨åˆ° nginxçš„åå‘ä»£ç†ã€‚
</code></pre>
<ol start="3">
<li>åœ¨ nginx.conf é…ç½®æ–‡ä»¶ä¸­å¢åŠ å¦‚ä¸‹é…ç½®</li>
</ol>
<pre><code class="language-json">server {
	listen  80;
	server_name www.123.com;
	
	location / {
		proxy_pass http://127.0.0.1:8080;
		index index.html index.htm index.jsp;
	}
}
</code></pre>
<ol start="4">
<li>å¦‚ä¸Šé…ç½®ï¼Œæˆ‘ä»¬ç›‘å¬ 80 ç«¯å£ï¼Œè®¿é—®åŸŸåä¸º www.123.comï¼Œä¸åŠ ç«¯å£å·æ—¶é»˜è®¤ä¸º 80 ç«¯å£ï¼Œæ•… è®¿é—®è¯¥åŸŸåæ—¶ä¼šè·³è½¬åˆ° 127.0.0.1:8080 è·¯å¾„ä¸Šã€‚åœ¨æµè§ˆå™¨ç«¯è¾“å…¥ www.123.com ä¼šçœ‹åˆ°tomcat index.jsp é¡µé¢ï¼š</li>
</ol>
<h2 id="åå‘ä»£ç†å®ä¾‹äºŒ">åå‘ä»£ç†å®ä¾‹äºŒ</h2>
<p>å®ç°æ•ˆæœï¼šä½¿ç”¨ nginx åå‘ä»£ç†ï¼Œæ ¹æ®è®¿é—®çš„è·¯å¾„è·³è½¬åˆ°ä¸åŒç«¯å£çš„æœåŠ¡ä¸­nginx ç›‘å¬ç«¯å£ä¸º 9001ï¼Œ</p>
<p>è®¿é—® http://127.0.0.1:9001/edu/ ç›´æ¥è·³è½¬åˆ° 127.0.0.1:8081</p>
<p>è®¿é—® http://127.0.0.1:9001/vod/ ç›´æ¥è·³è½¬åˆ° 127.0.0.1:8082</p>
<h3 id="å®ç°è¿‡ç¨‹-2">å®ç°è¿‡ç¨‹</h3>
<ol>
<li>
<p>å‡†å¤‡ä¸¤ä¸ª tomcatï¼Œä¸€ä¸ª 8001 ç«¯å£ï¼Œä¸€ä¸ª 8002 ç«¯å£ï¼Œå¹¶å‡†å¤‡å¥½æµ‹è¯•çš„é¡µé¢</p>
</li>
<li>
<p>ä¿®æ”¹ nginx çš„é…ç½®æ–‡ä»¶ ,åœ¨ http å—ä¸­æ·»åŠ  server{}</p>
</li>
</ol>
<pre><code class="language-json">server {
	listen 9001;
    server_name localhost;
    
    location ~ /edu/ {
    	proxy_pass http://localhost:8001;
	}
    location ~ /vod/ {
    	proxy_pass http://localhost:8002;
	}
}
</code></pre>
<ol start="3">
<li>è®¿é—®æµ‹è¯•</li>
</ol>
<h1 id="nginx-é…ç½®å®ä¾‹-è´Ÿè½½å‡è¡¡">nginx é…ç½®å®ä¾‹-è´Ÿè½½å‡è¡¡</h1>
<p>å®ç°æ•ˆæœ:</p>
<p>æµè§ˆå™¨åœ°å€æ è¾“å…¥åœ°å€ <code>http://192.168.17.129/edu/a.html</code>ï¼Œè´Ÿè½½å‡è¡¡æ•ˆæœ,å¹³å‡8080å’Œ 8081 ç«¯å£ä¸­</p>
<h2 id="å®ç°è¿‡ç¨‹-3">å®ç°è¿‡ç¨‹</h2>
<ol>
<li>
<p>å‡†å¤‡ä¸¤ä¸ªåŒæ—¶å¯åŠ¨çš„tomcat,ä¸€å°8080,ä¸€å°8081</p>
</li>
<li>
<p>åœ¨ä¸¤å° tomcaté‡Œé¢ webappsç›®å½•ä¸­ï¼Œåˆ›å»ºåç§° edu æ–‡ä»¶å¤¹ï¼Œåœ¨ edu æ–‡ä»¶å¤¹ä¸­åˆ›å»ºé¡µé¢ a.htmlï¼Œç”¨äºæµ‹è¯•</p>
</li>
<li>
<p>åœ¨nginxçš„é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œè´Ÿè½½å‡è¡¡çš„é…ç½®</p>
</li>
</ol>
<pre><code class="language-json">upstream myserver {
	server 192.168.17.129:8080;
	server 192.168.17.129:8081;
}
</code></pre>
<pre><code class="language-json">server {
	listen 80;
	server_name 192.168.17.129;
	
	location /{
		proxy_pass http://myserver;
		root html;
		index index.html index.htm;
	}
}
</code></pre>
<ol start="4">
<li>åœ°å€æ ä¸­è®¿é—®æµ‹è¯•<code>http://192.168.17.129/edu/a.html</code></li>
</ol>
<h2 id="nginxè´Ÿè½½å‡è¡¡-åˆ†é…ç­–ç•¥">nginxè´Ÿè½½å‡è¡¡ åˆ†é…ç­–ç•¥</h2>
<ol>
<li>è½®è¯¢ï¼ˆé»˜è®¤ï¼‰</li>
</ol>
<pre><code>æ¯ä¸ªè¯·æ±‚æŒ‰æ—¶é—´é¡ºåºé€ä¸€åˆ†é…åˆ°ä¸åŒçš„åç«¯æœåŠ¡å™¨ï¼Œå¦‚æœåç«¯æœåŠ¡å™¨ down æ‰ï¼Œèƒ½è‡ªåŠ¨å‰”é™¤ã€‚
</code></pre>
<ol start="2">
<li>weight</li>
</ol>
<pre><code class="language-json">weight ä»£è¡¨æƒ,é‡é»˜è®¤ä¸º 1,æƒé‡è¶Šé«˜è¢«åˆ†é…çš„å®¢æˆ·ç«¯è¶Šå¤š
æŒ‡å®šè½®è¯¢å‡ ç‡ï¼Œweight å’Œè®¿é—®æ¯”ç‡æˆæ­£æ¯”ï¼Œç”¨äºåç«¯æœåŠ¡å™¨æ€§èƒ½ä¸å‡çš„æƒ…å†µã€‚ä¾‹å¦‚:

upstream server_pool{ 
	server 192.168.5.21 weight=5; 
	server 192.168.5.22 weight=10; 
}

</code></pre>
<ol start="3">
<li>ip_hash</li>
</ol>
<pre><code class="language-json">æ¯ä¸ªè¯·æ±‚æŒ‰è®¿é—® ip çš„ hash ç»“æœåˆ†é…ï¼Œè¿™æ ·æ¯ä¸ªè®¿å®¢å›ºå®šè®¿é—®ä¸€ä¸ªåç«¯æœåŠ¡å™¨ï¼Œå¯ä»¥è§£å†³ session çš„é—®é¢˜ã€‚ ä¾‹å¦‚ï¼š

upstream server_pool{ 
	ip_hash; 
	server 192.168.5.21:80; 
	server 192.168.5.22:80; 
}
</code></pre>
<ol start="4">
<li>fair (ç¬¬ä¸‰æ–¹)</li>
</ol>
<pre><code class="language-json">æŒ‰åç«¯æœåŠ¡å™¨çš„å“åº”æ—¶é—´æ¥åˆ†é…è¯·æ±‚ï¼Œå“åº”æ—¶é—´çŸ­çš„ä¼˜å…ˆåˆ†é…ã€‚

upstream server_pool{ 
	server 192.168.5.21:80; 
	server 192.168.5.22:80; 
	fair; 
}
</code></pre>
<h1 id="nginx-é…ç½®å®ä¾‹-åŠ¨é™åˆ†ç¦»">nginx é…ç½®å®ä¾‹-åŠ¨é™åˆ†ç¦»</h1>
<p>Nginx åŠ¨é™åˆ†ç¦»ç®€å•æ¥è¯´å°±æ˜¯æŠŠåŠ¨æ€è·Ÿé™æ€è¯·æ±‚åˆ†å¼€ï¼Œä¸èƒ½ç†è§£æˆåªæ˜¯å•çº¯çš„æŠŠåŠ¨æ€é¡µé¢å’Œé™æ€é¡µé¢ç‰©ç†åˆ†ç¦»ã€‚ä¸¥æ ¼æ„ä¹‰ä¸Šè¯´åº”è¯¥æ˜¯åŠ¨æ€è¯·æ±‚è·Ÿé™æ€è¯·æ±‚åˆ†å¼€ï¼Œå¯ä»¥ç†è§£æˆä½¿ç”¨ Nginxå¤„ç†é™æ€é¡µé¢ï¼ŒTomcat å¤„ç†åŠ¨æ€é¡µé¢ã€‚åŠ¨é™åˆ†ç¦»ä»ç›®å‰å®ç°è§’åº¦æ¥è®²å¤§è‡´åˆ†ä¸ºä¸¤ç§ï¼Œ</p>
<p>â€‹	ä¸€ç§æ˜¯çº¯ç²¹æŠŠé™æ€æ–‡ä»¶ç‹¬ç«‹æˆå•ç‹¬çš„åŸŸåï¼Œæ”¾åœ¨ç‹¬ç«‹çš„æœåŠ¡å™¨ä¸Šï¼Œä¹Ÿæ˜¯ç›®å‰ä¸»æµæ¨å´‡çš„æ–¹æ¡ˆï¼›</p>
<p>â€‹	å¦å¤–ä¸€ç§æ–¹æ³•å°±æ˜¯åŠ¨æ€è·Ÿé™æ€æ–‡ä»¶æ··åˆåœ¨ä¸€èµ·å‘å¸ƒï¼Œé€šè¿‡ nginx æ¥åˆ†å¼€ã€‚é€šè¿‡ location æŒ‡å®šä¸åŒçš„åç¼€åå®ç°ä¸åŒçš„è¯·æ±‚è½¬å‘ã€‚é€šè¿‡ expires å‚æ•°è®¾ç½®ï¼Œå¯ä»¥ä½¿æµè§ˆå™¨ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼Œå‡å°‘ä¸æœåŠ¡å™¨ä¹‹å‰çš„è¯·æ±‚å’Œæµé‡ã€‚å…·ä½“ Expires å®šä¹‰ï¼šæ˜¯ç»™ä¸€ä¸ªèµ„æºè®¾å®šä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œä¹Ÿå°±æ˜¯è¯´æ— éœ€å»æœåŠ¡ç«¯éªŒè¯ï¼Œç›´æ¥é€šè¿‡æµè§ˆå™¨è‡ªèº«ç¡®è®¤æ˜¯å¦è¿‡æœŸå³å¯ï¼Œæ‰€ä»¥ä¸ä¼šäº§ç”Ÿé¢å¤–çš„æµé‡ã€‚æ­¤ç§æ–¹æ³•éå¸¸é€‚åˆä¸ç»å¸¸å˜åŠ¨çš„èµ„æºã€‚ï¼ˆå¦‚æœç»å¸¸æ›´æ–°çš„æ–‡ä»¶ï¼Œä¸å»ºè®®ä½¿ç”¨Expires æ¥ç¼“å­˜ï¼‰ï¼Œæˆ‘è¿™é‡Œè®¾ç½® 3dï¼Œè¡¨ç¤ºåœ¨è¿™ 3 å¤©ä¹‹å†…è®¿é—®è¿™ä¸ª URLï¼Œå‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œæ¯”å¯¹æœåŠ¡å™¨è¯¥æ–‡ä»¶æœ€åæ›´æ–°æ—¶é—´æ²¡æœ‰å˜åŒ–ï¼Œåˆ™ä¸ä¼šä»æœåŠ¡å™¨æŠ“å–ï¼Œè¿”å›çŠ¶æ€ç 304ï¼Œå¦‚æœæœ‰ä¿®æ”¹ï¼Œåˆ™ç›´æ¥ä»æœåŠ¡å™¨é‡æ–°ä¸‹è½½ï¼Œè¿”å›çŠ¶æ€ç  200ã€‚</p>
<h2 id="å®ç°è¿‡ç¨‹-4">å®ç°è¿‡ç¨‹</h2>
<ol>
<li>ç°åœ¨ç³»ç»Ÿä¸­å‡†å¤‡é™æ€èµ„æº,ç”¨äºè®¿é—®</li>
</ol>
<pre><code>åœ¨linux è·Ÿç›®å½•ä¸­åˆ›å»ºimageå’Œwwwæ–‡ä»¶å¤¹,å¹¶ç»™æ–‡ä»¶å¤¹ä¸‹æ”¾å…¥é™æ€èµ„æº
</code></pre>
<ol start="2">
<li>å…·ä½“é…ç½®</li>
</ol>
<pre><code class="language-json">server {
    listen 80;
    server_name 192.168.17.129;
    
    location /www/ {
    	root /data/;
    	index index.html index.htm;
	}
	location /image/ {
        root /data/;
        autoindex on;
    }
}
</code></pre>
<ol start="3">
<li>æµè§ˆå™¨ä¸­è¾“å…¥åœ°å€<code>http://192.168.17.129/image/01.jpg</code>,<code>http://192.168.17.129/www/a.html</code></li>
</ol>
<p><strong>ç‰¹åˆ«æ³¨æ„</strong>: å› ä¸ºé…ç½®æ–‡ä»¶ä¸­é…ç½®äº† autoindex on;æ‰€ä»¥åœ¨æµè§ˆå™¨ä¸­è®¿é—®<code>http://192.168.17.129/image/</code>ç»“æœå¦‚ä¸‹:</p>
<figure data-type="image" tabindex="2"><img src="https://i.loli.net/2020/04/19/ig8TzoqZWMU4Fhu.png" alt="image.png" loading="lazy"></figure>
<h1 id="nginx-å¤„ç†è·¨åŸŸè¯·æ±‚">nginx å¤„ç†è·¨åŸŸè¯·æ±‚</h1>
<p>å½“å‡ºç°403è·¨åŸŸé”™è¯¯çš„æ—¶å€™ <code>No 'Access-Control-Allow-Origin' header is present on the requested resource</code>ï¼Œéœ€è¦ç»™NginxæœåŠ¡å™¨é…ç½®å“åº”çš„headerå‚æ•°ï¼š</p>
<h2 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</h2>
<pre><code class="language-json">location / {  
    add_header Access-Control-Allow-Origin *;
    add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
    add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';

    if ($request_method = 'OPTIONS') {
        return 204;
    }
} 
</code></pre>
<h2 id="è§£é‡Š">è§£é‡Š</h2>
<h4 id="1-access-control-allow-origin">1. <strong>Access-Control-Allow-Origin</strong></h4>
<pre><code>æœåŠ¡å™¨é»˜è®¤æ˜¯ä¸è¢«å…è®¸è·¨åŸŸçš„ã€‚ç»™NginxæœåŠ¡å™¨é…ç½®`Access-Control-Allow-Origin *`åï¼Œè¡¨ç¤ºæœåŠ¡å™¨å¯ä»¥æ¥å—æ‰€æœ‰çš„è¯·æ±‚æºï¼ˆOriginï¼‰,å³æ¥å—æ‰€æœ‰è·¨åŸŸçš„è¯·æ±‚ã€‚
</code></pre>
<h4 id="2-access-control-allow-headers-æ˜¯ä¸ºäº†é˜²æ­¢å‡ºç°ä»¥ä¸‹é”™è¯¯">2. <strong>Access-Control-Allow-Headers</strong> æ˜¯ä¸ºäº†é˜²æ­¢å‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š</h4>
<pre><code>Request header field Content-Type is not allowed by Access-Control-Allow-Headers in preflight response.
</code></pre>
<p>è¿™ä¸ªé”™è¯¯è¡¨ç¤ºå½“å‰è¯·æ±‚Content-Typeçš„å€¼ä¸è¢«æ”¯æŒã€‚å…¶å®æ˜¯æˆ‘ä»¬å‘èµ·äº†&quot;application/json&quot;çš„ç±»å‹è¯·æ±‚å¯¼è‡´çš„ã€‚è¿™é‡Œæ¶‰åŠåˆ°ä¸€ä¸ªæ¦‚å¿µï¼š<code>é¢„æ£€è¯·æ±‚ï¼ˆpreflight requestï¼‰</code>,è¯·çœ‹ä¸‹é¢&quot;é¢„æ£€è¯·æ±‚&quot;çš„ä»‹ç»ã€‚</p>
<h4 id="3-access-control-allow-methods-æ˜¯ä¸ºäº†é˜²æ­¢å‡ºç°ä»¥ä¸‹é”™è¯¯">3. <strong>Access-Control-Allow-Methods</strong> æ˜¯ä¸ºäº†é˜²æ­¢å‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š</h4>
<pre><code>Content-Type is not allowed by Access-Control-Allow-Headers in preflight response.
</code></pre>
<h4 id="4ç»™options-æ·»åŠ -204çš„è¿”å›æ˜¯ä¸ºäº†å¤„ç†åœ¨å‘é€postè¯·æ±‚æ—¶nginxä¾ç„¶æ‹’ç»è®¿é—®çš„é”™è¯¯">4.ç»™<code>OPTIONS</code> æ·»åŠ  <code>204</code>çš„è¿”å›ï¼Œæ˜¯ä¸ºäº†å¤„ç†åœ¨å‘é€POSTè¯·æ±‚æ—¶Nginxä¾ç„¶æ‹’ç»è®¿é—®çš„é”™è¯¯</h4>
<p>å‘é€&quot;é¢„æ£€è¯·æ±‚&quot;æ—¶ï¼Œéœ€è¦ç”¨åˆ°æ–¹æ³• <code>OPTIONS</code> ,æ‰€ä»¥æœåŠ¡å™¨éœ€è¦å…è®¸è¯¥æ–¹æ³•ã€‚</p>
<h2 id="é¢„æ£€è¯·æ±‚preflight-request">é¢„æ£€è¯·æ±‚ï¼ˆpreflight requestï¼‰</h2>
<p>å…¶å®ä¸Šé¢çš„é…ç½®æ¶‰åŠåˆ°äº†ä¸€ä¸ªW3Cæ ‡å‡†ï¼š<code>CROS</code>,å…¨ç§°æ˜¯è·¨åŸŸèµ„æºå…±äº« (Cross-origin resource sharing)ï¼Œå®ƒçš„æå‡ºå°±æ˜¯ä¸ºäº†è§£å†³è·¨åŸŸè¯·æ±‚çš„ã€‚</p>
<blockquote>
<p>è·¨åŸŸèµ„æºå…±äº«(CORS)æ ‡å‡†æ–°å¢äº†ä¸€ç»„ HTTP é¦–éƒ¨å­—æ®µï¼Œå…è®¸æœåŠ¡å™¨å£°æ˜å“ªäº›æºç«™æœ‰æƒé™è®¿é—®å“ªäº›èµ„æºã€‚å¦å¤–ï¼Œè§„èŒƒè¦æ±‚ï¼Œ<code>å¯¹é‚£äº›å¯èƒ½å¯¹æœåŠ¡å™¨æ•°æ®äº§ç”Ÿå‰¯ä½œç”¨çš„HTTP è¯·æ±‚æ–¹æ³•ï¼ˆç‰¹åˆ«æ˜¯ GET ä»¥å¤–çš„ HTTP è¯·æ±‚ï¼Œæˆ–è€…æ­é…æŸäº› MIME ç±»å‹çš„ POST è¯·æ±‚ï¼‰</code>ï¼Œæµè§ˆå™¨å¿…é¡»é¦–å…ˆä½¿ç”¨ OPTIONS æ–¹æ³•å‘èµ·ä¸€ä¸ªé¢„æ£€è¯·æ±‚ï¼ˆpreflight requestï¼‰ï¼Œä»è€Œè·çŸ¥æœåŠ¡ç«¯æ˜¯å¦å…è®¸è¯¥è·¨åŸŸè¯·æ±‚ã€‚æœåŠ¡å™¨ç¡®è®¤å…è®¸ä¹‹åï¼Œæ‰å‘èµ·å®é™…çš„ HTTP è¯·æ±‚ã€‚åœ¨é¢„æ£€è¯·æ±‚çš„è¿”å›ä¸­ï¼ŒæœåŠ¡å™¨ç«¯ä¹Ÿå¯ä»¥é€šçŸ¥å®¢æˆ·ç«¯ï¼Œæ˜¯å¦éœ€è¦æºå¸¦èº«ä»½å‡­è¯ï¼ˆåŒ…æ‹¬ Cookies å’Œ HTTP è®¤è¯ç›¸å…³æ•°æ®ï¼‰ã€‚</p>
</blockquote>
<p>é‚£ä¹ˆ, å…è®¸è·¨åŸŸ, ä¸å°±æ˜¯æœåŠ¡ç«¯(ä¾‹å¦‚Nginxæˆ–è€…åç«¯ä»£ç )è®¾ç½®<code>Access-Control-Allow-Origin: *</code>å°±å¯ä»¥äº†å—?</p>
<p>æ™®é€šçš„è¯·æ±‚ç¡®å®æ˜¯è¿™æ ·å­çš„, é™¤æ­¤ä¹‹å¤–, è¿˜ä¸€ç§å«è¯·æ±‚å«Preflighted Requestï¼ˆå¸¦é¢„æ£€çš„è·¨åŸŸè¯·æ±‚ï¼‰</p>
<p>Preflighted Requeståœ¨å‘é€çœŸæ­£çš„è¯·æ±‚å‰, ä¼šå…ˆå‘é€ä¸€ä¸ªæ–¹æ³•ä¸ºOPTIONSçš„é¢„è¯·æ±‚(Preflighted Request), ç”¨äºè¯•æ¢æœåŠ¡ç«¯æ˜¯å¦èƒ½æ¥å—çœŸæ­£çš„è¯·æ±‚.</p>
<p>å¦‚æœoptionsè·å¾—çš„å›åº”æ˜¯æ‹’ç»æ€§è´¨çš„ï¼Œæ¯”å¦‚404\403\500ç­‰httpçŠ¶æ€ï¼Œå°±ä¼šåœæ­¢postã€getç­‰è¯·æ±‚çš„å‘å‡ºã€‚</p>
<p>é‚£ä¹ˆ, ä»€ä¹ˆæƒ…å†µä¸‹è¯·æ±‚ä¼šå˜æˆPreflighted Requestå‘¢? ç¿»çœ‹äº†MDNçš„æ–‡æ¡£å‘ç°å¦‚ä¸‹ï¼š(æ–‡æ¡£åœ°å€ï¼šhttps://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS#The_HTTP_request_headers)</p>
<ol>
<li>è¯·æ±‚æ–¹æ³•ä¸æ˜¯GET/HEAD/POST</li>
<li>POSTè¯·æ±‚çš„<code>Content-Type</code>å¹¶é<code>application/x-www-form-urlencoded</code>, <code>multipart/form-data</code>, æˆ–<code>text/plain</code></li>
<li>è¯·æ±‚è®¾ç½®äº†è‡ªå®šä¹‰çš„<code>header</code>å­—æ®µ</li>
</ol>
<p>ä¸¾ä¸ªä¾‹å­, å¦‚æœPOSTè¯·æ±‚è¦ä¼ è¾“çš„æ•°æ®ä¸º XMLæ–‡æ¡£, <code>Content-Type</code>ä¸º<code>application/xml</code>æˆ–<code>text/xml</code>, åˆ™å‘é€è¿™ä¸ªè¯·æ±‚å‰ä¼šå‘é€ä¸€ä¸ªé¢„è¯·æ±‚ï¼Œæˆ–è€…è‡ªå®šä¹‰çš„headerå­—æ®µä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ã€‚</p>
<p>æœ‰äº†ä¸Šé¢çš„çŸ¥è¯†ç‚¹, å†å»çœ‹é¡¹ç›®ä¸­ajaxè°ƒç”¨</p>
<figure data-type="image" tabindex="3"><img src="https://i.loli.net/2020/04/20/hyRJi2OaCktSAEB.png" alt="image.png" loading="lazy"></figure>
<p>å¯ä»¥çœ‹å‡º, è·¨åŸŸè¯·æ±‚ä¸­è®¾ç½®äº†è‡ªå®šä¹‰çš„<code>header</code>å­—æ®µ, æ‰€ä»¥è¯¥è¯·æ±‚æ˜¯<code>preflighted request</code>, åˆ™è¯·æ±‚å‰ä¸€å®šä¼šå‘é€ä¸€ä¸ªOPTIONSä½œä¸ºé¢„è¯·æ±‚.</p>
<p>æ‰€ä»¥è¯´, åœ¨é¡¹ç›®ä¸­ajaxå¯¹åå°APIçš„è°ƒç”¨, OPTIONSè¯·æ±‚æ˜¯æ²¡åŠæ³•å»æ‰çš„, é™¤éåå°æ¥å£ä¸å†éœ€è¦åœ¨è¯·æ±‚<code>header</code>ä¸­è®¾ç½®<code>openId</code>ä½†æ˜¯ç”±äºè¯¥é¡¹ç›®ä¸­ç”¨æˆ·ä¿¡æ¯æ˜¯é‡‡ç”¨çš„JWTçš„æ–¹å¼ï¼Œæ‰€ä»¥åªå¥½ä½œç½¢ã€‚</p>
<p>ä½†æ˜¯ç”±äºè¯¥é¡¹ç›®åœ¨åå°ä¸­è‡ªå®šä¹‰äº†è¯·æ±‚é¢‘ç‡é™åˆ¶çš„æ‹¦æˆªå™¨ï¼Œä¾‹å¦‚é™åˆ¶åŒä¸€ä¸ªå®¢æˆ·ç«¯ä¸€ç§’å†…å¯¹æŸä¸€ä¸ªæ¥å£åªèƒ½è®¿é—®1æ¬¡ã€‚å¦‚æœè¶…è¿‡é™åˆ¶ï¼Œåˆ™ç¬¬äºŒæ¬¡ä¼šè¿”å›çŠ¶æ€ç 500ï¼Œä¸äºˆå¤„ç†ã€‚å¦‚æœæ¯æ¬¡è¯·æ±‚å‰éƒ½å¸¦ç€ä¸€æ¬¡OPTIONSè¯·æ±‚ï¼Œåˆ™è¯¥æ‹¦æˆªå™¨æ— æ³•æ­£å¸¸å®ç°åŠŸèƒ½ï¼Œåæ­£ä¼šå¯¼è‡´å¤§æ‰¹æ¥å£è°ƒç”¨å¤±è´¥çš„æƒ…å†µã€‚</p>
<p>é‰´äºä¸Šè¿°åˆ†æï¼Œæ—¢ç„¶å‰ç«¯å‘èµ·è¯·æ±‚æ—¶OPTIONSè¯·æ±‚æ²¡æœ‰åŠæ³•å»é™¤ï¼Œé‚£ä¹ˆæ˜¯å¦å¯ä»¥è€ƒè™‘ä»åå°æ‹¦æˆªå™¨è¿›è¡Œæ”¹é€ ã€‚</p>
<p>æ”¹é€ åçš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure data-type="image" tabindex="4"><img src="https://i.loli.net/2020/04/20/9623BrEtSPhFRfL.png" alt="image.png" loading="lazy"></figure>
<p>å¦‚æœæ‹¦æˆªåˆ°çš„è¯·æ±‚ä¸æ˜¯é¡¹ç›®ä¸­å¸¸è§„çš„GETæˆ–è€…POSTè¯·æ±‚ï¼Œåˆ™è¯¥æ‹¦æˆªå™¨ç›´æ¥æ”¾è¡Œã€‚è‡³æ­¤ï¼Œé—®é¢˜å®Œç¾è§£å†³ã€‚</p>
<h1 id="nginx-åŸç†">nginx åŸç†</h1>
<figure data-type="image" tabindex="5"><img src="https://i.loli.net/2020/04/19/oBvuNLaUpHGICMX.png" alt="image.png" loading="lazy"></figure>
<figure data-type="image" tabindex="6"><img src="https://i.loli.net/2020/04/19/6oJX1jz9IWbD37Z.png" alt="1587305293_1_.jpg" loading="lazy"></figure>
<h2 id="master-workers-çš„æœºåˆ¶çš„å¥½å¤„">master-workers çš„æœºåˆ¶çš„å¥½å¤„</h2>
<p>é¦–å…ˆï¼Œå¯¹äºæ¯ä¸ª worker è¿›ç¨‹æ¥è¯´ï¼Œç‹¬ç«‹çš„è¿›ç¨‹ï¼Œä¸éœ€è¦åŠ é”ï¼Œæ‰€ä»¥çœæ‰äº†é”å¸¦æ¥çš„å¼€é”€ï¼Œ</p>
<p>åŒæ—¶åœ¨ç¼–ç¨‹ä»¥åŠé—®é¢˜æŸ¥æ‰¾æ—¶ï¼Œä¹Ÿä¼šæ–¹ä¾¿å¾ˆå¤šã€‚å…¶æ¬¡ï¼Œé‡‡ç”¨ç‹¬ç«‹çš„è¿›ç¨‹ï¼Œå¯ä»¥è®©äº’ç›¸ä¹‹é—´ä¸ä¼š</p>
<p>å½±å“ï¼Œä¸€ä¸ªè¿›ç¨‹é€€å‡ºåï¼Œå…¶å®ƒè¿›ç¨‹è¿˜åœ¨å·¥ä½œï¼ŒæœåŠ¡ä¸ä¼šä¸­æ–­ï¼Œmaster è¿›ç¨‹åˆ™å¾ˆå¿«å¯åŠ¨æ–°çš„</p>
<p>worker è¿›ç¨‹ã€‚å½“ç„¶ï¼Œworker è¿›ç¨‹çš„å¼‚å¸¸é€€å‡ºï¼Œè‚¯å®šæ˜¯ç¨‹åºæœ‰ bug äº†ï¼Œå¼‚å¸¸é€€å‡ºï¼Œä¼šå¯¼è‡´å½“</p>
<p>å‰ worker ä¸Šçš„æ‰€æœ‰è¯·æ±‚å¤±è´¥ï¼Œä¸è¿‡ä¸ä¼šå½±å“åˆ°æ‰€æœ‰è¯·æ±‚ï¼Œæ‰€ä»¥é™ä½äº†é£é™©ã€‚</p>
<h2 id="éœ€è¦è®¾ç½®å¤šå°‘ä¸ªworker">éœ€è¦è®¾ç½®å¤šå°‘ä¸ªworker</h2>
<p>Nginx åŒ redis ç±»ä¼¼éƒ½é‡‡ç”¨äº† io å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œæ¯ä¸ª worker éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹ï¼Œä½†æ¯ä¸ªè¿›ç¨‹é‡Œåªæœ‰ä¸€ä¸ªä¸»çº¿ç¨‹ï¼Œé€šè¿‡å¼‚æ­¥éé˜»å¡çš„æ–¹å¼æ¥å¤„ç†è¯·æ±‚ï¼Œ å³ä½¿æ˜¯åƒä¸Šä¸‡ä¸ªè¯·æ±‚ä¹Ÿä¸åœ¨è¯ä¸‹ã€‚æ¯ä¸ª worker çš„çº¿ç¨‹å¯ä»¥æŠŠä¸€ä¸ª cpu çš„æ€§èƒ½å‘æŒ¥åˆ°æè‡´ã€‚æ‰€ä»¥ worker æ•°å’ŒæœåŠ¡å™¨çš„cpuæ•°ç›¸ç­‰æ˜¯æœ€ä¸ºé€‚å®œçš„ã€‚è®¾å°‘äº†ä¼šæµªè´¹ cpuï¼Œè®¾å¤šäº†ä¼šé€ æˆ cpu é¢‘ç¹åˆ‡æ¢ä¸Šä¸‹æ–‡å¸¦æ¥çš„æŸè€—ã€‚</p>
<p><strong>è®¾ç½® worker æ•°é‡</strong></p>
<p>worker_processes 4</p>
<p>#work ç»‘å®š cpu(4 work ç»‘å®š 4cpu)ã€‚</p>
<p>worker_cpu_affinity 0001 0010 0100 1000</p>
<p>#work ç»‘å®š cpu (4 work ç»‘å®š 8cpu ä¸­çš„ 4 ä¸ª) ã€‚</p>
<p>worker_cpu_affinity 0000001 00000010 00000100 00001000</p>
<p><strong>è¿æ¥æ•°</strong> <strong>worker_connection</strong></p>
<p>è¿™ä¸ªå€¼æ˜¯è¡¨ç¤ºæ¯ä¸ª worker è¿›ç¨‹æ‰€èƒ½å»ºç«‹è¿æ¥çš„æœ€å¤§å€¼ï¼Œæ‰€ä»¥ï¼Œä¸€ä¸ª nginx èƒ½å»ºç«‹çš„æœ€å¤§è¿æ¥æ•°ï¼Œåº”è¯¥æ˜¯</p>
<p><code>worker_connections * worker_processes</code></p>
<p>å½“ç„¶ï¼Œè¿™é‡Œè¯´çš„æ˜¯æœ€å¤§è¿æ¥æ•°ï¼Œå¯¹äºHTTP è¯· æ±‚ æœ¬ åœ° èµ„ æº æ¥ è¯´ ï¼Œ èƒ½ å¤Ÿ æ”¯ æŒ çš„ æœ€ å¤§ å¹¶ å‘ æ•° é‡ æ˜¯</p>
<p><code>worker_connections * worker_processes</code></p>
<p>å¦‚æœæ˜¯æ”¯æŒ http1.1 çš„æµè§ˆå™¨æ¯æ¬¡è®¿é—®è¦å ä¸¤ä¸ªè¿æ¥ï¼Œæ‰€ä»¥æ™®é€šçš„é™æ€è®¿é—®æœ€å¤§å¹¶å‘æ•°æ˜¯ï¼š <code>worker_connections * worker_processes /2</code></p>
<p>è€Œå¦‚æœæ˜¯ HTTP ä½œ ä¸ºåå‘ä»£ç†æ¥è¯´ï¼Œæœ€å¤§å¹¶å‘æ•°é‡åº”è¯¥æ˜¯</p>
<p><code>worker_connections * worker_processes/4</code></p>
<p>å› ä¸ºä½œä¸ºåå‘ä»£ç†æœåŠ¡å™¨ï¼Œæ¯ä¸ªå¹¶å‘ä¼šå»ºç«‹ä¸å®¢æˆ·ç«¯çš„è¿æ¥å’Œä¸åç«¯æœåŠ¡çš„è¿æ¥ï¼Œä¼šå ç”¨ä¸¤ä¸ªè¿æ¥ã€‚</p>
<figure data-type="image" tabindex="7"><img src="https://i.loli.net/2020/04/19/LcyKewbUuTN2kF4.png" alt="image.png" loading="lazy"></figure>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[SpringBoot  é›†æˆredis]]></title>
        <id>http://blog.ludangxin.club/post/springboot-ji-cheng-redis/</id>
        <link href="http://blog.ludangxin.club/post/springboot-ji-cheng-redis/">
        </link>
        <updated>2020-05-16T15:51:29.000Z</updated>
        <content type="html"><![CDATA[<h1 id="ç®€ä»‹">ç®€ä»‹</h1>
<p>Redis æ˜¯å®Œå…¨å¼€æºå…è´¹çš„ï¼Œéµå®ˆBSDåè®®ï¼Œæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„key-valueéå…³ç³»æ€§æ•°æ®åº“(NoSql)ã€‚<br>
Redis ä¸å…¶ä»– key - value ç¼“å­˜äº§å“æœ‰ä»¥ä¸‹ä¸‰ä¸ªç‰¹ç‚¹ï¼š</p>
<ol>
<li>Redisæ”¯æŒæ•°æ®çš„æŒä¹…åŒ–ï¼Œå¯ä»¥å°†å†…å­˜ä¸­çš„æ•°æ®ä¿å­˜åœ¨ç£ç›˜ä¸­ï¼Œé‡å¯çš„æ—¶å€™å¯ä»¥å†æ¬¡åŠ è½½è¿›è¡Œä½¿ç”¨ã€‚</li>
<li>Redisä¸ä»…ä»…æ”¯æŒç®€å•çš„key-valueç±»å‹çš„æ•°æ®ï¼ŒåŒæ—¶è¿˜æä¾›listï¼Œsetï¼Œzsetï¼Œhashç­‰æ•°æ®ç»“æ„çš„å­˜å‚¨ã€‚</li>
<li>Redisæ”¯æŒæ•°æ®çš„å¤‡ä»½ï¼Œå³master-slaveæ¨¡å¼çš„æ•°æ®å¤‡ä»½ã€‚</li>
</ol>
<h2 id="æ•°æ®ç»“æ„ä»‹ç»">æ•°æ®ç»“æ„ä»‹ç»</h2>
<p>Rediså¯ä»¥å­˜å‚¨é”®ä¸5ç§ä¸åŒæ•°æ®ç»“æ„ç±»å‹ä¹‹é—´çš„æ˜ å°„ï¼Œè¿™5ç§æ•°æ®ç»“æ„ç±»å‹åˆ†åˆ«ä¸ºStringï¼ˆå­—ç¬¦ä¸²ï¼‰ã€Listï¼ˆåˆ—è¡¨ï¼‰ã€Setï¼ˆé›†åˆï¼‰ã€Hashï¼ˆæ•£åˆ—ï¼‰å’Œ Zsetï¼ˆæœ‰åºé›†åˆï¼‰ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:center">ç»“æ„ç±»å‹</th>
<th style="text-align:center">ç»“æ„å­˜å‚¨çš„å€¼</th>
<th style="text-align:center">è¯»å†™èƒ½åŠ›</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">String</td>
<td style="text-align:center">å¯ä»¥æ˜¯å­—ç¬¦ä¸²ã€æ•´æ•°æˆ–è€…æµ®ç‚¹æ•°</td>
<td style="text-align:center">å¯¹æ•´ä¸ªå­—ç¬¦ä¸²æˆ–è€…å­—ç¬¦ä¸²çš„å…¶ä¸­ä¸€éƒ¨åˆ†æ‰§è¡Œæ“ä½œï¼›å¯¹è±¡å’Œæµ®ç‚¹æ•°æ‰§è¡Œè‡ªå¢(increment)æˆ–è€…è‡ªå‡(decrement)</td>
</tr>
<tr>
<td style="text-align:center">List</td>
<td style="text-align:center">ä¸€ä¸ªé“¾è¡¨ï¼Œé“¾è¡¨ä¸Šçš„æ¯ä¸ªèŠ‚ç‚¹éƒ½åŒ…å«äº†ä¸€ä¸ªå­—ç¬¦ä¸²</td>
<td style="text-align:center">ä»é“¾è¡¨çš„ä¸¤ç«¯æ¨å…¥æˆ–è€…å¼¹å‡ºå…ƒç´ ï¼›æ ¹æ®åç§»é‡å¯¹é“¾è¡¨è¿›è¡Œä¿®å‰ª(trim)ï¼›è¯»å–å•ä¸ªæˆ–è€…å¤šä¸ªå…ƒç´ ï¼›æ ¹æ®å€¼æ¥æŸ¥æ‰¾æˆ–è€…ç§»é™¤å…ƒç´ </td>
</tr>
<tr>
<td style="text-align:center">Set</td>
<td style="text-align:center">åŒ…å«å­—ç¬¦ä¸²çš„æ— åºæ”¶é›†å™¨(unorderedcollection)ï¼Œå¹¶ä¸”è¢«åŒ…å«çš„æ¯ä¸ªå­—ç¬¦ä¸²éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„ã€å„ä¸ç›¸åŒ</td>
<td style="text-align:center">æ·»åŠ ã€è·å–ã€ç§»é™¤å•ä¸ªå…ƒç´ ï¼›æ£€æŸ¥ä¸€ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨äºæŸä¸ªé›†åˆä¸­ï¼›è®¡ç®—äº¤é›†ã€å¹¶é›†ã€å·®é›†ï¼›ä»é›†åˆé‡Œå–å¼„éšæœºè·å–å…ƒç´ </td>
</tr>
<tr>
<td style="text-align:center">Hash</td>
<td style="text-align:center">åŒ…å«é”®å€¼å¯¹çš„æ— åºæ•£åˆ—è¡¨</td>
<td style="text-align:center">æ·»åŠ ã€è·å–ã€ç§»é™¤å•ä¸ªé”®å€¼å¯¹ï¼›è·å–æ‰€æœ‰é”®å€¼å¯¹</td>
</tr>
<tr>
<td style="text-align:center">Zset</td>
<td style="text-align:center">å­—ç¬¦ä¸²æˆå‘˜(member)ä¸æµ®ç‚¹æ•°åˆ†å€¼(score)ä¹‹é—´çš„æœ‰åºæ˜ å°„ï¼Œå…ƒç´ çš„æ’åˆ—é¡ºåºç”±åˆ†å€¼çš„å¤§å°å†³å®š</td>
<td style="text-align:center">æ·»åŠ ã€è·å–ã€åˆ é™¤å•ä¸ªå…ƒç´ ï¼›æ ¹æ®åˆ†å€¼èŒƒå›´(range)æˆ–è€…æˆå‘˜æ¥è·å–å…ƒç´ </td>
</tr>
</tbody>
</table>
<h2 id="redis-ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«">redis ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«</h2>
<ol>
<li>å®Œå…¨<strong>åŸºäºå†…å­˜</strong>ï¼Œç»å¤§éƒ¨åˆ†è¯·æ±‚æ˜¯çº¯ç²¹çš„å†…å­˜æ“ä½œï¼Œéå¸¸å¿«é€Ÿã€‚æ•°æ®å­˜åœ¨å†…å­˜ä¸­ï¼Œç±»ä¼¼äºHashMapï¼ŒHashMapçš„ä¼˜åŠ¿å°±æ˜¯æŸ¥æ‰¾å’Œæ“ä½œçš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯O(1)ï¼›</li>
<li><strong>æ•°æ®ç»“æ„ç®€å•</strong>ï¼Œå¯¹æ•°æ®æ“ä½œä¹Ÿç®€å•ï¼ŒRedisä¸­çš„æ•°æ®ç»“æ„æ˜¯ä¸“é—¨è¿›è¡Œè®¾è®¡çš„ï¼›</li>
<li><strong>é‡‡ç”¨å•è¿›ç¨‹å•çº¿ç¨‹</strong>(è¿™ä¹Ÿè§£é‡Šä¸ºä»€ä¹ˆrediså¯ä»¥å¤„ç†é«˜å¹¶å‘é—®é¢˜)ï¼Œé¿å…äº†ä¸å¿…è¦çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œç«äº‰æ¡ä»¶ï¼Œä¹Ÿä¸å­˜åœ¨å¤šè¿›ç¨‹æˆ–è€…å¤šçº¿ç¨‹å¯¼è‡´çš„åˆ‡æ¢è€Œæ¶ˆè€— CPUï¼Œä¸ç”¨å»è€ƒè™‘å„ç§é”çš„é—®é¢˜ï¼Œä¸å­˜åœ¨åŠ é”é‡Šæ”¾é”æ“ä½œï¼Œæ²¡æœ‰å› ä¸ºå¯èƒ½å‡ºç°æ­»é”è€Œå¯¼è‡´çš„æ€§èƒ½æ¶ˆè€—ï¼›</li>
<li>ä½¿ç”¨<strong>å¤šè·¯I/Oå¤ç”¨æ¨¡å‹</strong>(æœ€åæœ‰ä»‹ç»)ï¼›</li>
<li>ä½¿ç”¨åº•å±‚æ¨¡å‹ä¸åŒï¼Œå®ƒä»¬ä¹‹é—´åº•å±‚å®ç°æ–¹å¼ä»¥åŠä¸å®¢æˆ·ç«¯ä¹‹é—´é€šä¿¡çš„åº”ç”¨åè®®ä¸ä¸€æ ·ï¼ŒRedisç›´æ¥è‡ªå·±æ„å»ºäº†VM æœºåˆ¶ ï¼Œå› ä¸ºä¸€èˆ¬çš„ç³»ç»Ÿè°ƒç”¨ç³»ç»Ÿå‡½æ•°çš„è¯ï¼Œä¼šæµªè´¹ä¸€å®šçš„æ—¶é—´å»ç§»åŠ¨å’Œè¯·æ±‚ï¼›</li>
</ol>
<h1 id="æ³¨è§£ä»‹ç»">æ³¨è§£ä»‹ç»</h1>
<h2 id="cacheable">@Cacheable</h2>
<p>@Cacheable(value=&quot;myCache&quot;)ï¼Œè¿™ä¸ªæ³¨é‡Šçš„æ„æ€æ˜¯ï¼Œå½“è°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œä¼šä»ä¸€ä¸ªåå«myCache çš„ç¼“å­˜ä¸­æŸ¥è¯¢ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™æ‰§è¡Œå®é™…çš„æ–¹æ³•ï¼ˆå³æŸ¥è¯¢æ•°æ®åº“ï¼‰ï¼Œå¹¶å°†æ‰§è¡Œçš„ç»“æœå­˜å…¥ç¼“å­˜ä¸­ï¼Œå¦åˆ™è¿”å›ç¼“å­˜ä¸­çš„å¯¹è±¡ã€‚</p>
<h2 id="cacheput">@CachePut</h2>
<p>@CachePut çš„ä½œç”¨ ä¸»è¦é’ˆå¯¹æ–¹æ³•é…ç½®ï¼Œèƒ½å¤Ÿæ ¹æ®æ–¹æ³•çš„è¯·æ±‚å‚æ•°å¯¹å…¶<strong>ç»“æœ</strong>è¿›è¡Œç¼“å­˜ï¼Œå’Œ @Cacheable ä¸åŒçš„æ˜¯ï¼Œå®ƒæ¯æ¬¡éƒ½ä¼šè§¦å‘çœŸå®æ–¹æ³•çš„è°ƒç”¨.</p>
<h2 id="cacheevict">@CacheEvict</h2>
<p>@CachEvict çš„ä½œç”¨ ä¸»è¦é’ˆå¯¹æ–¹æ³•é…ç½®ï¼Œèƒ½å¤Ÿæ ¹æ®ä¸€å®šçš„æ¡ä»¶å¯¹ç¼“å­˜è¿›è¡Œæ¸…ç©º</p>
<h2 id="cacheconfig">@CacheConfig</h2>
<p>@Cacheable()é‡Œé¢éƒ½æœ‰ä¸€ä¸ªvalueï¼â€œxxxâ€çš„å±æ€§ï¼Œè¿™æ˜¾ç„¶å¦‚æœæ–¹æ³•å¤šäº†ï¼Œå†™èµ·æ¥ä¹Ÿæ˜¯æŒºç´¯çš„ï¼Œå¦‚æœå¯ä»¥ä¸€æ¬¡æ€§å£°æ˜å®Œ é‚£å°±çœäº‹äº†ï¼Œ æ‰€ä»¥ï¼Œæœ‰äº†@CacheConfigè¿™ä¸ªé…ç½®ï¼Œ@CacheConfig is a class-level annotation that allows to share the cache namesï¼Œå¦‚æœä½ åœ¨ä½ çš„æ–¹æ³•å†™åˆ«çš„åå­—ï¼Œé‚£ä¹ˆä¾ç„¶ä»¥æ–¹æ³•çš„åå­—ä¸ºå‡†ã€‚</p>
<h2 id="caching">@Caching</h2>
<p>@Cachingå¯ä»¥ä½¿æ³¨è§£ç»„åˆä½¿ç”¨,æ¯”å¦‚æ ¹æ®idæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯,æŸ¥è¯¢å®Œçš„ç»“æœä¸º{key = id,value = userInfo},ä½†æˆ‘ä»¬ç°åœ¨ä¸ºäº†æ–¹é,æƒ³ç”¨ç”¨æˆ·çš„æ‰‹æœºå·,é‚®ç®±ç­‰ç¼“å­˜å¯¹åº”ç”¨æˆ·çš„ä¿¡æ¯,è¿™æ—¶å€™æˆ‘ä»¬å°±è¦ä½¿ç”¨@Cachingã€‚ä¾‹:</p>
<pre><code class="language-java">@Caching(put = {
@CachePut(value = &quot;user&quot;, key = &quot;#user.id&quot;),
@CachePut(value = &quot;user&quot;, key = &quot;#user.username&quot;),
@CachePut(value = &quot;user&quot;, key = &quot;#user.email&quot;)
})
public User getUserInfo(User user){
    ...
return user;
}
</code></pre>
<h1 id="é¡¹ç›®ç»“æ„å›¾ç¤º">é¡¹ç›®ç»“æ„å›¾ç¤º</h1>
<figure data-type="image" tabindex="1"><img src="http://blog.ludangxin.club/post-images/1589644541652.jpg" alt="" loading="lazy"></figure>
<h1 id="å¼•å…¥æ‰€éœ€ä¾èµ–">å¼•å…¥æ‰€éœ€ä¾èµ–</h1>
<pre><code class="language-xml">        &lt;!-- redis --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;!-- lettuce pool --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;
            &lt;artifactId&gt;commons-pool2&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;!-- aop æœ¬é¡¹ç›®ä¸­ä¸ºäº†æ–¹ä¾¿è®°å½•æ—¥å¿— --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-aop&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;!-- SpringBoot Webå®¹å™¨ --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;!-- lombok å·¥å…·ç±»--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
            &lt;artifactId&gt;lombok&lt;/artifactId&gt;
            &lt;optional&gt;true&lt;/optional&gt;
        &lt;/dependency&gt;
        &lt;!-- å•å…ƒæµ‹è¯•ä¾èµ– --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
            &lt;exclusions&gt;
                &lt;exclusion&gt;
                    &lt;groupId&gt;org.junit.vintage&lt;/groupId&gt;
                    &lt;artifactId&gt;junit-vintage-engine&lt;/artifactId&gt;
                &lt;/exclusion&gt;
            &lt;/exclusions&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;junit&lt;/groupId&gt;
            &lt;artifactId&gt;junit&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
</code></pre>
<h1 id="é…ç½®applicationyml">é…ç½®application.yml</h1>
<pre><code class="language-yaml">spring:
  # redis é…ç½®
  redis:
    # åœ°å€
    host: localhost
    # ç«¯å£ï¼Œé»˜è®¤ä¸º6379
    port: 6379
    # å¯†ç 
    password:
    # è¿æ¥è¶…æ—¶æ—¶é—´
    timeout: 10s
    lettuce:
      pool:
        # è¿æ¥æ± ä¸­çš„æœ€å°ç©ºé—²è¿æ¥
        min-idle: 0
        # è¿æ¥æ± ä¸­çš„æœ€å¤§ç©ºé—²è¿æ¥
        max-idle: 8
        # è¿æ¥æ± çš„æœ€å¤§æ•°æ®åº“è¿æ¥æ•°
        max-active: 8
        # #è¿æ¥æ± æœ€å¤§é˜»å¡ç­‰å¾…æ—¶é—´ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰
        max-wait: -1ms
</code></pre>
<h1 id="æ·»åŠ é¡¹ç›®é…ç½®ä¿¡æ¯">æ·»åŠ é¡¹ç›®é…ç½®ä¿¡æ¯</h1>
<h2 id="åˆ›å»ºredisé…ç½®ç±»">åˆ›å»ºredisé…ç½®ç±»</h2>
<pre><code class="language-java">import org.springframework.cache.annotation.EnableCaching;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.redis.connection.RedisConnectionFactory;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;
import org.springframework.data.redis.serializer.StringRedisSerializer;
import com.fasterxml.jackson.annotation.JsonAutoDetect;
import com.fasterxml.jackson.annotation.PropertyAccessor;
import com.fasterxml.jackson.databind.ObjectMapper;
/**
 * redisé…ç½®ç±»
 * @author ludangxin
 */
@Configuration
@EnableCaching
public class RedisConfig {

    @Bean
    @SuppressWarnings(&quot;all&quot;)
    public RedisTemplate&lt;String, Object&gt; redisTemplate(RedisConnectionFactory factory) {
        RedisTemplate&lt;String, Object&gt; template = new RedisTemplate&lt;String, Object&gt;();
        template.setConnectionFactory(factory);
        Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = new Jackson2JsonRedisSerializer(Object.class);
        ObjectMapper om = new ObjectMapper();
        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);
        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);
        jackson2JsonRedisSerializer.setObjectMapper(om);
        StringRedisSerializer stringRedisSerializer = new StringRedisSerializer();
        // keyé‡‡ç”¨Stringçš„åºåˆ—åŒ–æ–¹å¼
        template.setKeySerializer(stringRedisSerializer);
        // hashçš„keyä¹Ÿé‡‡ç”¨Stringçš„åºåˆ—åŒ–æ–¹å¼
        template.setHashKeySerializer(stringRedisSerializer);
        // valueåºåˆ—åŒ–æ–¹å¼é‡‡ç”¨jackson
        template.setValueSerializer(jackson2JsonRedisSerializer);
        // hashçš„valueåºåˆ—åŒ–æ–¹å¼é‡‡ç”¨jackson
        template.setHashValueSerializer(jackson2JsonRedisSerializer);
        template.afterPropertiesSet();
        return template;
    }
    
}
</code></pre>
<h2 id="åˆ›å»ºredis-util">åˆ›å»ºredis util</h2>
<pre><code class="language-java">/**
 * spring redis å·¥å…·ç±»
 *
 * @author ludangxin
 **/
@SuppressWarnings(value = { &quot;unchecked&quot;, &quot;rawtypes&quot; })
@Component
public class RedisUtil {

    @Autowired
    public RedisTemplate redisTemplate;

    /**
     * ç¼“å­˜åŸºæœ¬çš„å¯¹è±¡ï¼ŒIntegerã€Stringã€å®ä½“ç±»ç­‰
     *
     * @param key ç¼“å­˜çš„é”®å€¼
     * @param value ç¼“å­˜çš„å€¼
     * @return ç¼“å­˜çš„å¯¹è±¡
     */
    public &lt;T&gt; ValueOperations&lt;String, T&gt; setCacheObject(String key, T value) {
        ValueOperations&lt;String, T&gt; operation = redisTemplate.opsForValue();
        operation.set(key, value);
        return operation;
    }

    /**
     * ç¼“å­˜åŸºæœ¬çš„å¯¹è±¡ï¼ŒIntegerã€Stringã€å®ä½“ç±»ç­‰
     *
     * @param key ç¼“å­˜çš„é”®å€¼
     * @param value ç¼“å­˜çš„å€¼
     * @param timeout æ—¶é—´
     * @param timeUnit æ—¶é—´é¢—ç²’åº¦
     * @return ç¼“å­˜çš„å¯¹è±¡
     */
    public &lt;T&gt; ValueOperations&lt;String, T&gt; setCacheObject(String key, T value, Integer timeout, TimeUnit timeUnit) {
        ValueOperations&lt;String, T&gt; operation = redisTemplate.opsForValue();
        operation.set(key, value, timeout, timeUnit);
        return operation;
    }

    /**
     * è·å¾—ç¼“å­˜çš„åŸºæœ¬å¯¹è±¡ã€‚
     *
     * @param key ç¼“å­˜é”®å€¼
     * @return ç¼“å­˜é”®å€¼å¯¹åº”çš„æ•°æ®
     */
    public &lt;T&gt; T getCacheObject(String key) {
        ValueOperations&lt;String, T&gt; operation = redisTemplate.opsForValue();
        return operation.get(key);
    }

    /**
     * åˆ é™¤å•ä¸ªå¯¹è±¡
     *
     * @param key
     */
    public void deleteObject(String key) {
        redisTemplate.delete(key);
    }

    /**
     * åˆ é™¤é›†åˆå¯¹è±¡
     *
     * @param collection
     */
    public void deleteObject(Collection collection) {
        redisTemplate.delete(collection);
    }

    /**
     * ç¼“å­˜Listæ•°æ®
     *
     * @param key ç¼“å­˜çš„é”®å€¼
     * @param dataList å¾…ç¼“å­˜çš„Listæ•°æ®
     * @return ç¼“å­˜çš„å¯¹è±¡
     */
    public &lt;T&gt; ListOperations&lt;String, T&gt; setCacheList(String key, List&lt;T&gt; dataList) {
        ListOperations listOperation = redisTemplate.opsForList();
        if (null != dataList)
        {
            int size = dataList.size();
            for (int i = 0; i &lt; size; i++)
            {
                listOperation.leftPush(key, dataList.get(i));
            }
        }
        return listOperation;
    }

    /**
     * è·å¾—ç¼“å­˜çš„listå¯¹è±¡
     *
     * @param key ç¼“å­˜çš„é”®å€¼
     * @return ç¼“å­˜é”®å€¼å¯¹åº”çš„æ•°æ®
     */
    public &lt;T&gt; List&lt;T&gt; getCacheList(String key) {
        List&lt;T&gt; dataList = new ArrayList&lt;T&gt;();
        ListOperations&lt;String, T&gt; listOperation = redisTemplate.opsForList();
        Long size = listOperation.size(key);
        for (int i = 0; i &lt; size; i++)
        {
            dataList.add(listOperation.index(key, i));
        }
        return dataList;
    }

    /**
     * ç¼“å­˜Set
     *
     * @param key ç¼“å­˜é”®å€¼
     * @param dataSet ç¼“å­˜çš„æ•°æ®
     * @return ç¼“å­˜æ•°æ®çš„å¯¹è±¡
     */
    public &lt;T&gt; BoundSetOperations&lt;String, T&gt; setCacheSet(String key, Set&lt;T&gt; dataSet) {
        BoundSetOperations&lt;String, T&gt; setOperation = redisTemplate.boundSetOps(key);
        Iterator&lt;T&gt; it = dataSet.iterator();
        while (it.hasNext())
        {
            setOperation.add(it.next());
        }
        return setOperation;
    }

    /**
     * è·å¾—ç¼“å­˜çš„set
     *
     * @param key
     * @return
     */
    public &lt;T&gt; Set&lt;T&gt; getCacheSet(String key) {
        Set&lt;T&gt; dataSet = new HashSet&lt;T&gt;();
        BoundSetOperations&lt;String, T&gt; operation = redisTemplate.boundSetOps(key);
        dataSet = operation.members();
        return dataSet;
    }

    /**
     * ç¼“å­˜Map
     *
     * @param key
     * @param dataMap
     * @return
     */
    public &lt;T&gt; HashOperations&lt;String, String, T&gt; setCacheMap(String key, Map&lt;String, T&gt; dataMap) {
        HashOperations hashOperations = redisTemplate.opsForHash();
        if (null != dataMap)
        {
            for (Map.Entry&lt;String, T&gt; entry : dataMap.entrySet())
            {
                hashOperations.put(key, entry.getKey(), entry.getValue());
            }
        }
        return hashOperations;
    }

    /**
     * è·å¾—ç¼“å­˜çš„Map
     *
     * @param key
     * @return
     */
    public &lt;T&gt; Map&lt;String, T&gt; getCacheMap(String key) {
        Map&lt;String, T&gt; map = redisTemplate.opsForHash().entries(key);
        return map;
    }

    /**
     * è·å¾—ç¼“å­˜çš„åŸºæœ¬å¯¹è±¡åˆ—è¡¨
     *
     * @param pattern å­—ç¬¦ä¸²å‰ç¼€
     * @return å¯¹è±¡åˆ—è¡¨
     */
    public Collection&lt;String&gt; keys(String pattern) {
        return redisTemplate.keys(pattern);
    }
}
</code></pre>
<h2 id="åˆ›å»º-aop-log-åˆ‡é¢-æ–¹ä¾¿è®°å½•æ—¥å¿—">åˆ›å»º aop log åˆ‡é¢ æ–¹ä¾¿è®°å½•æ—¥å¿—</h2>
<pre><code class="language-java">import lombok.extern.slf4j.Slf4j;
import org.aspectj.lang.JoinPoint;
import org.aspectj.lang.annotation.After;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Pointcut;
import org.springframework.stereotype.Component;

/**
 * è®¾ç½®æ—¥å¿—åˆ‡é¢
 * @author ludangxin
 */
@Slf4j
@Aspect
@Component
public class LogAspect {
    
    @Pointcut(&quot;execution(public * com.ldx.springboot.service.impl.UserServiceImpl.*(..))&quot;)//åˆ‡å…¥ç‚¹æè¿°
    public void userServiceLog(){}//ç­¾åï¼Œå¯ä»¥ç†è§£æˆè¿™ä¸ªåˆ‡å…¥ç‚¹çš„ä¸€ä¸ªåç§°
    
    @After(&quot;userServiceLog()&quot;) //åœ¨åˆ‡å…¥ç‚¹çš„æ–¹æ³•runä¹‹å‰è¦å¹²çš„
    public void logBeforeController(JoinPoint joinPoint) {
        //ä¸‹é¢è¿™ä¸ªgetSignature().getDeclaringTypeName()æ˜¯è·å–åŒ…+ç±»åçš„   ç„¶ååé¢çš„joinPoint.getSignature.getName()è·å–äº†æ–¹æ³•å
        log.info(&quot;################æ‰§è¡Œæ–¹æ³• : &quot; + joinPoint.getSignature().getDeclaringTypeName() + &quot;.&quot; + joinPoint.getSignature().getName());
    }

}
</code></pre>
<h2 id="åˆ›å»ºç¼“å­˜å¸¸é‡ä¿¡æ¯">åˆ›å»ºç¼“å­˜å¸¸é‡ä¿¡æ¯</h2>
<pre><code class="language-java">public class CacheConstant {

    /** ç”¨æˆ·ä¿¡æ¯cache */
    public static final String USER_CACHE_NAME = &quot;user_cache&quot;;

    /** ç”¨æˆ·cache key å‰ç¼€ */
    public static final String USER_CACHE_KEY_PREFIX = &quot;user_&quot;;
}

</code></pre>
<h2 id="åˆ›å»ºå®ä½“ç±»">åˆ›å»ºå®ä½“ç±»</h2>
<pre><code class="language-java">import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;
import java.io.Serializable;

@Data
@AllArgsConstructor
@NoArgsConstructor
public class User implements Serializable {

    private static final long serialVersionUID = 1L;

    private int id;

    private String name;

    private String sex;

    private int age;

    private double height;

}
</code></pre>
<h2 id="åˆ›å»ºservice">åˆ›å»ºservice</h2>
<pre><code class="language-java">package com.ldx.springboot.service;

import com.ldx.springboot.model.User;

import java.util.List;

/**
 * ç”¨æˆ·ç®¡ç†
 * @author ludangxin
 */
public interface UserService {

    /**
     * æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯
     * @return
     */
    List&lt;User&gt; selectAll();

    /**
     * æ ¹æ®åç§°æ¨¡ç³ŠæŸ¥è¯¢
     * @param name
     * @return
     */
    List&lt;User&gt; selectByNameLike(String name);

    /**
     * æ ¹æ®idæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
     * @param id
     * @return
     */
    User getById(int id);

    /**
     * æ–°å¢ç”¨æˆ·ä¿¡æ¯
     * @param user
     * @return
     */
    List&lt;User&gt; add(User user);

    /**
     * æ›´æ–°ç”¨æˆ·ä¿¡æ¯
     * @param user
     * @return
     */
    List&lt;User&gt; updateById(User user);

    /**
     * æ ¹æ®idåˆ é™¤ç”¨æˆ·ä¿¡æ¯
     * @return
     */
    List&lt;User&gt; deleteById(int id);

    /**
     * åˆ é™¤å…¨éƒ¨ç”¨æˆ·ä¿¡æ¯
     * @return
     */
    void deleteAll();

}
</code></pre>
<h2 id="åˆ›å»ºå®ç°ç±»">åˆ›å»ºå®ç°ç±»</h2>
<pre><code class="language-java">package com.ldx.springboot.service.impl;

import com.ldx.springboot.constant.CacheConstant;
import com.ldx.springboot.model.User;
import com.ldx.springboot.service.UserService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.cache.annotation.*;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import java.util.stream.Collectors;

/**
 * ç”¨æˆ·ç®¡ç†å®ç°ç±»
 * @author ludangxin
 */
@Slf4j
@CacheConfig(cacheNames = CacheConstant.USER_CACHE_NAME)
@Service(value = &quot;userService&quot;)
public class UserServiceImpl implements UserService {

    //æ•°æ®æº
    static List&lt;User&gt; users = new ArrayList&lt;&gt;();
    static{
        User user1 = new User(1,&quot;å¼ ä¸‰&quot;,&quot;ç”·&quot;,18,178.5);
        User user2 = new User(2,&quot;æå››&quot;,&quot;ç”·&quot;,16,172.3);
        User user3 = new User(3,&quot;ç‹äº”&quot;,&quot;ç”·&quot;,22,180);
        User user4 = new User(4,&quot;ç‹éº»å­&quot;,&quot;ç”·&quot;,33,185);
        User user5 = new User(5,&quot;å°çº¢&quot;,&quot;å¥³&quot;,18,160);
        User user6 = new User(6,&quot;å°ç»¿&quot;,&quot;å¥³&quot;,17,160);
        User user7 = new User(7,&quot;å°è“&quot;,&quot;å¥³&quot;,19,160);
        users.add(user1);
        users.add(user2);
        users.add(user3);
        users.add(user4);
        users.add(user5);
        users.add(user6);
        users.add(user7);
    }

    @Cacheable(key = &quot;'&quot;+CacheConstant.USER_CACHE_KEY_PREFIX+&quot;all'&quot;)
    @Override
    public List&lt;User&gt; selectAll() {
        return users;
    }

    @Cacheable(key = &quot;'&quot;+CacheConstant.USER_CACHE_KEY_PREFIX+&quot;'+#name&quot;)
    @Override
    public List&lt;User&gt; selectByNameLike(String name) {
        List&lt;User&gt; listUser = users.stream().filter(obj -&gt; obj.getName().contains(name)).collect(Collectors.toList());
        return listUser;
    }

    @Cacheable(key = &quot;'&quot;+CacheConstant.USER_CACHE_KEY_PREFIX+&quot;'+#id&quot;)
    @Override
    public User getById(int id) {
        User user = users.stream().filter(obj -&gt; obj.getId() == id).findFirst().get();
        return user;
    }

    @CachePut(key = &quot;'&quot;+CacheConstant.USER_CACHE_KEY_PREFIX+&quot;all'&quot;)
    @Override
    public List&lt;User&gt; add(User user) {
        users.add(user);
        return users;
    }

    @Caching(put = {@CachePut(key = &quot;'&quot;+CacheConstant.USER_CACHE_KEY_PREFIX+&quot;all'&quot;)},
            evict = {@CacheEvict(key = &quot;'&quot;+CacheConstant.USER_CACHE_KEY_PREFIX+&quot;'+#user.id&quot;)}
    )
    @Override
    public List&lt;User&gt; updateById(User user) {
        for (int i = 0; i &lt; users.size(); i++) {
            if(users.get(i).getId() == user.getId()){
                users.set(i,user);
            }
        }
        return users;
    }

    @Caching(put = {@CachePut(key = &quot;'&quot;+CacheConstant.USER_CACHE_KEY_PREFIX+&quot;all'&quot;)},
            evict = {@CacheEvict(key= &quot;'&quot;+CacheConstant.USER_CACHE_KEY_PREFIX+&quot;'+#id&quot;)}
    )
    @Override
    public List&lt;User&gt; deleteById(int id) {
        Iterator&lt;User&gt; iterator = users.iterator();
        while(iterator.hasNext()) {
            User user = iterator.next();
            if(user.getId() == id){
                iterator.remove();
            }
        }
        return users;
    }

    @CacheEvict(allEntries = true)
    @Override
    public void deleteAll() {
        users = new ArrayList&lt;&gt;();
    }

}
</code></pre>
<h2 id="åˆ›å»ºæµ‹è¯•ç±»">åˆ›å»ºæµ‹è¯•ç±»</h2>
<pre><code class="language-java">import com.ldx.springboot.model.User;
import lombok.extern.slf4j.Slf4j;
import org.junit.jupiter.api.Test;
import org.junit.runner.RunWith;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.junit4.SpringRunner;
import javax.annotation.Resource;
import java.util.List;

@Slf4j
@RunWith(SpringRunner.class)
@SpringBootTest
class UserServiceTest  {

    @Resource(name = &quot;userService&quot;)
    UserService userService;

    @Test
    void selectAll() {
        List&lt;User&gt; users = userService.selectAll();
        users.forEach(System.out::println);
    }

    @Test
    void selectByNameLike() {
        String keywork = &quot;å°&quot;;
        List&lt;User&gt; users = userService.selectByNameLike(keywork);
        users.forEach(System.out::println);
    }

    @Test
    void getById() {
        int id = 3;
        User user = userService.getById(id);
        log.info(user.toString());
    }

    @Test
    void add() {
        User user = new User(6,&quot;å°ç²‰&quot;,&quot;å¥³&quot;,16,155);
        userService.add(user);
        selectAll();
    }

    @Test
    void updateById() {
        User user = new User(3,&quot;å°ç²‰&quot;,&quot;å¥³&quot;,16,155);
        userService.updateById(user);
        selectAll();
    }

    @Test
    void deleteById() {
        userService.deleteById(5);
    }

    @Test
    void deleteAll() {
        userService.deleteAll();
    }

}
</code></pre>
<h1 id="redis-å®‰è£…">redis å®‰è£…</h1>
<h2 id="å®‰è£…gcc">å®‰è£…gcc</h2>
<p>ç”±äº redis æ˜¯ç”¨ C è¯­è¨€å¼€å‘ï¼Œå®‰è£…ä¹‹å‰å¿…å…ˆç¡®è®¤æ˜¯å¦å®‰è£… gcc ç¯å¢ƒï¼ˆgcc -vï¼‰ï¼Œå¦‚æœæ²¡æœ‰å®‰è£…ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤è¿›è¡Œå®‰è£…</p>
<pre><code class="language-bash">yum install -y gcc 
</code></pre>
<h2 id="ä¸‹è½½å¹¶è§£å‹å®‰è£…åŒ…">ä¸‹è½½å¹¶è§£å‹å®‰è£…åŒ…</h2>
<pre><code class="language-bash">wget http://download.redis.io/releases/redis-5.0.3.tar.gz
tar -zxvf redis-5.0.3.tar.gz
</code></pre>
<h2 id="æ‰§è¡Œç¼–è¯‘">æ‰§è¡Œç¼–è¯‘</h2>
<pre><code class="language-bash">cd redis-5.0.3
make
</code></pre>
<h2 id="å®‰è£…å¹¶æŒ‡å®šå®‰è£…ç›®å½•">å®‰è£…å¹¶æŒ‡å®šå®‰è£…ç›®å½•</h2>
<pre><code class="language-bash">make install PREFIX=/usr/local/redis
</code></pre>
<h2 id="å¯åŠ¨æœåŠ¡">å¯åŠ¨æœåŠ¡</h2>
<h3 id="å‰å°å¯åŠ¨">å‰å°å¯åŠ¨</h3>
<pre><code class="language-bash">cd /usr/local/redis/bin/
./redis-server
</code></pre>
<h3 id="åå°å¯åŠ¨">åå°å¯åŠ¨</h3>
<ol>
<li>ä»redisçš„æºç ç›®å½•ä¸­å¤åˆ¶redis.confåˆ°redisçš„å®‰è£…ç›®å½•</li>
</ol>
<pre><code class="language-bash">cp /usr/local/redis-5.0.3/redis.conf /usr/local/redis/bin/
</code></pre>
<ol start="2">
<li>ä¿®æ”¹redis.conf æ–‡ä»¶ï¼ŒæŠŠ daemonize no æ”¹ä¸º daemonize yes</li>
</ol>
<pre><code class="language-bash">vi redis.conf
</code></pre>
<pre><code class="language-bash">################################# GENERAL #####################################

# By default Redis does not run as a daemon. Use 'yes' if you need it.
# Note that Redis will write a pid file in /var/run/redis.pid when daemonized.
daemonize yes
</code></pre>
<ol start="3">
<li>åå°å¯åŠ¨</li>
</ol>
<pre><code class="language-bash">./redis-server redis.conf
# æŸ¥çœ‹redisè¿›ç¨‹çŠ¶æ€
ps -ef | grep redis
</code></pre>
<h2 id="è®¾ç½®å¼€æœºå¯åŠ¨">è®¾ç½®å¼€æœºå¯åŠ¨</h2>
<h3 id="æ·»åŠ å¼€æœºå¯åŠ¨æœåŠ¡">æ·»åŠ å¼€æœºå¯åŠ¨æœåŠ¡</h3>
<pre><code class="language-bash">vi /etc/systemd/system/redis.service
</code></pre>
<p>æ·»åŠ ä»¥ä¸‹å†…å®¹</p>
<pre><code class="language-bash">[Unit]
Description=redis-server
After=network.target

[Service]
Type=forking
ExecStart=/usr/local/redis/bin/redis-server /usr/local/redis/bin/redis.conf
PrivateTmp=true

[Install]
WantedBy=multi-user.target
</code></pre>
<p><strong>æ³¨æ„</strong> : ExecStarté…ç½®æˆè‡ªå·±çš„è·¯å¾„</p>
<h3 id="è®¾ç½®å¼€æœºå¯åŠ¨-2">è®¾ç½®å¼€æœºå¯åŠ¨</h3>
<pre><code class="language-bash">systemctl daemon-reload
systemctl start redis.service
systemctl enable redis.service
</code></pre>
<h3 id="åˆ›å»ºrediså‘½ä»¤è½¯é“¾æ¥">åˆ›å»ºrediså‘½ä»¤è½¯é“¾æ¥</h3>
<pre><code class="language-bash"> ln -s /usr/local/redis/bin/redis-cli /usr/bin/redis
</code></pre>
<h3 id="æµ‹è¯•">æµ‹è¯•</h3>
<p>ç›´æ¥è¾“å…¥<code>redis</code></p>
<pre><code class="language-bash">[root@iZ2ze ~]# redis
127.0.0.1:6379&gt; 
</code></pre>
<h3 id="æœåŠ¡æ“ä½œå‘½ä»¤">æœåŠ¡æ“ä½œå‘½ä»¤</h3>
<pre><code class="language-bash">systemctl start redis.service   #å¯åŠ¨redisæœåŠ¡

systemctl stop redis.service   #åœæ­¢redisæœåŠ¡

systemctl restart redis.service   #é‡æ–°å¯åŠ¨æœåŠ¡

systemctl status redis.service   #æŸ¥çœ‹æœåŠ¡å½“å‰çŠ¶æ€

systemctl enable redis.service   #è®¾ç½®å¼€æœºè‡ªå¯åŠ¨

systemctl disable redis.service   #åœæ­¢å¼€æœºè‡ªå¯åŠ¨
</code></pre>
<h1 id="ç¼“å­˜é›ªå´©">ç¼“å­˜é›ªå´©</h1>
<p>ç¼“å­˜é›ªå´©æ˜¯æŒ‡åœ¨æˆ‘ä»¬è®¾ç½®ç¼“å­˜æ—¶é‡‡ç”¨äº†ç›¸åŒçš„è¿‡æœŸæ—¶é—´ï¼Œå¯¼è‡´ç¼“å­˜åœ¨æŸä¸€æ—¶åˆ»åŒæ—¶å¤±æ•ˆï¼Œè¯·æ±‚å…¨éƒ¨è½¬å‘åˆ°DBï¼ŒDBç¬æ—¶å‹åŠ›è¿‡é‡é›ªå´©ã€‚</p>
<h2 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</h2>
<p>ç¼“å­˜å¤±æ•ˆæ—¶çš„é›ªå´©æ•ˆåº”å¯¹åº•å±‚ç³»ç»Ÿçš„å†²å‡»éå¸¸å¯æ€•ã€‚å¤§å¤šæ•°ç³»ç»Ÿè®¾è®¡è€…è€ƒè™‘ç”¨åŠ é”æˆ–è€…é˜Ÿåˆ—çš„æ–¹å¼ä¿è¯ç¼“å­˜çš„å•çº¿ ç¨‹ï¼ˆè¿›ç¨‹ï¼‰å†™ï¼Œä»è€Œé¿å…å¤±æ•ˆæ—¶å¤§é‡çš„å¹¶å‘è¯·æ±‚è½åˆ°åº•å±‚å­˜å‚¨ç³»ç»Ÿä¸Šã€‚è¿™é‡Œåˆ†äº«ä¸€ä¸ªç®€å•æ–¹æ¡ˆå°±æ—¶è®²ç¼“å­˜å¤±æ•ˆæ—¶é—´åˆ†æ•£å¼€ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥åœ¨åŸæœ‰çš„å¤±æ•ˆæ—¶é—´åŸºç¡€ä¸Šå¢åŠ ä¸€ä¸ªéšæœºå€¼ï¼Œæ¯”å¦‚1-5åˆ†é’Ÿéšæœºï¼Œè¿™æ ·æ¯ä¸€ä¸ªç¼“å­˜çš„è¿‡æœŸæ—¶é—´çš„é‡å¤ç‡å°±ä¼šé™ä½ï¼Œå°±å¾ˆéš¾å¼•å‘é›†ä½“å¤±æ•ˆçš„äº‹ä»¶ã€‚<br>
æˆ–è€…è®¾ç½®çƒ­ç‚¹æ•°æ®æ°¸è¿œä¸è¿‡æœŸï¼Œæœ‰æ›´æ–°æ“ä½œå°±æ›´æ–°ç¼“å­˜å°±å¥½äº†ï¼ˆæ¯”å¦‚è¿ç»´æ›´æ–°äº†é¦–é¡µå•†å“ï¼Œé‚£ä½ åˆ·ä¸‹ç¼“å­˜å°±å®Œäº‹äº†ï¼Œä¸è¦è®¾ç½®è¿‡æœŸæ—¶é—´ï¼‰ï¼Œç”µå•†é¦–é¡µçš„æ•°æ®ä¹Ÿå¯ä»¥ç”¨è¿™ä¸ªæ“ä½œï¼Œä¿é™©ã€‚</p>
<h1 id="ç¼“å­˜å‡»ç©¿">ç¼“å­˜å‡»ç©¿</h1>
<p>å¯¹äºä¸€äº›è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„keyï¼Œå¦‚æœè¿™äº›keyå¯èƒ½ä¼šåœ¨æŸäº›æ—¶é—´ç‚¹è¢«è¶…é«˜å¹¶å‘åœ°è®¿é—®ï¼Œæ˜¯ä¸€ç§éå¸¸â€œçƒ­ç‚¹â€çš„æ•°æ®ã€‚è¿™ä¸ªæ—¶å€™ï¼Œéœ€è¦è€ƒè™‘ä¸€ä¸ªé—®é¢˜ï¼šç¼“å­˜è¢«â€œå‡»ç©¿â€çš„é—®é¢˜ï¼Œè¿™ä¸ªå’Œç¼“å­˜é›ªå´©çš„åŒºåˆ«åœ¨äºè¿™é‡Œé’ˆå¯¹æŸä¸€keyç¼“å­˜ï¼Œå‰è€…åˆ™æ˜¯å¾ˆå¤škeyã€‚<br>
ç¼“å­˜åœ¨æŸä¸ªæ—¶é—´ç‚¹è¿‡æœŸçš„æ—¶å€™ï¼Œæ°å¥½åœ¨è¿™ä¸ªæ—¶é—´ç‚¹å¯¹è¿™ä¸ªKeyæœ‰å¤§é‡çš„å¹¶å‘è¯·æ±‚è¿‡æ¥ï¼Œè¿™äº›è¯·æ±‚å‘ç°ç¼“å­˜è¿‡æœŸä¸€èˆ¬éƒ½ä¼šä»åç«¯DBåŠ è½½æ•°æ®å¹¶å›è®¾åˆ°ç¼“å­˜ï¼Œè¿™ä¸ªæ—¶å€™å¤§å¹¶å‘çš„è¯·æ±‚å¯èƒ½ä¼šç¬é—´æŠŠåç«¯DBå‹å®ã€‚</p>
<h2 id="è§£å†³æ–¹æ¡ˆ-2">è§£å†³æ–¹æ¡ˆ</h2>
<p>è®¾ç½®çƒ­ç‚¹æ•°æ®æ°¸è¿œä¸è¿‡æœŸæˆ–ä½¿ç”¨äº’æ–¥é”(mutex key)<br>
ä¸šç•Œæ¯”è¾ƒå¸¸ç”¨çš„åšæ³•ï¼Œæ˜¯ä½¿ç”¨mutexã€‚ç®€å•åœ°æ¥è¯´ï¼Œå°±æ˜¯åœ¨ç¼“å­˜å¤±æ•ˆçš„æ—¶å€™ï¼ˆåˆ¤æ–­æ‹¿å‡ºæ¥çš„å€¼ä¸ºç©ºï¼‰ï¼Œä¸æ˜¯ç«‹å³å»load dbï¼Œè€Œæ˜¯å…ˆä½¿ç”¨ç¼“å­˜å·¥å…·çš„æŸäº›å¸¦æˆåŠŸæ“ä½œè¿”å›å€¼çš„æ“ä½œï¼ˆæ¯”å¦‚Redisçš„SETNXæˆ–è€…Memcacheçš„ADDï¼‰å»setä¸€ä¸ªmutex keyï¼Œå½“æ“ä½œè¿”å›æˆåŠŸæ—¶ï¼Œå†è¿›è¡Œload dbçš„æ“ä½œå¹¶å›è®¾ç¼“å­˜ï¼›å¦åˆ™ï¼Œå°±é‡è¯•æ•´ä¸ªgetç¼“å­˜çš„æ–¹æ³•ã€‚<br>
SETNXï¼Œæ˜¯ã€ŒSET if Not eXistsã€çš„ç¼©å†™ï¼Œä¹Ÿå°±æ˜¯åªæœ‰ä¸å­˜åœ¨çš„æ—¶å€™æ‰è®¾ç½®ï¼Œå¯ä»¥åˆ©ç”¨å®ƒæ¥å®ç°é”çš„æ•ˆæœã€‚</p>
<h1 id="ç¼“å­˜ç©¿é€">ç¼“å­˜ç©¿é€</h1>
<p>ç¼“å­˜ç©¿é€æ˜¯æŒ‡æŸ¥è¯¢ä¸€ä¸ªä¸€å®šä¸å­˜åœ¨çš„æ•°æ®ï¼Œç”±äºç¼“å­˜æ˜¯ä¸å‘½ä¸­æ—¶è¢«åŠ¨å†™çš„ï¼Œå¹¶ä¸”å‡ºäºå®¹é”™è€ƒè™‘ï¼Œå¦‚æœä»å­˜å‚¨å±‚æŸ¥ä¸åˆ°æ•°æ®åˆ™ä¸å†™å…¥ç¼“å­˜ï¼Œè¿™å°†å¯¼è‡´è¿™ä¸ªä¸å­˜åœ¨çš„æ•°æ®æ¯æ¬¡è¯·æ±‚éƒ½è¦åˆ°å­˜å‚¨å±‚å»æŸ¥è¯¢ï¼Œå¤±å»äº†ç¼“å­˜çš„æ„ä¹‰ã€‚åœ¨æµé‡å¤§æ—¶ï¼Œå¯èƒ½DBå°±æŒ‚æ‰äº†ï¼Œè¦æ˜¯æœ‰äººåˆ©ç”¨ä¸å­˜åœ¨çš„keyé¢‘ç¹æ”»å‡»æˆ‘ä»¬çš„åº”ç”¨ï¼Œè¿™å°±æ˜¯æ¼æ´ã€‚</p>
<h2 id="è§£å†³æ–¹æ¡ˆ-3">è§£å†³æ–¹æ¡ˆ</h2>
<p>å¸ƒéš†è¿‡æ»¤å¯¹æ‰€æœ‰çš„å¯èƒ½æŸ¥è¯¢çš„å‚æ•°ä»¥hashå½¢å¼å­˜å‚¨,åœ¨æ§åˆ¶å™¨å±‚å…ˆè¿›è¡Œæ ¡éªŒ,ä¸ç¬¦åˆåˆ™ä¸¢å¼ƒ,ä»è€Œé¿å…äº†å¯¹åº•å±‚å­˜å‚¨ç³»ç»Ÿçš„æŸ¥è¯¢å‹åŠ›ã€‚bloomfilterå°±ç±»ä¼¼äºä¸€ä¸ªhash setï¼Œç”¨äºå¿«é€Ÿåˆ¤æŸä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨äºé›†åˆä¸­ï¼Œå…¶å…¸å‹çš„åº”ç”¨åœºæ™¯å°±æ˜¯å¿«é€Ÿåˆ¤æ–­ä¸€ä¸ªkeyæ˜¯å¦å­˜åœ¨äºæŸå®¹å™¨ï¼Œä¸å­˜åœ¨å°±ç›´æ¥è¿”å›ã€‚ä¸¾ä¾‹:å°†çœŸå®æ­£ç¡®Idåœ¨æ·»åŠ å®Œæˆä¹‹åä¾¿åŠ å…¥åˆ°è¿‡æ»¤å™¨å½“ä¸­ï¼Œæ¯æ¬¡å†è¿›è¡ŒæŸ¥è¯¢æ—¶ï¼Œå…ˆç¡®è®¤è¦æŸ¥è¯¢çš„Idæ˜¯å¦åœ¨è¿‡æ»¤å™¨ä¸­ï¼Œå¦‚æœä¸åœ¨ï¼Œåˆ™è¯´æ˜Idä¸ºéæ³•Idã€‚<br>
ç¼“å­˜ç©ºå¯¹è±¡å½“ä»æ•°æ®åº“æŸ¥è¯¢ä¸åˆ°å€¼ï¼Œå°±æŠŠå‚æ•°å’Œæ§åˆ¶ç¼“å­˜èµ·æ¥ï¼Œè®¾ç½®ä¸€ä¸ªç®€çŸ­çš„è¿‡æœŸæ—¶é—´(å› ä¸ºç¼“å­˜æ˜¯éœ€è¦å†…å­˜çš„ï¼Œå¦‚æœæœ‰è¿‡å¤šç©ºå€¼keyï¼Œå ç”¨å†…å­˜å¤š),åœ¨è¯¥æ—¶é—´æ®µå¦‚æœæœ‰æºå¸¦æ­¤å‚æ•°å†æ¬¡è¯·æ±‚ï¼Œå°±å¯ä»¥ç›´æ¥è¿”å›ã€‚å¯èƒ½å¯¼è‡´è¯¥æ®µæ—¶é—´ç¼“å­˜å±‚å’Œæ•°æ®åº“æ•°æ®ä¸ä¸€è‡´ï¼Œå¯¹äºéœ€è¦ä¿æŒä¸€è‡´æ€§çš„ä¸šåŠ¡æœ‰å½±å“ã€‚</p>
<h1 id="ä»€ä¹ˆæ˜¯å¤šè·¯ioå¤ç”¨æ¨¡å‹">ä»€ä¹ˆæ˜¯å¤šè·¯I/Oå¤ç”¨æ¨¡å‹?</h1>
<h2 id="é€šä¿—æ˜“æ‡‚çš„ä¾‹å­">é€šä¿—æ˜“æ‡‚çš„ä¾‹å­:</h2>
<p>å‡è®¾ä½ æ˜¯ä¸€ä¸ªè€å¸ˆï¼Œè®©30ä¸ªå­¦ç”Ÿè§£ç­”ä¸€é“é¢˜ç›®ï¼Œç„¶åæ£€æŸ¥å­¦ç”Ÿåšçš„æ˜¯å¦æ­£ç¡®ï¼Œä½ æœ‰ä¸‹é¢å‡ ä¸ªé€‰æ‹©ï¼š</p>
<ol>
<li>ç¬¬ä¸€ç§é€‰æ‹©ï¼šæŒ‰é¡ºåºé€ä¸ªæ£€æŸ¥ï¼Œå…ˆæ£€æŸ¥Aï¼Œç„¶åæ˜¯Bï¼Œä¹‹åæ˜¯Cã€Dã€‚ã€‚ã€‚è¿™ä¸­é—´å¦‚æœæœ‰ä¸€ä¸ªå­¦ç”Ÿå¡ä¸»ï¼Œå…¨ç­éƒ½ä¼šè¢«è€½è¯¯ã€‚è¿™ç§æ¨¡å¼å°±å¥½æ¯”ï¼Œä½ ç”¨å¾ªç¯æŒ¨ä¸ªå¤„ç†socketï¼Œæ ¹æœ¬ä¸å…·æœ‰å¹¶å‘èƒ½åŠ›ã€‚</li>
<li>ç¬¬äºŒç§é€‰æ‹©ï¼šä½ åˆ›å»º30ä¸ªåˆ†èº«ï¼Œæ¯ä¸ªåˆ†èº«æ£€æŸ¥ä¸€ä¸ªå­¦ç”Ÿçš„ç­”æ¡ˆæ˜¯å¦æ­£ç¡®ã€‚ è¿™ç§ç±»ä¼¼äºä¸ºæ¯ä¸€ä¸ªç”¨æˆ·åˆ›å»ºä¸€ä¸ªè¿›ç¨‹æˆ–è€…çº¿ç¨‹å¤„ç†è¿æ¥ã€‚</li>
<li>ç¬¬ä¸‰ç§é€‰æ‹©ï¼Œä½ ç«™åœ¨è®²å°ä¸Šç­‰ï¼Œè°è§£ç­”å®Œè°ä¸¾æ‰‹ã€‚è¿™æ—¶Cã€Dä¸¾æ‰‹ï¼Œè¡¨ç¤ºä»–ä»¬è§£ç­”é—®é¢˜å®Œæ¯•ï¼Œä½ ä¸‹å»ä¾æ¬¡æ£€æŸ¥Cã€Dçš„ç­”æ¡ˆï¼Œç„¶åç»§ç»­å›åˆ°è®²å°ä¸Šç­‰ã€‚æ­¤æ—¶Eã€Aåˆä¸¾æ‰‹ï¼Œç„¶åå»å¤„ç†Eå’ŒAã€‚ã€‚ã€‚ è¿™ç§å°±æ˜¯IOå¤ç”¨æ¨¡å‹ï¼ŒLinuxä¸‹çš„selectã€pollå’Œepollå°±æ˜¯å¹²è¿™ä¸ªçš„ã€‚å°†ç”¨æˆ·socketå¯¹åº”çš„fdæ³¨å†Œè¿›epollï¼Œç„¶åepollå¸®ä½ ç›‘å¬å“ªäº›socketä¸Šæœ‰æ¶ˆæ¯åˆ°è¾¾ï¼Œè¿™æ ·å°±é¿å…äº†å¤§é‡çš„æ— ç”¨æ“ä½œã€‚æ­¤æ—¶çš„socketåº”è¯¥é‡‡ç”¨éé˜»å¡æ¨¡å¼ã€‚è¿™æ ·ï¼Œæ•´ä¸ªè¿‡ç¨‹åªåœ¨è°ƒç”¨selectã€pollã€epollè¿™äº›è°ƒç”¨çš„æ—¶å€™æ‰ä¼šé˜»å¡ï¼Œæ”¶å‘å®¢æˆ·æ¶ˆæ¯æ˜¯ä¸ä¼šé˜»å¡çš„ï¼Œæ•´ä¸ªè¿›ç¨‹æˆ–è€…çº¿ç¨‹å°±è¢«å……åˆ†åˆ©ç”¨èµ·æ¥ï¼Œè¿™å°±æ˜¯äº‹ä»¶é©±åŠ¨ï¼Œæ‰€è°“çš„reactoræ¨¡å¼ã€‚</li>
</ol>
<p><a href="https://www.zhihu.com/question/28594409/answer/52835876">è½¬è‡ªæŸ´å°çŒ«</a></p>
<h2 id="å†æ¬¡åŠ æ·±ç†è§£">å†æ¬¡åŠ æ·±ç†è§£</h2>
<p>é¦–å…ˆï¼Œè¦ä»ä½ å¸¸ç”¨çš„IOæ“ä½œè°ˆèµ·ï¼Œæ¯”å¦‚readå’Œwriteï¼Œé€šå¸¸IOæ“ä½œéƒ½æ˜¯é˜»å¡I/Oçš„ï¼Œä¹Ÿå°±æ˜¯è¯´å½“ä½ è°ƒç”¨readæ—¶ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®æ”¶åˆ°ï¼Œé‚£ä¹ˆçº¿ç¨‹æˆ–è€…è¿›ç¨‹å°±ä¼šè¢«æŒ‚èµ·ï¼Œç›´åˆ°æ”¶åˆ°æ•°æ®ã€‚<br>
<img src="http://blog.ludangxin.club/post-images/1589980293659.jpg" alt="" loading="lazy"><br>
è¿™æ ·ï¼Œå½“æœåŠ¡å™¨éœ€è¦å¤„ç†1000ä¸ªè¿æ¥çš„çš„æ—¶å€™ï¼Œè€Œä¸”åªæœ‰å¾ˆå°‘è¿æ¥å¿™ç¢Œçš„ï¼Œé‚£ä¹ˆä¼šéœ€è¦1000ä¸ªçº¿ç¨‹æˆ–è¿›ç¨‹æ¥å¤„ç†1000ä¸ªè¿æ¥ï¼Œè€Œ1000ä¸ªçº¿ç¨‹å¤§éƒ¨åˆ†æ˜¯è¢«é˜»å¡èµ·æ¥çš„ã€‚ç”±äºCPUçš„æ ¸æ•°æˆ–è¶…çº¿ç¨‹æ•°ä¸€èˆ¬éƒ½ä¸å¤§ï¼Œæ¯”å¦‚4,8,16,32,64,128ï¼Œæ¯”å¦‚4ä¸ªæ ¸è¦è·‘1000ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆæ¯ä¸ªçº¿ç¨‹çš„æ—¶é—´æ§½éå¸¸çŸ­ï¼Œè€Œçº¿ç¨‹åˆ‡æ¢éå¸¸é¢‘ç¹ã€‚<br>
è¿™æ ·æ˜¯æœ‰é—®é¢˜çš„ï¼š</p>
<ol>
<li>çº¿ç¨‹æ˜¯æœ‰å†…å­˜å¼€é”€çš„ï¼Œ1ä¸ªçº¿ç¨‹å¯èƒ½éœ€è¦512Kï¼ˆæˆ–2Mï¼‰å­˜æ”¾æ ˆï¼Œé‚£ä¹ˆ1000ä¸ªçº¿ç¨‹å°±è¦512Mï¼ˆæˆ–2Gï¼‰å†… å­˜ã€‚</li>
<li>çº¿ç¨‹çš„åˆ‡æ¢ï¼Œæˆ–è€…è¯´ä¸Šä¸‹æ–‡åˆ‡æ¢æ˜¯æœ‰CPUå¼€é”€çš„ï¼Œå½“å¤§é‡æ—¶é—´èŠ±åœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ—¶å€™ï¼Œåˆ†é…ç»™çœŸæ­£çš„æ“ä½œçš„CPUå°±è¦å°‘å¾ˆå¤šã€‚</li>
</ol>
<p>é‚£ä¹ˆï¼Œæˆ‘ä»¬å°±è¦å¼•å…¥éé˜»å¡I/Oçš„æ¦‚å¿µï¼Œéé˜»å¡IOå¾ˆç®€å•ï¼Œé€šè¿‡fcntlï¼ˆPOSIXï¼‰æˆ–ioctlï¼ˆUnixï¼‰è®¾ä¸ºéé˜»å¡æ¨¡å¼ï¼Œè¿™æ—¶ï¼Œå½“ä½ è°ƒç”¨readæ—¶ï¼Œå¦‚æœæœ‰æ•°æ®æ”¶åˆ°ï¼Œå°±è¿”å›æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®æ”¶åˆ°ï¼Œå°±ç«‹åˆ»è¿”å›ä¸€ä¸ªé”™è¯¯ï¼Œå¦‚EWOULDBLOCKã€‚è¿™æ ·æ˜¯ä¸ä¼šé˜»å¡çº¿ç¨‹äº†ï¼Œä½†æ˜¯ä½ è¿˜æ˜¯è¦ä¸æ–­çš„è½®è¯¢æ¥è¯»å–æˆ–å†™å…¥ã€‚<br>
<img src="http://blog.ludangxin.club/post-images/1589980387132.jpg" alt="" loading="lazy"><br>
äºæ˜¯ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥IOå¤šè·¯å¤ç”¨çš„æ¦‚å¿µã€‚å¤šè·¯å¤ç”¨æ˜¯æŒ‡ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹æ¥æ£€æŸ¥å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆSocketï¼‰çš„å°±ç»ªçŠ¶æ€ï¼Œæ¯”å¦‚è°ƒç”¨selectå’Œpollå‡½æ•°ï¼Œä¼ å…¥å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå¦‚æœæœ‰ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦å°±ç»ªï¼Œåˆ™è¿”å›ï¼Œå¦åˆ™é˜»å¡ç›´åˆ°è¶…æ—¶ã€‚å¾—åˆ°å°±ç»ªçŠ¶æ€åè¿›è¡ŒçœŸæ­£çš„æ“ä½œå¯ä»¥åœ¨åŒä¸€ä¸ªçº¿ç¨‹é‡Œæ‰§è¡Œï¼Œä¹Ÿå¯ä»¥å¯åŠ¨çº¿ç¨‹æ‰§è¡Œï¼ˆæ¯”å¦‚ä½¿ç”¨çº¿ç¨‹æ± ï¼‰ã€‚<br>
<img src="http://blog.ludangxin.club/post-images/1589980421324.jpg" alt="" loading="lazy"><br>
è¿™æ ·åœ¨å¤„ç†1000ä¸ªè¿æ¥æ—¶ï¼Œåªéœ€è¦1ä¸ªçº¿ç¨‹ç›‘æ§å°±ç»ªçŠ¶æ€ï¼Œå¯¹å°±ç»ªçš„æ¯ä¸ªè¿æ¥å¼€ä¸€ä¸ªçº¿ç¨‹å¤„ç†å°±å¯ä»¥äº†ï¼Œè¿™æ ·éœ€è¦çš„çº¿ç¨‹æ•°å¤§å¤§å‡å°‘ï¼Œå‡å°‘äº†å†…å­˜å¼€é”€å’Œä¸Šä¸‹æ–‡åˆ‡æ¢çš„CPUå¼€é”€ã€‚</p>
<p><a href="https://www.zhihu.com/question/28594409/answer/74003996">è½¬è‡ªç”¨å¿ƒé˜</a></p>
]]></content>
    </entry>
</feed>